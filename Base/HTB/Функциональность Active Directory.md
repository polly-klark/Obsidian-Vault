#AD #htb #windows 

Как уже упоминалось, существует пять ролей Flexible Single Master Operation (FSMO). Эти роли можно определить следующим образом:

|**Роли**|**Описание**|
|---|---|
|`Schema Master`|Эта роль управляет копией схемы AD для чтения и записи, которая определяет все атрибуты, применимые к объекту в AD.|
|`Domain Naming Master`|Управляет доменными именами и следит за тем, чтобы в одном лесу не создавались два домена с одинаковым именем.|
|`Relative ID (RID) Master`|Мастер RID назначает другим контроллерам домена блоки RID, которые можно использовать для новых объектов. Мастер RID помогает избежать присвоения одному объекту нескольких одинаковых идентификаторов безопасности. Идентификаторы безопасности объектов домена представляют собой комбинацию идентификатора безопасности домена и номера RID, присвоенного объекту, что позволяет создать уникальный идентификатор безопасности.|
|`PDC Emulator`|Хост с этой ролью будет выступать в качестве полномочного контроллера домена и отвечать на запросы аутентификации, изменения пароля, а также управлять объектами групповой политики (ОГП). Эмулятор PDC также поддерживает синхронизацию времени в домене.|
|`Infrastructure Master`|Эта роль преобразует идентификаторы GUID, SID и DNs между доменами. Эта роль используется в организациях с несколькими доменами в одном лесу. Мастер инфраструктуры помогает им взаимодействовать. Если эта роль не функционирует должным образом, Списки контроля доступа (ACL) будут отображать SID вместо полностью разрешенных имен.|

В зависимости от организации эти роли могут быть назначены конкретным контроллерам домена или использоваться по умолчанию при добавлении нового контроллера домена. Проблемы с ролями FSMO могут привести к трудностям с аутентификацией и авторизацией в домене.

---

## Функциональные уровни домена и Леса

Корпорация Майкрософт ввела функциональные уровни для определения различных функций и возможностей, доступных в доменных службах Active Directory (AD DS) на уровне домена и леса. Они также используются для указания того, в каких операционных системах Windows Server может работать контроллер домена в домене или лесу. [В этой](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc754918\(v=ws.10\)?redirectedfrom=MSDN) и [этой](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels) статье описываются функциональные уровни домена и леса в операционных системах Windows 2000 и Windows Server 2012 R2. Ниже представлен краткий обзор различий в `domain functional levels` между Windows 2000 и Windows Server 2016, не считая всех функций служб каталогов Active Directory по умолчанию, которые находятся уровнем ниже (или просто функций AD DS по умолчанию в случае с Windows 2000).

|Функциональный Уровень Предметной области|Доступные функции|Поддерживаемые Операционные системы Контроллера домена|
|---|---|---|
|Встроенная система Windows 2000|Универсальные группы для распределения и защиты, вложенность групп, преобразование групп (между группами защиты и распределения), история SID.|Windows Server 2008 R2, Windows Server 2008, Windows Server 2003, Windows 2000|
|Windows Server 2003|Инструмент управления доменами Netdom.exe, атрибут lastLogonTimestamp, контейнеры известных пользователей и компьютеров, ограниченное делегирование, выборочная аутентификация.|Windows Server 2012 R2, Windows Server 2012, Windows Server 2008 R2, Windows Server 2008, Windows Server 2003|
|Windows Server 2008|Поддержка репликации распределённой файловой системы (DFS), поддержка расширенного стандарта шифрования (AES 128 и AES 256) для протокола Kerberos, детальная настройка политик паролей|Windows Server 2012 R2, Windows Server 2012, Windows Server 2008 R2, Windows Server 2008|
|Windows Server 2008 R2|Обеспечение механизма аутентификации, управляемые служебные учётные записи|Windows Server 2012 R2, Windows Server 2012, Windows Server 2008 R2|
|Windows Server 2012|Поддержка KDC для утверждений, составной аутентификации и защиты Kerberos|Windows Server 2012 R2, Windows Server 2012|
|Windows Server 2012 R2|Дополнительные средства защиты для участников группы «Защищённые пользователи», политики аутентификации, изолированные политики аутентификации|Windows Server 2012 R2|
|Windows Server 2016|[Для интерактивного входа в систему требуется смарт-карта](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/interactive-logon-require-smart-card) новые функции [Kerberos](https://docs.microsoft.com/en-us/windows-server/security/kerberos/whats-new-in-kerberos-authentication) и новые функции [защиты учётных данных](https://docs.microsoft.com/en-us/windows-server/security/credentials-protection-and-management/whats-new-in-credential-protection)|Windows Server 2019 и Windows Server 2016|

С выходом Windows Server 2019 не был добавлен новый функциональный уровень. Однако для добавления контроллеров домена Server 2019 в среду требуется функциональный уровень Windows Server 2008. Кроме того, целевой домен должен использовать [DFS-R](https://docs.microsoft.com/en-us/windows-server/storage/dfs-replication/dfsr-overview) для репликации SYSVOL.

За прошедшие годы функциональные уровни леса приобрели несколько ключевых особенностей:

|**Версия**|**Возможности**|
|---|---|
|`Windows Server 2003`|Мы увидели внедрение лесного траста, переименование доменов, контроллеры домена только для чтения (RODC) и многое другое.|
|`Windows Server 2008`|Все новые домены, добавляемые в лес, по умолчанию имеют функциональный уровень домена Server 2008. Никаких дополнительных функций.|
|`Windows Server 2008 R2`|Корзина Active Directory позволяет восстанавливать удалённые объекты во время работы служб каталогов Active Directory.|
|`Windows Server 2012`|Все новые домены, добавляемые в лес, по умолчанию имеют функциональный уровень домена Server 2012. Никаких дополнительных функций.|
|`Windows Server 2012 R2`|Все новые домены, добавляемые в лес, по умолчанию имеют функциональный уровень домена Server 2012 R2. Никаких дополнительных функций.|
|`Windows Server 2016`|[Управление привилегированным доступом (PAM) с помощью Microsoft Identity Manager (MIM).](https://docs.microsoft.com/en-us/windows-server/identity/whats-new-active-directory-domain-services#privileged-access-management)|

---

## Доверие

Доверие используется для установления `forest-forest` или `domain-domain` аутентификации, что позволяет пользователям получать доступ к ресурсам (или управлять ими) в другом домене, отличном от домена, в котором находится их учётная запись. Доверие создаёт связь между системами аутентификации двух доменов.

Существует несколько типов доверия.

|**Тип Доверия**|**Описание**|
|---|---|
|`Parent-child`|Домены в одном лесу. Дочерний домен имеет двустороннее транзитивное доверие с родительским доменом.|
|`Cross-link`|Доверие между дочерними доменами для ускорения аутентификации.|
|`External`|Нетранзитивный траст между двумя отдельными доменами в разных лесах, которые ещё не объединены лесным трастом. В этом типе траста используется фильтрация SID.|
|`Tree-root`|двустороннее транзитивное доверие между корневым доменом леса и новым корневым доменом дерева. Они создаются по умолчанию при настройке нового корневого домена дерева в лесу.|
|`Forest`|транзитивный траст между двумя корневыми доменами.|

#### Пример доверия

![[Pasted image 20250907181334.png]]

Трасты могут быть транзитивными и нетранзитивными.

- Транзитивное доверие означает, что доверие распространяется на объекты, которым доверяет дочерний домен.
    
- В нетранзитивном трасте доверительному отношению подлежит только дочерний домен.
    

Трасты могут быть односторонними или двусторонними (двунаправленными).

- При двунаправленном доверии пользователи из обоих доверенных доменов могут получать доступ к ресурсам.
- При одностороннем доверии только пользователи из доверенного домена могут получать доступ к ресурсам в доверяющем домене, но не наоборот. Направление доверия противоположно направлению доступа.

Часто доменные трасты настраиваются неправильно и создают непреднамеренные пути для атак. Кроме того, трасты, настроенные для удобства использования, могут не проверяться на предмет потенциальных угроз безопасности. Слияния и поглощения могут привести к созданию двунаправленных трастов с приобретенными компаниями, что неосознанно повышает риски для приобретающей компании. Нередко можно провести такую атаку, как Kerberoasting, на домен, не входящий в основной домен, и получить доступ к пользователю с административными правами в основном домене.