#network #htb #traffic #TCP 

`Network Traffic Analysis (NTA)` можно описать как процесс анализа сетевого трафика с целью определения наиболее часто используемых портов и протоколов, установления базовых показателей для нашей среды, мониторинга и реагирования на угрозы, а также получения максимально полной информации о сети нашей организации.

Этот процесс помогает специалистам по безопасности выявлять аномалии, в том числе угрозы безопасности в сети, на ранних этапах и эффективно локализовывать угрозы. Анализ сетевого трафика также может способствовать соблюдению правил безопасности. Злоумышленники часто меняют тактику, чтобы избежать обнаружения, и используют легитимные учётные данные с помощью инструментов, разрешённых в большинстве компаний, что затрудняет обнаружение и последующее реагирование для защитников. В таких случаях анализ сетевого трафика снова может оказаться полезным. Вот несколько примеров повседневного использования NTA:

| |
|---|
|`Collecting` отслеживание трафика в сети в режиме реального времени для анализа потенциальных угроз.|
|`Setting` базовый уровень для повседневных сетевых коммуникаций.|
|`Identifying` и анализ трафика с нестандартных портов, подозрительных хостов, а также выявление проблем с сетевыми протоколами, таких как ошибки HTTP, проблемы с TCP или другие сетевые ошибки конфигурации.|
|`Detecting` вредоносные программы, такие как программы-вымогатели, эксплойты и программы для нестандартного взаимодействия.|
|NTA также полезен при расследовании инцидентов, произошедших в прошлом, и при поиске угроз.|

Попробуйте представить, как злоумышленник нацеливается на нашу сеть и проникает в неё. Если они хотят взломать сеть, им неизбежно придётся взаимодействовать с нашей инфраструктурой и обмениваться с ней данными. Обмен данными в сети происходит через множество различных портов и протоколов, которые одновременно используются сотрудниками, оборудованием и клиентами. Чтобы обнаружить вредоносный трафик, нам нужно знать, как обычно происходит обмен данными в нашей сети. Это сузит круг поиска и поможет нам быстро обнаружить и прервать нежелательное взаимодействие.

Например, если мы обнаружим множество `SYN` пакетов на портах, которые мы никогда (или редко) используем в нашей сети, мы можем сделать вывод, что, скорее всего, кто-то пытается определить, какие порты открыты на наших хостах. Подобные действия являются типичными признаками `portscan`. Для проведения такого анализа и получения таких выводов требуются определённые навыки и знания.

---

## Необходимые навыки и знания

Навыки, которые мы собираемся перечислить и описать, требуют теоретических и практических знаний, приобретаемых с течением времени. Нам не нужно знать всё наизусть, но мы должны понимать, на что обращать внимание, когда некоторые аспекты материала кажутся нам незнакомыми. Это относится не только к NTA, но и к большинству других тем, которые мы будем рассматривать в рамках кибербезопасности.

#### Стек TCP/IP и модель OSI

Такое понимание поможет нам разобраться в том, как взаимодействуют сетевой трафик и приложения на хосте.

#### Основные сетевые Концепции

Чтобы понять, какие типы трафика мы будем видеть на каждом уровне, нужно разобраться в отдельных уровнях, составляющих модели TCP/IP и OSI, а также в концепциях коммутации и маршрутизации. Если мы подключимся к сети через магистральное соединение, то увидим гораздо больше трафика, чем обычно, и он будет сильно отличаться от того, что мы видим при подключении к офисному коммутатору.

#### Общие порты и протоколы

Быстрое определение стандартных портов и протоколов, а также понимание принципов их взаимодействия позволят нам выявлять потенциально вредоносный или некорректный сетевой трафик.

#### Концепция IP-пакетов и подуровней

Базовые знания о том, как взаимодействуют TCP и UDP, как минимум, помогут нам понять, что мы видим или ищем. TCP, например, ориентирован на потоковую передачу данных и позволяет нам легко отслеживать обмен данными между хостами. UDP работает быстро, но не заботится о полноте данных, поэтому воссоздать что-то на основе этого типа пакетов будет сложнее.

#### Инкапсуляция транспортного протокола

Каждый слой будет инкапсулировать предыдущий. Возможность считывать или анализировать изменения в инкапсуляции поможет нам быстрее работать с данными. По заголовкам инкапсуляции легко определить подсказки.

---

## Окружающая среда и оборудование

В приведённом ниже списке представлено множество различных инструментов и типов оборудования, которые можно использовать для анализа сетевого трафика. Каждый из них позволяет по-своему перехватывать или анализировать трафик. Некоторые из них позволяют копировать и перехватывать трафик, а другие — считывать и обрабатывать его. В этом модуле мы рассмотрим лишь некоторые из них ([Wireshark](https://www.wireshark.org/) и [tcpdump](https://www.tcpdump.org/) в основном). Имейте в виду, что эти инструменты предназначены не только для администраторов. Многие из них можно использовать и в злонамеренных целях.

#### Распространенные Инструменты Анализа Трафика

|**Инструмент**|**Описание**|
|---|---|
|`tcpdump`|[tcpdump](https://www.tcpdump.org/) — это утилита командной строки, которая с помощью LibPcap перехватывает и интерпретирует сетевой трафик с сетевого интерфейса или из файла захвата.|
|`Tshark`|[TShark](https://www.wireshark.org/docs/man-pages/tshark.html) — это анализатор сетевых пакетов, во многом похожий на TCPDump. Он может перехватывать пакеты в работающей сети или считывать и декодировать пакеты из файла. Это вариант Wireshark для командной строки.|
|`Wireshark`|[Wireshark](https://www.wireshark.org/) — это графический анализатор сетевого трафика. Он перехватывает и декодирует пакеты, передаваемые по сети, и позволяет детально изучить среду. Он может запускать различные анализаторы трафика для определения протоколов и приложений и предоставления информации о происходящем.|
|`NGrep`|[NGrep](https://github.com/jpr5/ngrep) — это инструмент для сопоставления с образцом, выполняющий те же функции, что и grep в дистрибутивах Linux. Главное отличие заключается в том, что он работает с пакетами сетевого трафика. NGrep умеет считывать трафик в реальном времени или из файла PCAP и использовать регулярные выражения и синтаксис BPF. Этот инструмент лучше всего подходит для отладки трафика таких протоколов, как HTTP и FTP.|
|`tcpick`|[tcpick](http://tcpick.sourceforge.net/index.php?p=home.inc) — это анализатор пакетов командной строки, который специализируется на отслеживании и повторной сборке TCP-потоков. Функция чтения потока и его повторной сборки в файл с помощью tcpick превосходна.|
|`Network Taps`|Taps ([Gigamon](https://www.gigamon.com/), [Niagra-taps](https://www.niagaranetworks.com/products/network-tap)) — это устройства, способные копировать сетевой трафик и отправлять его в другое место для анализа. Они могут быть встроенными или внешними. Они могут активно перехватывать и анализировать трафик напрямую или пассивно, отправляя исходный пакет обратно по проводу, как будто ничего не изменилось.|
|`Networking Span Ports`|[Промежуточные порты](https://en.wikipedia.org/wiki/Port_mirroring) — это способ копирования кадров с сетевых устройств второго или третьего уровня во время исходящей или входящей обработки и отправки их в точку сбора. Часто порт зеркалируется для отправки копий на сервер журналов.|
|`Elastic Stack`|[Elastic Stack](https://www.elastic.co/elastic-stack) — это совокупность инструментов, которые могут собирать данные из множества источников, обрабатывать их и визуализировать, чтобы обеспечить возможность поиска и анализа.|
|`SIEMS`|`SIEMS` (например, [Splunk](https://www.splunk.com/en_us)) — это центральная точка, в которой анализируются и визуализируются данные. Оповещения, криминалистический анализ и ежедневные проверки трафика — все это примеры использования SIEM.|
|и другие.||

---

## Синтаксис BPF

Многие из упомянутых выше инструментов имеют свой синтаксис и команды, но общим для них является [синтаксис Berkeley Packet Filter (BPF)](https://en.wikipedia.org/wiki/Berkeley_Packet_Filter) . Этот синтаксис мы будем использовать в первую очередь. По сути, BPF — это технология, которая позволяет необработанному интерфейсу читать и записывать данные на уровне передачи данных. Учитывая всё это, мы обращаем внимание на BPF из-за его возможностей фильтрации и декодирования. Мы будем использовать синтаксис BPF через модуль, поэтому базовое понимание того, как настраивается фильтр BPF, может оказаться полезным. Для получения дополнительной информации о синтаксисе BPF обратитесь к этому [справочному материалу](https://www.ibm.com/docs/en/qsip/7.4?topic=queries-berkeley-packet-filters).

---

## Выполнение анализа сетевого трафика

Выполнение анализа может быть таким же простым, как просмотр трафика в режиме реального времени в нашей консоли, или таким же сложным, как сбор данных одним касанием, отправка их обратно в SIEM для обработки и анализ данных pcap на предмет сигнатур и оповещений, связанных с распространенными тактиками и техниками.

Как минимум, для пассивного прослушивания нам необходимо подключиться к сегменту сети, в котором мы хотим прослушивать. Это особенно актуально в коммутируемой среде, где VLAN и порты коммутатора не будут перенаправлять трафик за пределы своего широковещательного домена. Имея это в виду, если мы хотим перехватывать трафик из определенной VLAN, наше устройство захвата должно быть подключено к этой же сети. Такие устройства, как сетевые ответвители, коммутаторы или маршрутизаторы с конфигурациями типа span-портов и зеркалирования портов, позволяют получить копию всего трафика, проходящего через определённое соединение, независимо от того, к какому сегменту сети или месту назначения он относится.

#### Рабочий процесс NTA

Анализ трафика — это не точная наука. Анализ сетевого трафика может быть очень динамичным процессом и не представлять собой замкнутый цикл. На него сильно влияет то, что мы ищем (ошибки в работе сети или злонамеренные действия), а также то, насколько хорошо мы видим свою сеть. Анализ трафика можно свести к нескольким основным принципам.

#### Рабочий процесс NTA

![Схема цикла, состоящая из четырёх этапов: 1. Сбор данных, 2. Снижение уровня шума с помощью фильтрации, 3. Анализ и исследование, 4. Обнаружение и оповещение.](https://academy.hackthebox.com/storage/modules/81/workflow.png)

#### 1. Входящий трафик

Определившись с местом размещения, приступайте к сбору данных о трафике. Используйте фильтры сбора данных, если у вас уже есть представление о том, что вы ищете.

#### 2. Уменьшите шум с помощью фильтрации

Сбор данных о трафике по ссылке, особенно в производственной среде, может быть сопряжен с большими трудностями. После того как мы выполним первоначальный сбор данных, можно попытаться отфильтровать ненужный трафик, чтобы упростить анализ. (Например, широковещательный и многоадресный трафик.)

#### 3. Анализ и исследование

Сейчас самое время начать собирать данные, имеющие отношение к проблеме, которую мы пытаемся решить. Обратите внимание на конкретные хосты, протоколы и даже на такие детали, как флаги в заголовке TCP. Вам помогут следующие вопросы:

1. Трафик зашифрован или передаётся в открытом виде? Так и должно быть?
    
2. Можем ли мы отслеживать попытки пользователей получить доступ к ресурсам, к которым у них не должно быть доступа?
    
3. Общаются ли между собой разные хосты, которые обычно этого не делают?
    

#### 4. Обнаружение и оповещение

1. Наблюдаем ли мы какие-либо ошибки? Не отвечает ли какое-то устройство, которое должно отвечать?
    
2. Используйте наш анализ, чтобы определить, является ли то, что мы видим, безопасным или потенциально опасным.
    
3. На этом этапе могут пригодиться другие инструменты, такие как IDS и IP-адреса. Они могут запускать эвристику и подписи для проверки трафика, чтобы определить, является ли что-либо внутри потенциально вредоносным.
    

#### 5. Исправление и контроль

Исправление и мониторинг не являются частью цикла, но должны быть включены в любой рабочий процесс, который мы выполняем. Если мы вносим изменения или устраняем проблему, мы должны продолжать отслеживать исходный код, чтобы определить, решена ли проблема.