#htb #linux 

Основная цель брандмауэров — обеспечить механизм безопасности для контроля и мониторинга сетевого трафика между различными сегментами сети, такими как внутренние и внешние сети или разные сетевые зоны. Брандмауэры играют важнейшую роль в защите компьютерных сетей от несанкционированного доступа, вредоносного трафика и других угроз безопасности. Linux, популярная операционная система, используемая на серверах и других сетевых устройствах, предоставляет встроенные брандмауэры, которые можно использовать для контроля сетевого трафика. Другими словами, они могут фильтровать входящий и исходящий трафик на основе заранее заданных правил, протоколов, портов и других критериев, чтобы предотвратить несанкционированный доступ и снизить риски для безопасности. Конкретная цель внедрения брандмауэра может варьироваться в зависимости от потребностей организации, например для обеспечения конфиденциальности, целостности и доступности сетевых ресурсов.

Примером из истории брандмауэров Linux является разработка инструмента iptables, который заменил более ранние инструменты ipchains и ipfwadm. Утилита iptables была впервые представлена в ядре Linux 2.4 в 2000 году и обеспечивала гибкий и эффективный механизм фильтрации сетевого трафика. iptables стал стандартным решением для брандмауэров в системах Linux и получил широкое распространение среди многих организаций и пользователей.

Утилита iptables предоставляла простой, но мощный интерфейс командной строки для настройки правил брандмауэра, с помощью которого можно было фильтровать трафик по различным критериям, таким как IP-адреса, порты, протоколы и т. д. Утилита iptables была разработана с возможностью гибкой настройки и могла использоваться для создания сложных наборов правил брандмауэра, которые защищали от различных угроз безопасности, таких как атаки типа «отказ в обслуживании» (DoS), сканирование портов и попытки проникновения в сеть.

В Linux функции брандмауэра обычно реализуются с помощью фреймворка Netfilter, который является неотъемлемой частью ядра. Netfilter предоставляет набор функций, которые можно использовать для перехвата и изменения сетевого трафика по мере его прохождения через систему. Утилита iptables обычно используется для настройки правил брандмауэра в системах Linux.

---

## Iptables

Утилита iptables предоставляет гибкий набор правил для фильтрации сетевого трафика на основе различных критериев, таких как IP-адреса источника и назначения, номера портов, протоколы и многое другое. Существуют и другие решения, такие как nftables, ufw и firewalld. `Nftables` Они обеспечивают более современный синтаксис и улучшенную производительность по сравнению с iptables. Однако синтаксис правил nftables не совместим с iptables, поэтому переход на nftables требует некоторых усилий. `UFW` означает «простой брандмауэр» и предоставляет простой и удобный интерфейс для настройки правил брандмауэра. UFW построен на основе фреймворка iptables, как и nftables, и обеспечивает более простой способ управления правилами брандмауэра. Наконец, FirewallD — это динамичное и гибкое решение для брандмауэра, которое можно использовать для управления сложными конфигурациями брандмауэра. Оно поддерживает широкий набор правил для фильтрации сетевого трафика и может использоваться для создания пользовательских зон и сервисов брандмауэра. Оно состоит из нескольких компонентов, которые работают вместе, обеспечивая гибкое и мощное решение для брандмауэра. Основными компонентами iptables являются:

|**Компонент**|**Описание**|
|---|---|
|`Tables`|Таблицы используются для организации и категоризации правил брандмауэра.|
|`Chains`|Цепочки используются для группировки набора правил брандмауэра, применяемых к определённому типу сетевого трафика.|
|`Rules`|Правила определяют критерии фильтрации сетевого трафика и действия, которые необходимо выполнять с пакетами, соответствующими этим критериям.|
|`Matches`|Сопоставления используются для соответствия конкретным критериям фильтрации сетевого трафика, таким как IP-адреса источника или назначения, порты, протоколы и многое другое.|
|`Targets`|Цели определяют действие для пакетов, соответствующих определённому правилу. Например, цели могут использоваться для принятия, отбрасывания или отклонения пакетов или для их изменения другим способом.|

#### Таблицы

При работе с брандмауэрами в системах Linux важно понимать, как работают таблицы в iptables. Таблицы в iptables используются для категоризации и организации правил брандмауэра в зависимости от типа трафика, с которым они предназначены для работы. Эти таблицы используются для организации и категоризации правил брандмауэра. Каждая таблица отвечает за выполнение определённого набора задач.

| **Имя таблицы** | **Описание**                                                                            | **Встроенные цепи**                             |
| --------------- | --------------------------------------------------------------------------------------- | ----------------------------------------------- |
| `filter`        | Используется для фильтрации сетевого трафика на основе IP-адресов, портов и протоколов. | INPUT, OUTPUT, FORWARD                          |
| `nat`           | Используется для изменения IP-адресов источника или назначения сетевых пакетов.         | PREROUTING, POSTROUTING                         |
| `mangle`        | Используется для изменения полей заголовков сетевых пакетов.                            | PREROUTING, OUTPUT, INPUT, FORWARD, POSTROUTING |

Помимо встроенных таблиц, iptables предоставляет четвёртую таблицу под названием «raw table», которая используется для настройки специальных параметров обработки пакетов. «raw table» содержит две встроенные цепочки: PREROUTING и OUTPUT.

#### Цепи

В iptables цепочки организуют правила, определяющие, как следует фильтровать или изменять сетевой трафик. В iptables есть два типа цепочек:

- Встроенные цепи
- Определяемые пользователем цепочки

Встроенные цепочки заранее определены и автоматически создаются при создании таблицы. У каждой таблицы свой набор встроенных цепочек. Например, у таблицы фильтров есть три встроенные цепочки:

- INPUT
- OUTPUT
- FORWARD

Эти цепочки используются для фильтрации входящего и исходящего сетевого трафика, а также трафика, который пересылается между различными сетевыми интерфейсами. В таблице NAT есть две встроенные цепочки:

- PREROUTING
- POSTROUTING

Цепочка PREROUTING используется для изменения IP-адреса назначения входящих пакетов до их обработки таблицей маршрутизации. Цепочка POSTROUTING используется для изменения IP-адреса источника исходящих пакетов после их обработки таблицей маршрутизации. В таблице mangle есть пять встроенных цепочек:

- PREROUTING
- OUTPUT
- INPUT
- FORWARD
- POSTROUTING

Эти цепочки используются для изменения полей заголовков входящих и исходящих пакетов, а также пакетов, обрабатываемых соответствующими цепочками.

`User-defined chains` можно упростить управление правилами, сгруппировав правила брандмауэра по определённым критериям, таким как IP-адрес источника, порт назначения или протокол. Их можно добавить в любую из трёх основных таблиц. Например, если в организации есть несколько веб-серверов, для которых требуются одинаковые правила брандмауэра, правила для каждого сервера можно сгруппировать в пользовательскую цепочку. Другой пример: пользовательская цепочка может фильтровать трафик, предназначенный для определённого порта, например порта 80 (HTTP). Затем пользователь может добавить в эту цепочку правила, которые будут фильтровать трафик, предназначенный для порта 80.

#### Правила и цели

Правила iptables используются для определения критериев фильтрации сетевого трафика и действий, которые необходимо выполнить для пакетов, соответствующих этим критериям. Правила добавляются в цепочки с помощью опции `-A` с последующим указанием имени цепочки, и их можно изменять или удалять с помощью других опций.

Каждое правило состоит из набора критериев или совпадений и цели, определяющей действие для пакетов, соответствующих критериям. Критерии или совпадения соответствуют определённым полям в заголовке IP-пакета, таким как IP-адрес источника или получателя, протокол, номер порта источника, номер порта получателя и т. д. Цель определяет действие для пакетов, соответствующих критериям. Они определяют действие, которое необходимо выполнить для пакетов, соответствующих определённому правилу. Например, цели могут принимать, отбрасывать, отклонять или изменять пакеты. Некоторые из распространённых целей, используемых в правилах iptables, включают следующее:

|**Имя цели**|**Описание**|
|---|---|
|`ACCEPT`|Позволяет пакету пройти через брандмауэр и продолжить путь к месту назначения|
|`DROP`|Отбрасывает пакет, эффективно блокируя его прохождение через брандмауэр|
|`REJECT`|Отбрасывает пакет и отправляет сообщение об ошибке на исходный адрес, уведомляя его о том, что пакет был заблокирован|
|`LOG`|Записывает информацию о пакете в системный журнал|
|`SNAT`|Изменяет исходный IP-адрес пакета, обычно используется для трансляции сетевых адресов (NAT) для преобразования частных IP-адресов в общедоступные|
|`DNAT`|Изменяет IP-адрес назначения пакета, обычно используется для NAT для перенаправления трафика с одного IP-адреса на другой|
|`MASQUERADE`|Похож на SNAT, но используется, когда исходный IP-адрес не фиксирован, например, при динамическом IP-адресе|
|`REDIRECT`|Перенаправляет пакеты на другой порт или IP-адрес|
|`MARK`|Добавляет или изменяет значение метки Netfilter в пакете, которое можно использовать для расширенной маршрутизации или других целей|

Давайте рассмотрим правило и предположим, что мы хотим добавить новую запись в цепочку INPUT, которая позволит принимать входящий TCP-трафик на порту 22 (SSH). Команда для этого будет выглядеть следующим образом:

  Настройка брандмауэра

```shell-session
Barlogsha@htb[/htb]$ sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT
```

#### Соответствия

`Matches` используются для указания критериев, определяющих, следует ли применять правило брандмауэра к конкретному пакету или соединению. Сопоставления используются для сопоставления конкретных характеристик сетевого трафика, таких как IP-адрес источника или назначения, протокол, номер порта и т. д.

| **Совпадающее имя**      | **Описание**                                                                       |
| ------------------------ | ---------------------------------------------------------------------------------- |
| `-p` или `--protocol`    | Указывает протокол для сопоставления (например, tcp, udp, icmp)                    |
| `--dport`                | Указывает порт назначения, который должен соответствовать                          |
| `--sport`                | Указывает порт источника, который должен соответствовать                           |
| `-s` или `--source`      | Указывает IP-адрес источника, который должен соответствовать                       |
| `-d` или `--destination` | Указывает IP-адрес назначения, который должен соответствовать                      |
| `-m state`               | Соответствует состоянию подключения (например, NEW, ESTABLISHED, RELATED)          |
| `-m multiport`           | Соответствует нескольким портам или диапазонам портов                              |
| `-m tcp`                 | Соответствует пакетам TCP и включает дополнительные параметры, специфичные для TCP |
| `-m udp`                 | Соответствует пакетам UDP и включает дополнительные параметры, специфичные для UDP |
| `-m string`              | Соответствует пакетам, содержащим определенную строку                              |
| `-m limit`               | Сопоставляет пакеты с заданным пределом скорости                                   |
| `-m conntrack`           | Сопоставляет пакеты на основе информации об отслеживании их соединений             |
| `-m mark`                | Сопоставляет пакеты на основе их значения метки Netfilter                          |
| `-m mac`                 | Сопоставляет пакеты на основе их MAC-адреса                                        |
| `-m iprange`             | Сопоставляет пакеты на основе диапазона IP-адресов                                 |

Как правило, в iptables совпадения указываются с помощью опции -m. Например, следующая команда добавляет правило в цепочку INPUT в таблице filter, которое соответствует входящему TCP-трафику на порту 80:

  Настройка брандмауэра

```shell-session
Barlogsha@htb[/htb]$ sudo iptables -A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
```

Это правило-пример сопоставляет входящий TCP-трафик (`-p tcp`) на порту 80 (`--dport 80`) и переходит к цели приёма (`-j ACCEPT`) в случае успешного сопоставления.

| | |
|---|---|
|1.|Запустите веб-сервер на целевом компьютере на порту TCP/8080 и используйте iptables для блокировки входящего трафика на этом порту.|
|2.|Измените правила iptables, чтобы разрешить входящий трафик на порту TCP/8080.|
|3.|Блокируйте трафик с определенного IP-адреса.|
|4.|Разрешить трафик с определенного IP-адреса.|
|5.|Блокируйте трафик на основе протокола.|
|6.|Разрешать трафик на основе протокола.|
|7.|Создайте новую цепочку.|
|8.|Перенаправлять трафик в определенную цепочку.|
|9.|Удалите конкретное правило.|
|10.|Перечислите все существующие правила.|
[Perplexity](obsidian://open?vault=Obsidian%20Vault&file=Base%2FHTB%2F%D0%9F%D1%80%D0%B0%D0%BA%D1%82%D0%B8%D0%BA%D0%B0%20%D0%BF%D0%BE%20iptables)