#tcpdump #htb #network #traffic 

Цель этой лабораторной работы — познакомить вас с анализом сетевого трафика и дать вам возможность попрактиковаться в реализации фильтров пакетов. Мы будем использовать такие фильтры, как `host`, `port`, `protocol`, и другие, чтобы изменить наш взгляд на изучение файла .PCAP.

Теперь, когда мы доказали, что можем перехватывать сетевой трафик для корпорации, руководство поручило нам провести быстрый анализ трафика, который наша команда перехватила во время проверки сети. Цель состоит в том, чтобы определить, какие серверы отвечают на запросы DNS и HTTP/S в нашей локальной сети.

Если вы хотите подойти к этой лабораторной работе более творчески, я опубликовал список общих задач. Более подробное описание того, как выполнить каждый шаг, приведено под каждой задачей в разделе «Решение».

---

## Задачи

Используя `TCPDump-lab-2.zip` в дополнительных ресурсах, выполните лабораторную работу в меру своих возможностей. Необязательно найти всё с первого раза. Наша главная задача — понять концепции. По мере того как мы будем повторять эти действия, нам будет всё проще.

#### Задача №1

`Read a capture from a file without filters implemented.`

Для начала давайте изучим этот pcap без применения фильтров.

##### **Нажмите, чтобы показать ответ**

```shell-session
Barlogsha@htb[/htb]$ tcpdump -r (file.pcap)
```

---

#### Задача №2

`Identify the type of traffic seen.`

Обратите внимание на типы трафика. (Используемые порты, протоколы, любая другая информация, которую вы считаете важной.) Какие фильтры можно использовать, чтобы упростить эту задачу?

Какой тип трафика мы наблюдаем?

Общие протоколы:

Используемые Порты:

##### **Нажмите, чтобы показать ответы**

Какой тип трафика мы наблюдаем?

Общие протоколы: мы должны отслеживать множество `DNS, HTTP, and HTTPS`-трафиков.

Используемые Порты: `53 80 443`

---

#### Задача №3

`Identify conversations.`

Мы рассмотрели основные аспекты этого трафика. Теперь определите, замечаете ли вы какие-либо закономерности в трафике.  
Замечаете ли вы какие-либо общие связи между сервером и хостом? Если да, то какие?

Какие номера портов клиента и сервера используются при первом полном трёхстороннем рукопожатии TCP?

Кто является серверами в этих разговорах? Откуда нам это известно?

Кто является принимающей стороной?

##### **Нажмите, чтобы показать ответ**

Чтобы упростить задачу, при определении диалогов будет очень полезно использовать абсолютные порядковые номера `(-S)`

Мы также можем изучить различные задействованные хосты. Серверы обычно взаимодействуют через известный номер порта, назначенный протоколу `(80 for HTTP, 443 for HTTPS, for example)`. Хосты или получатели в процессе взаимодействия обычно используют случайный высокий номер порта.

---

#### Задача №4

`Interpret the capture in depth.`

Теперь, когда мы немного разобрались с файлом pcap, давайте проведём анализ. Используйте любой синтаксис, необходимый для ответа на следующие вопросы.

Какова временная метка первого установленного соединения в файле pcap?

Какой IP-адрес /-ы у apache.org из ответов DNS-сервера?

Какой протокол используется в этом первом разговоре? (название/#)

##### **Нажмите, чтобы показать ответ**

Чтобы определить правильную временную метку: прочитайте файл с помощью (-r), а затем изучите сеансы связи. Найдите первый установленный сеанс (полное TCP-рукопожатие «Syn / SYN-ACK / ACK») и посмотрите на первое поле в выводе, чтобы найти временную метку. Чтобы найти IP-адрес хоста ( ), мы можем отфильтровать трафик, чтобы увидеть сеансы связи, исходящие от него ( src «имя-хоста» ), а затем отключить разрешение имён с помощью (-n). Чтобы определить протокол, используемый в первом сеансе связи, найдите известный порт #, отключив разрешение имён хостов и портов (-nn), или не используйте (-nn), и в выводе вы увидите название протокола.

---

#### Задание №5

`Filter out traffic.`

Пришло время очистить некоторые из этих данных. Перезагрузите файл pcap и отфильтруйте весь трафик, кроме DNS. Что вы видите?

Какой DNS-сервер используется для этого сегмента?

Какие доменные имена были запрошены в файле pcap?

Какие типы DNS-записей можно увидеть?

##### **Нажмите, чтобы показать ответ**

Чтобы удалить всё, что не является DNS, мы можем использовать:

```shell-session
Barlogsha@htb[/htb]$ sudo tcpdump -r (file.pcap) udp and port 53    
```

Помните, что DNS — это протокол, который использует как UDP, так и TCP для выполнения различных функций. Это значит, что нам, возможно, придётся фильтровать оба протокола, чтобы ничего не упустить.

Если используется параметр -X, мы можем получить шестнадцатеричный и ASCII-вывод для просмотра имён в открытом виде.

Понимание запросов и ответов протокола DNS поможет определить, какой тип записей запрашивается. В поле с информацией о протоколе часто содержится ответ.

Теперь, когда мы видим только DNS-трафик и лучше понимаем, как выглядит пакет, попробуйте ответить на следующие вопросы о разрешении имён на предприятии: Кто запрашивает A-запись для apache.org? (имя хоста или IP-адрес)

Какую информацию содержит запись A?

Какой DNS-сервер отвечает в pcap? (имя хоста или IP-адрес)

---

#### Задание №6

`Filter for TCP traffic.`

Теперь, когда у нас есть чёткое представление о нашем DNS-сервере, давайте поищем веб-серверы. Отфильтруйте данные, чтобы видеть только трафик, относящийся к HTTP или HTTPS. Какие веб-страницы запрашивались?

Какие методы HTTP-запросов чаще всего встречаются в этом PCAP?

Какой HTTP-ответ чаще всего встречается в этом PCAP?

##### **Нажмите, чтобы показать ответ**

Фильтрация по порту 80 или 443 — отличное начало. Вы также можете фильтровать по названию протокола HTTP или HTTPS. Помните, что порты — это скорее рекомендации. Я могу разместить веб-сервер на любом открытом порту, который можно привязать. (Например, 8080 или 8001)

#### Задание №7

`What can you determine about the server in the first conversation.`

Давайте рассмотрим подробнее. Что можно сказать о веб-сервере из первого разговора? Есть ли что-то примечательное? Для большей наглядности убедитесь, что в нашем представлении отображаются шестнадцатеричный и ASCII-вывод для pcap.

Можем ли мы определить, какое приложение запускает веб-сервер?

##### **Нажмите, чтобы показать ответ**

Часто веб-сервер включает в ответы на запросы соответствующую информацию, например название операционной системы или веб-сервера. По этим ответам вы также можете определить, какая служба управляет веб-сервером. Эту задачу немного сложнее выполнить с помощью tcpdump. Для этого нужно просмотреть ASCII-коды HTTP-ответов. В следующих разделах, когда мы перейдём к Wireshark, это будет намного проще.

---

## Краткие сведения

В ходе этой лабораторной работы мы расширили свои знания, используя TCPDump для анализа трафика PCAP. Мы научились эффективно захватывать и отображать фильтры, анализировать трафик, чтобы определить, какие протоколы используются в среде, и даже получили важную информацию о сегментах нашей корпоративной сети, DNS и веб-серверах. Продолжайте экспериментировать и узнайте, насколько глубока кроличья нора. Сможете ли вы перехватить трафик в своей домашней сети и ответить на те же вопросы?

---

## Советы по анализу

Ниже приведён список вопросов, которые мы можем задавать себе в процессе анализа, чтобы не сбиться с пути.

| |
|---|
|какой тип трафика вы видите? (протокол, порт и т. д.)|
|Это не один разговор? (сколько их?)|
|Сколько уникальных хостов?|
|Какова временная метка первого сеанса связи в pcap (TCP-трафик)?|
|Какой трафик я могу отфильтровать, чтобы очистить представление?|
|Какие серверы указаны в PCAP? (ответ на вопрос о хорошо известных портах: 53, 80 и т. д.)|
|Какие записи были запрошены или какие методы использовались? (GET, POST, DNS A-записи и т. д.)|