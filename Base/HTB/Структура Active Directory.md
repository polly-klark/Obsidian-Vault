#htb #windows #AD 

[Active Directory (AD)](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/get-started/virtual-dc/active-directory-domain-services-overview) — это служба каталогов для сетевых сред Windows. Это распределённая иерархическая структура, которая позволяет централизованно управлять ресурсами организации, включая пользователей, компьютеры, группы, сетевые устройства и общие файловые ресурсы, групповые политики, серверы и рабочие станции, а также трасты. AD обеспечивает функции аутентификации и авторизации в среде домена Windows. Служба каталогов, такая как [Active Directory Domain Services (AD DS)](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/get-started/virtual-dc/active-directory-domain-services-overview), позволяет организации хранить данные каталога и делать их доступными как для обычных пользователей, так и для администраторов в одной сети. AD DS хранит такую информацию, как имена пользователей и пароли, и управляет правами, необходимыми авторизованным пользователям для доступа к этой информации. Впервые она была поставлена с Windows Server 2000; в последние годы она подвергается все большим атакам. Он разработан для обеспечения обратной совместимости, и многие функции, возможно, "не защищены по умолчанию". Им сложно управлять должным образом, особенно в больших средах, где его можно легко неправильно настроить.

Ошибки и неправильные настройки в Active Directory часто используются для получения плацдарма (внутреннего доступа), горизонтального и вертикального перемещения внутри сети и получения несанкционированного доступа к защищенным ресурсам, таким как базы данных, файловые ресурсы, исходный код и т. д. AD — это, по сути, большая база данных, доступная всем пользователям домена, независимо от уровня их привилегий. С помощью обычной учетной записи пользователя AD без дополнительных привилегий можно получить доступ к большинству объектов, содержащихся в AD, включая, помимо прочего:

| | |
|---|---|
|Доменные Компьютеры|Пользователи Домена|
|Информация о Группе Домена|Организационные подразделения (ОП)|
|Политика домена по умолчанию|Уровни функциональной предметной области|
|Политика Использования паролей|Объекты групповой политики (GPO)|
|Доменные Трасты|Списки контроля доступа (ACL)|

По этой причине, прежде чем пытаться атаковать Active Directory, мы должны понять, как она устроена и каковы основы её администрирования. Всегда проще «сломать» что-то, если мы уже знаем, как это собрать.

---

Active Directory имеет иерархическую древовидную структуру, в которой на верхнем уровне находится лес, содержащий один или несколько доменов, которые, в свою очередь, могут иметь вложенные поддомены. Лес — это граница безопасности, в пределах которой все объекты находятся под административным контролем. Лес может содержать несколько доменов, а домен может включать в себя дочерние или вложенные поддомены. Домен — это структура, в пределах которой доступны содержащиеся в ней объекты (пользователи, компьютеры и группы). В нём есть множество встроенных организационных подразделений (OU), таких как `Domain Controllers`, `Users`, `Computers`, а при необходимости можно создавать новые OU. Организационные подразделения могут содержать объекты и вложенные организационные подразделения, что позволяет назначать различные групповые политики.

На очень (упрощённом) высоком уровне структура AD может выглядеть следующим образом:

  Структура Active Directory

```shell-session
INLANEFREIGHT.LOCAL/
├── ADMIN.INLANEFREIGHT.LOCAL
│   ├── GPOs
│   └── OU
│       └── EMPLOYEES
│           ├── COMPUTERS
│           │   └── FILE01
│           ├── GROUPS
│           │   └── HQ Staff
│           └── USERS
│               └── barbara.jones
├── CORP.INLANEFREIGHT.LOCAL
└── DEV.INLANEFREIGHT.LOCAL
```

Здесь мы можем сказать, что `INLANEFREIGHT.LOCAL` — это корневой домен, содержащий поддомены (дочерние или корневые домены), `ADMIN.INLANEFREIGHT.LOCAL`, `CORP.INLANEFREIGHT.LOCAL`, `DEV.INLANEFREIGHT.LOCAL` и другие объекты, составляющие домен, такие как пользователи, группы, компьютеры и т. д., как мы подробно рассмотрим ниже. В организациях, которые часто приобретают другие компании, часто можно увидеть несколько доменов (или лесов), связанных между собой доверительными отношениями. Часто проще и быстрее создать доверительные отношения с другим доменом/лесом, чем заново создавать всех пользователей в текущем домене. Как мы увидим в следующих модулях, при неправильном управлении доверием к доменам может возникнуть множество проблем с безопасностью.

![[Pasted image 20250907181050.png]]

На рисунке ниже показаны два леса: `INLANEFREIGHT.LOCAL` и `FREIGHTLOGISTICS.LOCAL`. Двусторонняя стрелка обозначает двустороннее доверие между двумя лесами, то есть пользователи из `INLANEFREIGHT.LOCAL` могут получать доступ к ресурсам из `FREIGHTLOGISTICS.LOCAL` и наоборот. Мы также видим несколько дочерних доменов под каждым корневым доменом. В этом примере видно, что корневой домен доверяет каждому из дочерних доменов, но дочерние домены в лесу A не обязательно доверяют дочерним доменам в лесу B. Это означает, что пользователь из `admin.dev.freightlogistics.local` по умолчанию НЕ сможет пройти аутентификацию на компьютерах в домене `wh.corp.inlanefreight.local`, даже если между доменами верхнего уровня `inlanefreight.local` и `freightlogistics.local` существует двустороннее доверие. Чтобы обеспечить прямую связь между `admin.dev.freightlogistics.local` и `wh.corp.inlanefreight.local`, необходимо настроить ещё одно доверие.

![[Pasted image 20250907181054.png]]