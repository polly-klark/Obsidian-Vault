#network #traffic #htb #wireshark 

`Wireshark` Это бесплатный анализатор сетевого трафика с открытым исходным кодом, очень похожий на tcpdump, но с графическим интерфейсом. Wireshark является мультиплатформенным и может собирать данные в реальном времени с различных типов интерфейсов (включая Wi-Fi, USB и Bluetooth) и сохранять трафик в нескольких форматах. Wireshark позволяет пользователю глубже анализировать сетевые пакеты, чем другие инструменты. По-настоящему мощным Wireshark делает возможность анализа, которая позволяет получить детальное представление о трафике.

В зависимости от используемого хоста у нас не всегда может быть графический интерфейс для работы с традиционным Wireshark. К счастью, есть несколько вариантов, которые позволяют использовать его из командной строки.

#### Особенности и возможности:

- Глубокая проверка пакетов для сотен различных протоколов
- Графический интерфейс и TTY
- Может работать в большинстве операционных систем
- Ethernet, IEEE 802.11, PPP/HDLC, ATM, Bluetooth, USB, Token Ring, Frame Relay, FDDI и другие
- Возможности расшифровки для IPsec, ISAKMP, Kerberos, SNMPv3, SSL/TLS, WEP и WPA/WPA2
- Еще много-много чего...

---

## Требования к использованию

Для использования Wireshark требуется следующее:

#### Windows:

- Универсальная среда выполнения C. Она входит в состав Windows 10 и Windows Server 2019 и автоматически устанавливается в более ранних версиях, если включено обновление Microsoft Windows. В противном случае необходимо установить KB2999226 или KB3118401.
- Любой современный 64-битный процессор AMD64/x86-64 или 32-битный процессор x86.
- Доступно 500 МБ оперативной памяти. Для больших файлов захвата требуется больше оперативной памяти.
- Доступно 500 МБ дискового пространства. Для файлов захвата требуется дополнительное дисковое пространство.
- Любой современный дисплей. Рекомендуется разрешение 1280 × 1024 или выше. Wireshark будет использовать разрешение HiDPI или Retina, если оно доступно. Опытные пользователи оценят возможность использования нескольких мониторов.
- Поддерживаемая сетевая карта для захвата:
    - Ethernet. Подойдет любая карта, поддерживаемая Windows.
    - 802.11. См. вики-страницу Wireshark. Сбор необработанной информации 802.11 может быть затруднён без специального оборудования.
- Для установки загрузите исполняемый файл с сайта wireshark.org, проверьте хэш и установите.

#### Linux:

- Wireshark работает на большинстве UNIX- и UNIX-подобных платформ, включая Linux и большинство вариантов BSD. Системные требования должны соответствовать указанным выше требованиям для Windows.
- Бинарные пакеты доступны для большинства дистрибутивов Unix и Linux.
- Чтобы проверить, существует ли пакет на хосте, используйте следующую команду:

#### Определение местоположения Wireshark

  Анализ с помощью Wireshark

```shell-session
Barlogsha@htb[/htb]$ which wireshark
```

Если пакета не существует (часто его можно найти в `/usr/sbin/wireshark`), вы можете установить его с помощью:

#### Установка Wireshark в Linux

  Анализ с помощью Wireshark

```shell-session
Barlogsha@htb[/htb]$ sudo apt install wireshark 
```

---

## TShark VS. Wireshark (терминал против графического интерфейса)

Оба варианта имеют свои преимущества. TShark — это специализированный терминальный инструмент на основе Wireshark. TShark обладает многими функциями Wireshark и даже использует тот же синтаксис и опции. TShark идеально подходит для использования на компьютерах с минимальной или отсутствующей средой рабочего стола и может легко передавать полученную информацию о захвате данных в другой инструмент через командную строку. Wireshark — это многофункциональный инструмент с графическим интерфейсом для захвата и анализа трафика. Если вам нужен полнофункциональный инструмент для работы на компьютере с операционной системой Windows, вам подойдёт графический интерфейс Wireshark.

#### Основные переключатели TShark

| **Команда переключения** | **Результат**                                                                                                                                                                                         |
| :----------------------: | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|            D             | Отобразит все доступные для захвата интерфейсы, а затем завершит работу.                                                                                                                              |
|            L             | Перечислит среды канального уровня, из которых можно выполнить захват, а затем завершит работу. (в качестве примера — Ethernet)                                                                       |
|            i             | выбор интерфейса для захвата. (-i eth0)                                                                                                                                                               |
|            f             | Пакетный фильтр в синтаксисе libpcap. Используется во время захвата.                                                                                                                                  |
|            c             | Захват определённого количества пакетов, а затем завершите программу. Определяет условие остановки.                                                                                                   |
|            a             | Определяет условие автоматического отключения. Может срабатывать по истечении определенного времени, при достижении определенного размера файла или после получения определенного количества пакетов. |
|      r (файл pcap)       | Считывание из файла.                                                                                                                                                                                  |
|      W (pcap-файл)       | Запишите данные в файл в формате pcapng.                                                                                                                                                              |
|            P             | Выведет сводку по пакету при записи в файл (-W)                                                                                                                                                       |
|            x             | добавит в захват вывод в формате Hex и ASCII.                                                                                                                                                         |
|            h             | Смотрите меню справки                                                                                                                                                                                 |

`To see the full list of switches you can utilize:`

#### Помощь TShark

  Анализ с помощью Wireshark

```shell-session
Barlogsha@htb[/htb]$ tshark -h
```

#### Базовое использование TShark

TShark может использовать фильтры для протоколов, общих элементов, таких как хосты и порты, и даже позволяет глубже анализировать пакеты и отдельные поля в них.

#### Определение местоположения TShark

  Анализ с помощью Wireshark

```shell-session
Barlogsha@htb[/htb]$ which tshark

Barlogsha@htb[/htb]$ tshark -D

Barlogsha@htb[/htb]$ tshark -i 1 -w /tmp/test.pcap

Capturing on 'Wi-Fi: en0'
484
```

Используя базовую строку в командной строке выше, мы применяем TShark для захвата данных с en0, указанного с помощью флага `-i` и опции `-w` для сохранения захвата в указанном выходном файле. Использование TShark очень похоже на использование TCPDump в плане фильтров и переключателей, которые мы можем использовать. Оба инструмента используют синтаксис BPF. Чтобы прочитать захват, в tshark можно передать переключатель `-r`, как и в TCPDump, или передать переключатель `-P`, чтобы tshark выводил сводки по пакетам при записи в файл. Ниже приведён пример чтения из файла PCAP, который мы ранее записали.

#### Выбор интерфейса и запись в файл

  Анализ с помощью Wireshark

```shell-session
Barlogsha@htb[/htb]$ sudo tshark -i eth0 -w /tmp/test.pcap
```

#### Применение фильтров

  Анализ с помощью Wireshark

```shell-session
Barlogsha@htb[/htb]$ sudo tshark -i eth0 -f "host 172.16.146.2"

Capturing on 'eth0'
    1 0.000000000 172.16.146.2 → 172.16.146.1 DNS 70 Standard query 0x0804 A github.com
    2 0.258861645 172.16.146.1 → 172.16.146.2 DNS 86 Standard query response 0x0804 A github.com A 140.82.113.4
    3 0.259866711 172.16.146.2 → 140.82.113.4 TCP 74 48256 → 443 [SYN] Seq=0 Win=64240 Len=0 MSS=1460 SACK_PERM=1 TSval=1321417850 TSecr=0 WS=128
    4 0.299681376 140.82.113.4 → 172.16.146.2 TCP 74 443 → 48256 [SYN, ACK] Seq=0 Ack=1 Win=65535 Len=0 MSS=1436 SACK_PERM=1 TSval=3885991869 TSecr=1321417850 WS=1024
    5 0.299771728 172.16.146.2 → 140.82.113.4 TCP 66 48256 → 443 [ACK] Seq=1 Ack=1 Win=64256 Len=0 TSval=1321417889 TSecr=3885991869
    6 0.306888828 172.16.146.2 → 140.82.113.4 TLSv1 579 Client Hello
    7 0.347570701 140.82.113.4 → 172.16.146.2 TLSv1.3 2785 Server Hello, Change Cipher Spec, Application Data, Application Data, Application Data, Application Data
    8 0.347653593 172.16.146.2 → 140.82.113.4 TCP 66 48256 → 443 [ACK] Seq=514 Ack=2720 Win=63488 Len=0 TSval=1321417937 TSecr=3885991916
    9 0.358887130 172.16.146.2 → 140.82.113.4 TLSv1.3 130 Change Cipher Spec, Application Data
   10 0.359781588 172.16.146.2 → 140.82.113.4 TLSv1.3 236 Application Data
   11 0.360037927 172.16.146.2 → 140.82.113.4 TLSv1.3 758 Application Data
   12 0.360482668 172.16.146.2 → 140.82.113.4 TLSv1.3 258 Application Data
   13 0.397331368 140.82.113.4 → 172.16.146.2 TLSv1.3 145 Application Data 
```

`-f` позволяет применять фильтры к захваченному трафику. В примере мы использовали `host`, но вы можете использовать практически любой фильтр, распознаваемый Wireshark. Мы уже немного затронули тему TShark. Давайте рассмотрим отличный инструмент под названием Termshark.

---

## Терминальная Метка

Termshark — это приложение с текстовым пользовательским интерфейсом (TUI), которое предоставляет пользователю интерфейс, похожий на Wireshark, прямо в окне терминала.

#### Терминальная Метка

![Захват сетевых пакетов в Termshark показывает трафик TCP и TLSv1.3 между IP-адресами 172.16.146.2 и 140.82.114.5 с подробной информацией о протоколах Ethernet, IP и TCP.](https://academy.hackthebox.com/storage/modules/81/termshark.png)

Termshark можно найти по адресу [Termshark](https://github.com/gcla/termshark). Его можно собрать из исходного кода, клонировав репозиторий, или скачать одну из текущих стабильных версий с https://github.com/gcla/termshark/releases , распаковать файл и приступить к работе.

Чтобы разобраться в этом пользовательском интерфейсе, посмотрите на изображение ниже.

#### Справка по терминам

![Интерфейс Termshark, отображающий сведения о сетевых пакетах, с всплывающей подсказкой, в которой перечислены сочетания клавиш для навигации и фильтрации.](https://academy.hackthebox.com/storage/modules/81/termshark-help.png)

Чтобы запустить Termshark, введите те же команды, что и для TShark или tcpdump. Мы можем указать интерфейс для захвата данных, фильтры и другие настройки в терминале. Окно Termshark не откроется, пока не будет получен трафик в фильтре захвата. Так что подождите секунду, если ничего не происходит.

---

## Пошаговое руководство с графическим интерфейсом Wireshark

Теперь, когда мы потратили время на изучение искусства захвата пакетов из командной строки, давайте проведём некоторое время в Wireshark. Мы потратим несколько минут на изучение того, что мы видим в приведённом ниже выводе. Давайте разберём этот вид графического интерфейса Wireshark.

#### Графический ИНТЕРФЕЙС Wireshark

![Снимок экрана Wireshark, на котором показан HTTP- и TCP-трафик между IP-адресами 10.1.1.101 и 10.1.1.1, с подробной информацией о GET-запросах и пакетных данных в шестнадцатеричном формате и формате ASCII.](https://academy.hackthebox.com/storage/modules/81/wireshark-interface.png)

Три Основные панели: `See Figure above`

1. Список пакетов: `Orange`
    
    - В этом окне мы видим сводную строку для каждого пакета, которая по умолчанию содержит перечисленные ниже поля. Мы можем добавлять или удалять столбцы, чтобы изменить отображаемую информацию.
        - Номер — порядок поступления пакетов в Wireshark
        - Время - формат времени Unix
        - Источник- IP-адрес источника
        - Пункт назначения - IP-адрес назначения
        - Протокол — используемый протокол (TCP, UDP, DNS и т. д.).
        - Информация — сведения о пакете. Это поле может варьироваться в зависимости от типа используемого протокола. Например, оно покажет, какой тип запроса используется в пакете DNS.
2. Сведения о пакете: `Blue`
    
    - Окно «Сведения о пакете» позволяет детально изучить пакет и протоколы. Оно разбивает пакет на части, соответствующие типичной модели OSI. `The packet is dissected into different encapsulation layers for inspection.`
    - Имейте в виду, что Wireshark отображает инкапсуляцию в обратном порядке: инкапсуляция более низкого уровня находится в верхней части окна, а более высокого — в нижней.
3. Байты пакета: `Green`
    
    - Окно Packet Bytes позволяет просматривать содержимое пакета в формате ASCII или шестнадцатеричном формате. Если выбрать поле в окнах выше, оно будет выделено в окне Packet Bytes и покажет, где находится этот бит или байт в общем пакете.
    - Это отличный способ убедиться в том, что информация, отображаемая на панели «Сведения», верна, а интерпретация, сделанная Wireshark, соответствует содержимому пакета.
    - Каждая строка в выводе содержит смещение данных, шестнадцать шестнадцатеричных байтов и шестнадцать байтов в формате ASCII. Непечатаемые байты заменяются точкой в формате ASCII.

#### Другие Примечательные особенности

При просмотре интерфейса Wireshark мы заметим несколько различных областей и радиальных кнопок. Эти области являются точками управления, с помощью которых мы можем изменять интерфейс и способ отображения пакетов в текущем захвате. `See Figure below`

#### Меню Wireshark

![Снимок экрана Wireshark, на котором показан HTTP- и TCP-трафик между IP-адресами 10.1.1.101 и 10.1.1.1, с подробной информацией о GET-запросах и пакетных данных в шестнадцатеричном формате и формате ASCII.](https://academy.hackthebox.com/storage/modules/81/wireshark-menu.png)

## Выполняем первый захват в Wireshark

Начать захват данных с помощью Wireshark очень просто. На гифке ниже показаны все шаги.

#### Шаги для начала захвата

![GIF-анимация с демонстрацией вариантов захвата.](https://academy.hackthebox.com/storage/modules/81/first-capture-ws.gif)

Помните, что при каждом изменении параметров захвата Wireshark будет перезапускать трассировку. Как и в TCPDump, в Wireshark есть параметры фильтрации захвата и отображения, которые можно использовать.

---

## Основы

#### Панель инструментов

![Панель инструментов с пунктами меню и значками для работы с файлами, поиска и фильтрации.](https://academy.hackthebox.com/storage/modules/81/wireshark-toolbar.jpg)

Панель инструментов Wireshark — это центральный элемент управления многочисленными функциями Wireshark. Здесь мы можем запускать и останавливать захват пакетов, менять интерфейсы, открывать и сохранять файлы .pcap, а также применять различные фильтры или надстройки для анализа.

#### Как сохранить снимок

Допустим, нам нужно сделать снимок того, что сейчас отображается в нашем окне, чтобы потом устранить неполадки. Сохранить снимок очень просто:

- Выберите «Файл» ⇢ «Сохранить» ИЛИ
- На панели инструментов выберите пункт «Файл» и укажите место для сохранения файла и его формат.

Обратите внимание, что Wireshark может сохранять записи в нескольких форматах. Выберите тот, который подходит для вашего сценария, но пока мы будем использовать формат `.pcap` .

---

## Предварительная и последующая обработка и фильтрация

При перехвате трафика с помощью Wireshark у нас есть несколько вариантов фильтрации трафика. Это делается с помощью фильтров захвата и отображения. Первый запускается до начала перехвата, а второй — во время или после завершения перехвата. Хотя в Wireshark есть множество полезных встроенных функций, стоит отметить, что он с трудом справляется с большими объёмами перехвата. Чем больше пакетов перехвачено, тем больше времени потребуется Wireshark для применения фильтра отображения или анализа. Это может занять от пары секунд до нескольких минут, если процесс вообще завершится. Если мы работаем с большим файлом pcap, возможно, лучше сначала разбить его на более мелкие части.

#### Фильтры захвата

`Capture Filters-` вводятся перед началом захвата. В них используется синтаксис BPF, например `host 214.15.2.30` почти так же, как в TCPDump. Таким образом, у нас меньше вариантов фильтрации, а фильтр захвата отбрасывает весь остальной трафик, который явно не соответствует заданным критериям. Это отличный способ сократить объём данных, записываемых на диск при устранении неполадок с подключением, например при захвате разговоров между двумя хостами.

Ниже приведена таблица с распространёнными и полезными фильтрами захвата с описанием каждого из них:

|       **Фильтры захвата**       | **Результат**                                                                                                                      |
| :-----------------------------: | ---------------------------------------------------------------------------------------------------------------------------------- |
|          host x.x.x.x           | Записывайте только трафик, относящийся к определённому хосту                                                                       |
|         net x.x.x.x/24          | Захват трафика, поступающего в определённую сеть или исходящего из неё (с использованием косой черты для указания маски)           |
|     src/dst net x.x.x.x/24      | Использование src или dst net позволяет перехватывать только трафик, исходящий из указанной сети или направляющийся в целевую сеть |
|             port #              | отфильтрует весь трафик, кроме указанного вами порта                                                                               |
|           not port #            | захватит всё, кроме указанного порта                                                                                               |
|          port # and #           | AND объединит указанные вами порты                                                                                                 |
|          portrange x-x          | portrange будет принимать трафик только со всех портов в указанном диапазоне                                                       |
|        ip / ether / tcp         | Эти фильтры будут захватывать только трафик с указанными заголовками протоколов.                                                   |
| broadcast / multicast / unicast | Перехватывает определенный тип трафика. один на один, один ко многим или один ко всем.                                             |

#### Применение фильтра захвата

Прежде чем применять фильтр захвата, давайте ознакомимся со встроенными фильтрами. Для этого: нажмите на значок захвата в верхней части окна Wireshark → затем выберите фильтры захвата в раскрывающемся списке.

#### Список фильтров

![Список фильтров захвата Wireshark с выражениями для фильтрации по Ethernet, IP, TCP, UDP и конкретным портам.](https://academy.hackthebox.com/storage/modules/81/capture-filter-list.png)

Здесь мы можем изменить существующие фильтры или добавить свои собственные.

Чтобы применить фильтр к захвату, выполните следующие действия: нажмите на значок захвата в верхней части окна Wireshark → затем выберите «Параметры» в раскрывающемся списке → в новом окне выберите в раскрывающемся списке «Фильтр захвата для выбранных интерфейсов» или введите фильтр, который хотите использовать. `below the red arrow in the picture below`

#### Применение фильтра захвата

![Параметры захвата Wireshark: отображение интерфейсов, включенный неразборчивый режим и примененный TCP-фильтр.](https://academy.hackthebox.com/storage/modules/81/how-to-add-cap.png)

#### Фильтры отображения

`Display Filters-` используются во время захвата и после его завершения. Фильтры отображения являются собственной разработкой Wireshark, которая предлагает множество различных вариантов практически для любого протокола.

Ниже приведена таблица с распространёнными и полезными фильтрами отображения с описанием каждого из них:

|  **Фильтры отображения**   | **Результат**                                                                                       |
| :------------------------: | --------------------------------------------------------------------------------------------------- |
|     ip.addr == x.x.x.x     | Записывайте только трафик, относящийся к определённому хосту. Это оператор ИЛИ.                     |
|   ip.addr == x.x.x.x/24    | Захват трафика, относящегося к определённой сети. Это оператор ИЛИ.                                 |
|   ip.src/dst == x.x.x.x    | Перехват трафика, поступающего на определенный хост или с него                                      |
| dns / tcp / ftp / arp / ip | Фильтруйте трафик по определённому протоколу. Существует множество других вариантов.                |
|       tcp.port == x        | фильтрация по определённому TCP-порту.                                                              |
|  tcp.port / udp.port != x  | захватит всё, кроме указанного порта                                                                |
|       and / or / not       | AND объединит два варианта, OR выберет один из двух вариантов, NOT исключит выбранный вами вариант. |

 Помните, что при использовании фильтров отображения трафик обрабатывается таким образом, чтобы отображалось только то, что запрашивается, но остальная часть файла захвата не перезаписывается. Применение фильтров отображения и параметров анализа приводит к тому, что Wireshark повторно обрабатывает данные pcap для их применения.

#### Применение фильтра отображения

Применить фильтр отображения ещё проще, чем фильтр захвата. В главном окне захвата Wireshark нам нужно сделать следующее: выбрать закладку на панели инструментов → , затем выбрать опцию в раскрывающемся списке. Или навести курсор на текстовое поле → и ввести фильтр, который мы хотим использовать. Если поле станет зелёным, значит, фильтр указан верно. `Just like in the image below.`

#### Применение фильтров отображения

![Интерфейс Wireshark показывает отфильтрованный TCP-трафик между IP-адресами 162.159.134.234 и 192.168.86.211 с использованием протоколов TLSv1.2 и TCP.](https://academy.hackthebox.com/storage/modules/81/display-filter.png)

При использовании фильтров захвата и отображения помните, что указанные нами параметры понимаются буквально. Например, фильтрация трафика через порт 80 — это не то же самое, что фильтрация по протоколу HTTP. Относитесь к портам и протоколам скорее как к рекомендациям, а не как к жёстким правилам. Порты могут быть привязаны и использоваться не по назначению. Например, при фильтрации по протоколу HTTP будут искать ключевые маркеры, используемые протоколом, такие как запросы GET/POST, и отображать результаты их выполнения. Фильтрация по порту 80 покажет все, что было отправлено или получено через этот порт, независимо от транспортного протокола.

В следующем разделе мы рассмотрим некоторые более продвинутые функции Wireshark.