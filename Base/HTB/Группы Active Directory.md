#htb #windows #AD 

После пользователей ещё одним важным объектом в Active Directory являются группы. Они позволяют объединять похожих пользователей и массово назначать им права и доступ. Группы — ещё одна ключевая цель для злоумышленников и специалистов по тестированию на проникновение, поскольку права, которые они предоставляют своим участникам, могут быть неочевидными, но при этом давать чрезмерные (и даже непреднамеренные) привилегии, которыми можно злоупотребить, если они не настроены должным образом. В Active Directory есть множество [встроенных групп](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#about-active-directory-groups), и большинство организаций также создают собственные группы для определения прав и привилегий и дальнейшего управления доступом в домене. Количество групп в среде Active Directory может стремительно расти и стать неуправляемым, что может привести к непреднамеренному доступу, если не контролировать этот процесс. Важно понимать, как использование различных типов групп влияет на ситуацию, и периодически `audit` проверять, какие группы существуют в домене, какие привилегии они предоставляют своим участникам, а также не является ли членство в группах чрезмерным по сравнению с тем, что требуется пользователю для выполнения повседневной работы. Далее мы рассмотрим различные типы групп и области, в которых они могут быть назначены.

Один из часто возникающих вопросов — в чём разница между группами и организационными подразделениями (ОП). Как уже говорилось в этом модуле, ОП полезны для группировки пользователей, групп и компьютеров, чтобы упростить управление и развёртывание параметров групповой политики для конкретных объектов в домене. Группы в основном используются для назначения разрешений на доступ к ресурсам. ОП также можно использовать для делегирования пользователю административных задач, таких как сброс паролей или разблокировка учётных записей пользователей, без предоставления им дополнительных прав администратора, которые они могут унаследовать благодаря членству в группе.

---

## Типы групп

Проще говоря, группы используются для объединения пользователей, компьютеров и объектов контактов в управляемые единицы, что упрощает администрирование разрешений и назначение таких ресурсов, как принтеры и доступ к общим файлам. Например, если администратору нужно предоставить 50 сотрудникам отдела доступ к новому общему диску, добавление учётной записи каждого пользователя по отдельности займёт много времени. Предоставление разрешений таким способом также затрудняет аудит доступа к ресурсам и очистку/отзыв разрешений. Вместо этого системный администратор может использовать существующую группу или создать новую и предоставить этой группе права доступа к ресурсу. После этого каждый пользователь в группе получит права доступа в соответствии со своим членством в группе. Если необходимо изменить или отозвать права доступа у одного или нескольких пользователей, их можно просто удалить из группы, не затрагивая права доступа других пользователей.

Группы в Active Directory имеют две основные характеристики: `type` и `scope`. Параметр `group type` определяет назначение группы, а параметр `group scope` показывает, как группа может использоваться в домене или лесу. При создании новой группы необходимо выбрать её тип. Существует два основных типа: `security` и `distribution` группы.

#### Тип и область применения группы

![[Pasted image 20251028171134.png]]

Тип `Security groups` в первую очередь предназначен для упрощения назначения разрешений и прав группе пользователей, а не каждому пользователю по отдельности. Они упрощают управление и сокращают трудозатраты при назначении разрешений и прав для конкретного ресурса. Все пользователи, добавленные в группу безопасности, наследуют все разрешения, назначенные группе, что упрощает добавление и исключение пользователей из групп без изменения разрешений группы.

Тип `Distribution groups` используется почтовыми приложениями, такими как Microsoft Exchange, для рассылки сообщений участникам группы. Они работают почти так же, как списки рассылки, и позволяют автоматически добавлять адреса электронной почты в поле «Кому» при создании письма в Microsoft Outlook. Этот тип группы нельзя использовать для назначения разрешений на ресурсы в доменной среде.

---

## Области действия группы

При создании новой группы можно использовать три разных `group scopes`

1. Локальная группа домена
2. Глобальная Группа
3. Универсальная Группа

#### Локальная группа домена

Локальные группы домена можно использовать только для управления разрешениями на доступ к ресурсам домена в том домене, где они были созданы. Локальные группы нельзя использовать в других доменах, но `CAN` содержать пользователей из `OTHER` доменов. Локальные группы могут быть вложены (содержаться внутри) других локальных групп, но `NOT` не могут быть вложены в глобальные группы.

#### Глобальная Группа

Глобальные группы можно использовать для предоставления доступа к ресурсам в `another domain`. Глобальная группа может содержать только учётные записи из домена, в котором она была создана. Глобальные группы можно добавлять как в другие глобальные группы, так и в локальные группы.

#### Универсальная Группа

Универсальная область действия группы может использоваться для управления ресурсами, распределёнными по нескольким доменам, и может предоставлять разрешения на доступ к любому объекту в рамках `forest`. Они доступны для всех доменов в организации и могут содержать пользователей из любого домена. В отличие от локальных и глобальных групп домена, универсальные группы хранятся в глобальном каталоге (ГК), а добавление или удаление объектов из универсальной группы запускает репликацию в масштабах всего леса. Администраторам рекомендуется включать другие группы (например, глобальные группы) в состав универсальных групп, поскольку вероятность изменения членства в глобальных группах в составе универсальных групп ниже, чем вероятность изменения членства отдельных пользователей в глобальных группах. Репликация запускается только на уровне отдельного домена, когда пользователь удаляется из глобальной группы. Если отдельные пользователи и компьютеры (а не глобальные группы) входят в состав универсальных групп, то при каждом изменении будет запускаться репликация в масштабах всего леса. Это может привести к большим нагрузкам на сеть и потенциальным проблемам. Ниже приведен пример групп в AD и их настроек области действия. Обратите внимание на некоторые критически важные группы и их область действия. (Например, администраторы предприятия и схемы по сравнению с администраторами домена.)

#### Примеры Охвата группы объявлений

  Группы Active Directory

```powershell-session
PS C:\htb> Get-ADGroup  -Filter * |select samaccountname,groupscope

samaccountname                           groupscope
--------------                           ----------
Administrators                          DomainLocal
Users                                   DomainLocal
Guests                                  DomainLocal
Print Operators                         DomainLocal
Backup Operators                        DomainLocal
Replicator                              DomainLocal
Remote Desktop Users                    DomainLocal
Network Configuration Operators         DomainLocal
Distributed COM Users                   DomainLocal
IIS_IUSRS                               DomainLocal
Cryptographic Operators                 DomainLocal
Event Log Readers                       DomainLocal
Certificate Service DCOM Access         DomainLocal
RDS Remote Access Servers               DomainLocal
RDS Endpoint Servers                    DomainLocal
RDS Management Servers                  DomainLocal
Hyper-V Administrators                  DomainLocal
Access Control Assistance Operators     DomainLocal
Remote Management Users                 DomainLocal
Storage Replica Administrators          DomainLocal
Domain Computers                             Global
Domain Controllers                           Global
Schema Admins                             Universal
Enterprise Admins                         Universal
Cert Publishers                         DomainLocal
Domain Admins                                Global
Domain Users                                 Global
Domain Guests                                Global

<SNIP>
```

Групповые области можно изменить, но есть несколько нюансов:

- Глобальная группа может быть преобразована в универсальную группу только в том случае, если она НЕ является частью другой глобальной группы.
    
- Локальная группа домена может быть преобразована в универсальную группу только в том случае, если локальная группа домена НЕ содержит других локальных групп домена в качестве участников.
    
- Универсальную группу можно преобразовать в локальную группу домена без каких-либо ограничений.
    
- Универсальная группа может быть преобразована в глобальную группу только в том случае, если она НЕ содержит других универсальных групп в качестве участников.
    

---

## Встроенные и пользовательские группы

При создании домена создается несколько встроенных групп безопасности с областью действия «Локальная группа домена». Эти группы используются для определенных административных целей, и подробнее о них рассказывается в следующем разделе. Важно отметить, что в эти встроенные группы можно добавлять только учетные записи пользователей, так как они не поддерживают вложенность групп (группы внутри групп). Вот несколько примеров встроенных групп: `Domain Admins`, которая является группой безопасности `Global` и может содержать только учетные записи из своего домена. Если организация хочет разрешить учетной записи из домена B выполнять административные функции на контроллере домена в домене A, эту учетную запись необходимо будет добавить во встроенную группу администраторов, которая является `Domain Local` группой. Хотя в Active Directory уже есть множество групп, большинство организаций создают дополнительные группы (как для обеспечения безопасности, так и для распространения) для своих целей. Изменения/добавления в среде Active Directory также могут привести к созданию дополнительных групп. Например, при добавлении Microsoft Exchange в домен в нём появляются различные группы безопасности, некоторые из которых имеют высокий уровень привилегий и при отсутствии надлежащего управления могут использоваться для получения привилегированного доступа в домене.

---

## Членство во Вложенной группе

Вложенное членство в группах — важная концепция в AD. Как упоминалось ранее, локальная группа домена может входить в состав другой локальной группы домена в том же домене. Благодаря такому членству пользователь может получить привилегии, назначенные не непосредственно его учетной записи или даже группе, членом которой он является, а группе, членом которой является его группа. Иногда это может привести к непреднамеренному предоставлению пользователю привилегий, которые сложно выявить без тщательной оценки домена. Такие инструменты, как [BloodHound](https://github.com/BloodHoundAD/BloodHound), особенно полезны для выявления привилегий, которые пользователь может унаследовать через одну или несколько вложенных групп. Это ключевой инструмент для специалистов по тестированию на проникновение, позволяющий выявлять неочевидные ошибки в конфигурации, а также чрезвычайно полезный для системных администраторов и других специалистов, желающих получить глубокое (визуальное) представление о состоянии безопасности своего домена (доменов).

Ниже приведён пример привилегий, наследуемых при вложенном членстве в группах. Хотя `DCorner` не является непосредственным членом группы `Helpdesk Level 1`, членство в группе `Help Desk` даёт ему те же привилегии, что и любому члену группы `Helpdesk Level 1` . В этом случае привилегия позволит ему добавить участника в группу `Tier 1 Admins` (`GenericWrite`). Если эта группа предоставляет какие-либо расширенные привилегии в домене, она, скорее всего, станет ключевой целью для специалиста по тестированию на проникновение. Здесь мы можем добавить нашего пользователя в группу и получить привилегии, предоставляемые членам группы `Tier 1 Admins`, например доступ локального администратора к одному или нескольким хостам, которые можно использовать для дальнейшего доступа.

#### Анализ вложенных групп с помощью BloodHound

![[Pasted image 20251028171146.png]]

---

## Важные Атрибуты Группы

Как и у пользователей, у групп есть множество [атрибутов](http://www.selfadsi.org/group-attributes.htm). Вот некоторые из наиболее [важных атрибутов групп](https://docs.microsoft.com/en-us/windows/win32/ad/group-objects):

- `cncn` или общее имя — это имя группы в доменных службах Active Directory.
    
- `member`: Какие пользователи, группы и объекты контактов входят в состав группы.
    
- `groupType`: целое число, определяющее тип и область действия группы.
    
- `memberOf`: Список всех групп, в которые входит данная группа (вложенное членство в группах).
    
- `objectSid`Это идентификатор безопасности или SID группы, то есть уникальное значение, используемое для идентификации группы как субъекта безопасности.
    

Группы — это основные объекты в AD, которые можно использовать для объединения других объектов и упрощения управления правами и доступом. Уделите время изучению различий между типами и областями действия групп. Эти знания пригодятся для администрирования AD, а также для понимания взаимосвязей между группами в одном и разных доменах и того, какую информацию можно получить на этапе разведки при тестировании на проникновение. Понимание того, как можно использовать различные типы групп для проведения атак в одном домене и за его пределами, — отличный навык. В этом разделе мы подробно рассмотрели группы. Теперь давайте разберёмся, чем отличаются `Rights` и `Privileges`.