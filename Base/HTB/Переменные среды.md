#htb #windows #cmd 

Теперь, когда мы разобрались с использованием командной строки, давайте обсудим одну из наиболее важных тем, связанных с работой приложений и скриптов в Windows, — `Environment Variables`. В этом разделе мы расскажем, что это такое, для чего они нужны и как управлять переменными в нашей системе.

---

## Что такое переменная окружения

Переменные среды - это настройки, которые часто применяются глобально к нашим хостам. Их можно найти на хостах Windows, Linux и macOS. Эта концепция не является специфичной для одного типа ОС, но в каждой ОС они функционируют по-разному. Переменные среды доступны большинству пользователей и приложений на хосте и используются для запуска сценариев и ускорения работы приложений и обращения к данным. На хосте Windows переменные среды `not` чувствительны к регистру и могут содержать пробелы и цифры в имени. Единственная реальная загвоздка, с которой мы столкнёмся, заключается в том, что их имя не может начинаться с цифры или содержать знак равенства. При обращении к ним мы увидим, что эти переменные называются так:

  Переменные среды

```cmd-session
%SUPER_IMPORTANT_VARIABLE%
```

Обычно эти переменные (особенно те, которые уже встроены в систему) отображаются заглавными буквами и с использованием подчёркивания для разделения слов в названии. Прежде чем двигаться дальше, следует упомянуть одну важную концепцию, связанную с переменными среды, которая называется `Scope`.

#### Область действия переменной

В данном контексте `Scope` — это концепция программирования, которая относится к тому, где можно получить доступ к переменным или ссылаться на них. «Область видимости» можно условно разделить на две категории:

- **Глобальный:**
    - Глобальные переменные доступны в `globally`. В данном контексте глобальная область видимости означает, что мы можем получить доступ к данным, хранящимся в переменной, и ссылаться на них из любой точки программы.
- **Местные новости:**
    - Локальные переменные доступны только в контексте `local`. `Local` Это означает, что данные, хранящиеся в этих переменных, доступны только в рамках функции или контекста, в котором они были объявлены.

Давайте рассмотрим пример сценария, чтобы лучше понять различия. В этом сценарии у нас есть два пользователя, `Alice` и `Bob`. Оба пользователя имеют сеанс командной строки по умолчанию и одновременно вошли в систему на одном компьютере. Кроме того, оба пользователя выполняют команду для вывода данных, хранящихся в переменной `%WINDIR%`, как показано в примерах ниже.

#### Отображение глобальных переменных

#### Пример 1:

  Переменные среды

```cmd-session
C:\Users\alice> echo %WINDIR%

C:\Windows
```

#### Пример 2:

  Переменные среды

```cmd-session
C:\Users\bob> echo %WINDIR%

C:\Windows
```

Мы видим, что эта переменная доступна обоим пользователям. Таким образом, оба пользователя могут отображать хранящиеся в ней данные. Это связано с тем, что `%WINDIR%` переменная является `global variable` в соответствии с определением ОС Windows. Однако что, если Алиса захочет создать секретную переменную, которую Боб не сможет увидеть или получить к ней доступ? Как бы она это сделала?

#### Отображение локальных переменных

#### Пример 1:

  Переменные среды

```cmd-session
C:\Users\alice> set SECRET=HTB{5UP3r_53Cr37_V4r14813}

C:\Users\alice> echo %SECRET%
HTB{5UP3r_53Cr37_V4r14813}

```

#### Пример 2:

  Переменные среды

```cmd-session
C:\Users\bob> echo %SECRET%
%SECRET%

C:\Users\bob> set %SECRET%
Environment variable %SECRET% not defined

```

В первом примере Алиса создаёт переменную с именем `SECRET` и сохраняет в ней значение `HTB{5UP3r_53Cr37_V4r14813}`. После присвоения значения переменной Алиса извлекает его с помощью команды `echo` и выводит на экран. Однако, когда Боб пытается извлечь ту же переменную, у него не получается, так как она не определена в его текущей среде. Алиса создала переменную `local variable` с доступом только для неё, так как она была определена только в контексте её локальной среды.

Примечание: это объяснение разницы между глобальной и локальной областью видимости ни в коем случае не является исчерпывающим руководством по различиям между ними и не включает более сложные концепции. Этот раздел предназначен для предоставления необходимой справочной информации.

Теперь, когда у нас есть базовое представление о переменных и общее представление об основах, лежащих в основе `scopes`-переменных, давайте разберёмся, как Windows взаимодействует с переменными среды и хранит их, а также как мы можем взаимодействовать с ними. Как и прежде, Windows, как и любая другая программа, содержит собственный набор переменных, известных как `Environment Variables`. Эти переменные можно разделить на определённые области, известные как `System`- и `User`-области. Кроме того, существует ещё одна определённая область, известная как `Process`-область; однако она изменчива по своей природе и считается под-областью как `System`-, так и `User`-областей. Учитывая это, давайте рассмотрим их различия и предполагаемые функции.

| Область применения | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                 | Разрешения, необходимые для доступа                                              | Местоположение реестра                                                            |
| ------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------- | --------------------------------------------------------------------------------- |
| `System (Machine)` | Область действия системы содержит переменные среды, определяемые операционной системой (ОС), и доступна глобально для всех пользователей и учётных записей, которые входят в систему. Для корректной работы ОС требуются эти переменные, которые загружаются во время выполнения.                                                                                                                                                        | Локальный администратор или Администратор Домена                                 | `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Environment` |
| `User`             | Область действия пользователя содержит переменные среды, заданные текущим активным пользователем, и доступна только ему, а не другим пользователям, которые могут войти в ту же систему.                                                                                                                                                                                                                                                 | Текущий Активный Пользователь, Локальный администратор или Администратор Домена  | `HKEY_CURRENT_USER\Environment`                                                   |
| `Process`          | Область видимости процесса содержит переменные среды, которые определяются и доступны в контексте текущего выполняемого процесса. Из-за их непостоянного характера они существуют только в рамках текущего выполняемого процесса, в котором они были изначально определены. Они также наследуют переменные из областей видимости системы/пользователя и родительского процесса, который их порождает (только если это дочерний процесс). | Текущий дочерний процесс, Родительский процесс или Текущий Активный пользователь | `None (Stored in Process Memory)`                                                 |

В таблице должно быть хорошо видно, как Windows работает с переменными среды и как только определённые пользователи могут получить доступ к определённым переменным из-за разрешений. Теперь, когда мы разобрались с этими различиями, давайте попробуем самостоятельно внести изменения в переменные среды.

---

## Использование Set и Echo для просмотра переменных

Чтобы понять, какие изменения происходят в переменных среды, нам нужно как-то просмотреть их содержимое в командной строке. К счастью, у нас есть несколько вариантов: `set` и `echo`.

#### Дисплей с Установленным

  Переменные среды

```cmd-session
C:\Users\htb\Desktop>set %SYSTEMROOT%

Environment variable C:\Windows not defined
```

После открытия командной строки вы можете ввести команду `set` для вывода всех доступных переменных среды в системе. Кроме того, вы можете ввести ту же команду ещё раз с именем переменной, не присваивая ей никакого значения, чтобы вывести значение конкретной переменной. В этом случае мы видим, что само значение не определено, но это связано с тем, что в этом примере мы не определяем значение `%SYSTEMROOT%` с помощью `set`

#### Дисплей с эхом

  Переменные среды

```cmd-session
C:\Users\htb\>echo %PATH%

C:\Users\htb\Desktop
```

Как и в приведённом выше примере, вы можете использовать `echo` для отображения значения переменной среды. В отличие от предыдущей команды, `echo` используется для вывода значения, содержащегося в переменной, и не имеет дополнительных встроенных функций для редактирования переменных среды. В следующем разделе мы обсудим, как создавать новые переменные, удалять ненужные и редактировать существующие с помощью командной строки.

---

## Управление Переменными среды

Теперь, когда у нас есть способ просматривать существующие переменные среды в нашей системе, нам нужно иметь возможность создавать, удалять их и управлять ими, не выходя из командной строки. Для этого у нас есть два доступных метода. Мы можем использовать `set` или `setx` для выполнения необходимых действий.

#### Когда использовать `set` Vs. `setx`

И [set](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/set_1), и [setx](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/setx) — это утилиты командной строки, которые позволяют отображать, устанавливать и удалять переменные среды. Разница заключается в том, как они достигают этих целей. Утилита `set` управляет переменными среды только в текущем сеансе командной строки. Это означает, что после закрытия текущего сеанса любые добавления, удаления или изменения не будут отражены при следующем открытии командной строки. Предположим, нам нужно внести постоянные изменения в переменные среды. В этом случае мы можем использовать `setx` для внесения соответствующих изменений в реестр, которые сохранятся после перезапуска текущего сеанса командной строки.

**Примечание:** при использовании `setx` у нас также появляется дополнительная функциональность, например, возможность создавать и настраивать переменные на компьютерах в домене, а также на нашем локальном компьютере.

Теперь мы должны быть знакомы с некоторыми основными различиями между обеими командами, о которых говорилось выше. Бывают случаи и ситуации, когда одна из них должна иметь приоритет над другой. Злоумышленнику иногда нужно перечислять существующие переменные среды для получения информации. Давайте перейдём к созданию реальных переменных, которые мы можем использовать.

#### Создание переменных

Создание переменных среды — довольно простая задача. Мы можем использовать `set` или `setx` в зависимости от поставленной задачи и нашей общей цели. В следующих примерах показано, как использовать обе команды, чтобы понять синтаксис каждой из них. Обратите внимание, что синтаксис обеих команд в некоторых случаях очень похож, однако `setx` имеет некоторые дополнительные функции, которые мы попытаемся изучить здесь. Кроме того, чтобы не повторяться, мы будем показывать только команды `set` и `setx` для создания переменных и использовать `setx` в каждом примере. Просто знайте, что синтаксис создания, удаления и редактирования переменных среды идентичен.

Давайте создадим переменную для хранения IP-адреса контроллера домена (`DC`), так как она может пригодиться для проверки подключения к домену или запроса обновлений. Это можно сделать с помощью команды `set`.

#### Использование набора

  Переменные среды

```cmd-session
C:\htb> set DCIP=172.16.5.2

```

При выполнении этой команды немедленного вывода не происходит. Однако знайте, что переменная была задана для текущего сеанса командной строки. Мы можем убедиться в этом, выведя её значение с помощью `echo`.

#### Проверка изменения

  Переменные среды

```cmd-session
C:\htb> echo %DCIP%

172.16.5.2
```

Как мы видим, переменная среды `%DCIP%` теперь задана и доступна для нас. Как было сказано выше, это изменение считается частью `process` области видимости, так как при выходе из командной строки и запуске нового сеанса эта переменная перестанет существовать в системе. Мы можем исправить эту ситуацию, навсегда задав эту переменную в среде с помощью `setx`.

#### Использование setx

  Переменные среды

```cmd-session
C:\htb> setx DCIP 172.16.5.2

SUCCESS: Specified value was saved.

```

Из этого примера мы видим, что синтаксис команд немного различается. Раньше нам нужно было присваивать переменной значение, равное самой переменной. Здесь же мы указываем имя переменной, а затем значение. Синтаксис выглядит следующим образом: `setx <variable name> <value> <parameters>`. После выполнения этой команды мы видим, что наше значение было сохранено в реестре, так как мы получили сообщение `SUCCESS`. Конечно, если нам интересно, действительно ли значение было установлено, мы можем проверить его, как описано выше. Помните, что это изменение произойдёт только после того, как мы откроем ещё один сеанс командной строки. В удалённой системе переменные, созданные или изменённые с помощью этого инструмента, будут доступны при следующем входе в систему.

#### Редактирование переменных

Помимо создания собственных переменных, мы можем редактировать существующие. Поскольку мы уже знакомы с их созданием, редактировать их так же просто, за исключением того, что мы будем заменять существующие значения. Допустим, IP-адрес нашего `DC` изменился, и нам нужно обновить значение нашей пользовательской переменной среды, чтобы отразить это изменение.

#### Использование setx

  Переменные среды

```cmd-session
C:\htb> setx DCIP 172.16.5.5

SUCCESS: Specified value was saved.
```

В предыдущем примере мы задали `172.16.5.2` в качестве значения для DC в сети. Однако, используя `setx`, мы можем обновить это значение, просто задав новый адрес `172.16.5.5`.

#### Проверка правки

  Переменные среды

```cmd-session
C:\htb> echo %DCIP%

172.16.5.5
```

Мы успешно отредактировали нашу первоначальную пользовательскую переменную, чтобы отразить изменение IP-адреса DC. Теперь мы можем двигаться дальше и обсудить удаление переменных.

#### Удаление переменных

Подобно созданию и редактированию переменных, мы можем удалять переменные среды практически таким же образом. Чтобы удалить переменные, мы не можем удалить их напрямую, как файл или каталог; вместо этого мы должны очистить их значения, установив для них нулевое значение. Это действие фактически удалит переменную и не позволит использовать её по назначению из-за удалённого значения. В нашем первом примере мы создали переменную `%DCIP%` со значением IP-адреса контроллера домена в сети и навсегда сохранили его в реестре. Мы можем попытаться удалить его, выполнив следующие действия:

#### Использование setx

  Переменные среды

```cmd-session
C:\htb> setx DCIP ""


SUCCESS: Specified value was saved.
```

Эта команда удалит `%DCIP%` из текущих переменных среды нашей системы и также отразится в реестре, как только мы откроем новую командную строку. Мы можем убедиться, что это действительно так, выполнив следующие действия:

#### Проверка того, что переменная была удалена

  Переменные среды

```cmd-session
C:\htb> set DCIP
Environment variable DCIP not defined

C:\htb> echo %DCIP%
%DCIP%
```

Используя `set` и `echo`, мы можем убедиться, что переменная `%DCIP%` больше не задана и не определена в нашей среде.

---

## Важные Переменные среды

Теперь, когда мы научились создавать, редактировать и удалять собственные переменные среды, давайте обсудим некоторые важные переменные, о которых следует помнить при выполнении перебора в среде хоста. Помните, что вся информация, которую мы здесь находим, предоставляется нам в открытом виде из-за особенностей переменных среды. Для злоумышленника это может предоставить множество сведений о текущей системе и учётной записи пользователя, которая к ней обращается.

|Имя переменной|Описание|
|---|---|
|`%PATH%`|Задает набор каталогов (расположений), в которых находятся исполняемые программы.|
|`%OS%`|Текущая операционная система на рабочей станции пользователя.|
|`%SYSTEMROOT%`|Расшифровывается как `C:\Windows`. Системная переменная только для чтения, содержащая системную папку Windows. Здесь находится всё, что Windows считает важным для своей основной функциональности, включая важные данные, основные системные двоичные файлы и файлы конфигурации.|
|`%LOGONSERVER%`|Предоставляет нам сервер входа в систему для текущего активного пользователя, а также имя хоста компьютера. Мы можем использовать эту информацию, чтобы узнать, присоединён ли компьютер к домену или рабочей группе.|
|`%USERPROFILE%`|Предоставляет нам информацию о местоположении домашнего каталога текущего активного пользователя. Расшифровывается как `C:\Users\{username}`.|
|`%ProgramFiles%`|Эквивалент `C:\Program Files`. Это место, где установлены все программы в системе на базе `x64`.|
|`%ProgramFiles(x86)%`|Эквивалент `C:\Program Files (x86)`. В этом расположении установлены все 32-разрядные программы, работающие под `WOW64`. Обратите внимание, что эта переменная доступна только на 64-разрядном хосте. Его можно использовать, чтобы указать, с каким хостом мы взаимодействуем. (`x86` против `x64` архитектуры)|

Приведённая здесь информация — лишь малая часть того, что мы можем узнать, перечислив переменные среды в системе. Однако вышеупомянутые переменные часто появляются при выполнении перечисления. Полный список можно найти по следующей [ссылке](https://ss64.com/nt/syntax-variables.html). Используя эту информацию в качестве руководства, мы можем начать собирать любую необходимую информацию из этих переменных, чтобы узнать больше о нашем хосте и его целевой среде.

---

## Двигаемся Дальше

К концу этого раздела мы должны хорошо понимать, что такое переменные среды и как ими управлять в системе. Переменные среды являются частью основных функций ОС Windows и считаются очень полезными как для злоумышленников, так и для защитников. К любым изменениям, которые могут повлиять на общесистемные переменные, следует относиться с особой осторожностью. Если мы считаем, что это необходимо для наших скриптов или инструментов, создайте новую переменную, прежде чем редактировать уже существующую в системе. Теперь, когда мы ознакомились с этой информацией, давайте перейдём к использованию командной строки для работы со службами на нашем хосте.