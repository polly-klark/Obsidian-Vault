#network #htb 

У каждого хоста в сети есть свой `48`-битный (`6 octets`) `Media Access Control` (`MAC`) адрес, представленный в шестнадцатеричном формате. `MAC` — это `physical address` для наших сетевых интерфейсов. Существует несколько различных стандартов для MAC-адресов:

- Ethernet (IEEE 802.3)
- Bluetooth (IEEE 802.15)
- WLAN (IEEE 802.11)

Это связано с тем, что `MAC`-адрес относится к физическому подключению (сетевой карте, Bluetooth или адаптеру WLAN) хоста. Каждая сетевая карта имеет свой индивидуальный MAC-адрес, который настраивается один раз на аппаратном уровне производителем, но его всегда можно изменить, по крайней мере временно.

Давайте рассмотрим пример такого MAC-адреса:

MAC-адрес:

- `DE:AD:BE:EF:13:37`
- `DE-AD-BE-EF-13-37`
- `DEAD.BEEF.1337`

| **Представительство** | **1 - й Октет** | **2 - й Октет** | **3 - й Октет** | **4 - й Октет** | **5 - й Октет** | **6 - й Октет** |
| --------------------- | --------------- | --------------- | --------------- | --------------- | --------------- | --------------- |
| Бинарный              | 1101 1110       | 1010 1101       | 1011 1110       | 1110 1111       | 0001 0011       | 0011 0111       |
| Шестнадцатеричный     | DE              | AD              | BE              | EF              | 13              | 37              |

---

Когда IP-пакет доставляется, он должен быть адресован `layer 2` физическому адресу конечного узла или маршрутизатору / NAT, который отвечает за маршрутизацию. Каждый пакет имеет `sender address` и `destination address`.

MAC-адрес состоит из `6 bytes`. Первая половина (`3 bytes` / `24 bit`) — это так называемый `Organization Unique Identifier` (`OUI`), определяемый `Institute of Electrical and Electronics Engineers` (`IEEE`) для соответствующих производителей.

|**Представительство**|**1 - й Октет**|**2 - й Октет**|**3 - й Октет**|**4 - й Октет**|**5 - й Октет**|**6 - й Октет**|
|---|---|---|---|---|---|---|
|Бинарный|`1101 1110`|`1010 1101`|`1011 1110`|1110 1111|0001 0011|0011 0111|
|Шестнадцатеричный|`DE`|`AD`|`BE`|EF|13|37|

---

Последняя половина MAC-адреса называется `Individual Address Part` или `Network Interface Controller` (`NIC`), и её присваивают производители. Производитель устанавливает эту последовательность битов только один раз и таким образом обеспечивает уникальность всего адреса.

| **Представительство** | **1 - й Октет** | **2 - й Октет** | **3 - й Октет** | **4 - й Октет** | **5 - й Октет** | **6 - й Октет** |
| --------------------- | --------------- | --------------- | --------------- | --------------- | --------------- | --------------- |
| Бинарный              | 1101 1110       | 1010 1101       | 1011 1110       | `1110 1111`     | `0001 0011`     | `0011 0111`     |
| Шестнадцатеричный     | DE              | AD              | BE              | `EF`            | `13`            | `37`            |

Если хост с целевым IP-адресом находится в той же подсети, доставка осуществляется непосредственно на физический адрес целевого компьютера. Однако если этот хост находится в другой подсети, кадр Ethernet адресуется `MAC address` ответственного маршрутизатора (`default gateway`). Если адрес назначения кадра Ethernet совпадает с его собственным `layer 2 address`, маршрутизатор перенаправит кадр на более высокие уровни. `Address Resolution Protocol` (`ARP`) используется в IPv4 для определения MAC-адресов, связанных с IP-адресами.

Как и в случае с IPv4-адресами, для MAC-адресов также предусмотрены определённые зарезервированные области. К ним относится, например, локальный диапазон MAC-адресов.

|**Локальный Диапазон**|
|---|
|0`2`:00:00:00:00:00|
|0`6`:00:00:00:00:00|
|0`A`:00:00:00:00:00|
|0`E`:00:00:00:00:00|

Кроме того, последние два бита в первом октете могут играть ещё одну важную роль. Как мы уже знаем, последний бит может иметь два состояния: 0 и 1. Последний бит определяет MAC-адрес как `Unicast` (`0`) или `Multicast` (`1`). Если `unicast` означает, что отправленный пакет достигнет только одного конкретного хоста.

#### Одноадресная рассылка MAC

| **Представительство** | **1 - й Октет** | **2 - й Октет** | **3 - й Октет** | **4 - й Октет** | **5 - й Октет** | **6 - й Октет** |
| --------------------- | --------------- | --------------- | --------------- | --------------- | --------------- | --------------- |
| Бинарный              | 1101 111`0`     | 1010 1101       | 1011 1110       | 1110 1111       | 0001 0011       | 0011 0111       |
| Шестнадцатеричный     | D`E`            | AD              | BE              | EF              | 13              | 37              |

---

При использовании `multicast` пакет отправляется только один раз всем хостам в локальной сети, которые затем решают, принимать пакет или нет, в зависимости от своей конфигурации. Адрес `multicast` — это уникальный адрес, как и адрес `broadcast`, с фиксированными значениями октетов. `Broadcast` в сети представляет собой широковещательный вызов, при котором пакеты данных передаются одновременно из одной точки всем участникам сети. Он используется в основном в тех случаях, когда адрес получателя пакета ещё неизвестен. Примером могут служить протоколы `ARP` (`for MAC addresses`) и DHCP (`for IPv4 addresses`).

Определённые значения каждого октета отмечены `green`.

#### Многоадресная рассылка MAC

|**Представительство**|**1 - й Октет**|**2 - й Октет**|**3 - й Октет**|**4 - й Октет**|**5 - й Октет**|**6 - й Октет**|
|---|---|---|---|---|---|---|
|Бинарный|`0000 0001`|`0000 0000`|`0101 1110`|1110 1111|0001 0011|0011 0111|
|Шестнадцатеричный|`01`|`00`|`5E`|EF|13|37|

#### Трансляция MAC

|**Представительство**|**1 - й Октет**|**2 - й Октет**|**3 - й Октет**|**4 - й Октет**|**5 - й Октет**|**6 - й Октет**|
|---|---|---|---|---|---|---|
|Бинарный|`1111 1111`|`1111 1111`|`1111 1111`|`1111 1111`|`1111 1111`|`1111 1111`|
|Шестнадцатеричный|`FF`|`FF`|`FF`|`FF`|`FF`|`FF`|

---

Предпоследний бит в первом октете определяет, является ли это `global OUI`, как определено в стандарте IEEE, или `locally administrated` MAC-адресом.

#### Глобальный OUI

| **Представительство** | **1 - й Октет** | **2 - й Октет** | **3 - й Октет** | **4 - й Октет** | **5 - й Октет** | **6 - й Октет** |
| --------------------- | --------------- | --------------- | --------------- | --------------- | --------------- | --------------- |
| Бинарный              | 1101 11`0`0     | 1010 1101       | 1011 1110       | 1110 1111       | 0001 0011       | 0011 0111       |
| Шестнадцатеричный     | D`C`            | AD              | BE              | EF              | 13              | 37              |

#### Управляемый локально

| **Представительство** | **1 - й Октет** | **2 - й Октет** | **3 - й Октет** | **4 - й Октет** | **5 - й Октет** | **6 - й Октет** |
| --------------------- | --------------- | --------------- | --------------- | --------------- | --------------- | --------------- |
| Бинарный              | 1101 11`1`0     | 1010 1101       | 1011 1110       | 1110 1111       | 0001 0011       | 0011 0111       |
| Шестнадцатеричный     | D`E`            | AD              | BE              | EF              | 13              | 37              |

---

## Протокол Разрешения адресов

MAC-адреса можно изменять, подделывать или манипулировать ими, поэтому не следует полагаться на них как на единственное средство обеспечения безопасности или идентификации. Для защиты от потенциальных атак сетевым администраторам следует внедрять дополнительные меры безопасности, такие как сегментация сети и надёжные протоколы аутентификации.

Существует несколько векторов атак, которые потенциально могут быть реализованы с использованием MAC-адресов:

- `MAC spoofing`Это предполагает изменение MAC-адреса устройства, чтобы он совпадал с MAC-адресом другого устройства. Обычно это делается для получения несанкционированного доступа к сети.
    
- `MAC flooding`Для этого нужно отправить на сетевой коммутатор множество пакетов с разными MAC-адресами, чтобы он исчерпал возможности своей таблицы MAC-адресов и перестал корректно работать.
    
- `MAC address filtering`Некоторые сети могут быть настроены таким образом, чтобы разрешать доступ только устройствам с определёнными MAC-адресами, которые мы потенциально можем использовать, пытаясь получить доступ к сети с помощью поддельного MAC-адреса.
    

---

## Протокол Разрешения адресов

[Протокол разрешения адресов](https://en.wikipedia.org/wiki/Address_Resolution_Protocol) (`ARP`) — это сетевой протокол. Он является важной частью сетевой коммуникации и используется для преобразования IP-адреса сетевого уровня (уровень 3) в MAC-адрес канального уровня (уровень 2). Он сопоставляет IP-адрес хоста с соответствующим ему MAC-адресом, чтобы упростить обмен данными между устройствами в [локальной сети](https://en.wikipedia.org/wiki/Local_area_network) (`LAN`). Когда устройство в локальной сети хочет связаться с другим устройством, оно отправляет широковещательное сообщение, содержащее IP-адрес получателя и собственный MAC-адрес. Устройство с соответствующим IP-адресом отвечает собственным MAC-адресом, после чего два устройства могут напрямую взаимодействовать друг с другом, используя свои MAC-адреса. Этот процесс называется разрешением ARP.

Протокол ARP играет важную роль в процессе сетевой коммуникации, поскольку позволяет устройствам отправлять и получать данные, используя MAC-адреса, а не IP-адреса, что может быть более эффективным. Можно использовать два типа запросов:

#### Запрос ARP

Когда устройство хочет установить связь с другим устройством в локальной сети, оно отправляет ARP-запрос, чтобы преобразовать IP-адрес устройства назначения в его MAC-адрес. Запрос транслируется всем устройствам в локальной сети и содержит IP-адрес устройства назначения. Устройство с соответствующим IP-адресом отвечает своим MAC-адресом.

#### Ответ ARP

Когда устройство получает ARP-запрос, оно отправляет ARP-ответ запрашивающему устройству со своим MAC-адресом. Ответное сообщение содержит IP- и MAC-адреса как запрашивающего, так и отвечающего устройства.

#### Tshark: захват ARP-запросов

  MAC-адреса

```shell-session
1   0.000000 10.129.12.100 -> 10.129.12.255 ARP 60  Who has 10.129.12.101?  Tell 10.129.12.100
2   0.000015 10.129.12.101 -> 10.129.12.100 ARP 60  10.129.12.101 is at AA:AA:AA:AA:AA:AA

3   0.000030 10.129.12.102 -> 10.129.12.255 ARP 60  Who has 10.129.12.103?  Tell 10.129.12.102
4   0.000045 10.129.12.103 -> 10.129.12.102 ARP 60  10.129.12.103 is at BB:BB:BB:BB:BB:BB
```

Сообщение «`who has`» в первой и третьей строках указывает на то, что устройство запрашивает MAC-адрес для указанного IP-адреса, а во второй и четвёртой строках отображается ответ ARP с MAC-адресом устройства назначения.

Однако он также уязвим для таких атак, как [подмена ARP](https://en.wikipedia.org/wiki/ARP_spoofing), которые могут использоваться для перехвата трафика в сети или манипулирования им. Однако для защиты от таких атак важно применять такие меры безопасности, как брандмауэры и системы обнаружения вторжений.

`ARP spoofing`, также известная как `ARP cache poisoning` или `ARP poison routing`, — это атака, которую можно осуществить с помощью таких инструментов, как [Ettercap](https://github.com/Ettercap/ettercap) или [Cain & Abel](https://github.com/xchwarze/Cain), при которой мы отправляем поддельные ARP-сообщения по локальной сети. Цель состоит в том, чтобы связать наш MAC-адрес с IP-адресом легитимного устройства в сети компании, что позволит нам перехватывать трафик, предназначенный для легитимного устройства. Например, это может выглядеть следующим образом:

  MAC-адреса

```shell-session
1   0.000000 10.129.12.100 -> 10.129.12.101 ARP 60  10.129.12.101 is at AA:AA:AA:AA:AA:AA
2   0.000015 10.129.12.100 -> 10.129.12.255 ARP 60  Who has 10.129.12.101?  Tell 10.129.12.100
3   0.000030 10.129.12.101 -> 10.129.12.100 ARP 60  10.129.12.101 is at BB:BB:BB:BB:BB:BB
4   0.000045 10.129.12.100 -> 10.129.12.101 ARP 60  10.129.12.101 is at AA:AA:AA:AA:AA:AA
```

В первой и четвёртой строках показано, как мы (`10.129.12.100`) отправляем целевому устройству поддельные ARP-сообщения, связывая его MAC-адрес с IP-адресом (`10.129.12.101`). Во второй и третьей строках показано, как целевое устройство отправляет ARP-запрос и отвечает нашим MAC-адресом. Это означает, что мы отравили ARP-кэш целевого устройства и теперь весь трафик, предназначенный для него, будет отправляться на наш MAC-адрес.

Мы можем использовать ARP-отравление для выполнения различных действий, таких как кража конфиденциальной информации, перенаправление трафика или запуск MITM-атак. Однако для защиты от подмены ARP важно использовать безопасные сетевые протоколы, такие как IPSec или SSL, и внедрять меры безопасности, такие как брандмауэры и системы обнаружения вторжений.