#windows #AD #htb 

Учетные записи пользователей создаются как в локальных системах (не подключенных к AD), так и в Active Directory, чтобы предоставить пользователю или программе (например, системной службе) возможность входить в систему и получать доступ к ресурсам в соответствии с их правами. При входе пользователя в систему система проверяет его пароль и создает токен доступа. Этот токен описывает состояние безопасности процесса или потока и включает в себя идентификатор безопасности пользователя и его принадлежность к группам. Этот токен отображается всякий раз, когда пользователь взаимодействует с процессом. Учетные записи пользователей используются для того, чтобы сотрудники/подрядчики могли входить в систему и получать доступ к ресурсам, запускать программы или службы в определенном контексте безопасности (например, от имени пользователя с высокими привилегиями, а не от имени учетной записи сетевой службы), а также для управления доступом к объектам и их свойствам, таким как сетевые папки, файлы, приложения и т. д. Пользователи могут быть назначены в группы, которые могут содержать одного или нескольких участников. Эти группы также можно использовать для контроля доступа к ресурсам. Администратору может быть проще один раз назначить права доступа группе (которые наследуют все участники группы), чем многократно назначать их каждому отдельному пользователю. Это упрощает администрирование и позволяет легче предоставлять и отзывать права пользователей.

Возможность создания учётных записей пользователей и управления ими — один из основных элементов Active Directory. Как правило, в каждой компании, с которой мы сталкиваемся, на каждого пользователя приходится как минимум одна учётная запись в Active Directory. У некоторых пользователей может быть две или более учётных записей в зависимости от их должностных обязанностей (например, у ИТ-администратора или сотрудника службы поддержки). Помимо стандартных учётных записей пользователей и администраторов, привязанных к конкретному пользователю, мы часто видим множество служебных учётных записей, которые используются для фонового запуска определённых приложений или служб или для выполнения других важных функций в доменной среде. В организации, где работает 1000 сотрудников, может быть 1200 активных учётных записей или даже больше! Мы также можем видеть организации с сотнями неактивных учётных записей бывших сотрудников, временных/сезонных работников, стажёров и т. д. Некоторые компании должны хранить записи об этих учётных записях для целей аудита, поэтому они деактивируют их (и, будем надеяться, удаляют все привилегии) после увольнения сотрудника, но не удаляют их. Часто можно увидеть подразделение, например `FORMER EMPLOYEES`, в котором содержится много деактивированных учётных записей.

![[Pasted image 20251028160502.png]]

Как мы увидим далее в этом модуле, учётным записям пользователей в Active Directory может быть предоставлено множество прав. Они могут быть настроены как пользователи, имеющие доступ только для чтения к большей части среды (это разрешения, которые получает стандартный пользователь домена), или как администраторы предприятия (с полным контролем над каждым объектом в домене), а также в бесчисленном множестве промежуточных вариантов. Поскольку пользователям может быть назначено множество прав, их можно относительно легко настроить неправильно и предоставить им непреднамеренные права, которыми могут воспользоваться злоумышленники или специалисты по тестированию на проникновение. Учетные записи пользователей представляют собой обширную поверхность для атак и, как правило, являются ключевым объектом для проникновения при тестировании на проникновение. Пользователи часто оказываются самым слабым звеном в любой организации. Трудно контролировать поведение людей и следить за тем, чтобы каждый пользователь не использовал слабые или общие пароли, не устанавливал неавторизованное программное обеспечение, а администраторы не допускали небрежных ошибок или не были слишком снисходительны к управлению учетными записями. Чтобы справиться с этой проблемой, организация должна разработать политики и процедуры для решения проблем, которые могут возникнуть с учетными записями пользователей, а также обеспечить многоуровневую защиту для снижения рисков, связанных с пользователями.

Подробная информация о неправильных настройках и атаках, связанных с пользователями, выходит за рамки данного модуля. Тем не менее важно понимать, какое влияние могут оказывать пользователи в любой сети Active Directory, а также разбираться в различиях между типами пользователей/учётных записей, с которыми мы можем столкнуться.

---

## Локальные Учетные Записи

Локальные учётные записи хранятся локально на определённом сервере или рабочей станции. Этим учётным записям могут быть назначены права на этом хосте как индивидуально, так и через членство в группе. Назначенные права могут действовать только на этом конкретном хосте и не будут распространяться на весь домен. Локальные учётные записи пользователей считаются субъектами безопасности, но могут управлять доступом к ресурсам и обеспечивать их безопасность только на отдельном хосте. В системе Windows по умолчанию создаётся несколько локальных учётных записей пользователей:

- `Administrator`: эта учётная запись имеет идентификатор безопасности `S-1-5-domain-500` и является первой учётной записью, созданной при новой установке Windows. Она имеет полный контроль практически над всеми ресурсами системы. Её нельзя удалить или заблокировать, но можно отключить или переименовать. В Windows 10 и Server 2016 встроенная учётная запись администратора по умолчанию отключена, а во время установки создаётся другая локальная учётная запись в группе локальных администраторов.
    
- `Guest`: эта учётная запись отключена по умолчанию. Цель этой учётной записи — позволить пользователям, у которых нет учётной записи на компьютере, временно войти в систему с ограниченными правами доступа. По умолчанию у неё пустой пароль, и обычно её рекомендуется отключать из соображений безопасности, поскольку анонимный доступ к хосту может представлять угрозу.
    
- `SYSTEM`Учетная запись SYSTEM (или `NT AUTHORITY\SYSTEM`) на хосте Windows — это учетная запись по умолчанию, установленная и используемая операционной системой для выполнения многих внутренних функций. В отличие от учетной записи Root в Linux, `SYSTEM` является учетной записью службы и работает не в том же контексте, что и обычный пользователь. Многие процессы и службы, работающие на хосте, запускаются в контексте SYSTEM. Следует отметить, что для этой учетной записи не существует профиля, но у нее есть права доступа практически ко всему на хосте. Она не отображается в «Диспетчере пользователей» и не может быть добавлена ни в одну группу. Учетная запись `SYSTEM` имеет наивысший уровень разрешений, который можно получить на хосте Windows, и по умолчанию ей предоставлены права полного доступа ко всем файлам в системе Windows.
    
- `Network Service`Это предопределённая локальная учётная запись, используемая диспетчером управления службами (SCM) для запуска служб Windows. Когда служба запускается в контексте этой учётной записи, она предоставляет учётные данные удалённым службам.
    
- `Local Service`Это ещё одна предопределённая локальная учётная запись, используемая диспетчером управления службами (SCM) для запуска служб Windows. Она настроена с минимальными привилегиями на компьютере и предоставляет анонимные учётные данные для доступа к сети.
    

Чтобы лучше понять, как различные учётные записи взаимодействуют друг с другом в отдельной системе Windows и в доменной сети, стоит изучить документацию Microsoft по [локальным учётным записям по умолчанию](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/local-accounts). Уделите немного времени их изучению и разберитесь в нюансах.

---

## Пользователи Домена

Пользователи домена отличаются от локальных пользователей тем, что им предоставляются права доступа к таким ресурсам домена, как файловые серверы, принтеры, хосты внутренней сети и другие объекты, в зависимости от разрешений, предоставленных их учётной записи или группе, членом которой является эта учётная запись. В отличие от локальных пользователей, учётные записи пользователей домена могут входить в систему на любом хосте домена. Дополнительную информацию о различных типах учётных записей Active Directory можно найти по этой [ссылке](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-accounts). Однако следует помнить об учётной записи `KRBTGT` . Это тип локальной учётной записи, встроенной в инфраструктуру AD. Эта учётная запись используется в качестве служебной учётной записи для службы распространения ключей, обеспечивающей аутентификацию и доступ к ресурсам домена. Эта учётная запись является распространённой целью для многих злоумышленников, поскольку получение контроля над ней или доступа к ней позволит злоумышленнику получить неограниченный доступ к домену. Её можно использовать для повышения привилегий и закрепления в домене с помощью таких атак, как [атака «Золотой билет»](https://attack.mitre.org/techniques/T1558/001/).

---

## Атрибуты Именования пользователей

Безопасность в Active Directory можно повысить с помощью набора атрибутов именования пользователей, которые помогают идентифицировать объекты пользователей, например имя для входа или идентификатор. Ниже приведены несколько важных атрибутов именования в AD.

| | |
|---|---|
|`UserPrincipalName` (UPN)|Это основное имя для входа в систему. По умолчанию UPN использует адрес электронной почты пользователя.|
|`ObjectGUID`|Это уникальный идентификатор пользователя. В Active Directory имя атрибута ObjectGUID никогда не меняется и остаётся уникальным, даже если пользователь удалён.|
|`SAMAccountName`|Это имя для входа в систему, которое поддерживает предыдущие версии клиентов и серверов Windows.|
|`objectSID`|Идентификатор безопасности пользователя (SID). Этот атрибут идентифицирует пользователя и его принадлежность к группам во время взаимодействия с сервером в целях обеспечения безопасности.|
|`sIDHistory`|Здесь содержатся предыдущие идентификаторы SID для пользовательского объекта, если он был перемещён из другого домена. Обычно это происходит при миграции из домена в домен. После миграции последний идентификатор SID будет добавлен в свойство `sIDHistory`, а новый идентификатор SID станет его `objectSID`.|

#### Общие Пользовательские Атрибуты

  Учетные записи пользователей и Компьютеров

```powershell-session
PS C:\htb Get-ADUser -Identity htb-student

DistinguishedName : CN=htb student,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
Enabled           : True
GivenName         : htb
Name              : htb student
ObjectClass       : user
ObjectGUID        : aa799587-c641-4c23-a2f7-75850b4dd7e3
SamAccountName    : htb-student
SID               : S-1-5-21-3842939050-3880317879-2865463114-1111
Surname           : student
UserPrincipalName : htb-student@INLANEFREIGHT.LOCAL
```

Чтобы подробнее изучить атрибуты пользовательских объектов, перейдите на эту [страницу](https://docs.microsoft.com/en-us/windows/win32/ad/user-object-attributes). Для любого объекта в AD можно задать множество атрибутов. Многие объекты никогда не будут использоваться или не будут иметь отношения к нам как к специалистам по безопасности. Тем не менее важно ознакомиться с наиболее распространёнными и менее известными атрибутами, которые могут содержать конфиденциальные данные или способствовать проведению атаки.

---

## Машины, объединённые в домен, и машины, не объединённые в домен

Существует несколько способов управления компьютерными ресурсами. Ниже мы рассмотрим различия между хостом, подключённым к домену, и хостом, который находится только в рабочей группе.

#### `Domain joined`

Хосты, подключенные к домену, упрощают обмен информацией внутри предприятия и имеют централизованную точку управления (контроллер домена) для сбора ресурсов, политик и обновлений. Хост, подключенный к домену, получает все необходимые конфигурации и изменения через групповую политику домена. Преимущество такого подхода в том, что пользователь домена может входить в систему и получать доступ к ресурсам с любого хоста, подключенного к домену, а не только с того, на котором он работает. Это типичная настройка для корпоративных сред.

#### `Non-domain joined`

Компьютеры, не присоединенные к домену, или компьютеры в `workgroup` не управляются с помощью политики домена. Учитывая это, совместное использование ресурсов за пределами локальной сети становится гораздо более сложной задачей, чем в домене. Это нормально для компьютеров, предназначенных для домашнего использования, или кластеров малого бизнеса в одной локальной сети. Преимущество такой настройки заключается в том, что отдельные пользователи сами отвечают за любые изменения, которые они хотят внести в свой компьютер. Учетные записи пользователей на компьютере в рабочей группе существуют только на этом компьютере, а профили не переносятся на другие компьютеры в рабочей группе.

Важно отметить, что учётная запись компьютера (доступ на уровне `NT AUTHORITY\SYSTEM`) в среде Active Directory будет иметь большинство тех же прав, что и стандартная учётная запись пользователя домена. Это важно, потому что нам не всегда нужно получать набор действительных учётных данных для отдельной учётной записи пользователя, чтобы начать сканирование и атаку на домен (как мы увидим в следующих модулях). Мы можем получить доступ на уровне `SYSTEM` к хосту Windows, присоединённому к домену, с помощью успешного эксплойта удалённого выполнения кода или путём повышения привилегий на хосте. Этот доступ часто упускают из виду, считая, что он полезен только для кражи конфиденциальных данных (например, паролей, SSH-ключей, конфиденциальных файлов и т. д.) на определённом хосте. На самом деле доступ в контексте `SYSTEM`-аккаунта позволяет нам читать большую часть данных в домене и является отличной отправной точкой для сбора как можно большего количества информации о домене, прежде чем приступать к атакам, связанным с Active Directory.