#htb #server 

Когда дело доходит до управления сервером, одним из наиболее важных аспектов (помимо безопасности) является обеспечение высокой скорости, надёжности и готовности сервера выполнять задачи, для которых он был создан. Поэтому настоятельно рекомендуется поддерживать сервер в актуальном состоянии и настраивать его таким образом, чтобы у него было достаточно ресурсов для выполнения всех необходимых задач. Ещё одним важным аспектом является доступ к серверу. Вместо того чтобы настраивать все сервисы, которые мы хотим использовать, а затем ограничивать доступ к серверу, мы поступим наоборот. В противном случае некоторые точки доступа к нашему собственному серверу могут остаться незамеченными, что сделает нас уязвимыми. Поэтому, когда мы начинаем создавать удалённый сервер, сначала нам нужно убедиться, что у сервера есть только один способ доступа с использованием безопасного протокола для связи. Лучше всего с самого начала сделать так, чтобы доступ к серверу осуществлялся только через SSH с использованием ключа аутентификации, а не пароля.

Усиление защиты доступа по SSH — один из важных аспектов. Другой аспект, на котором нам также нужно сосредоточиться, — это управление ключами. Когда нам нужно управлять всего несколькими серверами, это может быть довольно просто и понятно. Однако, когда на вас ложится ответственность за управление несколькими сотнями серверов, возникает необходимость в эффективном управлении ими. В таком случае организации и предприятия используют комбинацию [Teleport](https://goteleport.com/) и [Ansible](https://docs.ansible.com/ansible/latest/index.html#).

При настройке сервера рекомендуется придерживаться принципа `Zero Trust` — `No one and nothing - whether inside or outside a network - can be trusted automatically`. Представьте, что это здание с высоким уровнем безопасности. Даже если вы сотрудник, вам нужно предъявлять удостоверение и проходить контроль при каждом входе, и вы получаете доступ только в те помещения, которые вам нужны.

---

## SSH - агент

SSH-агент — это программа, которая работает в фоновом режиме и обычно устанавливается в большинстве систем Linux по умолчанию. Мы используем инструмент `ssh` для безопасного подключения к удалённым серверам, а SSH-агент помогает хранить ваши SSH-ключи и управлять ими, которые похожи на ваш идентификатор, используемый для подтверждения вашей личности на сервере. Давайте сначала укрепим наш SSH-сервер и сделаем его немного более безопасным. В дистрибутивах Ubuntu и Debian файл конфигурации SSH-сервера находится в `/etc/ssh/sshd_config`.

#### Серверная сторона

  Управление сервером

```shell-session
cry0l1t3@MyVPS:~$ vim /etc/ssh/sshd_config
```

Вы увидите множество различных настроек, которые можно включить, но мы настоятельно рекомендуем вам в первую очередь изменить следующие:

Код: bash

```bash
PermitRootLogin no
PubkeyAuthentication yes
PasswordAuthentication no
X11Forwarding no
Port 4444
AllowUsers cry0l1t3
```

В этом примере мы отключили доступ для пользователя `root` через SSH и разрешили подключения по TCP-порту 4444 для пользователя `cry0l1t3` только с помощью аутентификации по ключу SSH. После внесения этих изменений необходимо перезапустить SSH-сервер.

  Управление сервером

```shell-session
cry0l1t3@MyVPS:~$ sudo service ssh restart
```

Чтобы использовать SSH-агент, нам нужно сделать несколько вещей. Во-первых, нам нужен очень надёжный SSH-ключ. Один из наиболее эффективных способов заключается в следующем:

#### Клиентская сторона

  Управление сервером

```shell-session
cry0l1t3@htb:~$ ssh-keygen -t ed25519 -f ~/.ssh/cry0l1t3

Generating public/private ed25519 key pair.
Enter passphrase (empty for no passphrase): ****************************
Enter same passphrase again: ****************************

Your identification has been saved in /home/cry0l1t3/.ssh/cry0l1t3
Your public key has been saved in /home/cry0l1t3/.ssh/cry0l1t3.pub
The key fingerprint is:
SHA256:5TNgGHaqFsIhfqbsFPxa2PllgV2NZdHacaxNddlA0WI cry0l1t3@MyVPS
The key's randomart image is:
+--[ED25519 256]--+
|. .   o ..++o.=+*|
|oo . .o=.... oE=+|
| +oo..ooo . o.*. |
|. O..o ..+ . o . |
| = =o  oS +      |
|o o.. o    o     |
| o   .           |
|                 |
|                 |
+----[SHA256]-----+
```

Убедитесь, что на этом этапе вы добавили свой открытый ключ SSH (`<your_key>.pub`) на удалённый сервер в `~/.ssh/authorized_keys` и установили соответствующие разрешения для этого файла.

  Управление сервером

```shell-session
# Remote Server
cry0l1t3@MyVPS:~$ sudo chmod 600 ~/.ssh/authorized_keys
```

Затем нам нужно добавить закрытый ключ в SSH-агент и создать файл конфигурации для SSH-агента в каталоге `.ssh`.

  Управление сервером

```shell-session
cry0l1t3@MyVPS:~$ ssh-add ~/.ssh/cry0l1t3
Enter passphrase for /home/cry0l1t3/.ssh/cry0l1t3:
Identity added: /home/cry0l1t3/.ssh/cry0l1t3 (cry0l1t3@MyVPS)

cry0l1t3@MyVPS:~$ vim ~/.ssh/config
```

В этом файле конфигурации мы зададим имя, которое будем использовать для сервера, его IP-адрес или домен, файл идентификации, порт, пользователя и укажем SSH использовать только указанный ключ. и не пытаться использовать другие ключи. Это сделает соединения немного быстрее и значительно безопаснее.

Код: bash

```bash
Host MyVPS
    HostName <IP Address/domain name>
    IdentityFile ~/.ssh/cry0l1t3
    Port 4444
    User cry0l1t3
    IdentitiesOnly yes
```

С помощью следующей команды мы запускаем SSH-агент в нашем сеансе терминала. Если вы хотите запускать SSH-агент автоматически, вы можете добавить эту команду в свой файл `~/.bashrc` или `~/.zshrc`

  Управление сервером

```shell-session
cry0l1t3@htb:~$ eval $(ssh-agent)
```

Теперь мы можем использовать SSH-клиент, просто введя имя (`MyVPS`), которое мы задали для этого сервера, и подключиться к нему.

  Управление сервером

```shell-session
cry0l1t3@htb:~$ ssh MyVPS
```

---

## Управление паролями и секретами

Управление паролями — это практика создания, хранения и систематизации паролей и секретных кодов для обеспечения безопасности доступа к учётным записям и системам, при этом требующая меньше усилий при использовании. Поскольку большинство людей используют один пароль (который зачастую даже не является надёжным), настоятельно рекомендуется использовать менеджер паролей, который может генерировать и хранить сложные пароли. Существует множество различных вариантов на выбор:

|[Proton](https://proton.me/pass)|[Bitwarden](https://bitwarden.com/)|[1Password](https://1password.com/)|[Passbolt](https://www.passbolt.com/)|[Psono](https://psono.com/)|[Passky](https://passky.org/)|[OpenBao](https://openbao.org/)|
|---|---|---|---|---|---|---|

Вы можете использовать любой из этих менеджеров, поскольку все они предоставляют подходящие решения для безопасного хранения данных. За исключением Psono и Passbolt, все упомянутые менеджеры используют сквозное шифрование (E2EE), которое позволяет расшифровать данные только пользователю. E2EE — это модель безопасности, при которой данные шифруются на устройстве отправителя и могут быть расшифрованы только на устройстве получателя. Никто, кроме отправителя и получателя (включая поставщиков услуг), не может получить доступ к незашифрованным (открытым) данным.

Psono использует шифрование на стороне клиента, а Passbolt — шифрование GPG. Шифрование GPG использует закрытые и открытые ключи, как в SSH. Открытый ключ (которым можно поделиться с другими) используется для шифрования, и только тот, у кого есть закрытый ключ (которым ни в коем случае нельзя делиться с другими), может расшифровать данные. Шифрование на стороне клиента означает, что данные шифруются на устройстве перед отправкой.

Кроме того, на торговой площадке Linode есть предварительно настроенные образы, которые можно использовать для быстрого размещения таких менеджеров.

![На экране выбора приложений Linode Marketplace отображаются варианты для OpenBao, HashiCorp Vault, Passbolt Community Edition и Passky.](https://academy.hackthebox.com/storage/modules/87/servm1.png)

---

## Хостинг Git

Git — это распределённая система контроля версий (DVCS), которая помогает разработчикам управлять изменениями в файлах, в частности в коде, с течением времени. Она позволяет нескольким людям совместно работать над проектом, отслеживать историю изменений и эффективно поддерживать разные версии своей работы.

Например, если вы выпускаете новую версию своего программного обеспечения или инструмента и что-то ломается, вы всегда можете вернуться к предыдущей версии. Кроме того, вы можете одновременно работать над любым количеством функций, не нарушая работу оригинальной версии вашего программного обеспечения, а затем объединить их с оригинальной веткой после тестирования. Этот процесс также известен как непрерывная интеграция и непрерывная поставка или развёртывание (CI/CD).

Помимо разработки инструментов и программного обеспечения, мы можем использовать частные репозитории для своих собственных предпочтений и нужд. Например, мы можем хранить наши точечные файлы (файлы конфигурации) для нашей среды или сервисов. Это упрощает настройку новых виртуальных машин, поскольку мы можем легко клонировать репозиторий и заменить необходимые файлы конфигурации.

Существует множество провайдеров, использующих эту технологию, и многие из них при необходимости можно разместить на собственном сервере.

|[Github](https://github.com/)|[Gitlab](https://about.gitlab.com/)|[BitBucket](https://bitbucket.org/)|[Gitea](https://about.gitea.com/)|[OneDev](https://onedev.io/)|
|---|---|---|---|---|

Linode также предоставляет предварительно настроенные изображения, которые можно использовать сразу.

![На экране выбора приложений Linode Marketplace в категории «Разработка» отображаются Gitea и GitLab.](https://academy.hackthebox.com/storage/modules/87/servm2.png)

 