#htb #linux 

Протоколы удалённого рабочего стола используются в Windows, Linux и macOS для предоставления удалённого графического доступа к системе. Эти протоколы позволяют администраторам удалённо управлять системами, устранять неполадки и обновлять системы, что делает их незаменимыми инструментами для таких сценариев. Для этого администратор подключается к удалённой системе с помощью соответствующего протокола в зависимости от операционной системы, которой он управляет.

Например, когда администраторам нужно установить программное обеспечение или управлять удалённой системой, они используют соответствующий протокол для создания графического сеанса. Два наиболее распространённых протокола для такого типа доступа:

- `Remote Desktop Protocol` (`RDP`): в основном используется в средах Windows. RDP позволяет администраторам подключаться удалённо и взаимодействовать с рабочим столом компьютера с Windows так, как если бы они сидели прямо перед ним.
    
- `Virtual Network Computing` (`VNC`): популярный протокол в средах Linux, хотя он также является кроссплатформенным. VNC обеспечивает графический доступ к удалённым рабочим столам, позволяя администраторам выполнять задачи в системах Linux аналогично RDP в Windows.
    

Представьте, что протоколы удалённого доступа к рабочему столу — это разные наборы ключей для разных типов зданий. RDP — это ключ, специально созданный для зданий с Windows, который позволяет удалённо получать доступ к комнатам (рабочим столам) и управлять ими, как если бы вы находились внутри. VNC, с другой стороны, больше похож на универсальный ключ, который подходит для многих зданий, но часто используется для структур с Linux. Точно так же, как вы используете подходящий ключ в зависимости от здания, администраторы выбирают правильный протокол в зависимости от системы, к которой им нужно получить доступ и которой нужно управлять.

---

## XServer

XServer — это пользовательская часть `X Window System network protocol` (`X11` / `X`). `X11` — это фиксированная система, состоящая из набора протоколов и приложений, которые позволяют нам вызывать окна приложений на дисплеях в графическом пользовательском интерфейсе. X11 преобладает в системах Unix, но X-серверы доступны и для других операционных систем. В настоящее время XServer входит в состав почти каждой настольной версии Ubuntu и её производных и не требует отдельной установки.

Когда на компьютере с Linux запускается рабочий стол, взаимодействие графического пользовательского интерфейса с операционной системой происходит через X-сервер. Используется внутренняя сеть компьютера, даже если он не подключен к сети. Преимущество X-протокола в том, что он прозрачен для сети. Этот протокол в основном использует TCP/IP в качестве транспортной базы, но может использоваться и на чистых сокетах Unix. Порты, используемые для X-сервера, обычно находятся в диапазоне `TCP/6001-6009`, что позволяет осуществлять связь между клиентом и сервером. При запуске нового сеанса рабочего стола через X-сервер `TCP port 6000` будет открыт для первого X-дисплея `:0`. Этот диапазон портов позволяет серверу выполнять такие задачи, как размещение приложений, а также предоставление услуг клиентам. Они часто используются для обеспечения удалённого доступа к системе, позволяя пользователям получать доступ к приложениям и данным из любой точки мира. Кроме того, эти порты необходимы для безопасного обмена файлами и данными, что делает их неотъемлемой частью Open X Server. Таким образом, X-сервер не зависит от локального компьютера, его можно использовать для доступа к другим компьютерам, а другие компьютеры могут использовать локальный X-сервер. При условии, что и на локальном, и на удалённом компьютере установлены системы Unix/Linux, дополнительные протоколы, такие как VNC и RDP, не требуются. VNC и RDP генерируют графический вывод на удалённом компьютере и передают его по сети. В то время как при использовании X11 он отображается на локальном компьютере. Это экономит трафик и снижает нагрузку на удалённый компьютер. Однако существенным недостатком X11 является незашифрованная передача данных. Однако эту проблему можно решить с помощью туннелирования протокола SSH.

Для этого нам нужно разрешить переадресацию X11 в файле конфигурации SSH (`/etc/ssh/sshd_config`) на сервере, предоставляющем приложение, изменив этот параметр на `yes`.

#### X11Forwarding
  Протоколы удаленного рабочего стола в Linux

```shell-session
Barlogsha@htb[/htb]$ cat /etc/ssh/sshd_config | grep X11Forwarding

X11Forwarding yes
```

При этом мы можем запустить приложение из нашего клиента с помощью следующей команды:

  Протоколы удаленного рабочего стола в Linux

```shell-session
Barlogsha@htb[/htb]$ ssh -X htb-student@10.129.23.11 /usr/bin/firefox

htb-student@10.129.14.130's password: ********
<SKIP>
```

![[Pasted image 20250907170931.png]]

#### Безопасность X11

Как мы упоминали ранее, X11 по умолчанию не является безопасным протоколом, поскольку его связь не зашифрована. Поэтому при работе с целями на базе Linux нам следует обращать внимание на эти TCP-порты (6000–6010). Без надлежащих мер безопасности открытый `X server` может передавать конфиденциальные данные по сети. Например, злоумышленник в той же сети может прочитать содержимое окон `X server's` без ведома пользователя, и ему даже не придётся выполнять традиционный сетевой сниффинг. Эта уязвимость позволяет совершать серьёзные нарушения безопасности. Злоумышленник может перехватить конфиденциальную информацию, такую как пароли или личные данные, просто используя стандартные инструменты X11, такие как `xwd` (который делает скриншоты окон X) и `xgrabsc`.

Кроме того, на протяжении многих лет были обнаружены и другие уязвимости в системе безопасности, связанные с библиотеками XServer и самим программным обеспечением. Например, в 2017 году в XOrg Server, реализации оконной системы X с открытым исходным кодом, была обнаружена группа уязвимостей. Они были связаны со слабыми, предсказуемыми или поддающимися перебору ключами сеанса, использование которых могло позволить злоумышленнику выполнить произвольный код в сеансе Xorg другого пользователя. Пострадал широкий спектр систем, таких как Unix, Red Hat Enterprise Linux, Ubuntu Linux и SUSE Linux. Эти уязвимости стали известны как CVE-2017-2624, CVE-2017-2625 и CVE-2017-2626. [В этой](https://www.x41-dsec.de/lab/advisories/x41-2017-001-xorg/) статье представлен отличный обзор.

---

## XDMCP

Протокол `X Display Manager Control Protocol` (`XDMCP`) используется `X Display Manager` для связи через UDP-порт 177 между X-терминалами и компьютерами, работающими под управлением Unix/Linux. Он используется для управления удалёнными сеансами X Window на других компьютерах и часто применяется системными администраторами Linux для предоставления доступа к удалённым рабочим столам. XDMCP — небезопасный протокол, и его не следует использовать в средах, требующих высокого уровня безопасности. С его помощью можно перенаправить весь графический пользовательский интерфейс (`GUI`) (например, KDE или Gnome) на соответствующий клиент. Чтобы система Linux могла выступать в качестве сервера XDMCP, на сервере должна быть установлена и настроена система X с графическим интерфейсом. После запуска компьютера пользователь должен получить доступ к графическому интерфейсу.

Один из возможных способов использования XDMCP — это атака типа «человек посередине». При такой атаке злоумышленник перехватывает связь между удалённым компьютером и сервером X Window System и выдаёт себя за одну из сторон, чтобы получить несанкционированный доступ к серверу. Затем злоумышленник может использовать сервер для выполнения произвольных команд, доступа к конфиденциальным данным или выполнения других действий, которые могут поставить под угрозу безопасность системы.

---

## VNC

`Virtual Network Computing` (`VNC`) — это система удалённого доступа к рабочему столу, основанная на протоколе RFB, которая позволяет пользователям удалённо управлять компьютером. Она позволяет пользователю удалённо просматривать рабочую среду и взаимодействовать с ней по сетевому соединению. Пользователь может управлять удалённым компьютером так, как если бы он находился перед ним. Это также один из наиболее распространённых протоколов для удалённого графического подключения к хостам Linux.

VNC, как правило, считается безопасным. Он использует шифрование для защиты данных при передаче и требует аутентификации, прежде чем пользователь сможет получить доступ. Администраторы используют VNC для доступа к компьютерам, к которым нет физического доступа. Это можно использовать для устранения неполадок и обслуживания серверов, доступа к приложениям на других компьютерах или предоставления удалённого доступа к рабочим станциям. VNC также можно использовать для демонстрации экрана, что позволяет нескольким пользователям совместно работать над проектом или устранять неполадки.

Существует две разные концепции VNC-серверов. Обычный сервер предоставляет пользователю доступ к реальному экрану хост-компьютера. Поскольку клавиатура и мышь остаются доступными на удалённом компьютере, рекомендуется использовать такую конфигурацию. Вторая группа серверных программ позволяет пользователям входить в виртуальные сеансы, аналогично концепции терминального сервера.

Программы-серверы и программы-клиенты для VNC доступны для всех распространённых операционных систем. Поэтому многие ИТ-услуги предоставляются с помощью VNC. Проприетарные программы TeamViewer и RDP используются аналогичным образом.

Традиционно сервер VNC прослушивает TCP-порт 5900. Таким образом, он предлагает `display 0` там. Другие дисплеи могут быть подключены через дополнительные порты, в основном `590[x]` где `x` — номер дисплея. Для подключения нескольких дисплеев используется более высокий TCP-порт, например 5901, 5902, 5903 и т. д.

Для таких VNC-соединений используется множество различных инструментов. Среди них, например:

- [TigerVNC](https://tigervnc.org/)
- [TightVNC](https://www.tightvnc.com/)
- [RealVNC](https://www.realvnc.com/en/)
- [UltraVNC](https://uvnc.com/)

Наиболее часто используемыми инструментами для таких подключений являются UltraVNC и RealVNC из-за их шифрования и более высокого уровня безопасности.

В этом примере мы настраиваем сервер `TigerVNC` и для этого нам, помимо прочего, нужен менеджер рабочего стола `XFCE4` , так как соединения VNC с GNOME несколько нестабильны. Поэтому нам нужно установить необходимые пакеты и создать пароль для подключения VNC.

#### Установка TigerVNC

  Протоколы удаленного рабочего стола в Linux

```shell-session
htb-student@ubuntu:~$ sudo apt install xfce4 xfce4-goodies tigervnc-standalone-server -y
htb-student@ubuntu:~$ vncpasswd 

Password: ******
Verify: ******
Would you like to enter a view-only password (y/n)? n
```

Во время установки в домашнем каталоге создаётся скрытая папка с именем `.vnc`. Затем нам нужно создать два дополнительных файла: `xstartup` и `config`. Файл `xstartup` определяет, как создаётся сеанс VNC в связи с диспетчером отображения, а `config` определяет его настройки.

#### Конфигурация

  Протоколы удаленного рабочего стола в Linux

```shell-session
htb-student@ubuntu:~$ touch ~/.vnc/xstartup ~/.vnc/config
htb-student@ubuntu:~$ cat <<EOT >> ~/.vnc/xstartup

#!/bin/bash
unset SESSION_MANAGER
unset DBUS_SESSION_BUS_ADDRESS
/usr/bin/startxfce4
[ -x /etc/vnc/xstartup ] && exec /etc/vnc/xstartup
[ -r $HOME/.Xresources ] && xrdb $HOME/.Xresources
x-window-manager &
EOT
```

  Протоколы удаленного рабочего стола в Linux

```shell-session
htb-student@ubuntu:~$ cat <<EOT >> ~/.vnc/config

geometry=1920x1080
dpi=96
EOT
```

Кроме того, `xstartup` исполняемому файлу необходимы права для запуска службой.

  Протоколы удаленного рабочего стола в Linux

```shell-session
htb-student@ubuntu:~$ chmod +x ~/.vnc/xstartup
```

Теперь мы можем запустить VNC-сервер.

#### Запустите VNC-сервер

  Протоколы удаленного рабочего стола в Linux

```shell-session
htb-student@ubuntu:~$ vncserver

New 'linux:1 (htb-student)' desktop at :1 on machine linux

Starting applications specified in /home/htb-student/.vnc/xstartup
Log file is /home/htb-student/.vnc/linux:1.log

Use xtigervncviewer -SecurityTypes VncAuth -passwd /home/htb-student/.vnc/passwd :1 to connect to the VNC server.
```

Кроме того, мы можем отобразить все сеансы с соответствующими портами и идентификатором процесса.

#### Список Сеансов

  Протоколы удаленного рабочего стола в Linux

```shell-session
htb-student@ubuntu:~$ vncserver -list

TigerVNC server sessions:

X DISPLAY #     RFB PORT #      PROCESS ID
:1              5901            79746
```

Чтобы зашифровать соединение и сделать его более безопасным, мы можем создать SSH-туннель, через который будет проходить всё соединение. Подробнее о туннелировании мы узнаем в модуле [«Переадресация, туннелирование и переадресация портов»](https://academy.hackthebox.com/module/details/158).

#### Настройка SSH-туннеля

  Протоколы удаленного рабочего стола в Linux

```shell-session
Barlogsha@htb[/htb]$ ssh -L 5901:127.0.0.1:5901 -N -f -l htb-student 10.129.14.130

htb-student@10.129.14.130's password: *******
```

Наконец, мы можем подключиться к серверу через SSH-туннель с помощью `xtightvncviewer`.

#### Подключение к VNC-серверу

  Протоколы удаленного рабочего стола в Linux

```shell-session
Barlogsha@htb[/htb]$ xtightvncviewer localhost:5901

Connected to RFB server, using protocol version 3.8
Performing standard VNC authentication

Password: ******

Authentication successful
Desktop name "linux:1 (htb-student)"
VNC server default format:
  32 bits per pixel.
  Least significant byte first in each pixel.
  True colour: max red 255 green 255 blue 255, shift red 16 green 8 blue 0
Using default colormap which is TrueColor.  Pixel format:
  32 bits per pixel.
  Least significant byte first in each pixel.
  True colour: max red 255 green 255 blue 255, shift red 16 green 8 blue 0
Same machine: preferring raw encoding
```

![[Pasted image 20250907170943.png]]
