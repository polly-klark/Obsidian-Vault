#windows #htb 

Существует 5 типов файловых систем Windows: FAT12, FAT16, FAT32, NTFS и exFAT. FAT12 и FAT16 больше не используются в современных операционных системах Windows. В этом курсе мы рассмотрим файловые системы FAT32 и exFAT, но основное внимание уделим файловой системе NTFS.

FAT32 (таблица размещения файлов) широко используется на многих типах запоминающих устройств, таких как USB-накопители и SD-карты, но также может использоваться для форматирования жёстких дисков. Цифра «32» в названии указывает на то, что FAT32 использует 32 бита данных для идентификации кластеров данных на запоминающем устройстве.

**`Pros of FAT32:`**

- Совместимость с устройствами — его можно использовать на компьютерах, цифровых камерах, игровых консолях, смартфонах, планшетах и других устройствах.
- Кроссплатформенная совместимость с операционными системами — работает во всех операционных системах Windows, начиная с Windows 95, а также поддерживается MacOS и Linux.

**`Cons of FAT32:`**

- Может использоваться только с файлами размером менее 4 ГБ.
- Нет встроенных функций защиты данных или сжатия файлов.
- Необходимо использовать сторонние инструменты для шифрования файлов.

NTFS (файловая система на основе новых технологий) является файловой системой Windows по умолчанию, начиная с Windows NT 3.1. Помимо устранения недостатков FAT32, NTFS также лучше поддерживает метаданные и обеспечивает более высокую производительность благодаря улучшенной структуре данных.

**`Pros of NTFS:`**

- NTFS надёжна и может восстановить целостность файловой системы в случае сбоя системы или отключения питания.
- Обеспечивает безопасность, позволяя нам устанавливать подробные разрешения как для файлов, так и для папок.
- Поддерживает разделы очень большого размера.
- Имеет встроенную функцию ведения журнала, то есть изменения файлов (добавление, изменение, удаление) регистрируются.

**`Cons of NTFS:`**

- Большинство мобильных устройств изначально не поддерживают NTFS.
- Старые мультимедийные устройства, такие как телевизоры и цифровые камеры, не поддерживают накопители NTFS.

---

## Разрешения

Файловая система NTFS поддерживает множество базовых и расширенных разрешений. Вот некоторые из основных типов разрешений:

|Тип разрешения|Описание|
|---|---|
|Полный Контроль|Позволяет читать, записывать, изменять, удалять файлы / папки.|
|Изменять|Позволяет читать, записывать и удалять файлы / папки.|
|Список Содержимого папки|Позволяет просматривать и перечислять папки и подпапки, а также запускать файлы. Папки наследуют это разрешение.|
|Прочитать и выполнить|Позволяет просматривать и перечислять файлы и подпапки, а также запускать файлы. Файлы и папки наследуют это разрешение.|
|Написать|Позволяет добавлять файлы в папки и вложенные папки и записывать данные в файл.|
|Читать|Позволяет просматривать и перечислять папки и подпапки, а также просматривать содержимое файлов.|
|Пересекающая папка|Это позволяет или запрещает перемещение по папкам для доступа к другим файлам или папкам. Например, у пользователя может не быть разрешения на просмотр содержимого каталога или файлов в каталоге документов или веб-приложений в этом примере: c:\users\bsmith\documents\webapps\backups\backup_02042020.zip, но с разрешением на перемещение по папкам он может получить доступ к архиву резервных копий.|

Файлы и папки наследуют разрешения NTFS своей родительской папки для упрощения администрирования, поэтому администраторам не нужно явно устанавливать разрешения для каждого файла и папки, так как это заняло бы очень много времени. Если разрешения нужно установить явно, администратор может отключить наследование разрешений для нужных файлов и папок, а затем установить разрешения для каждого из них.

---

## Список контроля доступа для контроля целостности (icacls)

Разрешениями NTFS для файлов и папок в Windows можно управлять с помощью графического интерфейса проводника на вкладке «Безопасность». Помимо графического интерфейса, мы также можем управлять разрешениями NTFS для файлов в Windows из командной строки с помощью утилиты icacls.

Мы можем вывести список разрешений NTFS для конкретного каталога, запустив либо `icacls` из рабочего каталога, либо `icacls C:\Windows` для каталога, в котором мы сейчас не находимся.

  Файловая система

```cmd-session
C:\htb> icacls c:\windows
c:\windows NT SERVICE\TrustedInstaller:(F)
           NT SERVICE\TrustedInstaller:(CI)(IO)(F)
           NT AUTHORITY\SYSTEM:(M)
           NT AUTHORITY\SYSTEM:(OI)(CI)(IO)(F)
           BUILTIN\Administrators:(M)
           BUILTIN\Administrators:(OI)(CI)(IO)(F)
           BUILTIN\Users:(RX)
           BUILTIN\Users:(OI)(CI)(IO)(GR,GE)
           CREATOR OWNER:(OI)(CI)(IO)(F)
           APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(RX)
           APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(OI)(CI)(IO)(GR,GE)
           APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(RX)
           APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(OI)(CI)(IO)(GR,GE)

Successfully processed 1 files; Failed processing 0 files
```

Уровень доступа к ресурсу указывается после имени каждого пользователя в выводе. Возможные настройки наследования:

- `(CI)`: контейнер наследует
- `(OI)`: объект наследуется
- `(IO)`: наследовать только
- `(NP)`: не распространять , наследовать
- `(I)`: разрешение, унаследованное от родительского контейнера

В приведённом выше примере учётная запись `NT AUTHORITY\SYSTEM` имеет права наследования объекта, контейнера, только наследования и полного доступа. Это означает, что данная учётная запись имеет полный контроль над всеми объектами файловой системы в этом каталоге и подкаталогах.

Основными правами доступа являются следующие:

- `F` : полный доступ
- `D` : удалить доступ
- `N` : нет доступа
- `M` : изменить доступ
- `RX` : доступ к чтению и выполнению
- `R` : доступ только для чтения
- `W` : доступ только для записи

Мы можем добавлять и удалять разрешения через командную строку с помощью `icacls`. Здесь мы выполняем `icacls` в контексте учётной записи локального администратора, показывая каталог `C:\users`, в котором у пользователя `joe` нет прав на запись.

  Файловая система

```cmd-session
C:\htb> icacls c:\Users
c:\Users NT AUTHORITY\SYSTEM:(OI)(CI)(F)
         BUILTIN\Administrators:(OI)(CI)(F)
         BUILTIN\Users:(RX)
         BUILTIN\Users:(OI)(CI)(IO)(GR,GE)
         Everyone:(RX)
         Everyone:(OI)(CI)(IO)(GR,GE)

Successfully processed 1 files; Failed processing 0 files
```

С помощью команды `icacls c:\users /grant joe:f` мы можем предоставить пользователю joe полный доступ к каталогу, но, поскольку `(oi)` и `(ci)` не были включены в команду, пользователь joe будет иметь доступ только к папке `c:\users`, но не к подкаталогам и файлам, содержащимся в них.

  Файловая система

```cmd-session
C:\htb> icacls c:\users /grant joe:f
processed file: c:\users
Successfully processed 1 files; Failed processing 0 files
```

  Файловая система

```cmd-session
C:\htb> >icacls c:\users
c:\users WS01\joe:(F)
         NT AUTHORITY\SYSTEM:(OI)(CI)(F)
         BUILTIN\Administrators:(OI)(CI)(F)
         BUILTIN\Users:(RX)
         BUILTIN\Users:(OI)(CI)(IO)(GR,GE)
         Everyone:(RX)
         Everyone:(OI)(CI)(IO)(GR,GE)

Successfully processed 1 files; Failed processing 0 files
```

*BUILTIN\Administrators - группа однминистраторов
BUILTIN\Users - группа пользователей
NT AUTHORITY\SYSTEM - система*

Эти разрешения могут быть отозваны с помощью команды `icacls c:\users /remove joe`.

`icacls` Это очень мощное средство, которое можно использовать в доменной среде, чтобы предоставить определённым пользователям или группам конкретные разрешения на доступ к файлу или папке, явно запретить доступ, включить или отключить наследование разрешений и изменить владельца каталога/файла.

Полный список аргументов `icacls` командной строки и подробные настройки разрешений можно найти [здесь](https://ss64.com/nt/icacls.html).