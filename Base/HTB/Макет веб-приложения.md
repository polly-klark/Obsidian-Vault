#htb #web 

Не существует двух одинаковых веб-приложений. Компании создают веб-приложения для самых разных целей и аудиторий. Веб-приложения разрабатываются и программируются по-разному, а внутренняя инфраструктура может быть настроена множеством различных способов. Важно понимать, как веб-приложения работают «за кулисами», какова их структура, из каких компонентов они состоят и как их можно настроить в инфраструктуре компании.

Структура веб-приложений состоит из множества различных уровней, которые можно разделить на три основные категории:

|**Категория**|**Описание**|
|---|---|
|`Web Application Infrastructure`|Описывает структуру необходимых компонентов, таких как база данных, которые нужны для корректной работы веб-приложения. Поскольку веб-приложение можно настроить для работы на отдельном сервере, важно знать, к какому серверу базы данных ему нужен доступ.|
|`Web Application Components`|Компоненты, из которых состоит веб-приложение, представляют собой все элементы, с которыми взаимодействует веб-приложение. Они делятся на следующие три категории: `UI/UX`, `Client`, и `Server` компоненты.|
|`Web Application Architecture`|Архитектура включает в себя все взаимосвязи между различными компонентами веб-приложения.|

---

## Инфраструктура веб-приложений

Веб-приложения могут использовать различные инфраструктуры. Они также называются `models`. Наиболее распространённые из них можно разделить на следующие четыре типа:

- `Client-Server`
- `One Server`
- `Many Servers - One Database`
- `Many Servers - Many Databases`

---

#### Клиент-сервер

Веб-приложения часто используют `client-server` модель. Сервер размещает веб-приложение в рамках клиент-серверной модели и предоставляет к нему доступ всем клиентам.

![[Pasted image 20251221201507.png]]

В этой модели веб-приложения состоят из двух типов компонентов: интерфейсных, которые обычно интерпретируются и выполняются на стороне клиента (в браузере), и серверных, которые обычно компилируются, интерпретируются и выполняются на сервере хостинга.

Когда клиент переходит по URL-адресу веб-приложения (веб-адресу, например https://www.acme.local), сервер использует основной интерфейс веб-приложения (`UI`). Как только пользователь нажимает на кнопку или запрашивает определенную функцию, браузер отправляет HTTP-веб-запрос серверу, который интерпретирует этот запрос и выполняет необходимые задачи для завершения запроса (т. е. вход пользователя в систему, добавление товара в корзину, переход на другую страницу и т.д.). Как только сервер получает необходимые данные, он отправляет результат обратно в браузер клиента, отображая результат в удобочитаемом виде.

`This website we are currently interacting with is also a web application, developed and hosted by Hack The Box (webserver), and we access it and interact with it using our web browser (client).`

Однако, несмотря на то, что большинство веб-приложений используют клиент-серверную архитектуру, существует множество вариантов реализации.

---

#### Один сервер

В этой архитектуре всё веб-приложение или даже несколько веб-приложений и их компоненты, включая базу данных, размещаются на одном сервере. Хотя такая структура проста и легка в реализации, она также является самой рискованной.

![[Pasted image 20251221201514.png]]

Если в такой архитектуре будет скомпрометировано какое-либо веб-приложение, размещённое на этом сервере, то будут скомпрометированы данные всех веб-приложений. Такая структура представляет собой подход «`all eggs in one basket`», поскольку если какое-либо из размещённых веб-приложений уязвимо, то уязвим становится весь веб-сервер.

Кроме того, если веб-сервер по какой-либо причине выйдет из строя, все размещённые на нём веб-приложения станут полностью недоступными до тех пор, пока проблема не будет решена.

---

#### Множество серверов — одна база данных

В этой модели база данных размещается на отдельном сервере баз данных, что позволяет серверу, на котором размещены веб-приложения, получать доступ к серверу баз данных для хранения и извлечения данных. Эту модель можно рассматривать как «множество серверов — одна база данных» или «один сервер — одна база данных», если база данных размещена на отдельном сервере баз данных.

![[Pasted image 20251221201523.png]]

Эта модель позволяет нескольким веб-приложениям получать доступ к одной базе данных и работать с одними и теми же данными без синхронизации между ними. Веб-приложения могут быть репликами одного основного приложения (например, основного/резервного) или отдельными веб-приложениями, использующими общие данные.

Главным преимуществом этой модели (`from a security point of view`) является сегментация, при которой каждый из основных компонентов веб-приложения размещается отдельно. Если один веб-сервер взломан, это не затрагивает другие веб-серверы напрямую. Аналогичным образом, если взломана база данных (например, из-за уязвимости SQL-инъекции), это не затрагивает само веб-приложение напрямую. После сегментации ресурсов необходимо внедрить меры контроля доступа, например ограничить доступ веб-приложения только теми данными, которые необходимы для его корректной работы.

---

#### Много серверов — много баз данных

Эта модель основана на модели `Many Servers, One Database`. Однако на сервере баз данных данные каждого веб-приложения хранятся в отдельной базе данных. Веб-приложение может получать доступ только к личным данным и только к общим данным, которые используются несколькими веб-приложениями. Также можно разместить базу данных каждого веб-приложения на отдельном сервере баз данных.

![[Pasted image 20251221201530.png]]

Эта схема также широко используется для обеспечения избыточности: если какой-либо веб-сервер или база данных выходят из строя, вместо них запускается резервная копия, чтобы максимально сократить время простоя. Хотя реализовать это может быть сложнее и для правильной работы могут потребоваться такие инструменты, как [балансировщики нагрузки](https://en.wikipedia.org/wiki/Load_balancing_\(computing\)), эта архитектура является одним из лучших вариантов с точки зрения безопасности благодаря надлежащему контролю доступа и правильной сегментации ресурсов.

Помимо этих моделей, существуют и другие модели веб-приложений, такие как [бессерверные](https://aws.amazon.com/lambda/serverless-architectures-learn-more) веб-приложения или веб-приложения, использующие [микросервисы](https://aws.amazon.com/microservices).

---

## Компоненты веб-приложения

Каждое веб-приложение может состоять из разного количества компонентов. Тем не менее все компоненты упомянутых ранее моделей можно разделить на:

1. `Client`
2. `Server`
    - Веб-сервер
    - Логика веб-приложения
    - База данных
3. `Services` (Микросервисы)
    - Сторонние интеграции
    - Интеграции с веб-приложениями
4. `Functions` (Без сервера)

---

## Архитектура веб-приложений

Компоненты веб-приложения делятся на три различных уровня (так называемая трёхуровневая архитектура).

|**Слой**|**Описание**|
|---|---|
|`Presentation Layer`|Состоит из компонентов пользовательского интерфейса, которые обеспечивают взаимодействие с приложением и системой. Клиент может получить к ним доступ через веб-браузер, а возвращаются они в виде HTML, JavaScript и CSS.|
|`Application Layer`|Этот уровень обеспечивает корректную обработку всех клиентских запросов (веб-запросов). Проверяются различные критерии, такие как авторизация, привилегии и данные, передаваемые клиенту.|
|`Data Layer`|Уровень данных тесно взаимодействует с прикладным уровнем, чтобы точно определить, где хранятся необходимые данные и как к ним получить доступ.|

Пример архитектуры веб-приложения может выглядеть примерно так:

![[Pasted image 20251221201537.png]] Источник: [Документы Microsoft](https://docs.microsoft.com/en-us/dotnet/architecture/modern-web-apps-azure/common-web-application-architectures)

Кроме того, некоторые веб-серверы могут выполнять системные вызовы и программы, такие как [IIS ISAPI](https://learn.microsoft.com/en-us/previous-versions/iis/6.0-sdk/ms525172\(v=vs.90\)) или [PHP-CGI](https://www.php.net/manual/en/install.unix.commandline.php).

---

#### Микросервисы

Микросервисы можно рассматривать как независимые компоненты веб-приложения, которые в большинстве случаев предназначены для выполнения только одной задачи. Например, для интернет-магазина мы можем разделить основные задачи на следующие компоненты:

- Регистрация
- Поиск
- Платежи
- Рейтинги
- Отзывы

Эти компоненты взаимодействуют с клиентом и друг с другом. Взаимодействие между этими микросервисами является `stateless`, то есть запрос и ответ не зависят друг от друга. Это связано с тем, что сохранённые данные `stored separately` не связаны с соответствующими микросервисами. Использование микросервисов считается [сервис-ориентированной архитектурой (SOA)](https://en.wikipedia.org/wiki/Service-oriented_architecture), построенной как набор различных автоматизированных функций, направленных на достижение единой бизнес-цели. Тем не менее эти микросервисы зависят друг от друга.

Ещё одним важным и эффективным компонентом микросервисов является то, что они могут быть написаны на разных языках программирования и при этом взаимодействовать друг с другом. Микросервисы упрощают масштабирование и ускоряют разработку приложений, что способствует внедрению инноваций и ускоряет вывод на рынок новых функций. К преимуществам микросервисов относятся:

- Гибкость
- Гибкое масштабирование
- Простое развертывание
- Возможность повторного использования кода
- Устойчивость

В этом [официальном документе](https://d1.awsstatic.com/whitepapers/microservices-on-aws.pdf) AWS представлен отличный обзор реализации микросервисов.

---

#### Бессерверная архитектура

Облачные провайдеры, такие как AWS, GCP, Azure и другие, предлагают бессерверные архитектуры. Эти платформы предоставляют фреймворки для создания таких веб-приложений, не требуя заботы о самих серверах. Эти веб-приложения работают в вычислительных контейнерах без сохранения состояния (например, в Docker). Такой тип архитектуры позволяет компаниям гибко создавать и развертывать приложения и сервисы без необходимости управлять инфраструктурой. Все управление серверами осуществляется облачным провайдером, что избавляет от необходимости выделять, масштабировать и обслуживать серверы, необходимые для работы приложений и баз данных.

Подробнее о бессерверных вычислениях и различных сценариях их использования можно прочитать [здесь](https://aws.amazon.com/serverless).

---

## Безопасность архитектуры

При тестировании на проникновение любого веб-приложения важно понимать общую архитектуру веб-приложений и особенности архитектуры каждого веб-приложения. Во многих случаях уязвимость отдельного веб-приложения может быть вызвана не ошибкой программирования, а ошибкой проектирования его архитектуры.

Например, в отдельном веб-приложении может быть реализована вся его основная функциональность. Однако из-за отсутствия надлежащих мер контроля доступа в его структуре, то есть из-за отсутствия [управления доступом на основе ролей (Role-Based Access Control, RBAC)](https://en.wikipedia.org/wiki/Role-based_access_control), пользователи могут получить доступ к некоторым функциям администратора, которые не предназначены для прямого доступа, или даже к личной информации других пользователей, не имея на это прав. Чтобы решить эту проблему, необходимо внести существенные изменения в структуру, что, скорее всего, потребует больших затрат времени и средств.

Другой пример: если мы не можем найти базу данных после использования уязвимости и получения контроля над внутренним сервером, это может означать, что база данных размещена на отдельном сервере. Мы можем найти только часть данных базы, что может означать, что используется несколько баз данных. Вот почему безопасность необходимо обеспечивать на каждом этапе разработки веб-приложения, а тесты на проникновение следует проводить на протяжении всего жизненного цикла веб-приложения.