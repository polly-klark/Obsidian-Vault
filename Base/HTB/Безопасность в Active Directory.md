#AD #windows #htb 

Изучая этот модуль, мы рассмотрели множество функций и возможностей, встроенных в Active Directory. Все они основаны на принципе централизованного управления и возможности быстрого обмена информацией с большим количеством пользователей. Из-за этого Active Directory можно считать небезопасной по своей сути. При установке Active Directory по умолчанию отсутствуют многие меры по усилению защиты, настройки и инструменты, которые можно использовать для обеспечения безопасности AD. Когда мы думаем о кибербезопасности, первое, что приходит на ум, — это баланс между конфиденциальностью, целостностью и доступностью, также известный как [триада КЦД](https://www.f5.com/labs/articles/education/what-is-the-cia-triad). Найти этот баланс непросто, и в основе AD лежат `Availability` и `Confidentiality`.

#### Триада КЦД

![[Pasted image 20251028180427.png]]

Мы можем помочь уравновесить ситуацию, используя встроенные функции Microsoft, которые можно включить или настроить для защиты AD от распространенных атак. Приведенный ниже список не является исчерпывающим. Для обеспечения надлежащего `defense-in-depth` подхода в организации должны соблюдаться многие другие общие принципы усиления безопасности (наличие точного реестра активов, установка исправлений уязвимостей, управление конфигурацией, защита конечных точек, обучение по вопросам безопасности, сегментация сети и т. д.). Этот раздел можно считать минимальным набором общих рекомендаций по обеспечению безопасности AD, которые будут полезны любой организации. Мы подробно рассмотрим защиту Active Directory в следующем модуле. Давайте приступим и начнём с нескольких общих мер по усилению защиты AD.

---

## Общие меры по усилению защиты Active Directory

[Решение Microsoft для смены паролей локальных администраторов (LAPS)](https://www.microsoft.com/en-us/download/details.aspx?id=46899) используется для рандомизации и смены паролей локальных администраторов на компьютерах с Windows, а также для предотвращения горизонтального перемещения.

#### LAPS

Для учётных записей можно настроить смену пароля через фиксированный интервал (например, 12 часов, 24 часа и т. д.). Этот бесплатный инструмент может помочь снизить влияние отдельного скомпрометированного хоста в среде AD. Организациям не следует полагаться только на подобные инструменты. Тем не менее в сочетании с другими мерами по усилению защиты и передовыми методами обеспечения безопасности он может стать очень эффективным инструментом для управления паролями учётных записей локальных администраторов.

#### Настройки политики аудита (ведение журналов и мониторинг)

В каждой организации должны быть настроены ведение журналов и мониторинг для обнаружения и реагирования на непредвиденные изменения или действия, которые могут указывать на атаку. Эффективное ведение журналов и мониторинг позволяют обнаружить, что злоумышленник или неавторизованный сотрудник добавляет пользователя или компьютер, изменяет объект в AD, меняет пароль учетной записи, получает несанкционированный или нестандартный доступ к системе, выполняет такие атаки, как перебор паролей, или более сложные атаки, такие как современные атаки на Kerberos.

#### Параметры безопасности групповой политики

Как упоминалось ранее в этом модуле, объекты групповой политики (ОГП) — это виртуальные наборы параметров политики, которые можно применять к конкретным пользователям, группам и компьютерам на уровне подразделения. С их помощью можно применять широкий спектр [политик безопасности](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/security-policy-settings) для защиты Active Directory. Ниже приведён неполный список типов политик безопасности, которые можно применять:

- [Политики учётных записей](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/account-policies) — управление взаимодействием учётных записей пользователей с доменом. Сюда входят политика паролей, политика блокировки учётных записей и настройки, связанные с Kerberos, например срок действия билетов Kerberos
    
- [Локальные политики](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/security-options) — применяются к конкретному компьютеру и включают в себя политику аудита событий безопасности, назначение прав пользователей (привилегии пользователей на хосте) и конкретные параметры безопасности, такие как возможность установки драйверов, включение учётных записей администратора и гостя, переименование учётных записей гостя и администратора, запрет пользователям устанавливать принтеры или использовать съёмные носители, а также различные параметры доступа к сети и сетевой безопасности.
    
- [Политики ограничения программного обеспечения](https://docs.microsoft.com/en-us/windows-server/identity/software-restriction-policies/software-restriction-policies) — настройки, позволяющие контролировать, какое программное обеспечение может быть запущено на хосте.
    
- [Политики управления приложениями](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/windows-defender-application-control) — настройки, позволяющие контролировать, какие приложения могут запускать определенные пользователи/группы. Это может включать запрет на запуск определенных пользователями всех исполняемых файлов, файлов установщика Windows, скриптов и т. д. Администраторы используют [AppLocker](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/applocker/applocker-overview) для ограничения доступа к определенным типам приложений и файлов. Нередко организации блокируют доступ к CMD и PowerShell (среди прочих исполняемых файлов) для пользователей, которым они не нужны для повседневной работы. Эти правила несовершенны, и их часто можно обойти, но они необходимы для стратегии эшелонированной обороны.
    
- [Расширенная настройка политики аудита](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/secpol-advanced-security-audit-policy-settings) — различные параметры, которые можно настроить для аудита таких действий, как доступ к файлам или их изменение, вход в систему/выход из неё, изменение политики, использование привилегий и многое другое.
    

#### Расширенная Политика Аудита

![[Pasted image 20251028180435.png]]

#### Управление обновлениями (SCCM/WSUS)

Грамотное управление исправлениями критически важно для любой организации, особенно для тех, кто использует системы Windows/Active Directory. [Служба обновления Windows Server (WSUS)](https://docs.microsoft.com/en-us/windows-server/administration/windows-server-update-services/get-started/windows-server-update-services-wsus) может быть установлена как роль на Windows Server и использоваться для минимизации ручной работы по установке исправлений в системах Windows. `System Center Configuration Manager` (SCCM) — это платное решение, которое использует установленную роль WSUS на Windows Server и предлагает больше возможностей, чем WSUS сама по себе. Решение для управления исправлениями может помочь обеспечить своевременное развертывание исправлений и максимальный охват, гарантируя, что ни один хост не останется без критически важных исправлений безопасности. Если организация использует ручной метод установки исправлений, это может занять очень много времени в зависимости от размера среды, а также привести к тому, что некоторые системы останутся уязвимыми.

#### Групповые управляемые служебные учётные записи (gMSA)

gMSA — это управляемая доменом учётная запись, которая обеспечивает более высокий уровень безопасности по сравнению с другими типами служебных учётных записей. Она предназначена для использования с неинтерактивными приложениями, службами, процессами и задачами, которые запускаются автоматически, но требуют ввода учётных данных. Они обеспечивают автоматическое управление паролями с помощью пароля из 120 символов, генерируемого контроллером домена. Пароль меняется с определённой периодичностью, и его не нужно знать пользователям. Это позволяет использовать учётные данные на нескольких хостах.

#### Группы безопасности

Группы безопасности позволяют легко назначать доступ к сетевым ресурсам. Их можно использовать для назначения определенных прав группе (а не непосредственно пользователю), чтобы определить, какие действия участники группы могут выполнять в среде Active Directory. Во время установки Active Directory автоматически создает несколько [групп безопасности по умолчанию](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#active-directory-default-security-groups-by-operating-system-version). Например, это могут быть группы «Операторы учетных записей», «Администраторы», «Операторы резервного копирования», «Администраторы домена» и «Пользователи домена». Эти группы также можно использовать для назначения разрешений на доступ к ресурсам (например, к общему файловому ресурсу, папке, принтеру или документу). Группы безопасности позволяют назначать пользователям детальные разрешения массово, а не индивидуально для каждого пользователя.

#### Встроенные группы безопасности AD

![[Pasted image 20251028180442.png]]

#### Разделение учетных записей

У администраторов должно быть две отдельные учётные записи. Одна для повседневной работы, а вторая для выполнения административных задач. Например, пользователь может войти в систему под своей `sjones` учётной записью, чтобы отправить/получить электронное письмо, создать документы и т. д. У него должна быть отдельная учётная запись, например `sjones_adm`, для доступа к [защищённому административному хосту](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/implementing-secure-administrative-hosts), который используется для выполнения административных задач. Это поможет гарантировать, что в случае взлома хоста пользователя (например, в результате фишинговой атаки) злоумышленник получит доступ только к этому хосту и не сможет получить учётные данные для привилегированного пользователя с широким доступом в домене. Кроме того, пользователю необходимо использовать разные пароли для каждой учётной записи, чтобы снизить риск повторных атак с использованием пароля в случае взлома учётной записи без прав администратора.

#### Правила создания сложных паролей + парольные фразы + двухфакторная аутентификация

В идеале организация должна использовать парольные фразы или длинные случайно сгенерированные пароли с помощью корпоративного менеджера паролей. Стандартные пароли из 7–8 символов можно очень быстро взломать в автономном режиме с помощью такого инструмента, как Hashcat, и оборудования для взлома паролей на базе графического процессора. Более короткие и простые пароли также можно подобрать с помощью атаки методом перебора, что даст злоумышленнику возможность закрепиться в домене. Одних только правил сложности паролей в AD недостаточно для обеспечения надёжности паролей. Например, пароль `Welcome1` соответствует стандартным правилам сложности (3 из 4 символов должны быть прописными или строчными, числовыми или специальными), но это один из первых паролей, которые я бы попробовал при атаке методом перебора. Организации также следует рассмотреть возможность внедрения фильтра паролей, который будет запрещать использование паролей, содержащих названия месяцев или времен года, название компании и распространенные слова, такие как `password` и `welcome`. Минимальная длина пароля для обычных пользователей должна составлять не менее 12 символов, а для администраторов и служебных учётных записей — в идеале больше. Ещё одна важная мера безопасности — внедрение многофакторной аутентификации (MFA) для удалённого доступа к рабочему столу на любом хосте. Это поможет ограничить попытки горизонтального перемещения, которые могут быть связаны с доступом к графическому интерфейсу хоста.

#### Ограничение использования учётной записи администратора домена

Всемогущие учётные записи администратора домена следует использовать только для входа на контроллеры домена, а не на личные рабочие станции, промежуточные хосты, веб-серверы и т. д. Это может значительно снизить ущерб от атаки и сократить количество потенциальных путей атаки в случае взлома хоста. Таким образом можно гарантировать, что пароли учётных записей администратора домена не будут храниться в памяти хостов по всей среде.

#### Периодический аудит и удаление устаревших пользователей и объектов

Организации важно периодически проводить аудит Active Directory и удалять или отключать все неиспользуемые учётные записи. Например, может существовать привилегированная служебная учётная запись, созданная восемь лет назад с очень слабым паролем, который никогда не менялся, и эта учётная запись больше не используется. Даже если с тех пор политика паролей была изменена, чтобы сделать её более устойчивой к таким атакам, как подбор пароля, такая учётная запись может стать быстрым и простым плацдармом или методом горизонтального перемещения или повышения привилегий в домене.

#### Аудит Разрешений и доступа

Организациям также следует периодически проводить аудит контроля доступа, чтобы убедиться, что у пользователей есть только те права доступа, которые необходимы для их повседневной работы. Важно проверять права локальных администраторов, количество администраторов домена (действительно ли нам нужно 30 таких администраторов?) и администраторов предприятия, чтобы ограничить поверхность атаки, доступ к общим файлам, права пользователей (например, членство в определённых привилегированных группах безопасности) и многое другое.

#### Правила аудита и ведение журналов

Необходимо обеспечить прозрачность домена. Организация может добиться этого с помощью надежного ведения журналов и использования правил для обнаружения аномальной активности (например, большого количества неудачных попыток входа в систему, которые могут указывать на атаку методом перебора паролей) или признаков попытки атаки методом подбора Kerberoasting. Эти методы также можно использовать для обнаружения перебора Active Directory. Чтобы помочь в обнаружении компрометации, стоит ознакомиться с [рекомендациями по политике аудита](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/audit-policy-recommendations) Microsoft.

#### Использование ограниченных групп

[Группы с ограниченным доступом](https://social.technet.microsoft.com/wiki/contents/articles/20402.active-directory-group-policy-restricted-groups.aspx) позволяют администраторам настраивать членство в группах с помощью групповой политики. Их можно использовать по разным причинам, например для контроля членства в группе локальных администраторов на всех хостах в домене, ограничив его только учетной записью локального администратора и группой администраторов домена, а также для контроля членства в группах с высоким уровнем привилегий «Администраторы предприятия» и «Администраторы схемы» и других ключевых административных группах.

#### Ограничение Ролей сервера

Важно не устанавливать дополнительные роли на уязвимых хостах, например роль `Internet Information Server` (IIS) на контроллере домена. Это увеличит поверхность атаки контроллера домена, и такую роль следует устанавливать на отдельном веб-сервере. В качестве других примеров можно привести размещение веб-приложений не на почтовом сервере Exchange и разделение веб-серверов и серверов баз данных на разных хостах. Такое разделение ролей может помочь снизить последствия успешной атаки.

#### Ограничение прав локального администратора и RDP

Организации должны строго контролировать, какие пользователи и на каких компьютерах имеют права локального администратора. Как уже говорилось выше, этого можно добиться с помощью групп с ограниченным доступом. Я видел слишком много организаций, в которых вся группа «Пользователи домена» имела права локального администратора на одном или нескольких хостах. Это позволило бы злоумышленнику, получившему доступ к `ANY` учетной записи (даже с очень низкими привилегиями), получить доступ к этому хосту в качестве локального администратора и потенциально получить конфиденциальные данные или украсть учетные данные высокопривилегированных учетных записей домена из памяти, если в системе находится другой пользователь. То же самое касается прав на удаленный рабочий стол (RDP). Если многие пользователи могут подключаться по протоколу RDP к одному или нескольким компьютерам, это повышает риск раскрытия конфиденциальных данных или потенциальных атак с повышением привилегий, которые могут привести к дальнейшему взлому.

По этой [ссылке](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/best-practices-for-securing-active-directory) вы можете ознакомиться с рекомендациями Microsoft по обеспечению безопасности Active Directory.