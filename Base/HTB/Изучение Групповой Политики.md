#htb #AD #windows 

Групповая политика — это функция Windows, которая предоставляет администраторам широкий набор расширенных настроек, применимых как к учётным записям пользователей, так и к учётным записям компьютеров в среде Windows. На каждом хосте Windows есть редактор локальной групповой политики для управления локальными настройками. В наших целях мы сосредоточимся на групповой политике в контексте домена для управления пользователями и компьютерами в Active Directory. Групповая политика — это мощный инструмент для управления и настройки параметров пользователей, операционных систем и приложений. Групповая политика также является эффективным инструментом для управления безопасностью в доменной среде. С точки зрения безопасности использование групповой политики — один из лучших способов повысить уровень безопасности вашего предприятия. Active Directory ни в коем случае не является безопасной «из коробки», а групповая политика при правильном использовании является важнейшей частью стратегии эшелонированной защиты.

Хотя групповая политика — отличный инструмент для управления безопасностью домена, злоумышленники могут использовать её в своих целях. Получение прав на объект групповой политики может привести к горизонтальному перемещению, повышению привилегий и даже к полной компрометации домена, если злоумышленник сможет использовать эти права для получения доступа к ценному пользователю или компьютеру. Кроме того, злоумышленники могут использовать их для сохранения доступа в сети. Понимание того, как работает групповая политика, даст нам преимущество перед злоумышленниками и может существенно помочь при тестировании на проникновение. Иногда мы обнаруживаем мелкие ошибки в конфигурации, которые могут остаться незамеченными другими специалистами по тестированию на проникновение.

---

## Объекты групповой политики (GPO)

[Объект групповой политики (ОГП)](https://docs.microsoft.com/en-us/previous-versions/windows/desktop/policy/group-policy-objects) — это виртуальная коллекция параметров политики, которые можно применить к `user(s)` или `computer(s)`. ОГП включают в себя такие параметры, как время ожидания блокировки экрана, отключение USB-портов, применение пользовательской политики паролей домена, установка программного обеспечения, управление приложениями, настройка параметров удаленного доступа и многое другое. Каждый ОГП имеет уникальное имя и уникальный идентификатор (GUID). Они могут быть связаны с конкретным подразделением, доменом или сайтом. Один объект групповой политики может быть связан с несколькими контейнерами, и к любому контейнеру может быть применено несколько объектов групповой политики. Они могут применяться к отдельным пользователям, хостам или группам непосредственно в подразделении. Каждый объект групповой политики содержит один или несколько параметров групповой политики, которые могут применяться на уровне локального компьютера или в контексте Active Directory.

---

## Пример объектов групповой политики

Вот несколько примеров того, что можно делать с помощью групповых политик:

- Настройка различных политик паролей для служебных учётных записей, учётных записей администраторов и стандартных учётных записей пользователей с помощью отдельных объектов групповой политики
- Запрет на использование съемных носителей (например, USB-устройств)
- Установка экранной заставки с помощью пароля
- Ограничение доступа к приложениям, которые могут не понадобиться обычному пользователю, например cmd.exe и PowerShell
- Внедрение политик аудита и ведения журналов
- Блокировка пользователей от запуска определённых типов программ и скриптов
- Развёртывание программного обеспечения в домене
- Блокировка установки пользователями неподтвержденного программного обеспечения
- Отображение баннера при входе пользователя в систему
- Запрет на использование хэша LM в домене
- Запуск скриптов при включении/выключении компьютера или при входе/выходе пользователя из системы

В качестве примера возьмём стандартную реализацию Active Directory в Windows Server 2008, в которой по умолчанию используется сложная структура паролей. Требования к сложности паролей следующие:

- Пароль должен состоять как минимум из 7 символов.
- Пароли должны содержать символы как минимум из трёх следующих четырёх категорий:
    - Заглавные буквы (от A до Z)
    - Строчные буквы (a-z)
    - Цифры (0–9)
    - Специальные символы (например, !@#$%^&*()_+|~-=`{}[]:";'<>?,./)

Это лишь несколько примеров того, что можно сделать с помощью групповой политики. В рамках объекта групповой политики можно применить сотни настроек, которые могут быть очень детализированными. Например, ниже приведены некоторые параметры, которые можно задать для сеансов удалённого рабочего стола.

#### Настройки объекта групповой политики RDP

![[Pasted image 20251028181842.png]]

Настройки объектов групповой политики обрабатываются с использованием иерархической структуры AD и применяются с помощью правила `Order of Precedence`, как показано в таблице ниже:

#### Порядок приоритета

|**Уровень**|**Описание**|
|---|---|
|`Local Group Policy`|Политики определяются непосредственно на хосте локально, вне домена. Любые настройки здесь будут перезаписаны, если аналогичные настройки будут определены на более высоком уровне.|
|`Site Policy`|Любые политики, относящиеся к корпоративному сайту, на котором размещен хост. Помните, что корпоративные среды могут охватывать большие кампусы и даже целые страны. Поэтому логично предположить, что у сайта могут быть свои собственные политики, отличающие его от остальной организации. Отличным примером являются политики контроля доступа. Допустим, в определенном здании или `site` проводятся секретные или ограниченные исследования, для доступа к ресурсам которых требуется более высокий уровень авторизации. Вы можете указать эти настройки на уровне сайта и убедиться, что они связаны между собой и не перезаписываются политикой домена. Это также отличный способ выполнять такие действия, как печать и совместное использование карт для пользователей на определённых сайтах.|
|`Domain-wide Policy`|Любые настройки, которые вы хотите применить ко всему домену. Например, настройка уровня сложности паролей, настройка фона рабочего стола для всех пользователей и настройка баннера с уведомлением об использовании и согласии на мониторинг на экране входа в систему.|
|`Organizational Unit` (OU)|Эти настройки будут применяться к пользователям и компьютерам, принадлежащим к определённым организационным подразделениям. Здесь можно указать любые уникальные настройки, зависящие от роли. Например, сопоставление определённого общего диска, доступ к которому есть только у отдела кадров, доступ к определённым ресурсам, таким как принтеры, или возможность для ИТ-администраторов использовать PowerShell и командную строку.|
|`Any OU Policies nested within other OU's`|Настройки на этом уровне будут отражать особые разрешения для объектов во вложенных подразделениях организации. Например, предоставление аналитикам по безопасности особого набора параметров политики Applocker, отличающегося от стандартных параметров Applocker для ИТ-специалистов.|

Управлять групповой политикой можно с помощью консоли управления групповой политикой (находится в разделе «Администрирование» в меню «Пуск» на контроллере домена), пользовательских приложений или модуля PowerShell [GroupPolicy](https://docs.microsoft.com/en-us/powershell/module/grouppolicy/?view=windowsserver2022-ps) в командной строке. Политика домена по умолчанию — это объект групповой политики по умолчанию, который автоматически создается и связывается с доменом. Он имеет наивысший приоритет среди всех объектов групповой политики и по умолчанию применяется ко всем пользователям и компьютерам. Как правило, лучше всего использовать этот объект групповой политики по умолчанию для управления настройками по умолчанию, которые применяются ко всему домену. Политика контроллеров домена по умолчанию также создается автоматически вместе с доменом и устанавливает базовые параметры безопасности и аудита для всех контроллеров домена в данном домене. При необходимости ее можно настроить, как и любой другой объект групповой политики.

---

## Порядок старшинства в GPO

При рассмотрении с точки зрения организационной структуры домена объекты групповой политики обрабатываются сверху вниз. Сначала обрабатывается объект групповой политики, связанный с подразделением на самом высоком уровне в сети Active Directory (например, на уровне домена), затем — объекты, связанные с дочерним подразделением, и т. д. Это означает, что объект групповой политики, связанный непосредственно с подразделением, содержащим объекты пользователей или компьютеров, обрабатывается последним. Другими словами, объект групповой политики, привязанный к определённому подразделению, будет иметь приоритет над объектом групповой политики, привязанным на уровне домена, поскольку он будет обрабатываться последним и может привести к переопределению настроек в объекте групповой политики, расположенном выше в иерархии домена. Ещё один момент, на который следует обратить внимание при определении приоритета: настройка, заданная в политике для компьютеров, всегда будет иметь более высокий приоритет, чем та же настройка, применённая к пользователю. На следующем рисунке показано, как определяется приоритет и как он применяется.

#### Порядок приоритета GPO

![[Pasted image 20251028181849.png]]

Давайте рассмотрим другой пример с использованием консоли управления групповыми политиками на контроллере домена. На этом изображении мы видим несколько объектов групповой политики. Объект групповой политики `Disabled Forced Restarts` будет иметь приоритет над объектом групповой политики `Logon Banner`, поскольку он обрабатывается последним. Любые настройки, заданные в объекте групповой политики `Disabled Forced Restarts`, потенциально могут переопределять настройки в любых объектах групповой политики, расположенных выше в иерархии (включая те, которые связаны с объектом групповой политики `Corp`).

#### Пример улья GPMC

![[Pasted image 20251028181854.png]]

На этом изображении также показан пример нескольких объектов групповой политики, связанных с подразделением `Corp` OU. Если с подразделением связано несколько объектов групповой политики, они обрабатываются в соответствии с `Link Order`. Объект групповой политики с наименьшим порядком связи обрабатывается последним, то есть объект групповой политики с порядком связи 1 имеет наивысший приоритет, затем идут 2, 3 и так далее. Таким образом, в нашем примере объект групповой политики `Disallow LM Hash` будет иметь приоритет над объектами групповой политики `Block Removable Media` и `Disable Guest Account`, то есть он будет обработан первым.

Можно указать параметр `Enforced` для принудительного применения настроек в определенной группе объектов. Если этот параметр установлен, настройки политики в группах объектов, связанных с подразделениями более низкого уровня `CANNOT`, переопределяют настройки. Если группа объектов настроена на уровне домена с выбранным параметром `Enforced`, настройки, содержащиеся в этой группе объектов, будут применяться ко всем подразделениям в домене и не могут быть переопределены политиками подразделений более низкого уровня. Раньше этот параметр назывался `No Override` и устанавливался в соответствующем контейнере в разделе «Пользователи и компьютеры Active Directory». Ниже мы можем увидеть пример `Enforced` объекта групповой политики, где `Logon Banner` объект групповой политики имеет приоритет над объектами групповой политики, связанными с более низкими подразделениями, и поэтому не будет переопределен.

#### Приоритет принудительной политики GPO

![[Pasted image 20251028181901.png]]

Независимо от того, какой объект групповой политики выбран для принудительного применения, если принудительно применяется объект групповой политики `Default Domain Policy`, он будет иметь приоритет над всеми объектами групповой политики на всех уровнях.

#### Переопределение политики Домена по умолчанию

![[Pasted image 20251028181908.png]]

Также можно установить параметр `Block inheritance` для подразделения. Если он указан для конкретного подразделения, то политики, расположенные выше (например, на уровне домена), НЕ будут применяться к этому подразделению. Если установлены оба параметра, то параметр `No Override` имеет приоритет над параметром `Block inheritance` . Вот простой пример. Подразделение `Computers` наследует объекты групповой политики, установленные в подразделении `Corp` на изображении ниже.

![[Pasted image 20251028181916.png]]

Если выбран параметр `Block Inheritance`, мы увидим, что три объекта групповой политики, применённые выше, вплоть до `Corp` подразделения, больше не применяются в `Computers` подразделении.

#### Наследование блоков

![[Pasted image 20251028181922.png]]

---

## Частота обновления групповой политики

При создании новой групповой политики настройки не применяются автоматически сразу. Windows выполняет периодические обновления групповой политики, которые по умолчанию происходят каждые 90 минут со случайным смещением +/- 30 минут для пользователей и компьютеров. По умолчанию контроллеры домена обновляются каждые 5 минут. После создания и привязки новой групповой политики может пройти до 2 часов (120 минут), прежде чем настройки вступят в силу. Это случайное смещение на +/- 30 минут установлено для того, чтобы не перегружать контроллеры домена одновременными запросами групповой политики от всех клиентов.

В самой групповой политике можно изменить интервал обновления по умолчанию. Кроме того, мы можем ввести команду `gpupdate /force` для запуска процесса обновления. Эта команда сравнит объекты групповой политики, которые в данный момент применяются на компьютере, с контроллером домена и либо изменит их, либо пропустит, если они изменились с момента последнего автоматического обновления.

Мы можем изменить интервал обновления с помощью групповой политики, нажав на `Computer Configuration --> Policies --> Administrative Templates --> System --> Group Policy` и выбрав `Set Group Policy refresh interval for computers`. Хотя этот параметр можно изменить, не стоит устанавливать слишком частый интервал, иначе это может привести к перегрузке сети и проблемам с репликацией.

![[Pasted image 20251028181928.png]]

---

## Вопросы безопасности в GPO

Как упоминалось ранее, объекты групповой политики можно использовать для проведения атак. Такие атаки могут включать в себя предоставление дополнительных прав учётной записи пользователя, которую мы контролируем, добавление локального администратора на хост или создание немедленной запланированной задачи для запуска вредоносной команды, например для изменения членства в группе, добавления новой учётной записи администратора, установления обратного подключения к оболочке или даже установки целевого вредоносного ПО во всём домене. Такие атаки обычно происходят, когда у пользователя есть права, необходимые для изменения объекта групповой политики, применяемого к подразделению, содержащему либо учётную запись пользователя, которую мы контролируем, либо компьютер.

Ниже приведён пример пути атаки на объект групповой политики, выявленного с помощью инструмента [BloodHound](https://github.com/BloodHoundAD/BloodHound). В этом примере показано, что группа `Domain Users` может изменять объект групповой политики `Disconnect Idle RDP` из-за вложенного членства в группах . В этом случае нам нужно выяснить, к каким организационным подразделениям применяется этот объект групповой политики и можем ли мы использовать эти права, чтобы получить контроль над важным пользователем (администратором или администратором домена) или компьютером (сервером, контроллером домена или критически важным хостом) и расширить свои привилегии в домене.

![[Pasted image 20251028181933.png]]

---

На данный момент мы рассмотрели много информации. `Active Directory` Это обширная тема, и мы затронули лишь малую её часть. Теперь мы рассмотрели базовую теорию. Давайте перейдём к практике и поэкспериментируем с объектами Active Directory, групповой политикой и многим другим в следующем разделе.