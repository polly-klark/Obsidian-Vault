#windows #htb 

## Службы Windows

Службы — это основной компонент операционной системы Windows. Они позволяют создавать длительные процессы и управлять ими. Службы Windows могут запускаться автоматически при загрузке системы без вмешательства пользователя. Эти службы могут продолжать работать в фоновом режиме даже после того, как пользователь выйдет из своей учётной записи в системе.

Приложения также могут быть созданы для установки в качестве службы, например, приложение для мониторинга сети, установленное на сервере. Службы в Windows отвечают за многие функции операционной системы Windows, такие как сетевые функции, выполнение диагностики системы, управление учётными данными пользователей, контроль обновлений Windows и многое другое.

Службы Windows управляются с помощью системы Service Control Manager (SCM), доступной через надстройку `services.msc` MMC.

Эта надстройка предоставляет графический интерфейс для взаимодействия со службами и управления ими, а также отображает информацию о каждой установленной службе. Эта информация включает в себя название службы, описание, состояние, тип запуска и пользователя, от имени которого работает служба.

Также можно запрашивать данные о службах и управлять ими через командную строку с помощью `sc.exe` командлетов [PowerShell](https://docs.microsoft.com/en-us/powershell/scripting/overview?view=powershell-7), таких как `Get-Service`.

  Службы и процессы Windows

```powershell-session
PS C:\htb> Get-Service | ? {$_.Status -eq "Running"} | select -First 2 |fl


Name                : AdobeARMservice
DisplayName         : Adobe Acrobat Update Service
Status              : Running
DependentServices   : {}
ServicesDependedOn  : {}
CanPauseAndContinue : False
CanShutdown         : False
CanStop             : True
ServiceType         : Win32OwnProcess

Name                : Appinfo
DisplayName         : Application Information
Status              : Running
DependentServices   : {}
ServicesDependedOn  : {RpcSs, ProfSvc}
CanPauseAndContinue : False
CanShutdown         : False
CanStop             : True
ServiceType         : Win32OwnProcess, Win32ShareProcess
```

Состояние служб может отображаться как «Running», «Stopped» или «Paused», и их можно настроить на запуск вручную, автоматически или с задержкой при загрузке системы. Службы также могут отображаться в состоянии «Starting» или «Stopping», если какое-либо действие привело к их запуску или остановке. В Windows есть три категории служб: локальные службы, сетевые службы и системные службы. Обычно службы могут создаваться, изменяться и удаляться только пользователями с правами администратора. Неправильные настройки разрешений служб являются распространённым способом повышения привилегий в системах Windows.

В Windows есть несколько [критически важных системных служб](https://docs.microsoft.com/en-us/windows/win32/rstmgr/critical-system-services), которые нельзя остановить и перезапустить без перезагрузки системы. Если мы обновляем какой-либо файл или ресурс, используемый одной из этих служб, мы должны перезагрузить систему.

| Обслуживание            | Описание                                                                                                                                                                                                                                                                                         |
| ----------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| smss.exe                | Подсистема диспетчера сеансов. Отвечает за обработку сеансов в системе.                                                                                                                                                                                                                          |
| csrss.exe               | Процесс выполнения клиентского сервера. Часть подсистемы Windows в пользовательском режиме.                                                                                                                                                                                                      |
| wininit.exe             | Запускает файл Wininit .ini, в котором перечислены все изменения, которые необходимо внести в Windows при перезагрузке компьютера после установки программы.                                                                                                                                     |
| logonui.exe             | Используется для облегчения входа пользователя в систему ПК                                                                                                                                                                                                                                      |
| lsass.exe               | Сервер локальной аутентификации проверяет подлинность учётных записей пользователей на ПК или сервере. Он запускает процесс, отвечающий за аутентификацию пользователей для службы Winlogon.                                                                                                     |
| services.exe            | Управляет работой служб запуска и остановки.                                                                                                                                                                                                                                                     |
| winlogon.exe            | Отвечает за обработку последовательности безопасного доступа, загрузку профиля пользователя при входе в систему и блокировку компьютера во время работы заставки.                                                                                                                                |
| System                  | Фоновый системный процесс, который запускает ядро Windows.                                                                                                                                                                                                                                       |
| svchost.exe с RPCSS     | Управляет системными службами, которые запускаются из библиотек динамических ссылок (файлов с расширением .dll), таких как "Автоматические обновления", "Брандмауэр Windows" и "Подключи и играй". Использует службу удаленного вызова процедур (RPC) (RPCSS).                                   |
| svchost.exe с Dcom /PnP | Управляет системными службами, которые запускаются из библиотек динамической компоновки (файлов с расширением .dll), таких как «Автоматическое обновление», «Брандмауэр Windows» и «Plug and Play». Использует службы распределённой компонентной объектной модели (DCOM) и Plug and Play (PnP). |

По этой [ссылке](https://en.wikipedia.org/wiki/List_of_Microsoft_Windows_components#Services) приведен список компонентов Windows, включая ключевые службы.

---

## Процессы

В системах Windows процессы работают в фоновом режиме. Они либо запускаются автоматически как часть операционной системы Windows, либо запускаются другими установленными приложениями.

Процессы, связанные с установленными приложениями, часто можно завершить, не оказывая серьёзного влияния на операционную систему. Некоторые процессы являются критически важными и при их завершении могут привести к сбоям в работе определённых компонентов операционной системы. В качестве примера можно привести приложение входа в Windows, систему, процесс простоя системы, приложение запуска Windows, клиент-серверную среду выполнения, диспетчер сеансов Windows, хост-службу и процесс службы подсистемы локальных прав безопасности (LSASS).

---

## Служба подсистемы локального органа безопасности (LSASS)

`lsass.exe` Это процесс, отвечающий за соблюдение политики безопасности в системах Windows. Когда пользователь пытается войти в систему, этот процесс проверяет его попытку входа и создаёт токены доступа в соответствии с уровнями разрешений пользователя. LSASS также отвечает за изменение паролей учётных записей пользователей. Все события, связанные с этим процессом (попытки входа/выхода из системы и т. д.), регистрируются в журнале безопасности Windows. LSASS — чрезвычайно ценная цель, поскольку существует несколько инструментов для извлечения как текстовых, так и хешированных учётных данных, хранящихся в памяти этого процесса.

---

## Инструменты Sysinternals

[Набор инструментов SysInternals](https://docs.microsoft.com/en-us/sysinternals) — это набор переносимых приложений для Windows, которые можно использовать для администрирования систем Windows (по большей части без необходимости установки). Инструменты можно скачать с веб-сайта Microsoft или загрузить напрямую с общего файлового сервера, доступного через Интернет, введя `\\live.sysinternals.com\tools` в окне проводника Windows.

Например, мы можем запустить procdump.exe прямо с этого диска, не загружая его на диск.

  Службы и процессы Windows

```cmd-session
C:\htb> \\live.sysinternals.com\tools\procdump.exe -accepteula

ProcDump v9.0 - Sysinternals process dump utility
Copyright (C) 2009-2017 Mark Russinovich and Andrew Richards
Sysinternals - www.sysinternals.com

Monitors a process and writes a dump file when the process exceeds the
specified criteria or has an exception.

Capture Usage:
   procdump.exe [-mm] [-ma] [-mp] [-mc Mask] [-md Callback_DLL] [-mk]
                [-n Count]
                [-s Seconds]
                [-c|-cl CPU_Usage [-u]]
                [-m|-ml Commit_Usage]
                [-p|-pl Counter_Threshold]
                [-h]
                [-e [1 [-g] [-b]]]
                [-l]
                [-t]
                [-f  Include_Filter, ...]
                [-fx Exclude_Filter, ...]
                [-o]
                [-r [1..5] [-a]]
                [-wer]
                [-64]
                {
                 {{[-w] Process_Name | Service_Name | PID} [Dump_File | Dump_Folder]}
                |
                 {-x Dump_Folder Image_File [Argument, ...]}
                }
				
<SNIP>

```

Пакет включает такие инструменты, как `Process Explorer`, расширенную версию `Task Manager` и `Process Monitor`, которые можно использовать для мониторинга файловой системы, реестра и сетевой активности, связанной с любым процессом, запущенным в системе. Некоторые дополнительные инструменты — это TCPView, который используется для мониторинга интернет-активности, и PSExec, который можно использовать для удалённого управления системами и подключения к ним по протоколу SMB.

Эти инструменты могут быть полезны тестировщикам на проникновение, например, для обнаружения интересных процессов и возможных путей повышения привилегий, а также для горизонтального перемещения.

---

## Диспетчер задач

Диспетчер задач Windows — это мощный инструмент для управления системами Windows. Он предоставляет информацию о запущенных процессах, производительности системы, запущенных службах, программах автозагрузки, пользователях, вошедших в систему, и службах. Диспетчер задач можно открыть, щёлкнув правой кнопкой мыши на панели задач и выбрав `Task Manager`, нажав Ctrl + Shift + Esc, нажав Ctrl + Alt + Del и выбрав `Task Manager`, открыв меню «Пуск» и введя `Task Manager`, или введя `taskmgr` в консоли CMD или PowerShell.

![Диспетчер задач показывает процессы с использованием процессора, памяти, диска и сети, выделяя Google Chrome и Windows PowerShell.](https://academy.hackthebox.com/storage/modules/49/taskmgr.png)

| Вкладка                      | Описание                                                                                                                                                                                                                                                                                                               |
| ---------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Вкладка "Процессы"           | Показывает список запущенных приложений и фоновых процессов, а также использование процессора, памяти, диска, сети и энергии для каждого из них.                                                                                                                                                                       |
| Вкладка "Производительность" | Показывает графики и данные, такие как загрузка процессора, время безотказной работы системы, использование памяти, диска, сети и графического процессора. Мы также можем открыть `Resource Monitor`, которая даёт более подробное представление о текущем использовании процессора, памяти, диска и сетевых ресурсов. |

![Монитор ресурсов, отображающий процессы с подробной информацией об использовании памяти и графиком физической памяти.](https://academy.hackthebox.com/storage/modules/49/resource_monitor.png)

| Вкладка                      | Описание                                                                                                                                   |
| ---------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------ |
| Вкладка "История приложений" | Показывает использование ресурсов для текущей учётной записи пользователя для каждого приложения за определённый период времени.           |
| Вкладка "Запуск"             | Показывает, какие приложения настроены на запуск при загрузке, а также их влияние на процесс запуска.                                      |
| Вкладка "Пользователи"       | Показывает вошедших в систему пользователей и использование процессов / ресурсов, связанных с их сеансом.                                  |
| Вкладка "Сведения"           | Отображает имя, идентификатор процесса (PID), статус, связанное имя пользователя, загрузку ЦП и памяти для каждого запущенного приложения. |
| Вкладка "Службы"             | Отображает имя, PID, описание и состояние каждой установленной службы. На этой вкладке также можно открыть надстройку «Службы».            |

---

## Исследователь процессов

[Process Explorer](https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer) — это часть набора инструментов Sysinternals. Этот инструмент показывает, какие дескрипторы и процессы DLL загружаются при запуске программы. Process Explorer показывает список запущенных в данный момент процессов, и в одном из представлений мы можем увидеть, какие дескрипторы выбрал процесс, а в другом — загруженные библиотеки DLL и файлы с подкачкой памяти. Мы также можем выполнить поиск в инструменте, чтобы увидеть, какие процессы связаны с определённым дескриптором или библиотекой DLL. Этот инструмент также можно использовать для анализа отношений между родительским и дочерним процессами, чтобы увидеть, какие дочерние процессы порождаются приложением, и устранить любые проблемы, например, незавершённые процессы, которые могут остаться после завершения процесса.

Ответ на практику: 
```powershel-session
Get-WmiObject -Class Win32_Service | Where-Object { $_.PathName -match "Update" } | Select-Object -Property Name, PathName
```
