#windows #cmd #htb 

Первый шаг в освоении командной строки — это погружение в `cmd.exe` (приложение «Командная строка»). Давайте начнём наше обучение на уровне «белого пояса», разобравшись, что такое cmd.exe, как получить к нему доступ и как работает оболочка.

---

## CMD.exe

Командная строка, также известная как [cmd.exe](https://https//learn.microsoft.com/en-us/windows-server/administration/windows-commands/cmd) или CMD, — это интерпретатор командной строки по умолчанию для операционной системы Windows. Изначально командная строка была основана на интерпретаторе [COMMAND.COM](https://www.techopedia.com/definition/1360/commandcom) в DOS и используется практически во всех операционных системах Windows. Она позволяет пользователям вводить команды, которые напрямую интерпретируются и затем выполняются операционной системой. С помощью одной команды можно выполнить такие задачи, как смена пароля пользователя или проверка состояния сетевых интерфейсов. Это также экономит системные ресурсы, поскольку графическим программам требуется больше ресурсов процессора и памяти.

Несмотря на то, что его часто затмевает более современный аналог [PowerShell](https://learn.microsoft.com/en-us/powershell/scripting/overview?view=powershell-7.2), знание cmd.exe и его команд продолжает приносить пользу даже в наше время.

**`Quick Story:`** Несколько раз во время пентеста я сталкивался с хостами, которые довольно хорошо заблокировали PowerShell или сделали полностью недоступными с помощью средств управления приложениями, таких как AppLocker. Используя командную строку, я все еще мог использовать хост для получения дополнительного доступа и повышения своих привилегий для продолжения оценки. В современных операционных системах множество устаревшего программного обеспечения все еще встроено в хосты. Как администраторы, так и оценщики, мы должны знать об этом и понимать, как использовать их в наших интересах.

---

## Доступ к CMD

Прежде чем мы перейдём к базовому использованию командной строки, нам нужно ответить на один фундаментальный вопрос.

`How do we access the Command Prompt?`

Существует несколько способов доступа к командной строке в системе Windows. То, как вы хотите получить доступ к командной строке, зависит от ваших личных предпочтений, а также от соответствия определённым критериям в зависимости от доступных в данный момент ресурсов. Прежде чем объяснять эти критерии, необходимо пояснить некоторые важные понятия.

#### Локальный доступ по сравнению с Удаленным доступом

Чтобы лучше объяснить эти понятия, давайте сделаем шаг назад и вспомним наш предыдущий сценарий:

**Сценарий:** мы являемся системным администратором в нашей компании. В рамках наших повседневных обязанностей и ожиданий мы должны получать доступ к компьютерам в главном офисе нашей компании и в филиале, расположенном в другом регионе, для выполнения общего технического обслуживания и решения технических проблем. Допустим, у пользователя возникла проблема с компьютером, и вас вызвали на помощь. `How do we best access their machine to most effectively resolve their issue?`

Здесь возможно несколько сценариев в зависимости от вопросов, которые мы задаём себе. Находится ли пользователь в том же регионе, что и мы? Находится ли пользователь в том же здании? Находится ли офис пользователя в пределах разумной пешей доступности? Находится ли пользователь в активном режиме и работает ли он на своём компьютере? Эти вопросы, как правило, влияют на наше решение с точки зрения системного администратора о том, как мы будем пытаться получить доступ к рассматриваемому компьютеру. Однако мы немного забежали вперёд, поэтому давайте опишем, что включает в себя доступ к устройству и доступные типы доступа.

Вообще говоря, доступ к компьютеру можно разделить на две основные категории:

#### Локальный Доступ

Локальный доступ — это прямой физический доступ (или виртуальный в случае виртуальной машины (ВМ)) к самой машине. Этот уровень доступа не требует подключения машины к сети, так как доступ к ней можно получить напрямую через периферийные устройства (монитор, мышь, клавиатуру и т. д.), подключенные к машине. На рабочем столе мы можем открыть командную строку, выполнив следующие действия:

- Используя сочетание клавиш Windows + `r` для вызова командной строки, а затем введя `cmd`. ИЛИ
- Доступ к исполняемому файлу по пути к диску `C:\Windows\System32\cmd.exe`.

#### cmd.exe Начальный доступ

```cmd-session
Microsoft Windows [Version 10.0.19044.2006]
(c) Microsoft Corporation. All rights reserved.

C:\Users\htb>
```

Мы можем запускать наши команды, скрипты или другие действия по мере необходимости.

#### Удаленный доступ:

С другой стороны, удалённый доступ — это эквивалент доступа к компьютеру с помощью виртуальных периферийных устройств по сети. Этот уровень доступа не требует прямого физического доступа к компьютеру, но требует, чтобы пользователь был подключён к той же сети или имел доступ к компьютеру, к которому он хочет получить удалённый доступ. Мы можем сделать это с помощью `telnet` (небезопасно и не рекомендуется), Secure Shell (`SSH`), `PsExec`, `WinRM`, `RDP` или других протоколов по мере необходимости. Для системного администратора удалённое управление и доступ — это благо для рабочего процесса. Нам не пришлось бы подходить к рабочему столу пользователя и физически подключаться к хосту, чтобы выполнять свои обязанности. Это удобство для системных администраторов также может создать угрозу безопасности в нашей сети. Если эти инструменты удалённого доступа настроены неправильно или злоумышленник получит доступ к действительным учётным данным, он сможет получить широкий доступ к нашим средам. Мы должны поддерживать надлежащий баланс доступности и целостности наших сетей для обеспечения надлежащей безопасности.

---

## Основное Использование

Если посмотреть на командную строку, то то, что мы видим сейчас, похоже на то, что было несколько десятилетий назад. Более того, навигация в командной строке практически не изменилась. Навигация по файловой системе похожа на прогулку по коридору, полному дверей. Зайдя в один коридор(`directory`), мы можем посмотреть, что там есть (используя команду `dir`), а затем либо ввести дополнительные команды, либо продолжить движение. Ниже мы рассмотрим базовую структуру оболочки, как перемещаться по коридорам и как составить карту, чтобы сориентироваться.

#### Использование команды dir

### Командная подсказка

```cmd-session
C:\Users\htb\Desktop> dir
  
 Volume in drive C has no label.
 Volume Serial Number is DAE9-5896

 Directory of C:\Users\htb\Desktop

06/11/2021  11:59 PM    <DIR>          .
06/11/2021  11:59 PM    <DIR>          ..
06/11/2021  11:57 PM                 0 file1.txt
06/11/2021  11:57 PM                 0 file2.txt
06/11/2021  11:57 PM                 0 file3.txt
04/13/2021  11:24 AM             2,391 Microsoft Teams.lnk
06/11/2021  11:57 PM                 0 super-secret-sauce.txt
06/11/2021  11:59 PM                 0 write-secrets.ps1
               6 File(s)          2,391 bytes
               2 Dir(s)  35,102,117,888 bytes free
```

1. Текущее местоположение пути (`C:\Users\htb\Desktop`)
2. Команда, которую мы отдали (`dir`)
3. Результаты выполнения команды (`output below the line the command was issued on`)

Если посмотреть на командную строку, то это обычный диалог в формате «запрос-ответ». Мы запросили список каталогов в текущем рабочем каталоге, и система ответила соответствующим выводом.

#### Тематическое исследование: Восстановление Windows

В случае блокировки пользователя или возникновения технических проблем, препятствующих обычному использованию компьютера, загрузка с установочного диска Windows позволяет загрузиться в `Repair Mode`. Здесь пользователю предоставляется доступ к командной строке, что позволяет устранять неполадки устройства с помощью командной строки.

![Доступ к командной строке через режим восстановления](https://academy.hackthebox.com/storage/modules/167/RecoveryMode.gif)

Это полезно, но также представляет потенциальную опасность. Например, на этом компьютере с Windows 7 мы можем использовать командную строку восстановления для внесения изменений в файловую систему. В частности, для замены двоичного файла `Sticky Keys` (`sethc.exe`) другой копией `cmd.exe`

После перезагрузки компьютера мы можем пять раз нажать `Shift` на экране входа в Windows, чтобы вызвать `Sticky Keys`. Поскольку исполняемый файл был перезаписан, вместо этого мы получаем ещё одну командную строку — на этот раз с `NT AUTHORITY\SYSTEM` разрешениями. Мы обошли аутентификацию и теперь имеем доступ к компьютеру как суперпользователь.

Теперь, когда мы получили базовое представление о командной строке и о том, как получить к ней доступ, давайте двигаться дальше. В следующем разделе мы рассмотрим, как использовать встроенные `help` функции cmd.exe.