#htb #AD #windows 

Прежде чем двигаться дальше, давайте сделаем шаг назад и определимся с ключевыми терминами, которые будут использоваться в этом модуле и в целом при работе с Active Directory.

#### Объект

Объект можно определить как ЛЮБОЙ ресурс, присутствующий в среде Active Directory, например подразделения, принтеры, пользователи, контроллеры домена и т. д.

#### Атрибуты

Каждый объект в Active Directory имеет связанный с ним набор [атрибутов](https://docs.microsoft.com/en-us/windows/win32/adschema/attributes-all), используемых для определения характеристик данного объекта. Объект «компьютер» содержит такие атрибуты, как имя хоста и DNS-имя. Все атрибуты в AD имеют связанное имя LDAP, которое можно использовать при выполнении запросов LDAP, например `displayName` для `Full Name` и `given name` для `First Name`.

#### Схема

[Схема](https://docs.microsoft.com/en-us/windows/win32/ad/schema) Active Directory — это, по сути, план любой корпоративной среды. Она определяет, какие типы объектов могут существовать в базе данных AD и какие атрибуты с ними связаны. В ней перечислены определения, соответствующие объектам AD, и содержится информация о каждом объекте. Например, пользователи в AD относятся к классу «пользователь», а объекты «компьютер» — к классу «компьютер» и так далее. Каждый объект содержит собственную информацию (некоторые поля обязательны для заполнения, другие — необязательны), которая хранится в атрибутах. Когда объект создаётся на основе класса, это называется инстанцированием, а объект, созданный на основе определённого класса, называется экземпляром этого класса. Например, возьмём компьютер RDS01. Этот компьютерный объект является экземпляром класса «компьютер» в Active Directory.

#### Домен

Домен — это логическая группа объектов, таких как компьютеры, пользователи, организационные единицы, группы и т. д. Можно представить, что каждый домен — это отдельный город в штате или стране. Домены могут работать полностью независимо друг от друга или быть связанными доверительными отношениями.

#### Лес

Лес — это совокупность доменов Active Directory. Это самый верхний контейнер, содержащий все объекты AD, описанные ниже, в том числе домены, пользователей, группы, компьютеры и объекты групповой политики, но не ограничивающийся ими. Лес может содержать один или несколько доменов и может рассматриваться как штат в США или страна в ЕС. Каждый лес работает независимо, но может иметь различные доверительные отношения с другими лесами.

#### Дерево

Дерево — это совокупность доменов Active Directory, которая начинается с одного корневого домена. Лес — это совокупность деревьев AD. Каждый домен в дереве имеет общую границу с другими доменами. Доверительные отношения «родитель — потомок» формируются, когда домен добавляется в другой домен в дереве. Два дерева в одном лесу не могут иметь одинаковое имя (пространство имён). Допустим, в лесу AD есть два дерева: `inlanefreight.local` и `ilfreight.local`. Дочерним доменом первого будет `corp.inlanefreight.local`, а дочерним доменом второго — `corp.ilfreight.local`. Все домены в дереве имеют общий стандартный глобальный каталог, который содержит всю информацию об объектах, принадлежащих дереву.

#### Контейнер

Объекты-контейнеры содержат другие объекты и занимают определённое место в иерархии поддеревьев каталога.

#### Лист

Листовые объекты не содержат других объектов и находятся в конце иерархии поддеревьев.

#### Глобальный уникальный идентификатор (GUID)

[GUID](https://docs.microsoft.com/en-us/windows/win32/adschema/a-objectguid) — это уникальное 128-битное значение, присваиваемое при создании пользователя или группы в домене. Это значение GUID уникально для всего предприятия, подобно MAC-адресу. GUID присваивается каждому объекту, созданному в Active Directory, а не только объектам пользователей и групп. GUID хранится в атрибуте `ObjectGUID` . При запросе объекта AD (например, пользователя, группы, компьютера, домена, контроллера домена и т. д.) мы можем запросить его `objectGUID`-значение с помощью PowerShell или выполнить поиск, указав его отличительное имя, GUID, SID или имя учетной записи SAM. -значения GUID используются в AD для внутренней идентификации объектов. Поиск в Active Directory по значению GUID, вероятно, является самым точным и надёжным способом найти именно тот объект, который вам нужен, особенно если в глобальном каталоге могут быть похожие совпадения по имени объекта. Указание `ObjectGUID` значения при выполнении перечисления объявлений гарантирует получение наиболее точных результатов, относящихся к объекту, о котором мы ищем информацию. `ObjectGUID`Свойство `never` изменяется и ассоциируется с объектом до тех пор, пока этот объект существует в домене.

#### Участники системы безопасности

[Субъекты безопасности](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/security-principals) — это всё, что может пройти аутентификацию в операционной системе, включая пользователей, учётные записи компьютеров и даже потоки/процессы, которые выполняются в контексте учётной записи пользователя или компьютера (например, такое приложение, как Tomcat, работает в контексте учётной записи службы в домене). В AD субъекты безопасности — это объекты домена, которые могут управлять доступом к другим ресурсам в домене. Мы также можем использовать локальные учётные записи пользователей и группы безопасности для управления доступом к ресурсам только на этом конкретном компьютере. Они управляются не AD, а [диспетчером учетных записей безопасности (SAM)](https://en.wikipedia.org/wiki/Security_Account_Manager).

#### Идентификатор безопасности (SID)

[Идентификатор безопасности](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/security-principals), или SID, используется в качестве уникального идентификатора субъекта безопасности или группы безопасности. У каждой учетной записи, группы или процесса есть свой уникальный SID, который в среде Active Directory выдается контроллером домена и хранится в защищенной базе данных. SID можно использовать только один раз. Даже если субъект безопасности будет удален, его нельзя будет повторно использовать в этой среде для идентификации другого пользователя или группы. Когда пользователь входит в систему, система создает для него токен доступа, который содержит SID пользователя, предоставленные ему права и SID для любых групп, членом которых является пользователь. Этот токен используется для проверки прав всякий раз, когда пользователь выполняет действие на компьютере. Существуют также [хорошо известные SID](https://ldapwiki.com/wiki/Wiki.jsp?page=Well-known%20Security%20Identifiers), которые используются для идентификации обычных пользователей и групп. Они одинаковы во всех операционных системах. Примером является группа `Everyone`.

#### Выдающееся имя (ВИ)

[Отличительное имя (DN)](https://docs.microsoft.com/en-us/previous-versions/windows/desktop/ldap/distinguished-names) описывает полный путь к объекту в AD (например, `cn=bjones, ou=IT, ou=Employees, dc=inlanefreight, dc=local`). В этом примере пользователь `bjones` работает в ИТ-отделе компании Inlanefreight, и его учётная запись создана в организационном подразделении (OU), в котором хранятся учётные записи сотрудников компании. Общее имя (CN) `bjones` — это лишь один из способов поиска объекта пользователя или доступа к нему в домене.

#### Относительное выделенное имя (RDN)

[Относительное отличительное имя (ОДИ)](https://docs.microsoft.com/en-us/windows/win32/ad/object-names-and-identities) — это отдельный компонент отличительного имени, который позволяет отличить объект от других объектов на текущем уровне в иерархии именования. В нашем примере `bjones` — это относительное отличительное имя объекта. Служба каталогов не допускает наличия двух объектов с одинаковым именем в одном родительском контейнере, но могут существовать два объекта с одинаковыми ОДИ, которые при этом будут уникальными в домене, поскольку у них разные отличительные имена. Например, объект `cn=bjones,dc=dev,dc=inlanefreight,dc=local` будет отличаться от `cn=bjones,dc=inlanefreight,dc=local`.

![[Pasted image 20250907181151.png]]

#### Имя пользователя sAMAccountName

[sAMAccountName](https://docs.microsoft.com/en-us/windows/win32/ad/naming-properties#samaccountname) — это имя для входа в систему. Здесь это будет просто `bjones`. Это должно быть уникальное значение длиной не более 20 символов.

#### имя_пользователя

Атрибут [userPrincipalName](https://social.technet.microsoft.com/wiki/contents/articles/52250.active-directory-user-principal-name.aspx) — это ещё один способ идентификации пользователей в AD. Этот атрибут состоит из префикса (имени учётной записи пользователя) и суффикса (доменного имени) в формате `bjones@inlanefreight.local`. Этот атрибут не является обязательным.

#### Роли FSMO

На заре AD, если в среде было несколько контроллеров домена, они могли конфликтовать из-за того, какой из них будет вносить изменения, и иногда изменения вносились неправильно. Затем Microsoft внедрила принцип «побеждает последний написавший», который мог привести к новым проблемам, если последнее изменение нарушало работу системы. Затем была представлена модель, в которой один «главный» контроллер домена мог вносить изменения в домен, а остальные просто выполняли запросы на аутентификацию. Это была неудачная конструкция, поскольку в случае сбоя главного контроллера домена никакие изменения в среде не могли быть внесены до его восстановления. Чтобы устранить эту модель с единой точкой отказа, Microsoft разделила различные функции контроллера домена на [роли гибкой единой главной операции (Flexible Single Master Operation, FSMO)](https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/fsmo-roles). Это позволяет контроллерам домена (КД) продолжать аутентификацию пользователей и предоставлять разрешения без перебоев (авторизация и аутентификация). Существует пять ролей FSMO: `Schema Master` и `Domain Naming Master` (по одной на каждый лес), `Relative ID (RID) Master` (одна на каждый домен), `Primary Domain Controller (PDC) Emulator` (одна на каждый домен) и `Infrastructure Master` (одна на каждый домен). Все пять ролей назначаются первому контроллеру домена в корневом домене нового леса AD. При добавлении нового домена в лес ему назначаются только роли RID Master, PDC Emulator и Infrastructure Master. Роли FSMO обычно назначаются при создании контроллеров домена, но при необходимости системные администраторы могут перенести эти роли. Эти роли обеспечивают бесперебойную репликацию в AD и правильную работу критически важных служб. Подробнее о каждой из этих ролей мы расскажем далее в этом разделе.

#### Глобальный каталог

[Глобальный каталог (ГК)](https://docs.microsoft.com/en-us/windows/win32/ad/global-catalog) — это контроллер домена, на котором хранятся копии ВСЕХ объектов в лесу Active Directory. В ГК хранится полная копия всех объектов текущего домена и частичная копия объектов, принадлежащих другим доменам в лесу. Стандартные контроллеры домена содержат полную копию объектов, принадлежащих их домену, но не объектов других доменов в лесу. ГК позволяет пользователям и приложениям находить информацию о любых объектах в ЛЮБОМ домене в лесу. ГК — это функция, которая включена на контроллере домена и выполняет следующие функции:

- Аутентификация (предоставление авторизации для всех групп, к которым принадлежит учётная запись пользователя, что учитывается при создании токена доступа)
- Поиск объектов (делает структуру каталогов в лесу прозрачной, позволяя выполнять поиск по всем доменам в лесу, указав только один атрибут объекта).

#### Контроллер домена только для чтения (RODC)

[Контроллер домена только для чтения (RODC)](https://docs.microsoft.com/en-us/windows/win32/ad/rodc-and-active-directory-schema) имеет базу данных Active Directory только для чтения. На RODC не кэшируются пароли учетных записей AD (кроме пароля учетной записи компьютера RODC и паролей RODC KRBTGT). Изменения не передаются через базу данных AD, SYSVOL или DNS RODC. RODC также включает в себя DNS-сервер только для чтения, что позволяет разделить роли администратора, сократить трафик репликации в среде и предотвратить репликацию изменений SYSVOL на другие контроллеры домена.

#### Репликация

[Репликация](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/get-started/replication/active-directory-replication-concepts) происходит в AD, когда объекты AD обновляются и переносятся с одного контроллера домена на другой. При добавлении контроллера домена создаются объекты подключения для управления репликацией между ними. Эти подключения создаются службой проверки согласованности знаний (Knowledge Consistency Checker, KCC), которая присутствует на всех контроллерах домена. Репликация обеспечивает синхронизацию изменений со всеми остальными контроллерами домена в лесу, помогая создавать резервные копии на случай сбоя одного из контроллеров домена.

#### Имя участника-службы (SPN)

[Имя участника-службы (SPN)](https://docs.microsoft.com/en-us/windows/win32/ad/service-principal-names) однозначно идентифицирует экземпляр службы. Они используются при аутентификации по протоколу Kerberos для связывания экземпляра службы с учетной записью для входа, что позволяет клиентскому приложению запрашивать у службы аутентификацию учетной записи без необходимости знать ее имя.

#### Объект групповой политики (GPO)

[Объекты групповой политики (ОГП)](https://docs.microsoft.com/en-us/previous-versions/windows/desktop/policy/group-policy-objects) — это виртуальные наборы параметров политики. Каждый ОГП имеет уникальный идентификатор GUID. ОГП может содержать параметры локальной файловой системы или параметры Active Directory. Параметры ОГП можно применять как к объектам пользователей, так и к объектам компьютеров. Они могут применяться ко всем пользователям и компьютерам в домене или определяться более детально на уровне подразделения.

#### Список контроля доступа (ACL)

[Список контроля доступа (ACL)](https://docs.microsoft.com/en-us/windows/win32/secauthz/access-control-lists) — это упорядоченный набор записей контроля доступа (ACE), которые применяются к объекту.

#### Записи контроля доступа (ЗКД)

Каждая [запись о контроле доступа (ACE)](https://docs.microsoft.com/en-us/windows/win32/secauthz/access-control-entries) в ACL идентифицирует доверенного лица (учетную запись пользователя, учетную запись группы или сеанс входа в систему) и перечисляет права доступа, которые разрешены, отклонены или проверены для данного доверенного лица.

#### Список контроля дискреционного доступа (DACL)

DACL определяет, каким принципам безопасности предоставляется доступ к объекту, а каким — нет. Он содержит список ACE. Когда процесс пытается получить доступ к защищённому объекту, система проверяет ACE в DACL объекта, чтобы определить, предоставлять доступ или нет. Если у объекта НЕТ DACL, система предоставит полный доступ всем, но если в DACL нет записей ACE, система отклонит все попытки доступа. ACE в DACL проверяются последовательно до тех пор, пока не будет найдено совпадение, разрешающее запрошенные права, или пока не будет получен отказ в доступе.

#### Системные списки контроля доступа (SACL)

Позволяет администраторам регистрировать попытки доступа к защищенным объектам. ACE определяют типы попыток доступа, при которых система создает запись в журнале событий безопасности.

#### Полное доменное имя (FQDN)

Полное доменное имя - это полное имя для определенного компьютера или хоста. Оно записывается с именем хоста и доменным именем в формате [имя хоста].[доменное имя].[tld]. Это используется для указания местоположения объекта в древовидной иерархии DNS. ПОЛНОЕ доменное имя может использоваться для определения местоположения узлов в Active Directory без знания IP-адреса, аналогично переходу на веб-сайт, такой как google.com вместо ввода соответствующего IP-адреса. Примером может служить хост `DC01` в домене `INLANEFREIGHT.LOCAL`. Полное доменное имя здесь будет `DC01.INLANEFREIGHT.LOCAL`.

#### Надгробная плита

[Надгробие](https://ldapwiki.com/wiki/Wiki.jsp?page=Tombstone) — это объект-контейнер в AD, в котором хранятся удалённые объекты AD. Когда объект удаляется из AD, он остаётся в течение определённого периода времени, называемого `Tombstone Lifetime,`, а атрибуту `isDeleted` присваивается значение `TRUE`. По истечении `Tombstone Lifetime` объект будет полностью удалён. Microsoft рекомендует хранить надгробия в течение 180 дней, чтобы повысить эффективность резервного копирования, но это значение может отличаться в зависимости от среды. В зависимости от версии операционной системы контроллера домена это значение по умолчанию составляет 60 или 180 дней. Если объект удаляется в домене, в котором нет корзины AD Recycle Bin, он становится «мёртвым» объектом. В этом случае объект лишается большинства своих атрибутов и помещается в `Deleted Objects` контейнер на время `tombstoneLifetime`. Его можно восстановить, но утраченные атрибуты восстановить уже нельзя.

#### Корзина для рекламы

[Корзина AD](https://techcommunity.microsoft.com/t5/ask-the-directory-services-team/the-ad-recycle-bin-understanding-implementing-best-practices-and/ba-p/396944) впервые появилась в Windows Server 2008 R2, чтобы упростить восстановление удалённых объектов AD. Благодаря этому системным администраторам стало проще восстанавливать объекты, не прибегая к восстановлению из резервных копий, перезапуску доменных служб Active Directory (AD DS) или перезагрузке контроллера домена. Если корзина AD включена, все удалённые объекты сохраняются в течение определённого периода времени, что упрощает их восстановление в случае необходимости. Системные администраторы могут настроить срок хранения объекта в удалённом состоянии, доступном для восстановления. Если это не указано, объект будет доступен для восстановления в течение 60 дней по умолчанию. Самым большим преимуществом использования корзины AD является то, что большинство атрибутов удалённого объекта сохраняются, что значительно упрощает полное восстановление удалённого объекта до его предыдущего состояния.

#### СИСВОЛ

В папке [SYSVOL](https://social.technet.microsoft.com/wiki/contents/articles/8548.active-directory-sysvol-and-netlogon.aspx) или общем ресурсе хранятся копии общедоступных файлов домена, таких как системные политики, настройки групповой политики, сценарии входа в систему и выхода из неё, а также часто содержатся сценарии других типов, которые выполняются для решения различных задач в среде AD. Содержимое папки SYSVOL реплицируется на все контроллеры домена в среде с помощью служб репликации файлов (FRS). Подробнее о структуре SYSVOL можно прочитать [здесь](https://networkencyclopedia.com/sysvol-share/#Components-and-Structure).

#### Администратор , владелец

Объект [AdminSDHolder](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-c--protected-accounts-and-groups-in-active-directory) используется для управления списками управления доступом для участников встроенных групп в AD, помеченных как привилегированные. Он действует как контейнер, содержащий дескриптор безопасности, применяемый к членам защищенных групп. Процесс SDProp (SD Propagator) выполняется по расписанию на контроллере домена эмулятора PDC. Когда этот процесс выполняется, он проверяет участников защищенных групп, чтобы убедиться, что к ним применен правильный ACL. По умолчанию он выполняется каждый час. Например, предположим, что злоумышленник может создать вредоносную запись в списке управления доступом, чтобы предоставить пользователю определённые права в отношении члена группы «Администраторы домена» В этом случае, если злоумышленник не изменит другие настройки в AD, эти права будут удалены (и злоумышленник не добьётся желаемого постоянства) при запуске процесса SDProp с заданным интервалом.

#### Дшевристика

Атрибут [dsHeuristics](https://docs.microsoft.com/en-us/windows/win32/adschema/a-dsheuristics) — это строковое значение, заданное для объекта службы каталогов и используемое для определения нескольких параметров конфигурации на уровне леса. Один из таких параметров — исключение встроенных групп из списка [Защищенные группы](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-c--protected-accounts-and-groups-in-active-directory). Группы в этом списке защищены от изменений с помощью объекта `AdminSDHolder`. Если группа исключена с помощью атрибута `dsHeuristics`, то любые изменения, затрагивающие ее, не будут отменены при запуске процесса SDProp.

#### Количество администраторов

Атрибут [adminCount](https://docs.microsoft.com/en-us/windows/win32/adschema/a-admincount) определяет, защищает ли процесс SDProp пользователя. Если значение равно `0` или не указано, пользователь не защищён. Если значение атрибута равно `1`, пользователь защищён. Злоумышленники часто ищут учётные записи с атрибутом `adminCount`, установленным в значение `1`, чтобы атаковать их во внутренней среде. Зачастую это привилегированные учётные записи, которые могут привести к дальнейшему доступу или полной компрометации домена.

#### Пользователи и компьютеры Active Directory (ADUC)

ADUC — это консоль с графическим интерфейсом, которая обычно используется для управления пользователями, группами, компьютерами и контактами в AD. Изменения, внесённые в ADUC, можно также применить с помощью PowerShell.

#### ADSI Редактировать

ADSI Edit — это инструмент с графическим интерфейсом, который используется для управления объектами в AD. Он предоставляет гораздо больше возможностей, чем ADUC, и может использоваться для установки или удаления любого атрибута, доступного для объекта, а также для добавления, удаления и перемещения объектов. Это мощный инструмент, который позволяет пользователю получить доступ к AD на гораздо более глубоком уровне. При использовании этого инструмента следует соблюдать осторожность, так как внесённые изменения могут привести к серьёзным проблемам в AD.

#### Сидхистория

[Этот](https://docs.microsoft.com/en-us/defender-for-identity/cas-isp-unsecure-sid-history-attribute) атрибут содержит все идентификаторы SID, которые были назначены объекту ранее. Обычно он используется при миграции, чтобы пользователь мог сохранить тот же уровень доступа при переходе из одного домена в другой. Этот атрибут потенциально может быть использован не по назначению, если он установлен небезопасно. В этом случае злоумышленник может получить расширенный доступ, который был у учетной записи до миграции, если не включена фильтрация SID (или удаление SID из другого домена из токена доступа пользователя, который может быть использован для расширенного доступа).

#### NTDS.DIT

Файл NTDS.DIT можно считать сердцем Active Directory. Он хранится на контроллере домена по адресу `C:\Windows\NTDS\` и представляет собой базу данных, в которой хранятся данные AD, такие как информация об объектах пользователей и групп, членстве в группах и, что наиболее важно для злоумышленников и специалистов по тестированию на проникновение, хэши паролей всех пользователей домена. После полной компрометации домена злоумышленник может получить доступ к этому файлу, извлечь хэши и либо использовать их для атаки методом перебора, либо взломать их в автономном режиме с помощью такого инструмента, как Hashcat, чтобы получить доступ к дополнительным ресурсам домена. Если параметр [Хранить пароль с обратимым шифрованием](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/store-passwords-using-reversible-encryption) включен, то NTDS.DIT также будет хранить пароли в открытом виде для всех пользователей, которые были созданы или изменили свой пароль после установки этой политики. Хотя это и редкость, но некоторые организации могут включить этот параметр, если они используют приложения или протоколы, которым для аутентификации требуется существующий пароль пользователя (а не Kerberos).

#### MSBROWSE

MSBROWSE — это сетевой протокол Microsoft, который использовался в ранних версиях локальных сетей (LAN) на базе Windows для предоставления услуг просмотра. Он использовался для ведения списка ресурсов, таких как общие принтеры и файлы, доступных в сети, а также для того, чтобы пользователи могли легко просматривать эти ресурсы и получать к ним доступ.

В более старых версиях Windows для поиска главного браузера можно было использовать `nbtstat -A ip-address` . Если мы видим MSBROWSE, это значит, что это главный браузер. Кроме того, можно использовать утилиту `nltest` для запроса у главного браузера Windows имён контроллеров домена.

На сегодняшний день MSBROWSE в значительной степени устарел и больше не используется повсеместно. В современных локальных сетях на базе Windows для обмена файлами и принтерами используется протокол Server Message Block (SMB), а для просмотра — протокол Common Internet File System (CIFS).