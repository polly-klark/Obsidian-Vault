#AD #htb #windows 

В то время как операционные системы Windows используют различные протоколы для обмена данными, для Active Directory требуются [облегчённый протокол доступа к каталогам (Lightweight Directory Access Protocol, LDAP)](https://en.wikipedia.org/wiki/Lightweight_Directory_Access_Protocol), версия [Kerberos](https://en.wikipedia.org/wiki/Kerberos_\(protocol\)) от Microsoft, [DNS](https://en.wikipedia.org/wiki/Domain_Name_System) для аутентификации и обмена данными, а также [MSRPC](https://ldapwiki.com/wiki/MSRPC), который представляет собой реализацию Microsoft [вызова удалённых процедур (Remote Procedure Call, RPC)](https://en.wikipedia.org/wiki/Remote_procedure_call), метода межпроцессного взаимодействия, используемого в приложениях на основе модели «клиент-сервер».

---

## Керберос

Начиная с Windows 2000, протокол Kerberos используется по умолчанию для аутентификации учётных записей домена. Kerberos — это открытый стандарт, который обеспечивает взаимодействие с другими системами, использующими тот же стандарт. Когда пользователь входит в систему на своём ПК, Kerberos используется для взаимной аутентификации, то есть и пользователь, и сервер подтверждают свою личность. Kerberos — это протокол аутентификации без сохранения состояния, основанный на билетах, а не на передаче паролей пользователей по сети. В рамках доменных служб Active Directory (AD DS) контроллеры домена имеют центр распределения ключей Kerberos (KDC), который выдает билеты. Когда пользователь отправляет запрос на вход в систему, клиент, который он использует для аутентификации, запрашивает билет у KDC, шифруя запрос с помощью пароля пользователя. Если KDC может расшифровать запрос (AS-REQ) с помощью пароля, он создаст билет для выдачи билетов (TGT) и передаст его пользователю. Затем пользователь отправляет свой TGT на контроллер домена, чтобы запросить билет службы выдачи билетов (TGS), зашифрованный с помощью хэша пароля NTLM соответствующей службы. Наконец, клиент запрашивает доступ к нужной службе, предоставляя TGS приложению или службе, которые расшифровывают его с помощью хэша пароля. Если весь процесс проходит успешно, пользователю предоставляется доступ к запрошенной службе или приложению.

Аутентификация Kerberos эффективно отделяет учётные данные пользователей от их запросов к потребляемым ресурсам, гарантируя, что их пароль не будет передан по сети (например, при доступе к внутреннему сайту SharePoint). Центр распределения ключей Kerberos (KDC) не записывает предыдущие транзакции. Вместо этого служба выдачи билетов Kerberos (TGS) использует действительный билет выдачи билетов (TGT). Предполагается, что если у пользователя есть действительный TGT, значит, он подтвердил свою личность. На следующей схеме этот процесс показан в общих чертах.

#### Процесс аутентификации Kerberos

| |
|---|
|1. Когда пользователь входит в систему, его пароль используется для шифрования временной метки, которая отправляется в центр распределения ключей (Key Distribution Center, KDC) для проверки подлинности путём её расшифровки. Затем KDC выдаёт билет для выдачи билетов (Ticket-Granting Ticket, TGT), шифруя его секретным ключом учётной записи krbtgt. Этот билет используется для запроса служебных билетов для доступа к сетевым ресурсам, что позволяет проходить аутентификацию без повторной передачи учётных данных пользователя. Этот процесс отделяет учётные данные пользователя от запросов к ресурсам.|
|2. Служба KDC на контроллере домена проверяет запрос на аутентификацию (AS-REQ), сверяет данные пользователя и создаёт билет для выдачи разрешений (TGT), который доставляется пользователю.|
|3. Пользователь предъявляет TGT контролёру, запрашивая билет службы выдачи билетов (TGS) для конкретной услуги. Это запрос TGS-REQ. Если TGT успешно проверен, его данные копируются для создания билета TGS.|
|4. TGS шифруется с помощью хэша пароля NTLM службы или учётной записи компьютера, в контексте которой работает экземпляр службы, и доставляется пользователю в TGS_REP.|
|5. Пользователь предъявляет TGS службе, и, если он действителен, пользователю разрешается подключиться к ресурсу (AP_REQ).|

![[Pasted image 20250907181431.png]]

Протокол Kerberos использует порт 88 (как TCP, так и UDP). При перечислении объектов в среде Active Directory мы часто можем найти контроллеры домена, выполнив сканирование портов в поисках открытого порта 88 с помощью такого инструмента, как Nmap.

---

## DNS

Доменные службы Active Directory (AD DS) используют DNS, чтобы клиенты (рабочие станции, серверы и другие системы, взаимодействующие с доменом) могли находить контроллеры домена, а контроллеры домена, на которых размещена служба каталогов, могли взаимодействовать друг с другом. DNS используется для преобразования имён хостов в IP-адреса и широко применяется во внутренних сетях и Интернете. Частные внутренние сети используют пространства имён DNS Active Directory для упрощения взаимодействия между серверами, клиентами и одноранговыми узлами. AD ведёт базу данных служб, работающих в сети, в виде записей служб (SRV). Эти служебные записи позволяют клиентам в среде Active Directory находить нужные им службы, например файловый сервер, принтер или контроллер домена. Динамический DNS используется для автоматического внесения изменений в базу данных DNS при смене IP-адреса системы. Внесение этих записей вручную заняло бы много времени и могло бы привести к ошибкам. Если в базе данных DNS нет правильного IP-адреса хоста, клиенты не смогут найти его в сети и установить с ним связь. Когда клиент подключается к сети, он находит контроллер домена, отправляя запрос в службу DNS, получая SRV-запись из базы данных DNS и передавая клиенту имя хоста контроллера домена. Затем клиент использует это имя хоста для получения IP-адреса контроллера домена. DNS использует TCP и UDP-порт 53. По умолчанию используется UDP-порт 53, но при потере связи и если размер DNS-сообщений превышает 512 байт, используется TCP.

![[Pasted image 20250907181438.png]]

#### Прямой Поиск DNS

Давайте рассмотрим пример. Мы можем выполнить `nslookup` для доменного имени и получить все IP-адреса контроллеров домена в этом домене.

  Kerberos, DNS, LDAP, MSRPC

```powershell-session
PS C:\htb> nslookup INLANEFREIGHT.LOCAL

Server:  172.16.6.5
Address:  172.16.6.5

Name:    INLANEFREIGHT.LOCAL
Address:  172.16.6.5
```

#### Обратный поиск DNS

Если нам нужно получить DNS-имя отдельного хоста по IP-адресу, мы можем сделать это следующим образом:

  Kerberos, DNS, LDAP, MSRPC

```powershell-session
PS C:\htb> nslookup 172.16.6.5

Server:  172.16.6.5
Address:  172.16.6.5

Name:    ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
Address:  172.16.6.5
```

#### Определение IP-адреса хоста

Если нам нужно узнать IP-адрес одного хоста, мы можем сделать это в обратном порядке. Мы можем сделать это как с указанием полного доменного имени, так и без него.

  Kerberos, DNS, LDAP, MSRPC

```powershell-session
PS C:\htb> nslookup ACADEMY-EA-DC01

Server:   172.16.6.5
Address:  172.16.6.5

Name:    ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
Address:  172.16.6.5
```

Для более глубокого изучения DNS ознакомьтесь с модулем [Перечисление DNS с помощью Python](https://academy.hackthebox.com/course/preview/dns-enumeration-using-python) и разделом DNS в модуле [Сбор информации — веб-версия](https://academy.hackthebox.com/course/preview/information-gathering---web-edition).

---

## LDAP

Active Directory поддерживает [облегчённый протокол доступа к каталогам (Lightweight Directory Access Protocol, LDAP)](https://en.wikipedia.org/wiki/Lightweight_Directory_Access_Protocol) для поиска в каталогах. LDAP — это кроссплатформенный протокол с открытым исходным кодом, который используется для аутентификации в различных службах каталогов (таких как AD). Последняя версия спецификации LDAP — [версия 3](https://tools.ietf.org/html/rfc4511), опубликованная в виде RFC 4511. Для злоумышленников и специалистов по защите критически важно понимать, как работает LDAP в среде AD. LDAP использует порт 389, а LDAP через SSL (LDAPS) — порт 636.

AD хранит информацию об учётных записях пользователей и данные о безопасности, такие как пароли, и обеспечивает обмен этой информацией с другими устройствами в сети. LDAP — это язык, который приложения используют для взаимодействия с другими серверами, предоставляющими службы каталогов. Другими словами, LDAP — это способ, с помощью которого системы в сетевой среде могут «общаться» с AD.

Сеанс LDAP начинается с подключения к серверу LDAP, также известному как агент системы каталогов. Контроллер домена в AD активно прослушивает запросы LDAP, например запросы на аутентификацию.

![[Pasted image 20250907181446.png]]

Взаимосвязь между AD и LDAP можно сравнить с взаимосвязью между Apache и HTTP. Точно так же, как Apache — это веб-сервер, использующий протокол HTTP, Active Directory — это сервер каталогов, использующий протокол LDAP.

Хотя это и редкость, но при проведении оценки вы можете столкнуться с организацией, в которой нет AD, но используется LDAP. Это означает, что они, скорее всего, используют другой тип сервера LDAP, например [OpenLDAP](https://en.wikipedia.org/wiki/OpenLDAP).

#### Проверка подлинности AD LDAP

LDAP настроен на аутентификацию учётных данных в AD с помощью операции «BIND» для установки состояния аутентификации для сеанса LDAP. Существует два типа аутентификации LDAP.

1. `Simple Authentication`Сюда входят анонимная аутентификация, аутентификация без подтверждения подлинности и аутентификация по имени пользователя и паролю. Простая аутентификация означает, что `username` и `password` создают запрос BIND для аутентификации на сервере LDAP.
    
2. `SASL Authentication`[Простой уровень аутентификации и безопасности (SASL)](https://en.wikipedia.org/wiki/Simple_Authentication_and_Security_Layer) использует другие службы аутентификации, например Kerberos, для привязки к серверу LDAP, а затем использует эту службу аутентификации (в данном примере Kerberos) для аутентификации в LDAP. Сервер LDAP использует протокол LDAP для отправки сообщения LDAP в службу авторизации, которая инициирует серию запросов и ответов, в результате чего аутентификация проходит успешно или нет. SASL может обеспечить дополнительную безопасность за счёт отделения методов аутентификации от протоколов приложений.
    

Сообщения об аутентификации LDAP по умолчанию отправляются в открытом виде, поэтому любой может перехватить сообщения LDAP во внутренней сети. Для защиты этой информации при передаче рекомендуется использовать шифрование TLS или аналогичное.

---

## MSRPC

Как упоминалось выше, MSRPC — это реализация Microsoft удалённого вызова процедур (RPC), метода межпроцессного взаимодействия, используемого в приложениях на основе модели «клиент-сервер». Системы Windows используют MSRPC для доступа к системам в Active Directory с помощью четырёх ключевых интерфейсов RPC.

|Имя интерфейса|Описание|
|---|---|
|`lsarpc`|Набор RPC-вызовов для системы [Local Security Authority (LSA)](https://networkencyclopedia.com/local-security-authority-lsa/), которая управляет локальной политикой безопасности на компьютере, контролирует политику аудита и предоставляет услуги интерактивной аутентификации. LSARPC используется для управления политиками безопасности домена.|
|`netlogon`|Netlogon — это процесс Windows, используемый для аутентификации пользователей и других служб в доменной среде. Это служба, которая постоянно работает в фоновом режиме.|
|`samr`|Remote SAM (samr) предоставляет функции управления базой данных учетных записей домена, в которой хранится информация о пользователях и группах. ИТ-администраторы используют этот протокол для управления пользователями, группами и компьютерами, что позволяет администраторам создавать, считывать, обновлять и удалять информацию о принципах обеспечения безопасности. Злоумышленники (и специалисты по тестированию на проникновение) могут использовать протокол samr для сбора информации о внутреннем домене с помощью таких инструментов, как [BloodHound](https://github.com/BloodHoundAD/), чтобы визуально отобразить сеть AD и создать «пути атаки», наглядно демонстрирующие, как можно получить административный доступ или полностью скомпрометировать домен. Организации могут [защититься](https://stealthbits.com/blog/making-internal-reconnaissance-harder-using-netcease-and-samri1o/) от такого рода разведки, изменив ключ реестра Windows таким образом, чтобы только администраторы могли выполнять удалённые запросы к SAM, поскольку по умолчанию все пользователи домена, прошедшие аутентификацию, могут выполнять эти запросы для сбора значительного объёма информации о домене AD.|
|`drsuapi`|drsuapi — это API-интерфейс Microsoft, реализующий удалённый протокол службы репликации каталогов (DRS), который используется для выполнения задач, связанных с репликацией, на контроллерах домена в среде с несколькими контроллерами домена. Злоумышленники могут использовать drsuapi для [создания копии базы данных домена Active Directory](https://attack.mitre.org/techniques/T1003/003/) (NTDS.dit) и получения хэшей паролей для всех учётных записей в домене. Затем эти хэши можно использовать для проведения атак Pass-the-Hash для получения доступа к большему количеству систем или взломать их в автономном режиме с помощью такого инструмента, как Hashcat, чтобы получить пароль в открытом виде для входа в системы, использующие протоколы удалённого управления, такие как Remote Desktop (RDP) и WinRM.|

Включите пошаговые решения для всех вопросов![Иконка с блёстками](https://academy.hackthebox.com/images/sparkles-solid.svg)