#htb #windows #AD 

Active Directory (AD) — это служба каталогов для сетевых сред Windows. Это распределённая иерархическая структура, которая позволяет централизованно управлять ресурсами организации, включая пользователей, компьютеры, группы, сетевые устройства, общие файловые ресурсы, групповые политики, устройства и трасты. AD обеспечивает функции аутентификации и авторизации в среде домена Windows. В последние годы она всё чаще подвергается атакам. Она разработана с учётом обратной совместимости, и многие её функции, возможно, не являются «безопасными по умолчанию», а её конфигурацию легко нарушить. Эту уязвимость можно использовать для горизонтального и вертикального перемещения внутри сети и получения несанкционированного доступа. AD — это, по сути, большая база данных только для чтения, доступная всем пользователям домена, независимо от уровня их привилегий. Базовая учётная запись пользователя AD без дополнительных привилегий может перечислять большинство объектов в AD. В связи с этим крайне важно обеспечить надлежащую защиту AD, поскольку ЛЮБАЯ учётная запись пользователя, независимо от уровня его привилегий, может использоваться для перечисления объектов домена и тщательного поиска неправильных настроек и уязвимостей. Кроме того, несколько атак могут быть совершены с использованием только стандартной учётной записи пользователя домена, что подчёркивает важность стратегии эшелонированной защиты и тщательного планирования с упором на безопасность и усиление защиты AD, сегментацию сети и принцип наименьших привилегий. Одним из примеров является атака [noPac](https://www.secureworks.com/blog/nopac-a-tale-of-two-vulnerabilities-that-could-end-in-ransomware), впервые опубликованная в декабре 2021 года.

Active Directory упрощает поиск и использование информации для администраторов и пользователей. AD обладает высокой масштабируемостью, поддерживает миллионы объектов в домене и позволяет создавать дополнительные домены по мере роста организации.

![[Pasted image 20250907180807.png]] [Источник](https://dbaontap.com/2016/11/25/oem13c-roles-ad-groups/active-directory/)

По оценкам, около 95% [Fortune 500](https://en.wikipedia.org/wiki/Fortune_500) компаний используют Active Directory, что делает эту систему ключевым объектом для злоумышленников. Успешная атака, например фишинг, в результате которого злоумышленник попадает в среду Active Directory в качестве обычного пользователя домена, дает ему достаточный доступ для начала сканирования домена и поиска путей для атаки. Как специалисты по безопасности, мы на протяжении всей своей карьеры будем сталкиваться со средами Active Directory любого размера. Чтобы лучше понимать, как действуют злоумышленники и как их защищаются, важно знать структуру и функции Active Directory.

Операторы программ-вымогателей все чаще используют Active Directory в качестве ключевого элемента своих атак. Было показано, что [программа-вымогатель Conti](https://www.cisa.gov/sites/default/files/publications/AA21-265A-Conti_Ransomware_TLP_WHITE.pdf), которая использовалась в более чем 400 атаках по всему миру, задействует недавние критические уязвимости Active Directory, такие как [PrintNightmare (CVE-2021-34527)](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527) и [Zerologon (CVE-2020-1472)](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2020-1472), для повышения привилегий и горизонтального перемещения в целевой сети. Понимание структуры и функций Active Directory — первый шаг на пути к карьере, которая позволит находить и предотвращать подобные уязвимости до того, как это сделают злоумышленники. Исследователи постоянно обнаруживают новые атаки с чрезвычайно высоким уровнем риска, которые затрагивают среды Active Directory и часто требуют наличия всего лишь стандартного пользователя домена для получения полного административного контроля над всем доменом. Существует множество отличных инструментов с открытым исходным кодом для тестирования на проникновение, с помощью которых можно проводить аудит и атаковать Active Directory. Однако для наиболее эффективного использования этих инструментов необходимо понимать, как работает Active Directory, чтобы выявлять очевидные и скрытые уязвимости. Эффективность инструментов зависит от знаний их оператора. Поэтому давайте потратим время на то, чтобы разобраться в структуре и функциях Active Directory, прежде чем переходить к последующим модулям, в которых основное внимание будет уделено ручному и автоматизированному перечислению, атакам, горизонтальному перемещению, постэксплуатации и сохранению доступа.

Этот модуль заложит основу для начала работы по перечислению и атаке на Active Directory. Мы подробно рассмотрим структуру и функции AD, обсудим различные объекты AD, права и привилегии пользователей, инструменты и процессы управления AD и даже рассмотрим примеры настройки небольшой среды AD.

---

## История создания Active Directory

LDAP, основа Active Directory, впервые была представлена в [RFC](https://en.wikipedia.org/wiki/Request_for_Comments) ещё в 1971 году. Active Directory появилась раньше концепции [X.500](https://en.wikipedia.org/wiki/X.500) организационных единиц, которая была самой ранней версией всех систем каталогов, созданных Novell и Lotus и выпущенных в 1993 году под названием [Novell Directory Services](https://en.wikipedia.org/wiki/NetIQ_eDirectory).

Active Directory впервые появилась в середине 1990-х годов, но стала частью операционной системы Windows только после выхода Windows Server 2000. Microsoft впервые попыталась внедрить службы каталогов в 1990 году с выходом Windows NT 3.0. Эта операционная система сочетала в себе функции протокола [LAN Manager](https://en.wikipedia.org/wiki/LAN_Manager) и операционных систем [OS/2](https://en.wikipedia.org/wiki/OS/2), которые Microsoft изначально создавала совместно с IBM под руководством [Эда Якобуччи](https://en.wikipedia.org/wiki/Ed_Iacobucci), который также руководил разработкой [IBM DOS](https://en.wikipedia.org/wiki/IBM_PC_DOS) и позже стал соучредителем Citrix Systems. Операционная система NT развивалась на протяжении 90-х годов, адаптируя такие протоколы, как LDAP и Kerberos, с помощью собственных элементов Microsoft. Первая бета-версия Active Directory была выпущена в 1997 году.

В Windows Server 2003 была расширена функциональность, улучшено администрирование и добавлена функция `Forest`, которая позволяет системным администраторам создавать «контейнеры» из отдельных доменов, пользователей, компьютеров и других объектов, объединённых под одной крышей. [Службы федерации Active Directory (ADFS)](https://en.wikipedia.org/wiki/Active_Directory_Federation_Services) были представлены в Server 2008 для обеспечения единого входа (SSO) в системы и приложения для пользователей операционных систем Windows Server. Благодаря ADFS пользователям стало проще и удобнее входить в приложения и системы, находящиеся за пределами их локальной сети.

ADFS позволяет пользователям получать доступ к приложениям через границы организации, используя единый набор учетных данных. ADFS использует модель авторизации контроля доступа на основе [утверждений](https://en.wikipedia.org/wiki/Claims-based_identity), которая пытается обеспечить безопасность во всех приложениях путем идентификации пользователей по набору утверждений, связанных с их идентификацией, которые упаковываются поставщиком удостоверений в маркер безопасности.

Выпуск Server 2016 привнёс в Active Directory ещё больше изменений, таких как возможность переноса сред AD в облако и дополнительные функции безопасности, например мониторинг доступа пользователей и [управляемые групповые учётные записи служб (gMSA)](https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/service-accounts-group-managed). gMSA обеспечивает более безопасный способ запуска определённых автоматизированных задач, приложений и служб и часто рекомендуется для защиты от печально известной атаки Kerberoasting.

В 2016 году произошёл значительный сдвиг в сторону облачных технологий: была выпущена служба Azure AD Connect, которая представляла собой единый метод входа для пользователей, переходящих в среду Microsoft Office 365.

С 2000 года и по сей день Active Directory страдает от различных ошибок в конфигурации. Регулярно обнаруживаются новые уязвимости, затрагивающие Active Directory и другие технологии, взаимодействующие с AD, например Microsoft Exchange. Поскольку исследователи в области безопасности продолжают находить новые уязвимости, организациям, использующим Active Directory, необходимо своевременно устанавливать исправления. Наша задача как специалистов по тестированию на проникновение — находить эти уязвимости для наших клиентов до того, как их обнаружат злоумышленники.

По этой причине мы должны хорошо разбираться в основах Active Directory и понимать её структуру, функции, различные протоколы, которые она использует для работы, принципы управления правами и привилегиями пользователей, способы администрирования AD системными администраторами, а также множество уязвимостей и неправильных настроек, которые могут присутствовать в среде AD. Управление AD — непростая задача. Одно изменение/исправление может привести к дополнительным проблемам в других местах. Прежде чем приступить к перечислению и атаке на Active Directory, давайте рассмотрим основополагающие концепции, которые будут сопровождать нас на протяжении всей карьеры в сфере информационной безопасности.

Как уже было сказано, 95% компаний из списка Fortune 500 используют Active Directory, а Microsoft практически полностью монополизировала рынок служб каталогов. Несмотря на то, что многие компании переходят на облачные и гибридные среды, локальная служба каталогов AD никуда не денется. Если вы проводите тестирование сетей на проникновение, то почти наверняка столкнётесь с AD.

Эти фундаментальные знания помогут нам стать более эффективными злоумышленниками и дадут представление об AD, которое будет чрезвычайно полезно при консультировании наших клиентов по вопросам восстановления. Глубокое понимание AD позволит нам не бояться углубляться в детали, и мы будем чувствовать себя уверенно как при работе со средой с 10 000 хостов, так и со средой с 20 хостами.