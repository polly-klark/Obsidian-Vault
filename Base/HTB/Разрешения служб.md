#windows #htb 

Напомним, что службы позволяют управлять длительными процессами и являются важной частью операционных систем Windows. Системные администраторы часто упускают из виду, что они могут быть потенциальными источниками угроз, которые могут использоваться для загрузки вредоносных библиотек DLL, запуска приложений без доступа к учётной записи администратора, повышения привилегий и даже сохранения состояния. Эти источники угроз в службах Windows часто возникают из-за неправильных настроек разрешений служб, установленных сторонним программным обеспечением, и из-за ошибок, которые легко допустить администраторам во время установки.

Первым шагом к осознанию важности разрешений для служб является простое понимание того, что они существуют, и осведомлённость о них. В серверных операционных системах критически важные сетевые службы, такие как DHCP и доменные службы Active Directory, обычно устанавливаются с использованием учётной записи, назначенной администратору, выполняющему установку. Часть процесса установки включает назначение конкретной службы для запуска с использованием учётных данных и привилегий назначенного пользователя, которые по умолчанию устанавливаются в контексте пользователя, вошедшего в систему в данный момент.

Например, если мы вошли в систему под именем Боба на сервере во время установки DHCP, то эта служба будет настроена на запуск от имени Боба, если не указано иное. К чему это может привести? Ну, а что, если Боб покинет организацию или его уволят? Типичной деловой практикой будет отключение учётной записи Боба в рамках процесса его увольнения. Что в этом случае произойдёт с DHCP и другими службами, работающими под учётной записью Боба? Эти службы не смогут запуститься. DHCP, или протокол динамической конфигурации хоста, отвечает за предоставление IP-адресов компьютерам в сети. Если эта служба остановится на DHCP-сервере Windows, клиенты, запрашивающие IP-адрес, не получат его. Это означает, что неправильная настройка службы может привести к простою и потере производительности. Настоятельно рекомендуется создать отдельную учётную запись пользователя для запуска критически важных сетевых служб. Они называются служебными учётными записями.

Мы также должны помнить о разрешениях служб и разрешениях каталогов, из которых они запускаются, потому что можно заменить путь к исполняемому файлу вредоносной библиотекой DLL или исполняемым файлом. Давайте рассмотрим разрешения служб, работающих в Windows 10, чтобы лучше понять это.

---

## Изучение сервисов с помощью services.msc

Как обсуждалось в разделе «Процессы и сервисы», мы можем использовать `services.msc` для просмотра и управления практически всеми деталями, связанными со всеми сервисами. Давайте подробнее рассмотрим сервис, связанный с `Windows Update` (`wuauserv`).

![Окно «Службы» показывает свойства Центра обновления Windows с указанием имени службы, описания и текущего состояния.](https://academy.hackthebox.com/storage/modules/49/service_properties.png)

Обратите внимание на различные свойства, доступные для просмотра и настройки. Знание имени службы особенно полезно при использовании инструментов командной строки для проверки служб и управления ими. Путь к исполняемому файлу — это полный путь к программе и команде, которые будут выполняться при запуске службы. Если права доступа NTFS в целевом каталоге настроены неправильно, злоумышленник может заменить исходный исполняемый файл на созданный для вредоносных целей. Подробнее о правах доступа NTFS мы расскажем в разделе «Права доступа NTFS в сравнении с общими правами доступа» этого модуля.

![В окне «Службы» отображаются свойства Центра обновления Windows с параметрами входа для учётной записи «Локальная система» и конкретной учётной записи пользователя.](https://academy.hackthebox.com/storage/modules/49/logon.png)

По умолчанию большинство служб работают с правами LocalSystem, что является самым высоким уровнем доступа, разрешённым в отдельной ОС Windows. Не всем приложениям требуются разрешения на уровне учётной записи Local System, поэтому при установке новых приложений в среде Windows рекомендуется проводить исследования в каждом конкретном случае. Рекомендуется определять приложения, которые могут работать с наименьшим количеством привилегий, чтобы соответствовать принципу наименьших привилегий.

[Вот одно из проявлений принципа наименьших привилегий](https://www.cloudflare.com/learning/access-management/principle-of-least-privilege/)

Известные встроенные учетные записи служб в Windows:

- Локальный сервис
    
- Сетевой сервис
    
- Локальная система
    

Примечание: мы также можем создавать новые учётные записи и использовать их исключительно для предоставления услуг.

![Свойства Центра обновления Windows, показывающие варианты восстановления при сбоях службы, включая такие действия, как перезапуск службы или компьютера.](https://academy.hackthebox.com/storage/modules/49/recovery_screen.png)

На вкладке «Восстановление» можно настроить действия на случай сбоя службы. Обратите внимание, что эту службу можно настроить на запуск программы после первого сбоя. Это ещё один способ, с помощью которого злоумышленник может запустить вредоносные программы, используя легитимную службу.

---

## Проверка сервисов с использованием sc

Sc также можно использовать для настройки служб и управления ими. Давайте поэкспериментируем с несколькими командами.

  Разрешения служб

```cmd-session
C:\Users\htb-student>sc qc wuauserv
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: wuauserv
        TYPE               : 20  WIN32_SHARE_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : C:\WINDOWS\system32\svchost.exe -k netsvcs -p
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : Windows Update
        DEPENDENCIES       : rpcss
        SERVICE_START_NAME : LocalSystem
```

Команда `sc qc` используется для запроса службы. Вот где может пригодиться знание названий служб. Если мы хотим запросить службу на устройстве по сети, мы можем указать имя хоста или IP-адрес сразу после `sc`.

Разрешения служб

```cmd-session
C:\Users\htb-student>sc //hostname or ip of box query ServiceName

```

Мы также можем использовать sc для запуска и остановки служб.

 Разрешения служб

```cmd-session
C:\Users\htb-student> sc stop wuauserv

[SC] OpenService FAILED 5:

Access is denied.
```

Обратите внимание, что нам отказано в доступе к выполнению этого действия без запуска в административном контексте. Если мы запустим командную строку с помощью `elevated privileges`, нам будет разрешено выполнить это действие.

  Разрешения служб

```cmd-session
C:\WINDOWS\system32> sc config wuauserv binPath=C:\Winbows\Perfectlylegitprogram.exe

[SC] ChangeServiceConfig SUCCESS

C:\WINDOWS\system32> sc qc wuauserv

[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: wuauserv
        TYPE               : 20  WIN32_SHARE_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : C:\Winbows\Perfectlylegitprogram.exe
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : Windows Update
        DEPENDENCIES       : rpcss
        SERVICE_START_NAME : LocalSystem
```

Если бы мы расследовали ситуацию, в которой подозревали наличие вредоносного ПО в системе, sc позволил бы нам быстро искать и анализировать часто используемые и недавно созданные службы. Он также гораздо удобнее для написания скриптов, чем инструменты с графическим интерфейсом, такие как `services.msc`.

Другой полезный способ проверить разрешения службы с помощью `sc` — использовать команду `sdshow` .

  Разрешения служб

```cmd-session
C:\WINDOWS\system32> sc sdshow wuauserv

D:(A;;CCLCSWRPLORC;;;AU)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;SY)S:(AU;FA;CCDCLCSWRPWPDTLOSDRCWDWO;;;WD)
```

На первый взгляд вывод выглядит безумным. Кажется, что мы что-то не так сделали в нашей команде, но в этом безумии есть смысл. Каждый именованный объект в Windows является [защищаемым объектом](https://docs.microsoft.com/en-us/windows/win32/secauthz/securable-objects), и даже некоторые безымянные объекты являются защищаемыми. Если объект является защищаемым в ОС Windows, у него будет [дескриптор безопасности](https://docs.microsoft.com/en-us/windows/win32/secauthz/security-descriptors). Дескрипторы безопасности определяют владельца объекта и основную группу, содержащую `Discretionary Access Control List` (`DACL`) и `System Access Control List` (`SACL`).

Как правило, DACL используется для управления доступом к объекту, а SACL — для учёта и регистрации попыток доступа. В этом разделе мы рассмотрим DACL, но те же принципы применимы и к SACL.

```
D:(A;;CCLCSWRPLORC;;;AU)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;SY)
```

Это сочетание символов, объединённых вместе и разделённых открывающими и закрывающими скобками, представляет собой формат, известный как `Security Descriptor Definition Language` (`SDDL`).

У нас может возникнуть соблазн читать слева направо, потому что именно так обычно пишут на английском языке, но при взаимодействии с компьютерами всё может быть совсем по-другому. Прочтите весь дескриптор безопасности для службы `Windows Update` (`wuauserv`) в указанном порядке, начиная с первой буквы и набора скобок:

`D: (A;;CCLCSWRPLORC;;;AU)`

1. D: - исходящие символы являются разрешениями DACL
2. AU: - определяет участников процесса безопасности, прошедших проверку подлинности пользователей
3. A;;- доступ разрешен
4. CC — SERVICE_QUERY_CONFIG — это полное название запроса к диспетчеру управления службами (SCM) для получения конфигурации службы
5. LC — SERVICE_QUERY_STATUS — это полное название запроса к диспетчеру управления службами (SCM) о текущем статусе службы
6. SW — SERVICE_ENUMERATE_DEPENDENTS — это полное название, и оно перечисляет список зависимых служб
7. RP — полное название, и оно запустит службу
8. LO — SERVICE_INTERROGATE — это полное название, и оно запрашивает у службы текущий статус
9. RC — полное имя, и оно запрашивает дескриптор безопасности службы

Читая дескриптор безопасности, можно легко запутаться в кажущемся случайным порядке символов, но помните, что мы, по сути, просматриваем записи контроля доступа в списке контроля доступа. Каждый набор из двух символов между точками с запятой обозначает действия, которые может выполнять конкретный пользователь или группа.

`;;CCLCSWRPLORC;;;`

После последней пары точек с запятой символы указывают на субъект безопасности (пользователя и/или группу), которому разрешено выполнять эти действия.

`;;;AU`

Символ, стоящий сразу после открывающих скобок и перед первым набором точек с запятой, определяет, разрешены ли действия.

`A;;`

Весь этот дескриптор безопасности, связанный со службой `Windows Update` (`wuauserv`), содержит три набора записей контроля доступа, поскольку существует три разных субъекта безопасности. К каждому субъекту безопасности применяются определённые разрешения.

---

## Проверьте разрешения службы с помощью PowerShell

С помощью командлета `Get-Acl` PowerShell мы можем проверить разрешения службы, указав путь к конкретной службе в реестре.

  Разрешения служб

```powershell-session
PS C:\Users\htb-student> Get-ACL -Path HKLM:\System\CurrentControlSet\Services\wuauserv | Format-List

Path   : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\wuauserv
Owner  : NT AUTHORITY\SYSTEM
Group  : NT AUTHORITY\SYSTEM
Access : BUILTIN\Users Allow  ReadKey
         BUILTIN\Users Allow  -2147483648
         BUILTIN\Administrators Allow  FullControl
         BUILTIN\Administrators Allow  268435456
         NT AUTHORITY\SYSTEM Allow  FullControl
         NT AUTHORITY\SYSTEM Allow  268435456
         CREATOR OWNER Allow  268435456
         APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES Allow  ReadKey
         APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES Allow  -2147483648
         S-1-15-3-1024-1065365936-1281604716-3511738428-1654721687-432734479-3232135806-4053264122-3456934681 Allow
         ReadKey
         S-1-15-3-1024-1065365936-1281604716-3511738428-1654721687-432734479-3232135806-4053264122-3456934681 Allow
         -2147483648
Audit  :
Sddl   : O:SYG:SYD:AI(A;ID;KR;;;BU)(A;CIIOID;GR;;;BU)(A;ID;KA;;;BA)(A;CIIOID;GA;;;BA)(A;ID;KA;;;SY)(A;CIIOID;GA;;;SY)(A
         ;CIIOID;GA;;;CO)(A;ID;KR;;;AC)(A;CIIOID;GR;;;AC)(A;ID;KR;;;S-1-15-3-1024-1065365936-1281604716-3511738428-1654
         721687-432734479-3232135806-4053264122-3456934681)(A;CIIOID;GR;;;S-1-15-3-1024-1065365936-1281604716-351173842
         8-1654721687-432734479-3232135806-4053264122-3456934681)
```

Обратите внимание, что эта команда возвращает конкретные разрешения учётных записей в удобном для чтения формате SDDL. Кроме того, в SDDL присутствует SID, представляющий каждого субъекта безопасности (пользователя и/или группу). Этого мы не получаем при выполнении `sc` из командной строки.

Зная, как взаимодействовать со службами и связанными с ними разрешениями из командной строки, вы сможете автоматизировать эти задачи. Хотя полезно знать, как выполнять эти задачи из графического интерфейса, это не очень удобно, когда мы начинаем работать с более крупными сетевыми средами и доменами.