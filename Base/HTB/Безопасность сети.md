#htb 

Безопасность сети — один из важнейших аспектов кибербезопасности, требующий пристального внимания. Поскольку именно на этом этапе мы устанавливаем правила доступа, крайне важно сделать это правильно. В дальнейшем нам в основном нужно только следить за тем, чтобы защита оставалась такой же надёжной, как и раньше. Однако даже это требует больших усилий.

Поскольку мы уделяем особое внимание безопасности (и в то же время эффективности), нам нужно что-то, что позволит нам быстро и легко настроить доступ к удалённым серверам. Некоторые из этих решений предлагаются:

| [Netbird](https://netbird.io/) | [Tailscale](https://tailscale.com/) | [Twingate](https://www.twingate.com/) |
| ------------------------------ | ----------------------------------- | ------------------------------------- |

Zero Trust Network Access (`ZTNA`) — это то, на чём сосредоточены эти провайдеры, и это относительно новая концепция. ZTNA, переосмысливающий безопасный доступ, представляет собой значительный отход от традиционных моделей, основанных на периметре, таких как VPN. ZTNA, основанный на принципе `never trust, always verify`, аутентифицирует и авторизует каждого пользователя, каждое устройство и каждую попытку подключения на основе личности, контекста, устройства и статуса безопасности, обеспечивая детальный доступ к ресурсам, заданным администраторами, вместо широкого сетевого или группового доступа.

С одной стороны, это делает наши сетевые ресурсы гораздо более защищёнными. С другой стороны, управление каждым отдельным устройством и ресурсом может стать очень сложным. Выбор решения зависит от сценария использования.

[Netbird](https://netbird.io/) отлично подходит для случаев, когда требуется простая автоматическая настройка для безопасного доступа к облачным и локальным ресурсам, например, для подключения рабочих станций разработчиков к частным репозиториям.

[Tailscale](https://tailscale.com/) — это виртуальное частное облако на базе WireGuard, которое требует минимальной настройки и идеально подходит для таких задач, как защита подключений удалённых сотрудников к внутренним сервисам (например, конвейерам CI/CD, внутренним информационным панелям) или организация межсайтовых сетей без сложных правил брандмауэра.

[Twingate](https://www.twingate.com/) с архитектурой Relay и Connector и дизайном, ориентированным на API, идеально подходит для таких задач, как защита доступа к базам данных, кластерам Kubernetes или устаревшим приложениям в мультиоблачных или локальных средах.

Настоятельно рекомендуется бесплатно попробовать каждого из них и понять, какой из них лучше всего соответствует вашим потребностям. Поскольку эти провайдеры предлагают схожие услуги, у каждого из них своя философия и направленность. Какой из них лучше — вопрос, на который можно ответить, только если у вас есть представление о том, как будет выглядеть ваша сеть. В данном случае мы выберем Netbird.

---

## Netbird

Netbird — это одноранговая (P2P) ячеистая сеть на основе WireGuard с открытым исходным кодом, которая идеально подходит для команд с техническими знаниями для управления инфраструктурой, особенно для защиты гибридных сред с распределёнными устройствами, такими как удалённые рабочие места, серверы, внутренние ресурсы или даже небольшие филиалы. Огромным преимуществом Netbird является то, что его можно разместить на собственном сервере.

Посетив страницу Netbird, вы можете зарегистрироваться бесплатно. Процесс регистрации довольно прост и не требует особых пояснений. После подтверждения адреса электронной почты вы получите доступ к панели управления, которая будет выглядеть примерно так:

#### Информационная панель

![Интерфейс Netbird показывает список из 5 одноранговых узлов с такими данными, как имя, адрес, группы, время последнего посещения, операционная система и версия. Доступны опции фильтрации и добавления одноранговых узлов.](https://academy.hackthebox.com/storage/modules/87/net1.png)

Как вы можете видеть на панели управления выше, в сети есть 5 одноранговых узлов. Вы увидите имя каждого однорангового узла, его внутренний IP-адрес, доменное имя, время последнего подключения, операционную систему и версию клиента Netbird, используемую системой.

Теперь, когда мы настроили наш VPS, мы можем добавить его во внутреннюю сеть Netbird. Для этого нам нужно настроить так называемые «ключи настройки», которые сообщают Netbird, к какой сети принадлежит клиент.

Поэтому вы можете нажать на `Create Setup Key` и указать имя для этого ключа настройки.

#### Клавиши Настройки

![Экран создания ключа настройки Netbird с полями для «Названия», «Сделать этот ключ многоразовым», «Ограничение использования», «Срок действия» и переключателями для «Временных одноранговых узлов» и «Разрешить дополнительные метки DNS».](https://academy.hackthebox.com/storage/modules/87/net2.png)

Появится всплывающее окно с ключом настройки, который вам нужно будет скопировать. Этот ключ будет использоваться на VPS для подключения к сети.

![Подтвердите создание ключа с отображением ключа и возможностью «Закрыть» или «Установить NetBird».](https://academy.hackthebox.com/storage/modules/87/net3.png)

После того как вы скопируете его, вы увидите ещё одно всплывающее окно с инструкциями для каждой операционной системы, которые вы можете использовать для подключения к серверу с помощью ключа настройки.

![Экран установки NetBird для Linux с инструкциями по установке и запуску с помощью установочного ключа.](https://academy.hackthebox.com/storage/modules/87/net4.png)

В нашем примере для Ubuntu мы будем использовать команду `curl` с указанным URL-адресом, которая загружает сценарий оболочки и запускает его для автоматической установки. Программа запросит у вас пароль, а после установки покажет, что клиент Netbird запущен.

  Сетевая безопасность

```shell-session
cry0l1t3@MyVPS:~$ curl -fsSL https://pkgs.netbird.io/install.sh | sh

The installation will be performed using apt package manager
[sudo] password for cry0l1t3: *****************

<SNIP>

NetBird service has already been loaded
Netbird service has been started
Installation has been finished. To connect, you need to run NetBird by executing the following command:

netbird up
```

Далее мы воспользуемся сгенерированным ключом установки и укажем его в клиенте Netbird с помощью следующей команды:

  Сетевая безопасность

```shell-session
cry0l1t3@MyVPS:~$ netbird up --setup-key 826BC181-63D4-4875-84C3-9949FDEA48EE

Connected
```

Мы должны увидеть сообщение о том, что наш партнёр теперь подключён к сети. Когда Netbird запускается, он создаёт новый сетевой интерфейс, который обычно называется `wt0`. Мы можем использовать `ifconfig` или `ip addr` для проверки наличия нового сетевого интерфейса.

  Сетевая безопасность

```shell-session
cry0l1t3@MyVPS:~$ ifconfig wt0

wt0: flags=209<UP,POINTOPOINT,RUNNING,NOARP>  mtu 1280
        inet 100.108.232.34  netmask 255.255.0.0  destination 100.108.232.34
        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen 1000  (UNSPEC)
        RX packets 0  bytes 0 (0.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

```

После подтверждения нам нужно перейти на панель управления Netbird. Здесь вы увидите, что на панели управления появился одноранговый узел, запрашивающий разрешение. Имейте в виду, что даже если кто-то украдёт ваш ключ настройки и попытается подключиться к вашей сети, этот одноранговый узел всё равно потребует разрешения администратора.

![Запись MyVPS показывает, что сервер работает, адрес «myvps.netbird.cloud», последнее посещение «только что», версия 0.41.3, с кнопками «Требуется одобрение» и «Одобрить».](https://academy.hackthebox.com/storage/modules/87/net5.png)

После подтверждения мы можем протестировать подключение, попытавшись подключиться к нему через SSH.

  Сетевая безопасность

```shell-session
cry0l1t3@htb:~$ ssh cry0l1t3@myvps.netbird.cloud

The authenticity of host 'myvps.netbird.cloud (100.108.232.34)' can't be established.
ED25519 key fingerprint is SHA256:NuxuseOH6mjejxr7dGWmBEYb4dHCi24eSFm+9qnn4lI.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes

Warning: Permanently added 'myvps.netbird.cloud' (ED25519) to the list of known hosts.

cry0l1t3@myvps.netbird.cloud's password: *******************

Welcome to Ubuntu 24.04.2 LTS (GNU/Linux 6.11.0-21-generic x86_64)

<SNIP>

cry0l1t3@MyVPS:~$
```

Далее, поскольку соединение работает, мы можем настроить брандмауэр так, чтобы он разрешал входящие соединения только на интерфейсе `wt0` и отклонял все остальные, кроме исходящих. Мы можем использовать инструмент `ufw` или `iptables`. Для простоты мы будем использовать `ufw`.

#### Настройка брандмауэра

  Сетевая безопасность

```shell-session
# Allow incoming connection only from the netbird interface wt0
# Reset ufw to default state
ufw --force reset

# Allow all incoming traffic on wt0 interface
ufw allow in on wt0

# Set default policies
ufw default deny incoming
ufw default allow outgoing

# Enable ufw
ufw --force enable

# Display ufw status
ufw status
```

При желании мы можем ещё больше усилить защиту нашего SSH-сервера, настроив его на прослушивание только на интерфейсе `wt0` с помощью следующего скрипта.

#### Альтернативная конфигурация SSH

Код: bash

```bash
#!/bin/bash

# Get the IP address of wt0
WT0_IP=$(ip addr show wt0 | grep -oP 'inet \K[\d.]+')

# Backup current SSH configuration
SSHD_CONF="/etc/ssh/sshd_config"
BACKUP_CONF="/etc/ssh/sshd_config.bak_$(date +%F_%H-%M-%S)"
cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak

# Check if ListenAddress is already set
if grep -q "^ListenAddress" "$SSHD_CONF"; then
    # Replace existing ListenAddress
    sed -i "s/^ListenAddress.*/ListenAddress $WT0_IP/" "$SSHD_CONF"
else
    # Add ListenAddress
    echo "ListenAddress $WT0_IP" >> "$SSHD_CONFIG"
fi

# Ensure SSH is not listening on 0.0.0.0 or ::
sed -i '/^ListenAddress 0.0.0.0/d' "$SSHD_CONFIG"
sed -i '/^ListenAddress ::/d' "$SSHD_CONFIG"

# Test SSH configuration
if sshd -t; then
    echo "SSH configuration is valid."
else
    echo "Error: Invalid SSH configuration. Restoring backup."
    cp "$BACKUP_CONFIG" "$SSHD_CONFIG"
    exit 1
fi

# Restart SSH service
systemctl restart sshd
if [ $? -eq 0 ]; then
    echo "SSH service restarted successfully."
else
    echo "Error: Failed to restart SSH service."
    exit 1
fi
```
