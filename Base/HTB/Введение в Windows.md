#htb #windows 

Тестировщику на проникновение важно разбираться в широком спектре технологий. Глубокое понимание операционных систем Windows и Linux полезно при проведении самых разных видов оценки. Большинство систем, с которыми мы сталкиваемся во время оценки, будь то локальные или облачные, основаны на этих двух операционных системах. Важно понимать, как атаковать и защищать эти операционные системы, а также как использовать каждую из них в качестве платформы для дальнейшего тестирования на проникновение.

---

## Операционная система Windows

Компания Microsoft впервые представила операционную систему Windows 20 ноября 1985 года. Первая версия Windows представляла собой графическую оболочку операционной системы MS-DOS. В более поздних версиях Windows Desktop появились файловый менеджер Windows, менеджер программ и менеджер печати.

Windows 95 стала первой полноценной интеграцией Windows и DOS и впервые предложила встроенную поддержку Интернета. В этой версии также дебютировал веб-браузер Internet Explorer. С момента выхода первой версии было выпущено более десятка версий Windows, таких как Windows XP, Vista и 8, вплоть до текущей версии: Windows 11. Со временем Microsoft предлагала различные версии каждой из версий Windows для настольных компьютеров, ориентируясь на всех — от обычных пользователей до корпоративных клиентов.

Windows Server была впервые выпущена в 1993 году вместе с Windows NT 3.1 Advanced Server. На протяжении многих лет в Windows NT было выпущено несколько обновлений, добавлявших такие технологии, как Internet Information Services (IIS), различные сетевые протоколы, мастера администрирования для упрощения задач администратора и многое другое. С выходом Windows 2000 Microsoft представила Active Directory, изначально предназначенную для помощи системным администраторам в настройке общего доступа к файлам, шифрования данных, VPN и т. д. Windows Server 2000 также включала Консоль управления Microsoft (MMC) и поддерживала динамические дисковые тома.

Затем появилась Windows Server 2003 с серверными ролями, встроенным брандмауэром, службой теневого копирования томов и многим другим. Windows Server 2008 включала в себя кластеризацию с отказоустойчивостью, программное обеспечение для виртуализации Hyper-V, Server Core, средство просмотра событий и значительные улучшения для Active Directory. На протяжении многих лет Microsoft выпускала новые версии Server, в том числе Server 2012, Server 2016 и, совсем недавно, Server 2019. В последней версии добавлена поддержка Kubernetes, контейнеров Linux и более продвинутых функций безопасности.

По мере выпуска новых версий Windows старые версии устаревают и перестают получать обновления от Microsoft (если только в некоторых случаях не будет приобретён долгосрочный контракт на поддержку). 14 января 2020 года срок поддержки обновлений безопасности для Windows Server 2008 и 2012 подошёл к концу. В настоящее время поддерживается только Server 2012 R2 и более поздние версии. Однако в последние несколько лет Microsoft выпустила дополнительные обновления для более ранних версий Windows из-за обнаружения критической уязвимости SMBv1 (EternalBlue).

Многие версии Windows в настоящее время считаются «устаревшими» и больше не поддерживаются. Организации часто используют различные устаревшие операционные системы для поддержки критически важных приложений или из-за операционных или бюджетных проблем. Специалист по оценке должен понимать различия между версиями, а также различные неправильные настройки и уязвимости, присущие каждой из них.

---

## Версии для Windows

Ниже приведён список основных операционных систем Windows и соответствующих номеров версий:

|Названия операционных систем|Номер версии|
|---|---|
|Windows NT 4|4.0|
|Windows 2000|5.0|
|Windows XP|5.1|
|Windows Server 2003, 2003 R2|5.2|
|Windows Vista, сервер 2008|6.0|
|Windows 7, сервер 2008 R2|6.1|
|Windows 8, сервер 2012|6.2|
|Windows 8.1, сервер 2012 R2|6.3|
|Windows 10, Server 2016, Server 2019|10.0|

Мы можем использовать [командлет Get-WmiObject](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-wmiobject?view=powershell-5.1) [](https://docs.microsoft.com/en-us/powershell/scripting/developer/cmdlet/cmdlet-overview?view=powershell-7)для получения информации об операционной системе. Этот командлет можно использовать для получения экземпляров классов WMI или информации о доступных классах WMI. Существует множество способов узнать версию и номер сборки нашей системы. Мы можем легко получить эту информацию с помощью класса `win32_OperatingSystem`, который показывает, что мы работаем на компьютере с Windows 10, номер сборки 19041.

  Введение в Windows

```powershell-session
PS C:\htb> Get-WmiObject -Class win32_OperatingSystem | select Version,BuildNumber

Version    BuildNumber
-------    -----------
10.0.19041 19041
```

Некоторые другие полезные классы, которые можно использовать с `Get-WmiObject`: `Win32_Process` для получения списка процессов, `Win32_Service` для получения списка служб и `Win32_Bios` для получения информации о [базовой системе ввода-вывода](https://en.wikipedia.org/wiki/BIOS) (`BIOS`). BIOS — это встроенное ПО, установленное на материнской плате компьютера, которое управляет основными функциями компьютера, такими как управление питанием, интерфейсы ввода-вывода и конфигурация системы. Мы можем использовать параметр `ComputerName` для получения информации об удалённых компьютерах. `Get-WmiObject` можно использовать для запуска и остановки служб на локальных и удалённых компьютерах и многого другого. Дополнительную информацию о командлете можно найти [здесь](https://ss64.com/ps/get-wmiobject.html) и [здесь](https://adamtheautomator.com/get-wmiobject/).

---

## Доступ к Windows

#### Концепции локального доступа

Если вы читаете эти слова прямо сейчас, значит, у вас есть локальный доступ к какому-либо компьютеру. Будь то смартфон, планшет, ноутбук, Raspberry Pi или настольный компьютер. Локальный доступ — это наиболее распространённый способ доступа к любому компьютеру, включая компьютеры под управлением Windows. `Input` Скорее всего, вы используете клавиатуру, трекпад и/или мышь. `Output` Вы смотрите на экран(ы). Организации, у которых есть офисные помещения, где сотрудники работают изо дня в день, выстраивают политику безопасности и средства контроля безопасности, исходя из того, что их сотрудники работают в выделенных рабочих пространствах на компьютерах, принадлежащих организации. Все чаще можно увидеть, как организации расширяют поддержку удаленной работы для своих сотрудников, не являющихся техническими специалистами, и технических специалистов. Это не новая реальность для технических специалистов, работающих в сфере информационных технологий, разработки программного обеспечения и информационной безопасности. В любой день технический специалист может получать доступ к нескольким локальным и удаленным компьютерам. Исходя из этого, давайте обсудим концепцию удаленного доступа.

#### Концепции удаленного доступа

Удаленный доступ — это доступ к компьютеру по сети. Прежде чем получить удаленный доступ к другому компьютеру, необходимо получить локальный доступ к нему. Существует множество способов удаленного доступа. В этом модуле мы в основном будем использовать методы удаленного доступа для подключения к операционным системам Windows и взаимодействия с ними. Развитие сетевых и интернет-технологий привело к появлению целых отраслей, которые полностью зависят от удаленного доступа и удаленного администрирования компьютерных систем.

Рассмотрим [MSP](https://www.techtarget.com/searchitchannel/definition/managed-service-provider) и [MSSP](https://www.gartner.com/en/information-technology/glossary/mssp-managed-security-service-provider). Обе отрасли в первую очередь зависят от удалённого управления компьютерными системами своих клиентов. Эта функция позволяет им централизовать управление, стандартизировать используемые технологии, автоматизировать множество задач, организовывать удалённую работу и быстро реагировать на возникающие проблемы или потенциальные угрозы безопасности. Удалённый доступ доступен не только MSP и MSSP. Организации, в которых есть отделы информационных технологий, разработки программного обеспечения и/или безопасности, ежедневно используют методы удалённого доступа для создания приложений, управления серверами и администрирования рабочих станций сотрудников. Некоторые из наиболее распространённых технологий удалённого доступа включают, но не ограничиваются:

- Виртуальные частные сети (VPN)
- Защищенная оболочка (SSH)
- Протокол передачи файлов (FTP)
- Виртуальные сетевые вычисления (VNC)
- Удаленное управление Windows (или PowerShell Remoting) (WinRM)
- Протокол удаленного рабочего стола (RDP)

Мы сосредоточимся в первую очередь на использовании RDP в этом модуле.

#### Протокол удаленного рабочего стола (RDP)

RDP использует клиент-серверную архитектуру, в которой клиентское приложение используется для указания целевого IP-адреса или имени хоста компьютера в сети, где разрешён доступ по RDP. Целевой компьютер, на котором разрешён удалённый доступ по RDP, считается сервером. Важно отметить, что RDP по умолчанию прослушивает логический порт `3389`. Помните, что IP-адрес используется в качестве логического идентификатора компьютера в сети, а логический порт — это идентификатор, присвоенный приложению. Проще говоря, мы можем представить сетевую подсеть как улицу в городе (корпоративную сеть), IP-адрес в этой подсети, назначенный хосту, — как дом на этой улице, а логические порты — как окна/двери, через которые можно попасть в дом.

Как только запрос (инкапсулированный в пакет) достигает целевого компьютера по его IP-адресу, запрос направляется приложению, работающему на этом компьютере, на основе порта, указанного в запросе (включённом в качестве заголовка в пакет). IP-адресация и инкапсуляция протоколов более подробно рассматриваются в модуле [«Введение в сетевые технологии»](https://academy.hackthebox.com/module/details/34). С точки зрения сетевых технологий, в этом модуле нам нужно лишь понимать, что каждому компьютеру для связи по сети присваивается IP-адрес, а приложения, работающие на целевых компьютерах, прослушивают определённые логические порты.

Мы можем использовать RDP для подключения к цели Windows с атакующего хоста под управлением Linux или Windows. Если мы подключаемся к цели Windows с хоста Windows, мы можем использовать встроенное клиентское приложение RDP под названием `Remote Desktop Connection` ([mstsc.exe](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/mstsc)). Посмотрите видео ниже, чтобы увидеть, как это работает:

![GIF, демонстрирующий использование приложения для подключения к удаленному рабочему столу.](https://academy.hackthebox.com/storage/modules/49/UsingRemoteDesktopConnection.gif)

Чтобы это работало, в целевой системе Windows уже должен быть [разрешён](https://docs.microsoft.com/en-us/windows-server/remote/remote-desktop-services/clients/remote-desktop-allow-access) удалённый доступ. По умолчанию в операционных системах Windows удалённый доступ не разрешён. Команда HTB Academy настроила многие из наших целевых систем Windows так, чтобы они разрешали доступ по RDP после подключения к лабораториям Академии через VPN.

Подключение к удалённому рабочему столу также позволяет сохранять профили подключения. Это распространённая привычка среди ИТ-администраторов, поскольку она делает подключение к удалённым системам более удобным.

![GIF, демонстрирующий сохранение учетных данных в приложении для подключения к удаленному рабочему столу.](https://academy.hackthebox.com/storage/modules/49/SavingRDPConnections.gif)

Мы, специалисты по тестированию на проникновение, можем извлечь пользу из поиска этих сохранённых файлов удалённого рабочего стола (`.rdp`) во время выполнения задания.

Существует множество других клиентских приложений для удалённого рабочего стола, некоторые из которых перечислены в этой статье Microsoft под названием [«Клиенты удалённого рабочего стола»](https://docs.microsoft.com/en-us/windows-server/remote/remote-desktop-services/clients/remote-desktop-clients). В этом модуле мы не будем рассматривать все клиентские приложения для удалённого рабочего стола.

#### Использование xfreerdp

С хоста для атак на базе Linux мы можем использовать инструмент под названием [xfreerdp](https://linux.die.net/man/1/xfreerdp) для удалённого доступа к целям на базе Windows. Вы заметите, что мы используем xfreerdp в нескольких модулях из-за его простоты в использовании, набора функций, утилиты командной строки и эффективности. Посмотрите видео ниже, чтобы увидеть базовое использование в Pwnbox:

![GIF-изображение, демонстрирующее использование инструмента xfreerdp на рабочей станции Linux.](https://academy.hackthebox.com/storage/modules/49/ConnectingwithXfreerdp.gif)

Помните, что мы также можем копировать и вставлять команды xfreerdp в командной строке, поэтому нам не нужно вводить параметры вручную. В xfreerdp доступно несколько параметров, например перенаправление дисков для передачи файлов на целевой хост и обратно. Их стоит попрактиковать, и мы рассмотрим их в других модулях HTB Academy.

Существуют и другие клиенты RDP, такие как [Remmina](https://remmina.org/) и [rdesktop](http://www.rdesktop.org/), и мы рекомендуем вам поэкспериментировать с ними и выбрать наиболее подходящий для вас вариант. Теперь, когда мы рассмотрели эти концепции, давайте применим их, запустив целевую систему и подключившись к ней с помощью RDP, используя предоставленные учётные данные.

---

## Подключение к целевому объекту Windows

Подключитесь через Удаленный рабочий стол (RDP), используя следующую команду:

  Введение в Windows

```shell-session
Barlogsha@htb[/htb]$ xfreerdp /v:<targetIp> /u:htb-student /p:Password
```