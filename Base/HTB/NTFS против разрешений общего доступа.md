#windows #htb 

Microsoft владеет более чем [70%](https://gs.statcounter.com/os-market-share/desktop/worldwide/#monthly-201804-202104) мирового рынка настольных операционных систем с Windows. Это объясняет, почему большинство авторов вредоносных программ предпочитают писать их для Windows и почему многие считают Windows менее безопасной, чем другие операционные системы. С точки зрения бизнеса, авторам вредоносных программ имеет смысл тратить ресурсы на написание вредоносных программ для Windows. Это ценная цель. Идея о том, что любая операционная система защищена от вредоносных программ, является технической ошибкой. Если программное обеспечение может быть написано для операционной системы, то и вирус может быть написан для операционной системы. Имейте в виду, что вирус по определению — это программное обеспечение, написанное со злым умыслом, и его можно написать для любой ОС. Многие варианты вредоносного ПО, написанного для Windows, могут распространяться по сети через общие сетевые ресурсы с применёнными мягкими разрешениями. Также стоит отметить, что по сей день печально известная `EternalBlue` уязвимость всё ещё преследует незащищённые системы Windows, работающие `SMBv1` и часто открывает путь программам-вымогателям для отключения организаций.

`Server Message Block protocol`(`SMB`) используется в Windows для подключения к общим ресурсам, таким как файлы и принтеры. Он используется в крупных, средних и малых корпоративных средах. Чтобы визуализировать эту концепцию, см. изображение ниже:

![[Pasted image 20250907171611.png]]

Примечание: каждый раз, когда вы видите визуализацию/схему концепции, не торопитесь, тщательно её изучитe. Картинка может стоить тысячи слов, но при чтении очень хочется её пропустить.

Разрешения NTFS и разрешения общего доступа часто считаются одним и тем же. Пожалуйста, имейте в виду, что это не одно и то же, но часто применяется к одному и тому же общему ресурсу. Давайте рассмотрим отдельные разрешения, которые можно установить для защиты/предоставления объектам доступа к общему сетевому ресурсу, размещённому в ОС Windows с файловой системой NTFS.

#### Разрешения для совместного использования

|Разрешение|Описание|
|---|---|
|`Full Control`|Пользователям разрешено выполнять все действия, разрешённые правами «Изменить» и «Прочитать», а также изменять права доступа к файлам и подпапкам NTFS|
|`Change`|Пользователям разрешается читать, редактировать, удалять и добавлять файлы и вложенные папки|
|`Read`|Пользователям разрешено просматривать содержимое файлов и вложенных папок|

#### Основные разрешения NTFS

|Разрешение|Описание|
|---|---|
|`Full Control`|Пользователям разрешено добавлять, редактировать, перемещать, удалять файлы и папки, а также изменять разрешения NTFS, которые применяются ко всем разрешённым папкам|
|`Modify`|Пользователям предоставляются или не предоставляются права на просмотр и изменение файлов и папок. Это включает добавление или удаление файлов|
|`Read & Execute`|Пользователям разрешаются или отказываются в разрешениях на чтение содержимого файлов и выполнение программ|
|`List folder contents`|Пользователям разрешаются или отказываются в разрешениях на просмотр списка файлов и вложенных папок|
|`Read`|Пользователям разрешаются или отказываются в разрешениях на чтение содержимого файлов|
|`Write`|Пользователям разрешено или запрещено вносить изменения в файл и добавлять новые файлы в папку|
|`Special Permissions`|Множество дополнительных параметров разрешений|

#### Специальные разрешения NTFS

|Разрешение|Описание|
|---|---|
|`Full control`|Пользователям предоставляются или не предоставляются разрешения на добавление, редактирование, перемещение, удаление файлов и папок, а также на изменение разрешений NTFS, которые применяются ко всем разрешённым папкам|
|`Traverse folder / execute file`|Пользователям разрешен или запрещен доступ к подпапкам в структуре каталогов, даже если пользователю запрещен доступ к содержимому на уровне родительской папки. Пользователям также может быть разрешен или запрещен доступ к выполнению программ|
|`List folder/read data`|Пользователям разрешено или запрещено просматривать файлы и папки, содержащиеся в родительской папке. Пользователям также может быть разрешено открывать и просматривать файлы|
|`Read attributes`|Пользователям предоставляются или не предоставляются разрешения на просмотр основных атрибутов файла или папки. Примеры основных атрибутов: системный, архивный, только для чтения и скрытый|
|`Read extended attributes`|Пользователям разрешено или запрещено просматривать расширенные атрибуты файла или папки. Атрибуты различаются в зависимости от программы|
|`Create files/write data`|Пользователям разрешено или запрещено создавать файлы в папке и вносить изменения в файл|
|`Create folders/append data`|Пользователям разрешено или запрещено создавать подпапки внутри папки. В файлы можно добавлять данные, но существующее содержимое нельзя перезаписать|
|`Write attributes`|Пользователям разрешено или запрещено изменять атрибуты файлов. Это разрешение не предоставляет доступ к созданию файлов или папок|
|`Write extended attributes`|Пользователям разрешено или запрещено изменять расширенные атрибуты файла или папки. Атрибуты различаются в зависимости от программы|
|`Delete subfolders and files`|Пользователям разрешено или запрещено удалять подпапки и файлы. Родительские папки не будут удалены|
|`Delete`|Пользователям разрешено или запрещено удалять родительские папки, подпапки и файлы.|
|`Read permissions`|Пользователям разрешаются или отказываются в разрешениях на чтение папок|
|`Change permissions`|Пользователям разрешаются или отказываются изменять разрешения файла или папки|
|`Take ownership`|Пользователям разрешено или запрещено становиться владельцами файлов или папок. Владелец файла имеет полные права на изменение любых разрешений|

Имейте в виду, что разрешения NTFS применяются к системе, в которой размещены папка и файлы. Папки, созданные в NTFS, по умолчанию наследуют разрешения родительских папок. Можно отключить наследование, чтобы установить собственные разрешения для родительских и вложенных папок, как мы сделаем позже в этом модуле. Разрешения общего доступа применяются при доступе к папке через SMB, как правило, из другой системы по сети. Это означает, что пользователь, вошедший в систему локально или через RDP, может получить доступ к общей папке и файлам, просто перейдя в нужное место в файловой системе, и ему нужно будет только учитывать разрешения NTFS. Разрешения на уровне NTFS предоставляют администраторам гораздо более детальный контроль над тем, что пользователи могут делать в папке или файле.

---

## Создание общего сетевого ресурса

Чтобы получить чёткое представление о SMB и его связи с NTFS, мы создадим общий сетевой ресурс на `Windows 10 target box`.

Примечание: для идеального обучения лучше всего открыть Pwnbox в полноэкранном режиме на отдельном мониторе, чтобы у нас был как минимум один дисплей для отображения текстового контента и один дисплей для блоков, с которыми мы взаимодействуем. В качестве альтернативы, если у нас есть доступ только к одному дисплею, мы можем использовать его для взаимодействия с блоками, а смартфон или планшет — для отображения текстового контента.

В этом случае мы создадим общую папку, сначала создав новую папку на рабочем столе Windows 10. Имейте в виду, что в большинстве крупных корпоративных сред общие папки создаются в сети хранения данных (SAN), на сетевом устройстве хранения данных (NAS) или в отдельном разделе на дисках, к которым можно получить доступ через серверную операционную систему, например Windows Server. Если мы когда-нибудь столкнёмся с общими папками в операционной системе для настольных компьютеров, то это будет либо малый бизнес, либо система-плацдарм, используемая тестировщиками на проникновение или злоумышленниками для сбора и передачи данных.

Мы пройдем через этот процесс, используя графический интерфейс в Windows.

#### Создание папки

![[Pasted image 20250907171622.png]]

Мы собираемся использовать опцию `Advanced Sharing` для настройки нашего общего ресурса.

#### Превращение папки в общий ресурс

![[Pasted image 20250907171630.png]]

Обратите внимание, что имя общего ресурса автоматически устанавливается по умолчанию в соответствии с названием папки. Кроме того, мы видим, что можно ограничить количество пользователей, которые могут одновременно подключаться к этому общему ресурсу. В реальных условиях администраторам рекомендуется устанавливать это количество в соответствии с количеством пользователей, которым регулярно требуется доступ к общему ресурсу.

Как и в случае с разрешениями NTFS, для общих ресурсов существует `access control list` (`ACL`). Мы можем рассматривать его как список разрешений SMB. Имейте в виду, что в случае с общими ресурсами списки разрешений SMB и NTFS применяются к каждому ресурсу, который используется совместно в Windows. Список управления доступом содержит `access control entries` (`ACEs`). Как правило, эти ACE состоят из `users` и `groups` (также называемых субъектами безопасности), поскольку они являются подходящим механизмом для управления и отслеживания доступа к общим ресурсам.

Обратите внимание на запись о контроле доступа по умолчанию и настройки разрешений.

#### ACL разрешений для общего доступа (вкладка "Общий доступ")

![[Pasted image 20250907171634.png]]

Сейчас мы применим эти настройки, чтобы проверить действие этого ACL и разрешений, применённых как есть. Мы проверим подключение из Pwnbox, открыв терминал и используя `smbclient`.

Примечание: сервер — это программная функция, используемая для обслуживания запросов клиента. В данном случае Pwnbox — это наш клиент, а целевой компьютер с Windows 10 — наш сервер.

#### Использование smbclient для составления списка доступных общих ресурсов

  NTFS против разрешений общего доступа

```shell-session
Barlogsha@htb[/htb]$ smbclient -L SERVER_IP -U htb-student
Enter WORKGROUP\htb-student's password: 

	Sharename       Type      Comment
	---------       ----      -------
	ADMIN$          Disk      Remote Admin
	C$              Disk      Default share
	Company Data    Disk      
	IPC$            IPC       Remote IPC
```

#### Подключение к общему ресурсу данных Компании

  NTFS против разрешений общего доступа

```shell-session
Barlogsha@htb[/htb]$ smbclient '\\SERVER_IP\Company Data' -U htb-student
Password for [WORKGROUP\htb-student]:
Try "help" to get a list of possible commands.

smb: \> 
```

Что может помешать нам получить доступ к этому общему ресурсу, если все наши записи верны, а в списке разрешений есть группа «Все» с разрешением как минимум на чтение?

---

## Рекомендации по брандмауэру Защитника Windows

Это брандмауэр Защитника Windows, который потенциально может блокировать доступ к общему ресурсу SMB. Поскольку мы подключаемся из системы на базе Linux, брандмауэр блокирует доступ с любого устройства, которое не подключено к тому же `workgroup`. Также важно отметить, что когда система Windows является частью рабочей группы, все `netlogon` запросы проходят аутентификацию в базе данных `SAM` этой конкретной системы Windows. Когда система Windows подключена к среде Windows Domain, все запросы на вход в систему проходят аутентификацию в `Active Directory`. Основное различие между рабочей группой и доменом Windows с точки зрения аутентификации заключается в том, что в рабочей группе используется локальная база данных SAM, а в домене Windows используется централизованная сетевая база данных (Active Directory). Мы должны знать эту информацию при попытке входа в систему и аутентификации в системе Windows. Чтобы правильно подключиться к целевой системе, учитывайте, где находится учётная запись htb-student.

Что касается брандмауэра, блокирующего подключения, это можно проверить, полностью отключив каждый профиль брандмауэра в Windows или включив определённые предустановленные правила входящего брандмауэра в `Windows Defender Firewall advanced security settings`. Как и большинство брандмауэров, брандмауэр Защитника Windows разрешает или запрещает трафик (в данном случае запросы на доступ и подключение), проходящий через `inbound` и/или `outbound`

Различные правила входящего и исходящего трафика связаны с разными профилями брандмауэра в Защитнике.

Профили брандмауэра Защитника Windows:

- `Public`
- `Private`
- `Domain`

Лучше всего включить заранее заданные правила или добавить пользовательские исключения, а не полностью отключать брандмауэр. К сожалению, брандмауэры часто полностью отключают ради удобства или из-за непонимания. Правила брандмауэра в настольных системах можно централизованно управлять при подключении к домену Windows с помощью групповой политики. Концепции и настройки групповой политики выходят за рамки данного модуля.

Как только будут включены соответствующие `inbound` правила брандмауэра, мы успешно подключимся к общему ресурсу. Имейте в виду, что мы можем подключиться к общему ресурсу только потому, что используемая нами учётная запись (`htb-student`) находится в `Everyone group`. Напомним, что мы оставили для группы «Все» разрешение на чтение, что в буквальном смысле означает, что мы сможем только читать файлы на этом общем ресурсе. Как только будет установлено соединение с общим ресурсом, мы сможем создать `mount point` из нашего Pwnbox в файловой системе целевого компьютера с Windows 10. Здесь мы также должны учитывать, что разрешения NTFS применяются наряду с разрешениями общего доступа. Напомним, что NTFS — это файловая система по умолчанию в Windows. Давайте вернёмся к сеансу xfreerdp с нашим целевым компьютером с Windows 10 и посмотрим на разрешения NTFS для папки «Company Data».

#### ACL разрешений NTFS (вкладка "Безопасность")

![[Pasted image 20250907171645.png]]

С разрешениями NTFS можно более детально управлять пользователями и группами. Всякий раз, когда мы видим серую галочку рядом с разрешением, оно было унаследовано от родительского каталога. По умолчанию все разрешения NTFS наследуются от родительского каталога. В мире Windows `C:\ drive` является родительским каталогом, который управляет всеми каталогами, если только системный администратор не отключит наследование в расширенных настройках безопасности вновь созданной папки.

Во многих случаях системный администратор (или администраторы) организации отвечает за то, какие разрешения получает пользователь или группа пользователей в отношении сетевых ресурсов. Именно поэтому многие атаки с использованием целевого фишинга направлены на системных администраторов и других ИТ-руководителей. Они имеют большое влияние на то, что разрешено в контролируемых ими средах, даже больше, чем руководители высшего звена, не имеющие технического образования. Например, у врачей или руководителей, работающих в больнице, не будет административных прав в отношении сети, но они будут у системных администраторов.

Теперь давайте добавим группе «Everyone» `Full control` на уровне общего доступа и проверим влияние этого изменения, попытавшись создать точку подключения к общему доступу с рабочего стола нашего Pwnbox

#### Крепление к доле

  NTFS против разрешений общего доступа

```shell-session
Barlogsha@htb[/htb]$ sudo mount -t cifs -o username=htb-student,password=Academy_WinFun! //ipaddoftarget/"Company Data" /home/user/Desktop/
```

Если эта команда не работает, проверьте синтаксис. Если синтаксис правильный, но команда всё равно не работает, `cifs-utils` нужно установить. Это можно сделать с помощью следующей команды:

#### Установка утилит CIFS

  NTFS против разрешений общего доступа

```shell-session
Barlogsha@htb[/htb]$ sudo apt-get install cifs-utils
```

После того как мы успешно создали точку монтирования на рабочем столе нашего Pwnbox, нам следует изучить несколько встроенных в Windows инструментов, которые позволят нам отслеживать и контролировать то, что мы сделали.

Команда `net share` позволяет нам просмотреть все общие папки в системе. Обратите внимание на созданную нами общую папку, а также на диск C:\.

`Do you remember us sharing the C:\ drive?`

Мы не настраивали общий доступ к C:. Самый важный диск с наиболее важными файлами в системе Windows по умолчанию доступен через SMB при установке. Это означает, что любой пользователь с соответствующим доступом может получить удалённый доступ ко всему диску C:\ в каждой системе Windows в сети.

Мы также можем просмотреть созданный нами общий ресурс.

#### Отображение общих ресурсов с помощью net share

  NTFS против разрешений общего доступа

```cmd-session
C:\Users\htb-student> net share

Share name   Resource                        Remark

-------------------------------------------------------------------------------
C$           C:\                             Default share
IPC$                                         Remote IPC
ADMIN$       C:\WINDOWS                      Remote Admin
Company Data C:\Users\htb-student\Desktop\Company Data

The command completed successfully.
```

`Computer Management` Это ещё один инструмент, который мы можем использовать для обнаружения и мониторинга общих ресурсов в системе Windows.

#### Мониторинг общих ресурсов с помощью управления компьютером

![[Pasted image 20250907171654.png]]

Мы можем поискать в `Shares`, `Sessions`, и `Open Files` информацию, которая нам нужна. Если возникнет ситуация, в которой мы будем помогать отдельному пользователю или организации реагировать на взлом, связанный с SMB, это отличные места для проверки и начала понимания того, как мог произойти взлом и что могло остаться после него.

#### Просмотр журналов общего доступа в программе просмотра событий

`Event Viewer` Это ещё одно хорошее место для изучения действий, выполненных в Windows. Почти в каждой операционной системе есть механизм ведения журналов и утилита для просмотра сохранённых журналов. Знайте, что журнал — это что-то вроде записи в журнале компьютера, где компьютер записывает все выполненные действия и множество подробностей, связанных с этими действиями. Мы можем просматривать журналы, созданные для каждого действия, которое мы выполнили при доступе к целевому компьютеру с Windows 10, а также при создании, редактировании и доступе к общей папке.

![[Pasted image 20250907171705.png]]