#AD #windows #htb 

Помимо Kerberos и LDAP, Active Directory использует несколько других методов аутентификации, которые могут применяться (и использоваться не по назначению) приложениями и службами в AD. К ним относятся LM, NTLM, NTLMv1 и NTLMv2. LM и NTLM — это имена хэшей, а NTLMv1 и NTLMv2 — протоколы аутентификации, использующие хэш LM или NT. Ниже приведено краткое сравнение этих хэшей и протоколов, которое показывает, что, несмотря на некоторые недостатки, Kerberos часто является предпочтительным протоколом аутентификации. Важно понимать разницу между типами хэшей и протоколами, которые их используют.

#### Сравнение хэш-протоколов

|**Хэш/ Протокол**|**Криптографический метод**|**Взаимная Аутентификация**|**Тип сообщения**|**Доверенная Третья Сторона**|
|---|---|---|---|---|
|`NTLM`|Криптография с симметричным ключом|НЕТ|Случайное число|Контроллер домена|
|`NTLMv1`|Криптография с симметричным ключом|НЕТ|Хэш MD4, случайное число|Контроллер домена|
|`NTLMv2`|Криптография с симметричным ключом|НЕТ|Хэш MD4, случайное число|Контроллер домена|
|`Kerberos`|Криптография с симметричным ключом и асимметричная криптография|ДА|Зашифрованный билет с использованием DES, MD5|Контроллер домена/центр распространения ключей (KDC)|

---

## LM

`LAN Manager` Хеши LM (LANMAN) — это самый старый механизм хранения паролей, используемый в операционной системе Windows. Хеши LM появились в 1987 году в операционной системе OS/2. Если они используются, то хранятся в базе данных SAM на хосте Windows и в базе данных NTDS.DIT на контроллере домена. Из-за существенных недостатков в алгоритме хеширования, используемом для хешей LM, они по умолчанию отключены в Windows Vista/Server 2008. Тем не менее с этим всё ещё часто сталкиваются, особенно в крупных компаниях, где до сих пор используются старые системы. Пароли, использующие LM, ограничены максимальным количеством `14` символов. Пароли не чувствительны к регистру и преобразуются в верхний регистр перед генерацией хешированного значения, что ограничивает пространство ключей 69 символами и позволяет относительно легко взламывать такие хеши с помощью таких инструментов, как Hashcat.

Перед хешированием 14-значный пароль сначала разбивается на две части по семь знаков. Если в пароле меньше 14 знаков, он дополняется символами NULL до нужного значения. Из каждой части создаются два ключа DES. Затем эти части шифруются с помощью строки `KGS!@#$%`, в результате чего получаются два 8-байтовых значения зашифрованного текста. Эти два значения объединяются, и получается хеш LM. Этот алгоритм хеширования означает, что злоумышленнику нужно перебрать только семь символов дважды, а не все четырнадцать, что позволяет быстро взламывать LM-хеши в системе с одним или несколькими графическими процессорами. Если пароль состоит из семи символов или меньше, вторая половина LM-хеша всегда будет иметь одно и то же значение, и его можно будет определить даже визуально, без использования таких инструментов, как Hashcat. Использование LM-хешей можно запретить с помощью [групповой политики](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/network-security-do-not-store-lan-manager-hash-value-on-next-password-change). LM-хеш имеет вид `299bd128c1101fd6`.

**Примечание:** в операционных системах Windows до Windows Vista и Windows Server 2008 (Windows NT4, Windows 2000, Windows 2003, Windows XP) по умолчанию хранились как LM-хэш, так и NTLM-хэш пароля пользователя.

---

## NTHash (NTLM)

`NT LAN Manager` (NTLM) хэши используются в современных системах Windows. Это протокол аутентификации по принципу «запрос-ответ», в котором для аутентификации используются три сообщения: сначала клиент отправляет `NEGOTIATE_MESSAGE` на сервер, который в ответ отправляет `CHALLENGE_MESSAGE` для проверки подлинности клиента. Наконец, клиент отправляет `AUTHENTICATE_MESSAGE`. Эти хэши хранятся локально в базе данных SAM или в файле базы данных NTDS.DIT на контроллере домена. Для аутентификации в протоколе используются два хешированных значения пароля: хеш LM (как описано выше) и хеш NT, который представляет собой хеш MD4 значения пароля в кодировке UTF-16 с прямым порядком байтов. Алгоритм можно представить следующим образом: `MD4(UTF-16-LE(password))`.

#### Запрос аутентификации NTLM

![[Pasted image 20250907181543.png]]

Несмотря на то, что они значительно надёжнее, чем хэши LM (поддерживающие весь набор символов Юникода, состоящий из 65 536 символов), их всё равно можно относительно быстро взломать в автономном режиме с помощью такого инструмента, как Hashcat. Атаки с использованием графических процессоров показали, что весь набор из 8 символов NTLM можно взломать менее чем за `3 hours`. Взлом более длинных хэшей NTLM может оказаться более сложной задачей в зависимости от выбранного пароля, и даже длинные пароли (15+ символов) можно взломать с помощью автономной атаки по словарю в сочетании с правилами. Протокол NTLM также уязвим для атаки «прохождение по хешу». Это означает, что злоумышленник может использовать только хеш NTLM (полученный в результате другой успешной атаки) для аутентификации в целевых системах, где пользователь является локальным администратором, без необходимости знать пароль в открытом виде.

NT-хэш имеет вид `b4b9b02e6f09a9bd760f388b67351e2b`, что является второй половиной полного NTLM-хэша. NTLM-хэш выглядит следующим образом:

  Аутентификация NTLM

```shell-session
Rachel:500:aad3c435b514a4eeaad3b935b51304fe:e46b9e548fa0d122de7f59fb6d48eaa2:::
```

Глядя на приведённый выше хэш, мы можем разделить хэш NTLM на отдельные части:

- `Rachel` это имя пользователя
- `500` это относительный идентификатор (RID). 500 — это известный RID для аккаунта `administrator`
- `aad3c435b514a4eeaad3b935b51304fe` Это хэш LM, и если в системе отключены хэши LM, его нельзя будет использовать ни для чего
- `e46b9e548fa0d122de7f59fb6d48eaa2` Это хэш NT. Этот хэш можно взломать в автономном режиме, чтобы получить значение в открытом виде (в зависимости от длины/надежности пароля), или использовать для атаки методом перебора. Ниже приведен пример успешной атаки методом перебора с использованием инструмента [CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec):

  Аутентификация NTLM

```shell-session
Barlogsha@htb[/htb]$ crackmapexec smb 10.129.41.19 -u rachel -H e46b9e548fa0d122de7f59fb6d48eaa2

SMB         10.129.43.9     445    DC01      [*] Windows 10.0 Build 17763 (name:DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)
SMB         10.129.43.9     445    DC01      [+] INLANEFREIGHT.LOCAL\rachel:e46b9e548fa0d122de7f59fb6d48eaa2 (Pwn3d!)
```

Теперь, когда мы разобрались в возможностях и структуре NTLM, давайте рассмотрим развитие протокола от NTLMv1 до NTLMv2.

**Примечание:** ни LANMAN, ни NTLM не используют соль.

---

## NTLMv1 (Net-NTLMv1)

Протокол NTLM выполняет обмен запросами и ответами между сервером и клиентом с использованием хэша NT. NTLMv1 использует хэши NT и LM, что упрощает «взлом» в автономном режиме после получения хэша с помощью такого инструмента, как [Responder](https://github.com/lgandx/Responder), или с помощью [ретрансляционной атаки NTLM](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html) (оба метода выходят за рамки этого модуля и будут рассмотрены в последующих модулях, посвященных горизонтальному перемещению). Протокол используется для сетевой аутентификации, а сам хэш Net-NTLMv1 создаётся с помощью алгоритма «запрос/ответ». Сервер отправляет клиенту 8-байтовое случайное число (запрос), а клиент возвращает 24-байтовый ответ. Эти хэши НЕЛЬЗЯ использовать для атак типа «передай хэш». Алгоритм выглядит следующим образом:

#### Алгоритм вызова и ответа V1

  Аутентификация NTLM

```shell-session
C = 8-byte server challenge, random
K1 | K2 | K3 = LM/NT-hash | 5-bytes-0
response = DES(K1,C) | DES(K2,C) | DES(K3,C)
```

Пример полного хэша NTLMv1 выглядит так:

#### Пример хеширования NTLMv1

  Аутентификация NTLM

```shell-session
u4-netntlm::kNS:338d08f8e26de93300000000000000000000000000000000:9526fb8c23a90751cdd619b6cea564742e1e4bf33006ba41:cb8086049ec4736c
```

NTLMv1 был основой для современной аутентификации NTLM. Как и любой другой протокол, он имеет недостатки и подвержен взлому и другим атакам. Теперь давайте рассмотрим NTLMv2 и узнаем, как он улучшает возможности первой версии.

---

## NTLMv2 (Net-NTLMv2)

Протокол NTLMv2 был впервые представлен в Windows NT 4.0 SP4 и создан как более надёжная альтернатива NTLMv1. Начиная с Windows Server 2000, он используется по умолчанию. Он защищён от некоторых видов подмены данных, которым подвержен NTLMv1. NTLMv2 отправляет два ответа на 8-байтовый запрос, полученный сервером. Эти ответы содержат 16-байтовый хэш HMAC-MD5 запроса, случайно сгенерированный запрос от клиента и хэш HMAC-MD5 учётных данных пользователя. Отправляется второй ответ с клиентским запросом переменной длины, включающим текущее время, 8-байтовое случайное значение и доменное имя. Алгоритм выглядит следующим образом:

#### Алгоритм вызова и ответа V2

  Аутентификация NTLM

```shell-session
SC = 8-byte server challenge, random
CC = 8-byte client challenge, random
CC* = (X, time, CC2, domain name)
v2-Hash = HMAC-MD5(NT-Hash, user name, domain name)
LMv2 = HMAC-MD5(v2-Hash, SC, CC)
NTv2 = HMAC-MD5(v2-Hash, SC, CC*)
response = LMv2 | CC | NTv2 | CC*
```

Пример хэша NTLMv2:

#### Пример хеширования NTLMv2

  Аутентификация NTLM

```shell-session
admin::N46iSNekpT:08ca45b7d7ea58ee:88dcbe4446168966a153a0064958dac6:5c7830315c7830310000000000000b45c67103d07d7b95acd12ffa11230e0000000052920b85f78d013c31cdb3b92f5d765c783030
```

Мы видим, что разработчики усовершенствовали версию 1, усложнив взлом NTLMv2 и создав более надёжный алгоритм, состоящий из нескольких этапов. Прежде чем двигаться дальше, нам нужно обсудить ещё один механизм аутентификации. Этот метод примечателен тем, что для его работы не требуется постоянное подключение к сети.

---

## Кэш учётных данных домена (MSCache2)

В среде AD методы аутентификации, упомянутые в этом разделе и предыдущих, требуют, чтобы хост, к которому мы пытаемся получить доступ, взаимодействовал с "мозгом" сети, Контроллером домена. Корпорация Майкрософт разработала [алгоритм MS Cache v1 и v2](https://webstersprodigy.net/2014/02/03/mscash-hash-primer-for-pentesters/) (также известный как `Domain Cached Credentials` (DCC)), чтобы решить потенциальную проблему, связанную с невозможностью подключения подключенного к домену хоста к контроллеру домена (т. Е. Из-за сбоя в сети или другой технической проблемы) и, следовательно, невозможностью аутентификации NTLM / Kerberos для доступа к данному хосту. Хосты сохраняют последние `ten` хэши для всех пользователей домена, успешно вошедших в систему, в ключе реестра `HKEY_LOCAL_MACHINE\SECURITY\Cache`. Эти хэши нельзя использовать в атаках типа «передай хэш». Кроме того, хэш очень медленно взламывается с помощью таких инструментов, как Hashcat, даже при использовании чрезвычайно мощного графического процессора для взлома, поэтому попытки взлома этих хэшей обычно носят целенаправленный характер или основаны на использовании очень слабого пароля. Эти хэши могут быть получены злоумышленником или пентестером после получения локального административного доступа к хосту и имеют следующий формат: `$DCC2$10240#bjones#e4e938d12fe5974dc42a90120bd9c90f`. Для специалистов по тестированию на проникновение крайне важно понимать, с какими типами хэшей мы можем столкнуться при оценке среды AD, каковы их сильные и слабые стороны, как ими можно злоупотребить (взлом до открытого текста, передача хэша или ретрансляция) и когда атака может оказаться бесполезной (например, если вы тратите дни на взлом набора кэшированных учётных данных домена).

---

## Двигаемся Дальше

Теперь, когда мы рассмотрели протоколы аутентификации и связанные с ними хэши паролей, давайте поговорим о пользователях и группах в Active Directory, которые, как правило, являются наиболее важной целью как для специалистов по тестированию на проникновение, так и для злоумышленников. Они могут иметь различные привилегии и использоваться для горизонтального перемещения в среде или получения доступа к защищенным ресурсам.