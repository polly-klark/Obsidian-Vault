#htb #traffic #network #wireshark 

Цель этой лабораторной работы — получить опыт анализа трафика в Wireshark. У нас будет возможность извлекать объекты из ранее записанного сетевого трафика, а также получать данные из реального трафика.

Нам предоставили файл с захваченными пакетами, содержащий данные из незашифрованного веб-сеанса. В файл встроено изображение, которое необходимо использовать в качестве доказательства неправомерного использования сети. Менеджер по безопасности считает, что пользователь отправляет сообщения, скрытые за изображением. С помощью Wireshark примените фильтры, чтобы найти и извлечь доказательства.

Если вы хотите подойти к выполнению этого лабораторного задания более творчески, я опубликовал список общих задач. Более подробное описание того, как выполнить каждый шаг, приведено под каждой задачей в блоке с решениями.

---

## Задачи

Используя `Wireshark-lab-2.zip` в дополнительных ресурсах, выполните лабораторную работу в меру своих возможностей.

#### Задача №1

`Open a pre-captured file (HTTP extraction)`

В Wireshark выберите «Файл» → «Открыть» → , затем перейдите к файлу Wireshark-lab-2.pcap. и откройте его.

#### Задача №2

`Filter the results.`

Теперь, когда файл pcap открыт в Wireshark, мы можем увидеть довольно большой объём трафика в этом файле захвата. Всего в нём около 1171 пакета, и из них менее 20 — это HTTP-пакеты. Уделите минуту изучению файла pcap, чтобы ознакомиться с происходящими разговорами и понять, какую задачу нужно решить. Наша цель — извлечь потенциальные изображения, которые могут служить доказательством. Исходя из того, что нам поручили, давайте очистим экран, отфильтровав только HTTP-трафик.

Примените фильтр, чтобы включить только запросы HTTP (80/TCP).

##### **Нажмите, чтобы показать ответ**

`Step one`: Нажмите на панель инструментов «Фильтр отображения» в верхней части экрана и введите `HTTP`. Если вы всё сделали правильно, панель загорится зелёным.

Обратите внимание, что при этом из окна удаляются все дополнительные дейтаграммы TCP или IP, что позволяет нам сосредоточиться исключительно на обмене данными по протоколу HTTP. Здесь мы видим несколько базовых дейтаграмм HTTP, содержащих метод GET и ответы 200 OK. Они интересны тем, что теперь мы видим, как клиент запросил несколько файлов, а сервер ответил OK. Если мы выберем один из ответов OK, то сможем проследить за этим потоком и увидеть передачу данных по протоколу TCP. Давайте попробуем.

#### Задача №3

`Follow the stream and extract the item(s) found.`

Итак, теперь, когда мы убедились, что в этом файле есть HTTP-трафик, давайте попробуем извлечь из него некоторые элементы, как и было запрошено. Первое, что нам нужно сделать, — это отследить поток передачи одного из файлов. Не снимая `http`-фильтр, найдите одну из строк, в которой веб-сервер отвечает сообщением «200 OK», которое служит подтверждением/квитанцией о получении GET-запроса от пользователя. Теперь давайте выберем этот пакет и проследим за TCP-потоком.

##### **Нажмите, чтобы показать ответ**

`Step one`: Выберите пакет с кодом 200 OK в информационном поле. Щёлкните по пакету правой кнопкой мыши.

`Step two`В появившемся меню выберите «Отслеживать» → «TCP-поток». Откроется новое окно со всем TCP-потоком. Также будет применён фильтр отображения `tcp.stream eq #`.

`Step three`: Уделите немного времени просмотру данных, чтобы убедиться, что файл успешно передан.

Теперь, когда мы убедились, что передача данных состоялась, с помощью Wireshark можно легко извлечь файлы из HTTP-трафика. Мы можем проверить, был ли загружен файл изображения, поискав в пакетах формат `JFIF`. Формат обмена файлами JPEG `JFIF` сообщит нам о наличии файлов изображений в формате JPEG. Мы ищем этот формат, потому что он является наиболее распространённым типом файлов для изображений наряду с форматом png. Учитывая это, мы, скорее всего, увидим изображение в этом формате в ходе нашего расследования.

#### Проверьте наличие файлов JFIF в HTTP-трафике.

##### **Нажмите, чтобы показать ответ**

Очистите ранее использовавшийся фильтр отображения и примените `http && image-jfif` в качестве фильтра отображения. Примените фильтр «http && image-jfif», чтобы включить только пакеты HTTP (80/TCP), а также фильтр, включающий только файлы JPEG. Это сократит количество результатов до нескольких пакетов. `3` или около того.

Теперь, когда мы уверены, что файлы изображений были переданы между подозрительным хостом и сервером, давайте извлечём их из перехвата. Для этого нам нужно экспортировать объекты из HTTP-трафика.

##### **Нажмите, чтобы показать ответ**

Чтобы экспортировать изображения, выберите «Файл → Экспорт объектов → HTTP → `file.JPG`.  
». Это позволит Wireshark извлечь запрошенные объекты из HTTP-трафика. Мы можем сохранить копию файла локально.

На этом этапе у нас должны быть файлы изображений, которые наш менеджер по безопасности попросил нас сохранить, если они существуют. Теперь они могут изучить файл, чтобы определить, были ли в нём скрыты какие-либо данные.

---

## Оперативный захват и анализ

В описанном выше сценарии мы практиковались в фильтрации на основе предварительно записанного файла. Теперь пришло время выполнить захват пакетов в реальном времени. Для этого мы подключимся к лаборатории академии и будем в реальном времени перехватывать трафик с хоста в сети.

После того как мы проанализировали трафик pcap, менеджер по безопасности вернулся и подтвердил, что пользователь передавал данные из сети через изображения. Он просит нас перехватить трафик, чтобы определить, происходит ли что-то ещё на хосте пользователя `172.16.10.2`. Нам нужно будет начать перехват, классифицировать и отфильтровать данные, а также извлечь всё, что может быть полезно для расследования.

---

## Подключение к лаборатории

Доступ к лабораторной среде для выполнения этой части работы будет немного другим. Мы используем [XfreeRDP](https://manpages.ubuntu.com/manpages/trusty/man1/xfreerdp.1.html), чтобы получить доступ к рабочему столу виртуальной машины лаборатории и использовать Wireshark внутри среды.

Мы будем подключаться к лаборатории Академии в обычном режиме, используя вашу собственную виртуальную машину с VPN-ключом HTB Academy или Pwnbox, встроенным в раздел модуля. Вы можете запустить клиент FreeRDP на Pwnbox, введя в командной строке следующую команду после запуска цели:

Код: bash

```bash
xfreerdp /v:<target IP> /u:htb-student /p:HTB_@cademy_stdnt!
```

Вы можете найти `target IP`, `Username` и `Password` необходимые ниже:

- Нажмите ниже в разделе «Вопросы», чтобы создать целевой хост и получить IP-адрес.
    - `IP` ==
    - `Username` == htb-студент
    - `Password` == HTB_@cademy_stdnt!

#### Запустите захват данных Wireshark

Мы будем перехватывать трафик с хоста, на который мы вошли, с нашей виртуальной машины или Pwnbox. Используя интерфейс `ENS224` в Wireshark, дайте захвату поработать несколько минут, прежде чем останавливать его. Наша цель — определить, происходит ли что-то между хостом пользователя и другим компьютером в корпоративной или внешней сети.

#### Самоанализ

Прежде чем приступить к выполнению следующих заданий, потратьте немного времени на самостоятельный анализ нашего трафика pcap. Используйте навыки, которые мы уже проверили, например отслеживание потоков, анализ разговоров и другие навыки, чтобы понять, что происходит. При анализе обращайте внимание на следующие вопросы:

- Сколько диалогов можно просмотреть?
- Можем ли мы определить, кто является клиентами и серверами?
- Какие протоколы используются?
- Происходит ли что-то примечательное? (неправильное использование портов, передача данных в открытом виде, учётные данные и т. д.)

В этой лаборатории мы работаем с хостами 172.16.10.2 и 172.16.10.20, выполняя следующие действия. В ходе анализа мы должны были заметить некоторый веб-трафик между этими хостами и некоторый FTP-трафик. Давайте копнём глубже.

#### Анализ FTP

При анализе трафика мы заметили, что он был связан с FTP. Кто был сервером для этого трафика?

Удалось ли нам определить, совершал ли эти действия аутентифицированный пользователь или это был анонимный пользователь?

#### Отфильтруйте результаты

Теперь, когда мы увидели интересный трафик, давайте попробуем получить файл по сети.

Изучите команды FTP, чтобы понять, что вам нужно проверить, а затем извлеките файлы из ftp-data и соберите их заново

##### **Нажмите, чтобы показать ответ**

1. Определите любой FTP-трафик с помощью фильтра отображения `ftp` .
2. Посмотрите на команды управления, передаваемые между сервером и хостами, чтобы определить, была ли выполнена какая-либо передача данных и кто это сделал, с помощью фильтра `ftp.request.command` .
3. Выберите файл, затем выполните фильтрацию по `ftp-data`. Выберите пакет, соответствующий интересующему нас файлу, и проследите за соответствующим ему потоком TCP.
4. После этого измените параметр «Показать и сохранить данные как» на «Необработанные данные» и сохраните содержимое под исходным именем файла.
5. Подтвердите извлечение, проверив тип файла.

#### HTTP - анализ

Мы также должны были увидеть небольшой HTTP-трафик. У вас было так же?

Если да, то можем ли мы определить, кто является владельцем веб-сервера?

Какое приложение запускает веб-сервер?

Какие запросы к методам вы встречали чаще всего?

#### Следуйте за потоком и извлеките найденный предмет (предметы)

Теперь попробуйте отследить HTTP-поток и определить, есть ли что-то, что можно извлечь.

##### **Нажмите, чтобы показать ответ**

Примените фильтр «http && image-jfif», чтобы включить только пакеты HTTP (80/TCP), а также фильтр, чтобы включить только форматы обмена файлами JPEG (файлы JPEG).

Найдите строку, в которой веб-сервер отвечает сообщением «200 OK», подтверждающим получение GET-запроса от пользователя.

Выберите “Файл " > " Экспорт объектов " > HTTP > `file.JPG`

---

## Краткие сведения

К концу этого лабораторного занятия мы должны научиться открывать ранее записанные файлы .pcap, применять фильтры отображения, отслеживать потоки и извлекать элементы из файла записи. Поэкспериментируйте со способами записи нового трафика и применения фильтров для поиска определённого трафика. Чтобы проверить, насколько хорошо вы усвоили материал, ответьте на вопросы ниже, используя трафик, который вы записали самостоятельно.

Проверьте свое понимание:

• Какие фильтры или выражения вы использовали? Были ли они эффективными?

• Как эти фильтры повлияли на трафик, который вы могли видеть на записи?

• Как использование этих функций может помочь вам и вашей миссии?

• Какой фильтр вы бы использовали, если бы хотели видеть только TCP-трафик от клиента?