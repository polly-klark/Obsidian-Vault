#htb #windows #AD 

В последнее десятилетие Active Directory был в центре внимания исследователей в области безопасности. Начиная с 2014 года появилось множество инструментов и исследований, которые привели к обнаружению распространённых атак и методов, используемых до сих пор. Ниже представлена хронология событий, в которой рассказывается об обнаружении некоторыми выдающимися исследователями наиболее опасных атак и уязвимостей, а также о выпуске наиболее широко используемых специалистами по тестированию на проникновение инструментов. Несмотря на то, что за прошедшие годы было разработано множество методов, AD (а теперь и Azure AD) представляет собой обширную поверхность для атак, и новые уязвимости продолжают обнаруживаться. Появляются новые инструменты, с которыми должны хорошо разбираться как специалисты по тестированию на проникновение, так и защитники, чтобы помочь организациям в решении сложной, но критически важной задачи по обеспечению безопасности сред AD.

Как видно из приведённой ниже временной шкалы, критические уязвимости обнаруживаются постоянно. Атака noPac была обнаружена в декабре 2021 года и на момент написания статьи (январь 2022 года) является самой последней критической атакой на Active Directory. В 2022 году мы наверняка увидим новые инструменты и атаки, а также новые методы использования и объединения известных уязвимостей. Мы должны быть в курсе последних исследований в области Active Directory, чтобы наилучшим образом помочь клиентам защитить её или сделать это самостоятельно.

Это ни в коем случае не исчерпывающий список всех превосходных исследований и инструментов, выпущенных за последние годы, но здесь представлены многие из наиболее значимых разработок за последнее десятилетие. Упорный труд исследователей, упомянутых в этой хронологии (и многих других), привёл к выдающимся открытиям и созданию инструментов, которые могут помочь как специалистам по тестированию на проникновение, так и защитникам глубоко изучить среду Active Directory. С их помощью легче найти как очевидные, так и скрытые уязвимости с высоким уровнем риска до того, как это сделают злоумышленники.

---

## Хронология атак и инструментов AD

## 2021

Была обнаружена уязвимость [PrintNightmare](https://en.wikipedia.org/wiki/PrintNightmare). Это была уязвимость, связанная с удалённым выполнением кода в диспетчере очереди печати Windows, которую можно было использовать для захвата хостов в среде Active Directory. Была обнаружена атака [Shadow Credentials](https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab), которая позволяет пользователям с ограниченными правами выдавать себя за других пользователей и учётные записи компьютеров при определённых условиях и может быть использована для повышения привилегий в домене. Атака [noPac](https://www.secureworks.com/blog/nopac-a-tale-of-two-vulnerabilities-that-could-end-in-ransomware) была обнаружена в середине декабря 2021 года, когда большая часть специалистов по безопасности была сосредоточена на уязвимостях Log4j. Эта атака позволяет злоумышленнику получить полный контроль над доменом с помощью стандартной учётной записи пользователя домена при соблюдении определённых условий.

## 2020

Атака [ZeroLogon](https://blog.malwarebytes.com/exploits-and-vulnerabilities/2021/01/the-story-of-zerologon/) была впервые обнаружена в конце 2020 года. Это была критическая уязвимость, которая позволяла злоумышленнику выдавать себя за любой незащищённый контроллер домена в сети.

## 2019

harmj0y выступил с докладом [«Возвращение к Kerberoasting»](https://www.slideshare.net/harmj0y/derbycon-2019-kerberoasting-revisited) на конференции DerbyCon, в котором рассказал о новых подходах к Kerberoasting. Элад Шамир опубликовал [пост в блоге](https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html), в котором описал методы злоупотребления делегированием с ограничениями по ресурсам (RBCD) в Active Directory. Компания BC Security выпустила [Empire 3.0](https://github.com/BC-SECURITY/Empire) (сейчас доступна версия 4), которая представляет собой обновлённую версию фреймворка PowerShell Empire, написанного на Python3, с множеством дополнений и изменений.

## 2018

Ошибка "Ошибка принтера" была обнаружена Ли Кристенсеном и был выпущен инструмент [SpoolSample](https://github.com/leechristensen/SpoolSample) PoC, который использует эту ошибку для принуждения хостов Windows к аутентификации на других компьютерах через интерфейс MS-RPRN RPC. harmj0y выпустил [Rubeus toolkit](https://blog.harmj0y.net/redteaming/from-kekeo-to-rubeus/) для атаки на Kerberos. В конце 2018 года harmj0y также опубликовал блог ["Not A Security Boundary: взлом лесных трастов"](https://blog.harmj0y.net/redteaming/not-a-security-boundary-breaking-forest-trusts/), в котором были представлены ключевые исследования по проведению атак через лесные трасты. Метод атаки [DCShadow](https://www.dcshadow.com/) также был представлен Винсентом ЛЕ ТО и Бенджамином Дельпи на конференции Bluehat IL 2018. Инструмент [Ping Castle](https://github.com/vletoux/pingcastle/commits/master?after=f128d84e86e675f1ad65c4b9b05bd529e1f9dc7c+34&branch=master) был выпущен Винсентом ЛЕ ТО для проведения аудита безопасности Active Directory с целью поиска неправильных настроек и других уязвимостей, которые могут повысить уровень риска для домена, а также для создания отчёта, который можно использовать для определения способов дальнейшего усиления защиты среды.

## 2017

Метод [ASREPRoast](https://blog.harmj0y.net/activedirectory/roasting-as-reps/) был разработан для атак на учётные записи пользователей, которым не требуется предварительная аутентификация по протоколу Kerberos. _wald0 и harmj0y выступили с ключевым докладом об атаках на списки управления доступом Active Directory [«ACE Up the Sleeve»](https://www.slideshare.net/harmj0y/ace-up-the-sleeve) на конференциях Black Hat и DEF CON. harmj0y опубликовал в своём блоге [«A Guide to Attacking Domain Trusts»](https://blog.harmj0y.net/redteaming/a-guide-to-attacking-domain-trusts/) пост о перечислении и атаках на доменные трасты.

## 2016

[BloodHound](https://wald0.com/?p=68) был выпущен как революционный инструмент для визуализации путей атаки в AD на [DEF CON 24](https://www.youtube.com/watch?v=wP8ZCczC1OU).

## 2015

В 2015 году были выпущены одни из самых эффективных инструментов для работы с Active Directory за всё время. Была выпущена [платформа PowerShell Empire](https://github.com/EmpireProject/Empire). [PowerView 2.0](https://blog.harmj0y.net/redteaming/powerview-2-0/) был выпущен как часть (ныне устаревшего) репозитория [PowerTools](https://github.com/PowerShellEmpire/PowerTools/), который был частью аккаунта PowerShellEmpire на GitHub. Атака DCSync была впервые представлена Бенджамином Дельпи и Винсентом Ле Ту в рамках инструмента [mimikatz](https://github.com/gentilkiwi/mimikatz/). С тех пор она была включена в другие инструменты. Был представлен первый стабильный выпуск CrackMapExec ([(v1.0.0)](https://github.com/byt3bl33d3r/CrackMapExec/releases?page=3). Шон Меткалф выступил в Black Hat USA с докладом об опасностях неограниченного делегирования Kerberos и опубликовал отличный [пост в блоге](https://adsecurity.org/?p=1667) на эту тему. В 2015 году также был выпущен инструментарий [Impacket](https://github.com/SecureAuthCorp/impacket/releases?page=2). Это набор инструментов Python, многие из которых можно использовать для выполнения атак Active Directory. По состоянию на январь 2022 года он по-прежнему активно поддерживается и является ключевым инструментом в арсенале большинства специалистов по тестированию на проникновение.

## 2014

Veil-PowerView впервые [выпущен](https://github.com/darkoperator/Veil-PowerView/commit/fdfd47c0a1e06e529bf31c93da7caed3479d08e1#diff-1695122ff2b5844b625f6d05c9274ce0a8b75b9b7cde84386df07e24ae98181b). Позже этот проект стал частью [PowerSploit](https://github.com/PowerShellMafia/PowerSploit) в виде (больше не поддерживаемого) [PowerView.ps1](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1) инструмента для разведки в AD. Атака Kerberoasting была впервые представлена на конференции [Тима Медина](https://twitter.com/timmedin) на SANS Hackfest 2014.

## 2013

Инструмент [Responder](https://github.com/SpiderLabs/Responder/commits/master?after=c02c74853298ea52a2bfaa4d250c3898886a44ac+174&branch=master) был выпущен Лораном Гаффи. Responder — это инструмент, используемый для отравления LLMNR, NBT-NS и MDNS в сети Active Directory. С его помощью можно получать хэши паролей, а также выполнять атаки SMB Relay (в сочетании с другими инструментами) для горизонтального и вертикального перемещения в среде AD. За прошедшие годы он значительно усовершенствовался и по состоянию на январь 2022 года продолжает активно поддерживаться (с добавлением новых функций).