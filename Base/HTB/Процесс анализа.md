#traffic #network #htb 

Анализ сетевого трафика — это динамический процесс, который может меняться в зависимости от имеющихся у нас инструментов, разрешений, предоставленных нам организацией, и видимости нашей сети. Наша цель — создать воспроизводимый процесс, который мы сможем использовать для анализа трафика.

Анализ трафика — это `detailed examination of an event or process`, определение его источника и влияния, которое может быть использовано для принятия конкретных мер предосторожности и/или действий для поддержки или предотвращения проблем в будущем. В случае с сетевым трафиком это означает разделение данных на понятные фрагменты и их проверку на наличие отклонений от обычного сетевого трафика, потенциально вредоносного трафика, например несанкционированных удаленных подключений из Интернета через RDP, SSH или Telnet, а также уникальных случаев, предшествующих проблемам в сети. В ходе анализа мы также изучаем тенденции в трафике и определяем, соответствует ли он базовому уровню типичного рабочего трафика.

Анализ трафика — это универсальный и крайне важный инструмент в нашем арсенале средств защиты. Без возможности отслеживать трафик мы не сможем решить большую часть задач. Аналитика использования сети, наиболее активных хостов и серверов, а также внутренних коммуникаций — все это важнейшие элементы, которые позволяют нам, администраторам и специалистам по защите, выявлять и устранять проблемы до или вскоре после их возникновения. Пожалуй, самое полезное, что дает аналитика, — это наглядность. Благодаря ей мы можем фиксировать трафик за разные периоды, чтобы установить базовые показатели для нашей среды. Этот базовый уровень позволяет легче увидеть, когда произошло изменение. В более продвинутых реализациях NTA, которые включают другие инструменты, такие как IDS / IP, брандмауэры, журналы хоста и сети, а также дополнительную информацию, загружаемую в такие инструменты, как Splunk или ELK Stack, возможность отслеживать трафик имеет неоценимое значение. Инструменты помогают нам быстро оповещать о происходящих вредоносных действиях. Многие защитные инструменты имеют сигнатуры, созданные для большинства распространенных атак, и наборы инструментов.

Наличие надлежащих средств защиты важно для всех, но как быть с повседневными операциями? Как нам может помочь NTA? Наблюдение за сетевым трафиком в режиме реального времени позволяет легко устранять проблемы с подключением или определять, правильно ли функционирует наша инфраструктура и соответствующие протоколы. Если мы видим, куда направляется трафик, мы можем определить, есть ли проблема.

Наконец, это динамичный навык, и использование автоматизированных инструментов для его развития вполне оправданно. Просто не полагайтесь на них полностью. Используйте имеющиеся у вас навыки и выполняйте проверки вручную. Это поможет нам следить за нашей сетью. Мы будем контролировать и уравновешивать работу инструментов, поскольку инструменты можно обойти. Злоумышленники постоянно находят способы обойти меры безопасности. Человеческий глаз по-прежнему остаётся нашим лучшим помощником в поиске злоумышленников.

---

## Анализ Зависимостей

Сбор и анализ трафика можно выполнять двумя способами: `active` или `passive`. У каждого из них есть свои особенности. При пассивном сборе мы просто копируем данные, которые можем видеть, без непосредственного взаимодействия с пакетами. При активном сборе и анализе трафика требования немного другие. Активный сбор требует более активного участия. Этот процесс также можно назвать `in-line` сбором трафика. В обоих случаях анализ данных зависит от нас. Мы можем выполнить захват и анализ после завершения процесса или проводить анализ в режиме реального времени, пока трафик не остановлен. В таблице ниже приведены зависимости для каждого из вариантов.

#### Зависимости от сбора трафика

| **Зависимости**                           | **Пассивный** | **Активный** | **Описание**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| ----------------------------------------- | ------------- | ------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `Permission`                              | `☑`           | `☑`          | В зависимости от организации, в которой мы работаем, сбор данных может противоречить правилам или даже закону в некоторых чувствительных сферах, таких как здравоохранение или банковское дело. Обязательно получите письменное разрешение от лица, обладающего соответствующими полномочиями. Мы можем называть себя хакерами, но мы хотим действовать в рамках закона и этических норм.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| `Mirrored Port`                           | `☑`           | ☐            | Сетевой интерфейс коммутатора или маршрутизатора, настроенный на копирование данных из других источников на этот конкретный интерфейс, а также возможность перевода сетевой карты в неразборчивый режим. Копирование пакетов на наш порт позволяет нам проверять любой трафик, предназначенный для других каналов, которые мы обычно не можем контролировать. Поскольку виртуальные локальные сети и порты коммутаторов не пересылают трафик за пределы своего широковещательного домена, мы должны быть подключены к сегменту или обеспечить копирование трафика на наш конкретный порт. При работе с беспроводными сетями пассивное подключение может быть немного сложнее. Мы должны подключиться к SSID, трафик с которого хотим перехватить. Если мы будем просто пассивно прослушивать радиоволны вокруг нас, то увидим множество рекламных объявлений SSID, но не более того. |
| `Capture Tool`                            | `☑`           | `☑`          | Способ сбора трафика. Достаточно компьютера с доступом к таким инструментам, как TCPDump, Wireshark, Netminer и другим. Помните, что при работе с данными в формате PCAP эти файлы могут быстро увеличиваться в размере. Каждый раз, когда мы применяем к ним фильтр в таких инструментах, как Wireshark, приложение снова анализирует эти данные. Это может быть ресурсоёмким процессом, поэтому убедитесь, что у хоста достаточно ресурсов.                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `In-line Placement`                       | ☐             | `☑`          | Для установки линейного коммутатора требуется изменить топологию сети, в которой вы работаете. Хосты-источники и хосты-получатели не заметят разницы в трафике, но для маршрутизации и коммутации это будет невидимый следующий узел, через который проходит трафик на пути к получателю.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| `Network Tap or Host With Multiple NIC's` | ☐             | `☑`          | Чтобы данные, которые мы проверяем, продолжали передаваться, требуется компьютер с двумя сетевыми картами или такое устройство, как Network Tap. Представьте, что вы добавляете ещё один маршрутизатор в середину канала. Чтобы активно перехватывать трафик, мы будем дублировать данные непосредственно из источников. Лучше всего размещать tap на канале третьего уровня между коммутируемыми сегментами. Это позволяет перехватывать любой трафик, направляющийся за пределы локальной сети. Коммутируемый порт или сегментация VLAN не фильтруют наш обзор.                                                                                                                                                                                                                                                                                                                    |
| `Storage and Processing Power`            | `☑`           | `☑`          | Для перехвата трафика с помощью tap вам понадобится много места для хранения данных и вычислительная мощность. По каналу третьего уровня проходит гораздо больше трафика, чем просто внутри коммутируемой локальной сети. Представьте себе следующее: когда мы пассивно перехватываем трафик внутри локальной сети, это похоже на то, как если бы мы наливали воду в чашку из фонтана. Это непрерывный, но управляемый поток. Активный захват трафика из маршрутизируемого канала больше похож на использование водяного шланга для наполнения чайной чашки. За этим потоком стоит гораздо большее давление, и хосту может быть сложно его обработать и сохранить.                                                                                                                                                                                                                   |

Последняя зависимость — это скорее рекомендация, чем требование, но мы считаем необходимым упомянуть о ней. Понимание того, как происходит ежедневный трафик, критически важно для достижения успеха. Анализ трафика можно провести и без этого, но это будет намного сложнее и займёт больше времени. Исходные данные позволят нам быстро отфильтровать обычный трафик для этой сети во время анализа. Это ускорит процесс и поможет быстрее выявить отклонения или проблемы. Давайте рассмотрим этот сценарий:

 Вы — сетевой администратор крупной корпорации, в кампусе которой работают несколько тысяч сотрудников. Вам сообщили, что в одном из сегментов вашей сети возникли проблемы с подключением. Несколько хостов сообщают о чрезвычайно высокой задержке, а на их рабочих столах появляются новые файлы. Чтобы понять, что происходит, вы подключаете компьютер к этому сегменту и запускаете захват данных. Через несколько минут вы останавливаете захват и начинаете анализ.

А теперь подумайте вот о чём. Как мы можем узнать, что является типичным для этой сети, если у нас нет исходных данных о ежедневном сетевом трафике? За время сбора данных мы получили массу информации, и часть из неё нужно отсеять. Этот процесс может занять много времени, поскольку нам придётся проверять каждый разговор, чтобы убедиться, что всё в порядке, определять, принадлежат ли хосты, которые мы видим, сети или являются вредоносными, и многое другое. Этот процесс быстро превратился в сложную задачу, верно?

Имея такой сценарий и доступ к базовым настройкам сети, мы можем быстро отсеять заведомо безопасные соединения. Использование инструментов для анализа данных, таких как модуль top talkers в Wireshark, может помочь выявить хосты, которые отправляют большие объёмы данных. Мы можем сравнить эти данные с базовыми настройками хоста, чтобы определить, не выходят ли они за рамки обычного поведения. Другой способ — проанализировать соединения между внутренними хостами или обычными и необычными портами. Теперь, когда мы можем видеть полную картину, мы видим, что несколько пользовательских хостов подключаются через порты 8080 и 445. Сами по себе порты не вызывают подозрений, но странно то, что два пользовательских компьютера взаимодействуют друг с другом через эти порты. Веб-трафик обычно поступает с хоста на размещённый веб-сервер или внутренний веб-сервер, на котором размещены бизнес-приложения. То же самое можно сказать и о трафике SMB. Очень подозрительно, что два хоста взаимодействуют друг с другом через этот порт. Теперь, когда мы знаем, что произошло, мы можем быстро отправить запрос в службу поддержки, чтобы получить помощь в устранении потенциального нарушения.

Если говорить о сетевых вторжениях, то чем быстрее мы сможем выявить проблему, тем меньше будет потенциальный ущерб для нашей сети. Обязательно разберитесь в том, как происходит обмен данными в наших сетях и как обычно работают протоколы.