#network #htb 

[Протокол управления передачей](https://en.wikipedia.org/wiki/Transmission_Control_Protocol) (`TCP`) и [протокол пользовательских дейтаграмм](https://en.wikipedia.org/wiki/User_Datagram_Protocol) (`UDP`) — это протоколы, используемые для передачи информации и данных в Интернете. Как правило, по TCP-соединениям передаются важные данные, такие как веб-страницы и электронные письма. По UDP-соединениям, напротив, передаются данные в реальном времени, например потоковое видео или онлайн-игры.

`TCP` Это протокол, ориентированный на установление соединения, который гарантирует получение всех данных, отправленных с одного компьютера на другой. Это похоже на телефонный разговор, во время которого обе стороны остаются на связи до тех пор, пока звонок не будет завершён. Если при отправке данных возникает ошибка, получатель отправляет ответное сообщение, чтобы отправитель мог повторно отправить недостающие данные. Это делает `TCP` более надёжным и медленным протоколом по сравнению с UDP, поскольку для передачи и устранения ошибок требуется больше времени.

`UDP`, с другой стороны, — это протокол без установления соединения. Он используется, когда скорость важнее надёжности, например при потоковой передаче видео или в онлайн-играх. При использовании `UDP` не проверяется, являются ли полученные данные полными и безошибочными. Если при отправке данных возникает ошибка, получатель не получит недостающие данные, и не будет отправлено сообщение о повторной отправке. При использовании `UDP` некоторые данные могут быть потеряны, но в целом передача происходит быстрее.

---

## IP-пакет

[Интернет-протокол](https://en.wikipedia.org/wiki/Internet_Protocol) (`IP`) — это область данных, используемая сетевым уровнем [модели взаимодействия открытых систем](https://en.wikipedia.org/wiki/OSI_model) (`OSI`) для передачи данных с одного компьютера на другой. Она состоит из заголовка и полезной нагрузки — собственно данных.

IP-пакет можно представить как письмо, отправленное в конверте. В конверте находится заголовок, содержащий информацию об отправителе и получателе, а также инструкции по маршрутизации письма, то есть указания, через какие почтовые отделения его следует отправить. Само письмо — это полезная нагрузка, то есть фактические данные.

#### IP - заголовок

Заголовок IP-пакета содержит несколько полей с важной информацией.

|**Поле**|**Описание**|
|---|---|
|`Version`|Указывает, какая версия протокола IP используется|
|`Internet Header Length`|Указывает размер заголовка в 32-битных словах|
|`Class of Service`|Это показывает, насколько важна передача данных|
|`Total length`|Указывает общую длину пакета в байтах|
|`Identification (ID)`|Используется для идентификации фрагментов пакета при его разбиении на более мелкие части|
|`Flags`|Используется для обозначения фрагментации|
|`Fragment Offset`|Указывает, где в пакете находится текущий фрагмент|
|`Time to Live`|Указывает, как долго пакет может находиться в сети|
|`Protocol`|Указывает, какой протокол используется для передачи данных, например TCP или UDP|
|`Checksum`|Используется для обнаружения ошибок в заголовке|
|`Source/Destination`|Укажите, откуда был отправлен пакет и куда он направляется|
|`Options`|Содержит дополнительную информацию для маршрутизации|
|`Padding`|Дополняет пакет до полной длины слова|

Мы можем видеть компьютер с несколькими IP-адресами в разных сетях. Здесь следует обратить внимание на `IP ID` поле. Оно используется для идентификации фрагментов IP-пакета при его разбиении на более мелкие части. Это `16-bit` поле с уникальным номером в диапазоне от `0-65535`.

Если у компьютера несколько IP-адресов, поле `IP ID` будет разным для каждого пакета, отправленного с компьютера, но в целом будет выглядеть примерно так: В TCPdump сетевой трафик может выглядеть примерно так:

#### Обнюхивание Сети

  Соединения TCP / UDP

```shell-session
IP 10.129.1.100.5060 > 10.129.1.1.5060: SIP, length: 1329, id 1337
IP 10.129.1.100.5060 > 10.129.1.1.5060: SIP, length: 1329, id 1338
IP 10.129.1.100.5060 > 10.129.1.1.5060: SIP, length: 1329, id 1339
IP 10.129.2.200.5060 > 10.129.1.1.5060: SIP, length: 1329, id 1340
IP 10.129.2.200.5060 > 10.129.1.1.5060: SIP, length: 1329, id 1341
IP 10.129.2.200.5060 > 10.129.1.1.5060: SIP, length: 1329, id 1342
```

Из вывода видно, что два разных IP-адреса отправляют пакеты на IP-адрес 10.129.1.1. Однако из `IP ID` видно, что пакеты идут непрерывно. Это явно указывает на то, что два IP-адреса принадлежат одному и тому же хосту в сети.

#### Поле записи маршрута

`Record-Route field` в заголовке IP-пакета также записывает маршрут до устройства назначения. Когда устройство назначения отправляет обратно `ICMP Echo Reply`-пакет, IP-адреса всех устройств, через которые проходит пакет, перечисляются в `Record-Route field` заголовка IP-пакета. Это происходит, например, когда мы используем следующую команду:

  Соединения TCP / UDP

```shell-session
Barlogsha@htb[/htb]$ ping -c 1 -R 10.129.143.158

PING 10.129.143.158 (10.129.143.158) 56(124) bytes of data.
64 bytes from 10.129.143.158: icmp_seq=1 ttl=63 time=11.7 ms
RR: 10.10.14.38
        10.129.0.1
        10.129.143.158
        10.129.143.158
        10.10.14.1
        10.10.14.38


--- 10.129.143.158 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 11.688/11.688/11.688/0.000 ms
```

Вывод показывает, что был отправлен запрос `ping` и получен ответ от целевого устройства, а также отображается `Record-Route field` в IP-заголовке пакета `ICMP Echo Request` . Поле Record Route содержит IP-адреса всех устройств, через которые прошёл пакет `ICMP Echo Request` на пути к целевому устройству. В данном случае `Record-Route field` содержит IP-адреса:

| | | |
|---|---|---|
|10.10.14.38|10.129.0.1|10.129.143.158|
|10.129.143.158|10.10.14.1|10.10.14.38|

Инструмент `traceroute` также можно использовать для более точного отслеживания маршрута до пункта назначения. Он использует метод тайм-аута TCP для определения того, когда маршрут будет полностью отслежен.

1. Мы отправляем TCP-пакет SYN на целевое устройство с TTL, равным 1, в IP-заголовке.
    
    Когда TCP-пакет SYN с TTL больше 1 достигает маршрутизатора, значение TTL уменьшается на 1, и пакет пересылается на следующее устройство. Если TCP-пакет SYN с TTL равен 1 достигает маршрутизатора, пакет отбрасывается, а маршрутизатор отправляет нам пакет ICMP Time-Exceeded.
    
2. Мы получаем пакет ICMP Time-Exceeded и записываем IP-адрес маршрутизатора, отправившего пакет.
    
3. После этого мы отправляем в пункт назначения ещё один TCP-пакет SYN, увеличивая TTL на 1.
    

Процесс повторяется до тех пор, пока TCP-пакет SYN не достигнет целевого хоста и не получит ответ `TCP SYN/ACK` или `TCP RST` от целевого устройства. Как только мы получаем ответ от целевого устройства, мы понимаем, что проложили маршрут до целевого устройства и завершили процесс трассировки.

#### Полезная нагрузка IP

Полезная нагрузка (также называемая `IP Data`) — это фактическая полезная нагрузка пакета. Она содержит данные различных протоколов, таких как TCP или UDP, которые передаются, подобно содержимому письма в конверте.

---

## TCP

Пакеты TCP, также известные как `segments`, делятся на несколько частей, называемых заголовками и полезными данными. Сегменты TCP заключены в отправляемый IP-пакет.

Заголовок содержит несколько полей с важной информацией. Исходный порт указывает на компьютер, с которого был отправлен пакет. Порт назначения указывает, на какой компьютер был отправлен пакет. Порядковый номер указывает на порядок отправки данных. Номер подтверждения используется для подтверждения того, что все данные были успешно получены. Управляющие флаги указывают на то, является ли пакет завершающим, подтверждает ли он получение данных или содержит запрос на повторение данных. Размер окна указывает, какой объём данных может получить получатель. Контрольная сумма используется для обнаружения ошибок в заголовке и полезной нагрузке. Указатель срочности предупреждает получателя о том, что в полезной нагрузке содержатся важные данные.

Полезная нагрузка — это фактическое содержимое пакета, содержащее передаваемые данные, подобно тому, как содержание разговора между двумя людьми является полезной нагрузкой.

---

## UDP

UDP передаёт `datagrams` (небольшие пакеты данных) между двумя хостами. Это протокол без установления соединения, то есть ему `not` не нужно устанавливать соединение между отправителем и получателем перед отправкой данных. Вместо этого данные отправляются непосредственно на целевой хост без предварительного установления соединения.

Если `traceroute` используется с протоколом UDP, то при получении пакета дейтаграмм UDP целевым устройством мы получим сообщения `Destination Unreachable` и `Port Unreachable`. Как правило, пакеты UDP отправляются с помощью `traceroute` на хостах Unix.

---

## Слепая Подмена

`Blind spoofing`— это метод атаки с манипулированием данными, при котором злоумышленник отправляет ложную информацию по сети, не видя реальных ответов, получаемых от целевых устройств. Он предполагает манипулирование полем заголовка IP-пакета для указания ложных адресов источника и назначения. Например, мы отправляем TCP-пакет на целевой хост с ложными номерами портов источника и назначения и ложным `Initial Sequence Number` (`ISN`).`ISN` — это поле в заголовке TCP, которое используется для указания порядкового номера первого TCP-пакета в соединении. ISN устанавливается отправителем TCP-пакета и отправляется получателю в заголовке TCP первого пакета. Это может привести к тому, что целевой хост установит с нами соединение, не получив подтверждения.

Эта атака обычно используется для нарушения целостности сетевых соединений или разрыва связей между сетевыми устройствами. Она также может использоваться для отслеживания сетевого трафика или перехвата информации, отправляемой сетевыми устройствами.