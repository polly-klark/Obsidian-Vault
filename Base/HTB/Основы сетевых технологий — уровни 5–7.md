#network #traffic #htb #TCP #OSI

Мы рассмотрели сетевые функции нижнего уровня. Теперь давайте познакомимся с некоторыми протоколами верхнего уровня, которые используются в наших приложениях. Для поддержания сетевого соединения и обеспечения передачи данных между хостами требуется множество различных приложений и сервисов. В этом разделе мы расскажем лишь о самых важных из них.

---

## HTTP

Протокол передачи гипертекста (`HTTP`) — это протокол прикладного уровня без сохранения состояния, который используется с 1990 года. HTTP позволяет передавать данные в виде обычного текста между клиентом и сервером по протоколу TCP. Клиент отправляет на сервер HTTP-запрос на получение ресурса. Устанавливается сеанс связи, и сервер отвечает запрошенным медиафайлом (HTML, изображения, гиперссылки, видео). При обычной работе HTTP использует порты 80 или 8000 по протоколу TCP. В исключительных случаях его можно настроить на использование альтернативных портов или даже UDP.

#### Методы HTTP

Для выполнения таких операций, как загрузка веб-страниц, запрос на скачивание файлов или публикация последнего твита, необходимо использовать определённые методы. Эти методы определяют действия, выполняемые при запросе URI. Методы:

|**Способ**|**Описание**|
|---|---|
|`HEAD`|`required` Это безопасный метод, который запрашивает у сервера ответ, аналогичный запросу Get, за исключением того, что тело сообщения не включается. Это отличный способ получить дополнительную информацию о сервере и его рабочем состоянии.|
|`GET`|`required` Get — наиболее часто используемый метод. Он запрашивает информацию и контент с сервера. Например, `GET http://10.1.1.1/Webserver/index.html` запрашивает страницу index.html с сервера по указанному нами URI.|
|`POST`|`optional` POST — это способ отправки информации на сервер на основе полей в запросе. Например, отправка сообщения в Facebook или на форум веб-сайта — это действие POST. Фактическое действие может зависеть от сервера, и для проверки действия следует обращать внимание на возвращаемые коды ответов.|
|`PUT`|`optional` Метод PUT принимает данные, добавленные к сообщению, и помещает их в запрошенный URI. Если элемент там ещё не существует, он будет создан на основе предоставленных данных. Если объект уже существует, новый PUT будет считаться наиболее актуальным, и объект будет изменён в соответствии с ним. Проще всего представить разницу между PUT и POST следующим образом: PUT создаёт или обновляет объект по указанному URI, а POST создаёт дочерние объекты по указанному URI. Это действие можно сравнить с разницей между созданием нового файла и написанием комментариев к этому файлу на той же странице.|
|`DELETE`|`optional` Команда Delete выполняет действия, соответствующие её названию. Она удаляет объект по указанному URI.|
|`TRACE`|`optional` Позволяет проводить диагностику удалённого сервера. Если метод TRACE включён, удалённый сервер в своём ответе повторит тот же запрос, который был отправлен.|
|`OPTIONS`|`optional` Метод Options может собирать информацию о поддерживаемых сервером методах HTTP. Таким образом, мы можем определить требования к взаимодействию с конкретным ресурсом или сервером, не запрашивая у него данные или объекты.|
|`CONNECT`|`optional` Функция Connect предназначена для использования с прокси-серверами или другими устройствами безопасности, такими как брандмауэры. Функция Connect позволяет осуществлять туннелирование через HTTP. (`SSL tunnels`)|

Обратите внимание, что рядом с каждым методом указано `required` или `optional`. Согласно требованиям стандарта, методы GET и HEAD всегда должны работать и поддерживаться стандартными реализациями HTTP. Это справедливо только для них. Методы trace, options, delete, put и post являются дополнительными функциями, которые можно включить. Примером может служить веб-страница, доступная только для чтения, например запись в блоге. Клиентский компьютер может запрашивать ресурс со страницы, но не может изменять, добавлять или удалять ресурс или ресурсы.

Дополнительную информацию о протоколе HTTP и принципах его работы можно найти в `RFC:2616`.

---

## HTTPS

HTTP Secure (`HTTPS`) — это модификация протокола HTTP, предназначенная для использования Transport Layer Security (`TLS`) или Secure Sockets Layer (`SSL`) в старых приложениях для обеспечения безопасности данных. Протокол TLS используется в качестве механизма шифрования для защиты связи между клиентом и сервером. Протокол TLS может обернуть обычный HTTP-трафик в TLS, то есть мы можем зашифровать весь разговор, а не только отправляемые или запрашиваемые данные. До появления механизма TLS мы были уязвимы для атак типа «человек посередине» и других видов разведки или перехвата данных. Это означало, что любой пользователь в той же локальной сети, что и клиент или сервер, мог просматривать веб-трафик, если прослушивал канал. Теперь в браузере реализована функция безопасности, которая позволяет каждому пользователю шифровать свои действия в интернете, поисковые запросы, сеансы или передачу данных, банковские транзакции и многое другое.

Несмотря на то, что в основе HTTPS лежит HTTP, вместо стандартного порта 80 используются порты 443 и 8443. Это простой способ для клиента сообщить серверу, что он хочет установить безопасное соединение. Давайте посмотрим на трафик HTTPS и разберёмся, как работает `TLS handshake` в течение минуты.

#### Рукопожатие TLS Через HTTPS

![[Pasted image 20250907175700.png]]

В первых нескольких пакетах мы видим, что клиент устанавливает соединение с сервером через порт 443 `boxed in blue`. Это означает, что сервер должен использовать HTTPS в качестве протокола связи с приложением.

После того как сеанс связи инициирован по протоколу TCP, отправляется TLS ClientHello для начала рукопожатия по протоколу TLS. Во время рукопожатия согласовываются несколько параметров, в том числе идентификатор сеанса, сертификат x509 однорангового узла, используемый алгоритм сжатия, алгоритм шифрования cipher spec, возможность возобновления сеанса и 48-байтовый мастер-секрет, которым обмениваются клиент и сервер для подтверждения сеанса.

После установления сеанса все данные и методы будут передаваться через TLS-соединение и отображаться как данные приложения TLS `as seen in the red box`. TLS по-прежнему использует TCP в качестве транспортного протокола, поэтому мы по-прежнему будем видеть пакеты подтверждения от потока, поступающие через порт 443.

Подведём итог рукопожатию:

1. Клиент и сервер обмениваются приветственными сообщениями, чтобы согласовать параметры подключения.
2. Клиент и сервер обмениваются необходимыми криптографическими параметрами для создания премастер-секрета.
3. Клиент и сервер обмениваются сертификатами X.509 и криптографической информацией, что позволяет осуществлять аутентификацию в рамках сеанса.
4. Генерируется мастер-ключ на основе предварительного мастер-ключа и происходит обмен случайными значениями.
5. Клиент и сервер передают согласованные параметры безопасности на уровень записи протокола TLS.
6. Клиент и сервер проверяют, что их одноранговый узел рассчитал те же параметры безопасности и что рукопожатие произошло без вмешательства злоумышленника.

Шифрование само по себе — сложная и обширная тема, которая заслуживает отдельного модуля. В этом разделе кратко рассказывается о том, как HTTP и TLS обеспечивают безопасность в рамках прикладного протокола HTTPS. Дополнительную информацию о том, как работает HTTPS и как TLS выполняет операции по обеспечению безопасности, можно найти в `RFC:2246`.

---

## FTP

Протокол передачи файлов (`FTP`) — это протокол прикладного уровня, который обеспечивает быструю передачу данных между вычислительными устройствами. FTP можно использовать из командной строки, веб-браузера или с помощью графического FTP-клиента, такого как FileZilla. FTP сам по себе считается небезопасным протоколом, и большинство пользователей перешли на использование таких инструментов, как SFTP, для передачи файлов по защищенным каналам. Следует отметить, что с 2020 года большинство современных веб-браузеров прекратили поддержку FTP.

Когда мы думаем о взаимодействии между хостами, мы обычно представляем себе клиента и сервер, взаимодействующие через один сокет. Через этот сокет и клиент, и сервер отправляют команды и данные по одному и тому же каналу. В этом аспекте FTP уникален, поскольку использует несколько портов одновременно. FTP использует порты 20 и 21 по протоколу TCP. Порт 20 используется для передачи данных, а порт 21 — для отправки команд, управляющих сеансом FTP. Что касается аутентификации, FTP поддерживает аутентификацию пользователей, а также позволяет осуществлять анонимный доступ, если это настроено.

FTP может работать в двух разных режимах: `active` или `passive`. Активный режим — это метод работы FTP по умолчанию. Это означает, что сервер ожидает от клиента управляющей команды `PORT`, указывающей, какой порт использовать для передачи данных. Пассивный режим позволяет нам получать доступ к FTP-серверам, расположенным за брандмауэрами или через канал с поддержкой NAT, что делает невозможным прямое TCP-соединение. В этом случае клиент отправляет команду `PASV` и ожидает ответа от сервера, который сообщает клиенту, какой IP-адрес и порт использовать для подключения к каналу передачи данных.

#### Примеры команд и ответов FTP

![[Pasted image 20250907175707.png]]

На изображении выше показано несколько примеров запросов, отправленных через командный канал FTP `green arrows`, и ответов, полученных от FTP-сервера `blue arrows`. Всё это довольно стандартно. Список команд и их назначение приведены в таблице ниже.

При анализе FTP-трафика можно заметить, что через порт 21 передаются следующие распространённые команды:

#### Команды FTP

| **Команда** | **Описание**                                                       |
| ----------- | ------------------------------------------------------------------ |
| `USER`      | указывает пользователя, от имени которого нужно войти.             |
| `PASS`      | отправляет пароль пользователя, который пытается войти в систему.  |
| `PORT`      | в активном режиме это приведет к смене используемого порта данных. |
| `PASV`      | переключает соединение с сервером из активного режима в пассивный. |
| `LIST`      | выводит список файлов в текущей директории.                        |
| `CWD`       | изменит текущий рабочий каталог на указанный.                      |
| `PWD`       | выводит на экран каталог, в котором вы сейчас работаете.           |
| `SIZE`      | вернёт размер указанного файла.                                    |
| `RETR`      | извлекает файл с FTP-сервера.                                      |
| `QUIT`      | завершает сеанс.                                                   |

Это не исчерпывающий список возможных команд управления FTP. Они могут различаться в зависимости от используемого FTP-приложения или оболочки. Дополнительную информацию о FTP можно найти по ссылке `RFC:959`.

---

## SMB

Блок сообщений сервера (`SMB`) — это протокол, наиболее распространённый в корпоративных средах Windows, который позволяет совместно использовать ресурсы между хостами в рамках общих сетевых архитектур. SMB — это протокол, ориентированный на установление соединения, который требует аутентификации пользователя на хосте, чтобы убедиться, что у пользователя есть необходимые разрешения для использования этого ресурса или выполнения действий. В прошлом SMB использовал NetBIOS в качестве транспортного механизма через порты UDP 137 и 138. После внесения современных изменений SMB теперь поддерживает прямой TCP-транспорт через порт 445, NetBIOS через TCP-порт 139 и даже протокол QUIC.

Для пользователей SMB обеспечивает простой и удобный доступ к таким ресурсам, как принтеры, общие диски, серверы аутентификации и т. д. По этой причине SMB очень привлекателен и для потенциальных злоумышленников.

Как и любое другое приложение, использующее TCP в качестве транспортного механизма, оно будет выполнять стандартные функции, такие как трёхстороннее рукопожатие и подтверждение получения пакетов. Давайте взглянем на SMB-трафик, чтобы лучше разобраться.

#### SMB На Проводе

![[Pasted image 20250907175712.png]]

На изображении выше видно, что при каждом установлении сеанса `orange boxes` происходит рукопожатие по протоколу TCP. Если посмотреть на порты источника и назначения `blue box`, то можно увидеть, что используется порт 445, сигнализирующий о передаче SMB-трафика по протоколу TCP. Если посмотреть на `green boxes,` в поле info, то можно узнать немногое о том, что происходит при обмене данными по протоколу SMB. В этом примере много ошибок, и это повод для более глубокого изучения. Один или два неудачных попытки аутентификации со стороны пользователя — это довольно распространенное явление, но большое количество повторяющихся попыток может свидетельствовать о том, что неавторизованный пользователь пытается получить доступ к учетной записи или использовать учетные данные для перехода на другой ресурс. Это распространенная тактика злоумышленников: они перехватывают аутентифицированного пользователя, крадут его учетные данные и используют их для перехода на другой ресурс или для доступа к ресурсам, в котором обычно отказывают.

Это лишь один из примеров использования SMB. Ещё одна распространённая ситуация — доступ к общим файлам между серверами и хостами. По большей части это обычная коммуникация. Однако если мы видим, что хост обращается к общим файлам на других хостах, это не является нормой. Пожалуйста, обратите внимание на то, кто запрашивает подключения, куда и к чему они подключаются.