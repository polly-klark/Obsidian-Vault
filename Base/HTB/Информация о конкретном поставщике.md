#network #htb 

[Cisco IOS](https://www.cisco.com/c/en/us/products/ios-nx-os-software/ios-technologies/index.html) — это операционная система сетевых устройств Cisco, таких как маршрутизаторы и коммутаторы. Она предоставляет функции и сервисы, необходимые для управления сетевыми устройствами и их эксплуатации. Эта операционная система выпускается в различных версиях и модификациях, которые отличаются функциями, поддержкой и производительностью. Она предлагает ряд функций, необходимых для работы современных сетей, в том числе:

- Поддержка IPv6
- Качество обслуживания (QoS)
- Такие функции безопасности, как шифрование и аутентификация
- Функции виртуализации, такие как служба виртуальных частных сетей (VPLS)
- Виртуальная маршрутизация и переадресация (VRF)

Управлять Cisco IOS можно несколькими способами в зависимости от используемого сетевого устройства и оборудования. Наиболее распространённым методом является использование интерфейса командной строки (`CLI`), которым также можно управлять через графический интерфейс пользователя (`GUI`). Кроме того, он поддерживает различные сетевые протоколы и службы, необходимые для работы сети. К ним относятся:

|**Тип протокола**|**Описание**|
|---|---|
|`Routing protocols`|Такие протоколы, как [OSPF](https://en.wikipedia.org/wiki/Open_Shortest_Path_First) и [BGP](https://en.wikipedia.org/wiki/Border_Gateway_Protocol), используются для маршрутизации пакетов данных в сети.|
|`Switching protocols`|Такие протоколы, как [VLAN Trunking Protocol](https://en.wikipedia.org/wiki/VLAN_Trunking_Protocol) (`VTP`) и [Spanning Tree Protocol](https://en.wikipedia.org/wiki/Spanning_Tree_Protocol) (`STP`), используются для настройки коммутаторов в сети и управления ими.|
|`Network services`|Такие протоколы, как [протокол динамической конфигурации хоста](https://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol) (`DHCP`), используются для автоматического предоставления клиентам в сети IP-адресов и других сетевых конфигураций.|
|`Security features`|Например, [списки контроля доступа](https://en.wikipedia.org/wiki/Access-control_list) (`ACLs`), которые используются для контроля доступа к сетевым ресурсам и предотвращения угроз безопасности.|

---

В Cisco IOS для разных целей используются разные типы паролей, например:

|**Тип пароля**|**Описание**|
|---|---|
|`User`|Пароль [пользователя](https://www.cisco.com/c/en/us/td/docs/ios-xml/ios/security/s1/sec-s1-cr-book/sec-cr-t2.html#wp2992613898) используется для входа в Cisco IOS. Он используется для ограничения доступа к сетевому устройству и его функциям.|
|`Enable Password`|[Пароль для включения](https://www.cisco.com/c/en/us/td/docs/ios-xml/ios/security/d1/sec-d1-cr-book/sec-cr-e1.html#wp3884449514) используется для входа в режим «включения». Режим «включения» — это режим, в котором у вас есть доступ к расширенным функциям и настройкам.|
|`Secret`|[секрет](https://www.cisco.com/c/en/us/td/docs/ios-xml/ios/security/s1/sec-s1-cr-book/sec-cr-s1.html#wp2622423174) — это пароль для защиты доступа к определенным функциям и сервисам. Он часто используется для ограничения доступа к инструментам и сервисам удаленного управления.|
|`Enable Secret`|[секретный код включения](https://www.cisco.com/c/en/us/td/docs/ios-xml/ios/security/d1/sec-d1-cr-book/sec-cr-e1.html#wp3438133060) — это сверхнадёжный пароль, используемый для защиты доступа к режиму «включения». Он хранится в зашифрованном виде для обеспечения дополнительной защиты.|

Мы настоятельно рекомендуем изучить предоставленные внешние ресурсы, чтобы понять, как работает шифрование в Cisco IOS и как оно используется.

Устройства Cisco IOS можно настроить для работы по протоколу SSH или Telnet. Таким образом, к ним можно получить удалённый доступ. По полученному ответу мы можем определить, что это действительно Cisco IOS, поскольку она отвечает сообщением `User Access Verification`

#### Cisco IOS

  Информация о конкретном поставщике

```shell-session
Barlogsha@htb[/htb]$ telnet 10.129.10.2

Trying 10.129.10.2...
Connected to 10.129.10.2.
Escape character is '^]'.


User Access Verification

Password:
```

---

# VLANы

Представьте себе такую ситуацию: стартап под названием XQ нанял сетевого администратора для создания сети в своей компании с одним офисом. Из-за бюджетных ограничений они могут позволить себе только один коммутатор и маршрутизатор. Системный администратор XQ заявил, что помимо размещения веб-серверов и серверов баз данных в сети, ею будут пользоваться сотрудники из разных отделов. Будучи опытным специалистом по сетевой безопасности, сетевой администратор сразу же подумал о том, какие атаки может совершить инсайдер, особенно те, которые связаны с использованием широковещательного трафика, например `broadcast storms`. Поэтому, чтобы решить эту проблему, сетевой администратор решил логически сегментировать сеть с помощью `Virtual Local Area Networks` (`VLANS`), концептуально разделив один коммутатор на несколько мини-коммутаторов.

`VLAN` — это логическая группа сетевых конечных точек, подключенных к определенным портам коммутатора. Она позволяет сегментировать сети, создавая логические широковещательные домены, которые могут охватывать несколько физических сегментов локальной сети. С помощью `VLANs` сетевые администраторы могут сегментировать сети по таким факторам, как команда, функция, отдел или приложение, не беспокоясь о физическом расположении конечных точек и пользователей. Широковещательный пакет, отправленный через один `VLAN`, не дойдет до другой конечной точки, входящей в состав другого `VLAN`. Поскольку каждый `VLAN` считается областью вещания, ему нужен собственный `subnet`; например, сетевой администратор, с которым сотрудничает XQ, может сегментировать сеть по отделам:

|**Отдел**|**ИДЕНТИФИКАТОР VLAN**|**Подсеть**|
|:-:|:-:|:-:|
|`Servers`|`VLAN 10`|`192.168.1.0/24`|
|`C-Level`|`VLAN 20`|`192.168.2.0/24`|
|`Finance`|`VLAN 30`|`192.168.3.0/24`|
|`HR`|`VLAN 40`|`192.168.4.0/24`|
|`Marketing`|`VLAN 50`|`192.168.5.0/24`|
|`Support`|`VLAN 60`|`192.168.6.0/24`|

Использование `VLANs` даёт множество преимуществ, в том числе:

- `Better Organization`Сетевые администраторы могут группировать конечные устройства по любому общему для них признаку.
- `Increased Security`: Сегментация сети не позволяет неавторизованным пользователям перехватывать сетевые пакеты в других `VLANs`.
- `Simplified Administration`Сетевым администраторам не нужно беспокоиться о физическом расположении конечных устройств.
- `Increased Performance`Благодаря сокращению широковещательного трафика для всех конечных устройств сеть может использовать более широкую полосу пропускания.

Коммутаторы Cisco предоставляют `VLAN` идентификаторы/номера от 1 до 4094 (`0` и `4095` являются зарезервированными идентификаторами и не могут использоваться); идентификаторы от 1 до 1005 (`VLAN 1` известен как `default VLAN` и не может/не должен изменяться или удаляться) известны как `normal-range` `VLANs`, при этом идентификаторы 1002–1005 зарезервированы для `Token Ring` и `Fiber Distributed Data Interface` (`FDDI`) `VLANs`, а идентификаторы 1006–4094 известны как `extended-range` `VLANs`. По умолчанию любые настройки, применённые к `normal-range` `VLANs`, сохраняются в базе данных `VLAN` (файл `vlan.dat`), в отличие от `extended-range` `VLANs`, настройки которых не сохраняются. `VLANs` 2-1001, хранящийся в `vlan.dat`, может иметь такие параметры, как имя, тип, состояние и максимальная единица передачи (`MTU`).

## Членство в VLAN

Сетевые администраторы могут назначать порты коммутатора `VLANs` либо статически, либо динамически. Статическое `VLAN` назначение, которое является самым простым и распространённым методом, предполагает назначение каждого порта `VLAN` вручную с помощью `network operating system`; это необходимо делать для всех коммутаторов по отдельности (важно помнить, что конечные устройства, подключающиеся к этим портам, не знают о существовании `VLANs`). В отличие от этого, динамическое `VLAN` назначение автоматически определяет принадлежность конечной точки `VLAN` на основе `MAC`-адресов или протоколов. Системный администратор может зарегистрировать `MAC` адреса в централизованной службе/базе данных `VLAN` управления, например в службе `VLAN Membership Policy Server` (`VMPS`), после чего коммутатор запросит базу данных `VMPS` для определения `VLAN` конечной точки с этим конкретным `MAC` адресом. Несмотря на свою гибкость и мобильность, динамические `VLANs` увеличивают административную нагрузку.

С точки зрения безопасности статические `VLANs` являются более надёжным вариантом, поскольку порт всегда будет привязан к определённому `VLAN` идентификатору, если только он не будет изменён вручную. В случае с динамическими `VLANs` злоумышленник потенциально может использовать такие инструменты, как [macchanger](https://github.com/alobbs/macchanger), чтобы подделать MAC-адрес законных конечных точек и получить доступ к их `VLANs`, тем самым перехватывая весь сетевой трафик, проходящий через них.

## Порты доступа и Магистрали

Любой порт коммутатора с поддержкой `VLAN` должен быть либо `access port`, либо `trunk port`. `Access ports` принадлежит и может передавать трафик только одного `VLAN` (или в некоторых случаях двух, где второй предназначен для `voice traffic`); предполагается, что любой трафик, поступающий на `access port`, принадлежит `VLAN` которому был назначен порт. С другой стороны, `trunk ports` может одновременно передавать несколько `VLANs`; `trunk links` соединяют два `trunk ports` на двух коммутаторах (или коммутатор и маршрутизатор), чтобы обеспечить передачу информации от нескольких `VLANs` через коммутаторы.

## Идентификация VLAN

Стандартные `802.3` `Ethernet` кадры не содержат `VLAN` информации; поэтому коммутаторам и другим устройствам с поддержкой `VLAN` необходим механизм для отслеживания всей `VLAN` информации, связанной с пакетом, при прохождении через устройства с поддержкой `VLAN` . Для этого используются два основных `trunking methods`: `ISL` и `IEEE 802.1Q`.

#### Межкоммутационная связь (ISL)

`Inter-Switch Link` (`ISL`) — это проприетарный протокол Cisco, используемый для транкинга между устройствами с поддержкой `VLAN`. Несмотря на то, что `ISL` является одним из первых `trunking methods` (предшествующих `802.1Q`), он устарел и не так широко используется в современных коммутаторах (и маршрутизаторах) Cisco. Вместо него большинство устройств поддерживают широко распространённый `802.1Q`. `ISL` инкапсулирует весь кадр `Ethernet` включая исходный заголовок `Ethernet` и тег `VLAN` добавляя свой 26-байтовый заголовок и 4-байтовый трейлер.

#### Стандарт IEEE 802.1Q

Чтобы обеспечить совместимость `VLAN` технологий от разных производителей сетевого оборудования, `Institute of Electrical and Electronics Engineers` (`IEEE`) в 1998 году разработал спецификацию [802.1Q](https://ieeexplore.ieee.org/document/10004498). Комитету `IEEE 802` пришлось изменить формат `802.3` `Ethernet` кадра, добавив пару 2-байтовых полей, `TPID` и `TCI` (состоящих из трёх подполей, `PCP`, `DEI`, и `VID`), в результате чего получился `VLAN`-совместимый `802.1Q` `Ethernet` кадр.

![[Pasted image 20250907175250.png]]

`Tag protocol identifier` (`TPID`) - это 16-битное поле, для которого всегда задается значение `0x8100` для идентификации `Ethernet` кадра как `802.1Q` помеченного. `Tag Control Information` (`TCI`) - 16-разрядное поле, содержащее `Priority code point` (`PCP`), `Drop eligible indicator` (`DEI`) (ранее известное как `Canonical format indicator` (`CFI`)) и `VLAN identifier` (`VID`). Основное поле, касающееся `VLANs`, - это `VID` поле, занимающее 12-битное значение младшего порядка `TCI`. Поскольку это 12 бит, он допускает 2 ^ 12 - 2 = 4096 (помните, что `0` и `4095` зарезервированы) `VLAN` Идентификаторы. Таким образом, кадр с `802.1Q`-тегами может содержать информацию для 4094 `VLANs`; практика вставки нескольких `802.1Q`-тегов в один пакет известна как `Double Tagging`, представленная в [802.1ad](https://standards.ieee.org/ieee/802.1Q/10323/). `VLAN tagging` — это процесс вставки `VLAN`-информации в `802.1Q` `Ethernet header`, а `VLAN untagging` — это процесс удаления `VLAN`-информации из `802.1Q`-кадра с `Ethernet`-тегами и пересылки пакета на назначенные порты.

## Сетевые карты с поддержкой VLAN

Некоторые `network interface cards` (`NICs`), подключённые к компьютерам/серверам, поддерживают `VLAN tagging`. Давайте посмотрим, как можно присвоить `VLAN` идентификатор `NIC` в Linux и Windows.

#### Назначение сетевых адаптеров в Linux

В Linux для создания `VLAN` нужно создать интерфейс поверх другого интерфейса, называемого `parent`-интерфейсом. Этот `VLAN`-интерфейс будет помечать пакеты присвоенным `VLAN`-идентификатором, а возвращаемые пакеты будут безметочными.

Чтобы назначить сетевому адаптеру `VLAN` в Linux, можно использовать множество инструментов, таких как [ip](https://man7.org/linux/man-pages/man8/ip.8.html), [nmcli](https://linux.die.net/man/1/nmcli) и [vconfig](https://linux.die.net/man/8/vconfig) (устаревший). Однако сначала нужно убедиться, что в ядре загружен модуль [802.1Q](https://elixir.bootlin.com/linux/v6.4.7/source/net/8021q/vlan.c):

  VLANы

```shell-session
Barlogsha@htb[/htb]$ sudo modprobe 8021q
```

Затем мы можем использовать `lsmod` для проверки того, что `8021q` успешно загрузилось:

  VLANы

```shell-session
Barlogsha@htb[/htb]$ lsmod | grep 8021

8021q                  40960  0
garp                   16384  1 8021q
mrp                    20480  1 8021q
```

Теперь нам нужно найти имя физического `Ethernet` интерфейса, на основе которого мы создадим `VLAN` интерфейс, то есть `eth0`:

  VLANы

```shell-session
Barlogsha@htb[/htb]$ ip a

<SNIP>
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether a6:ba:3b:08:3a:36 brd ff:ff:ff:ff:ff:ff
    altname enp0s3
    altname ens3
    inet 94.2X.5X.72/22 brd 94.237.51.255 scope global dynamic eth0
       valid_lft 83489sec preferred_lft 83489sec
    inet6 fe80::a4ba:3bff:fe08:3a36/64 scope link 
       valid_lft forever preferred_lft forever
```

Затем мы используем `vconfig` для создания нового интерфейса, который является частью нужного `VLAN`, `20`, например, поверх `eth0`:

  VLANы

```shell-session
Barlogsha@htb[/htb]$ sudo vconfig add eth0 20

Warning: vconfig is deprecated and might be removed in the future, please migrate to ip(route2) as soon as possible!
```

Использовать `ip` вместо:

  VLANы

```shell-session
sudo ip link add link eth0 name eth0.20 type vlan id 20
```

Любая из этих команд создаст новый интерфейс под названием `eth0.20@eth0`:

  VLANы

```shell-session
Barlogsha@htb[/htb]$ ip a

<SNIP>
4: eth0.20@eth0: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether a6:ba:3b:08:3a:36 brd ff:ff:ff:ff:ff:ff
```

Затем, на основе `subnet` назначенных адресов с `VLAN 20` в локальной сети, нам нужно назначить интерфейсу IP-адрес и запустить его:

  VLANы

```shell-session
Barlogsha@htb[/htb]$ sudo ip addr add 192.168.1.1/24 dev eth0.20
Barlogsha@htb[/htb]$ sudo ip link set up eth0.20
```

Наконец-то мы можем проверить, изменилось ли состояние интерфейса на «включено»:

  VLANы

```shell-session
Barlogsha@htb[/htb]$ ip a | grep eth0.20

4: eth0.20@eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    inet 192.168.1.1/24 scope global eth0.20
```

#### Назначение сетевых адаптеров в Windows

В Windows, чтобы назначить `VLAN` для физического сетевого адаптера, поддерживающего `VLAN tagging`, сначала нужно открыть `Device Manager`:

![[Pasted image 20250907175301.png]]

Затем нам нужно нажать на `Properties` для `Ethernet interface` , который мы хотим присвоить `VLAN`:

![[Pasted image 20250907175305.png]]

Внутри `Advanced` будет свойство `VLAN ID`, которому мы можем присвоить значение. После нажатия `OK` если адаптер поддерживает присвоение `VLAN`, оно будет установлено; в противном случае окно закроется и ни к одному пакету, исходящему с этого хоста, не будет добавлен тег `VLAN`:

![[Pasted image 20250907175311.png]]

Вместо того чтобы полагаться на графический интерфейс, мы можем использовать `PowerShell`. Сначала давайте получим имена всех доступных физических сетевых адаптеров с помощью командлета [Get-NetAdapter](https://learn.microsoft.com/en-us/powershell/module/netadapter/get-netadapter?view=windowsserver2022-ps):

  VLANы

```powershell-session
PS C:\> Get-NetAdapter | Format-Table -AutoSize

Name                                           InterfaceDescription                                                          ifIndex Status             MacAddress              LinkSpeed
----                                           --------------------                                                          ------- ------             ----------              ---------
VirtualBox Host-Only Network  VirtualBox Host-Only Ethernet Adapter                                        20 Up                    0A-00-27-10-42-15       1 Gbps
Ethernet 2                                 ASIX AX88772B USB2.0 to Fast Ethernet Adapter                            55 Up                    90-EB-78-14-21-7F    100 Mbps
Bluetooth Network Connection  Bluetooth Device (Personal Area Network)                                   18 Disconnected   38-41-25-E8-DE-2D        3 Mbps
Wi-Fi                                         Intel(R) Wireless-AC 9560 160MHz                                                12 Disconnected   8E-36-6A-7A-BA-6A 866.7 Mbps
```

Ранее мы использовали `Device Manager` для присвоения `Ethernet 2` переменной `VLAN 10`; чтобы получить `VLAN`-идентификатор интерфейса, мы можем использовать командлет [Get-NetAdapaterAdvancedProperty](https://learn.microsoft.com/en-us/powershell/module/netadapter/get-netadapteradvancedproperty?view=windowsserver2022-ps) с флагом `-DisplayName` вместе с `vlan id`:

  VLANы

```powershell-session
PS C:\> Get-NetAdapterAdvancedProperty -DisplayName "vlan id"

Name                      DisplayName                    DisplayValue                   RegistryKeyword RegistryValue
----                      -----------                    ------------                   --------------- -------------
Ethernet 2                VLAN ID                        10                                     VLAN_ID               {10}
```

Мы также можем задать `VLAN` идентификатор физического сетевого адреса с помощью командлета [Set-NetAdapter](https://learn.microsoft.com/en-us/powershell/module/netadapter/set-netadapter?view=windowsserver2022-ps) вместе с флагом [VlanID](https://learn.microsoft.com/en-us/powershell/module/netadapter/set-netadapter?view=windowsserver2022-ps#-vlanid). Этот мощный командлет можно использовать и для настройки других свойств интерфейсов, таких как [MAC-адреса](https://learn.microsoft.com/en-us/powershell/module/netadapter/set-netadapter?view=windowsserver2022-ps#-macaddress):

  VLANы

```powershell-session
PS C:\> Set-NetAdapter -Name "Ethernet 2" -VlanID 10
```

Однако помните, что эта операция будет успешной только в том случае, если сетевой интерфейс поддерживает эту функцию. В противном случае `PowerShell` выдаст ошибку, указывающую на то, что интерфейс не поддерживает эту функцию.

## Анализ Трафика с тегами VLAN

Мы можем идентифицировать и проанализировать `VLAN` помеченный трафик в сети с `Wireshark` с помощью фильтра [vlan](https://www.wireshark.org/docs/dfref/v/vlan.html). Например, при анализе дампа сетевых пакетов мы можем проверить пакеты с `802.1Q` метками с помощью фильтра `vlan`:

![[Pasted image 20250907175317.png]]

Кроме того, мы можем искать пакеты с определённым `VLAN` идентификатором. Например, чтобы найти пакеты с `VLAN 10`, мы можем использовать фильтр `vlan.id == 10`:

![[Pasted image 20250907175322.png]]

Кроме того, чтобы перечислить используемые `VLAN` идентификаторы в дампе пакетов, мы можем использовать [tshark](https://www.wireshark.org/docs/man-pages/tshark.html):

  VLANы

```shell-session
Barlogsha@htb[/htb]$ tshark -r "The Ultimate PCAP v20221220.pcapng" -T fields -e vlan.id | sort -n -u

1
2
3
7
10
20
30
40
50
60
70
80
90
121
125
224
```

---

## Последствия для безопасности и атаки на VLAN

Несмотря на повышение уровня безопасности сети, злоумышленники по-прежнему могут обходить защитные механизмы, реализованные с помощью `VLANs`. Хотя использование `VLANs` в современных коммутируемых сетях дает множество преимуществ (таких как упрощение обслуживания сети и повышение производительности), оно также создает потенциальные риски для безопасности, приводящие к различным `VLAN` атакам. Важно понимать основные методы этих атак и применять практические подходы к их предотвращению для защиты сетей.

#### Переключение по VLAN

`VLAN hopping` Атаки позволяют просматривать трафик с одного `VLAN` на другом `VLAN` без помощи маршрутизатора. При этом используется `Dynamic Trunking Protocol` (`DTP`), протокол, который автоматически согласовывает формирование `trunk link` между двумя устройствами Cisco. Злоумышленнику необходимо настроить хост так, чтобы он имитировал/действовал как коммутатор, чтобы воспользоваться функцией автоматического объединения портов в транк, которая по умолчанию включена на большинстве портов коммутатора. Чтобы использовать `VLAN hopping`, злоумышленник должен иметь возможность физически подключиться к порту коммутатора, на котором включена функция `DTP` . Злоумышленник может воспользоваться этим подключением, настроив хост, подключённый к коммутатору через этот конкретный порт, на подмену `802.1Q` сигналов и `DTP` пакетов. В случае успеха коммутатор в конечном счёте установит `trunk link` соединение с хостом злоумышленника, что приведёт к раскрытию сетевых пакетов, причём не только для конкретного `VLAN`.

Мы можем использовать такие инструменты, как [Yersinia](https://linux.die.net/man/8/yersinia), для проведения `VLAN hopping` атак:

![[Pasted image 20250907175328.png]]

#### Двойная маркировка VLAN Hopping

`double-tagging VLAN hopping attack` — это всё более изощрённая атака на `VLANs`. Хотя `VLAN double-tagging` — это законная практика, которую используют такие организации, как `Internet Service Providers` (`ISPs`) (они могут использовать `VLANs` внутри компании, передавая трафик от клиентов, которые уже `VLAN tagged`), злоумышленники также могут пытаться злоупотреблять этим. В `double-tagging VLAN hopping attack` злоумышленник встраивает скрытый `802.1Q`-тег в `Ethernet`-фрейм, у которого уже есть `802.1Q`-тег, что позволяет фрейму перейти в другой `VLAN`, который не был указан в исходном `802.1Q`-теге.

Злоумышленник может осуществить эту атаку, выполнив три действия. Имейте в виду, что эта атака сработает только в том случае, если злоумышленник подключён к порту, расположенному в том же `VLAN` что и `native VLAN` магистрального порта:

1. Злоумышленник отправляет `double-tagged 802.1Q` `Ethernet` кадр на коммутатор с внешним заголовком, содержащим `VLAN` идентификатор злоумышленника, который совпадает с собственным `VLAN` магистрального порта. Предположим, что собственный `VLAN` — это `VLAN 10`, а `VLAN 30` — это `VLAN` порт, к которому злоумышленник хочет подключиться и на котором находится жертва.
2. Внешний 4-байтовый `802.1Q` тег поступает на коммутатор и определяется как предназначенный для `VLAN 10`, собственного `VLAN`. После удаления `VLAN 10` тега кадр пересылается на все `VLAN 10` порты. На магистральном порту `VLAN 10` тег удаляется (сбрасывается), а пакет не перемаркируется, поскольку он является частью собственного `VLAN`. Однако `VLAN 30` тег остается нетронутым (не сбрасывается), и первый коммутатор его не проверяет.
3. Затем коммутатор проверит только внутренний тег `802.1Q`, отправленный злоумышленником, и решит, что кадр нужно переслать на `VLAN 30`, то есть на выбранный злоумышленником `VLAN`. Теперь второй коммутатор либо отправит кадр напрямую на порт жертвы, либо отправит его во все порты, в зависимости от того, есть ли в таблице MAC-адресов запись для хоста жертвы.

[Scapy](https://scapy.readthedocs.io/en/latest/usage.html#vlan-hopping) позволяет выполнять `double-tagging VLAN hopping attack` в дополнение к `Yersinia`:

![[Pasted image 20250907175336.png]]

---

## VXLAN

Ранее мы упоминали, что `VID` поле в заголовке '802.1Q' внутри фрейма 'Ethernet' имеет всего 12 бит, что позволяет использовать 4094 VLAN. Хотя такого количества VLAN может быть достаточно для небольших сетей, для центров обработки данных и поставщиков облачных услуг требуется большее количество, которые требуют обширной сегментации. Кроме того, текущие сети уровня 2 используют `IEEE 802.1D` `Spanning Tree Protocol` (`STP`) для предотвращения сетевых циклов, вызванных избыточными путями. Однако некоторые операторы центров обработки данных сталкиваются с ограничениями `STP`, такими как блокировка каналов, которая сокращает количество доступных портов и препятствует отказоустойчивости за счёт использования нескольких путей. Эти проблемы снижают эффективность сети в виртуализированных средах, использующих физическую инфраструктуру уровня 2. Важнейшим требованием в таких средах является беспрепятственная масштабируемость сети уровня 2 в пределах всего центра обработки данных и даже между центрами обработки данных для эффективного распределения вычислительных ресурсов, сетевых ресурсов и ресурсов хранения. Тем не менее традиционные подходы, такие как `STP`, хотя и обеспечивают отсутствие циклов в топологии, могут отключать многие каналы, что ещё больше усугубляет проблему.

[RFC7348](https://datatracker.ietf.org/doc/html/rfc7348) предлагает решение этих проблем и устранение ограничений в сетях второго уровня с помощью `Virtual eXtensible Local Area Network` (`VXLAN`), которая, по сути, представляет собой «схему наложения второго уровня на сеть третьего уровня». `VXLAN` специально разработана для устранения ограничений традиционных сетей второго уровня и отвечает требованиям сетевых инфраструктур центров обработки данных второго и третьего уровней в многопользовательской среде с виртуальными машинами (ВМ). Работая поверх существующей сетевой инфраструктуры, `VXLAN` обеспечивает инновационный способ плавного расширения сети второго уровня. Его основная цель — упростить масштабирование сетей второго уровня в крупных центрах обработки данных, даже если они расположены в нескольких физических местах хранения данных. Каждое `VXLAN` наложение называется `VXLAN segment`, что позволяет виртуальным машинам в одном сегменте VXLAN взаимодействовать друг с другом, обеспечивая тем самым сетевую изоляцию и безопасность. 24-битный идентификатор сегмента, известный как `VXLAN Network Identifier` (`VNI`), однозначно идентифицирует каждый сегмент VXLAN. Внедрение VXLAN позволяет сосуществовать 16 миллионам `VXLAN` сегментов в рамках одного административного домена, обеспечивая масштабируемость и гибкость для современных центров обработки данных и виртуализированных сред.

---

## Протокол обнаружения Cisco

Cisco Discovery Protocol (CDP) — это сетевой протокол второго уровня от Cisco, который используется устройствами Cisco, такими как маршрутизаторы, коммутаторы и мосты, для сбора информации о других устройствах Cisco, подключенных напрямую. Эту информацию можно использовать для обнаружения и отслеживания топологии сети, а также для управления сетью и устранения неполадок. Этот протокол обычно включен на устройствах Cisco, но его можно отключить, если он не нужен или если его следует отключить из соображений безопасности.

#### Сетевой трафик CDP

  VLANы

```shell-session
22:14:11.563654 CDPv2, ttl: 180s, checksum: 0xebc1 (incorrect -> 0x8b71), length: 180
        Device-ID (0x01), length: 14 bytes: 'router.inlanefreight.loc'
        Addresses (0x02), length: 8 bytes:
                IPv4 (0x01), length: 4: 10.129.100.1
        Port-ID (0x03), length: 9 bytes: 'Ethernet0/0'
        Capability (0x04), length: 4: (0x00000010): Router
        Version String (0x05), length: 27 bytes: 'Cisco IOS Software, C880 Software'
        Platform (0x06), length: 26 bytes: 'Cisco 881 (MPC8300) processor'
```

Отображаемое сообщение содержит информацию о самом устройстве, такую как название устройства, IP-адрес, имя порта и функциональные возможности маршрутизатора, а также информацию об операционной системе и аппаратной платформе устройства. Кроме того, из `CDPv2` в первой строке видно, что мы имеем дело с `Cisco Discovery Protocol`.

Для сравнения можно рассмотреть другой протокол — Spanning Tree Protocol (`STP`).`STP` — это сетевой протокол, который предотвращает образование петель в сети с несколькими соединениями между коммутаторами. Петли отсутствуют, что не позволяет пакетам данных циркулировать по кругу и перегружать сеть.

#### Сетевой трафик STP

  VLANы

```shell-session
22:14:11.563654 STP 802.1w, Rapid STP, Flags [Learn, Forward], bridge-id 8001.00:11:22:33:44:55.8000, length 43
        root-id 8001.AA:AA:AA:AA:AA:AA, cost 0, port-id 8001, message-age 0.00s, max-age 20.00s, hello-time 2.00s, forward-delay 15.00s
```

В этом примере мы видим, что было отправлено сообщение `STP` с информацией о корневом коммутаторе, MAC-адресе корневого коммутатора, идентификаторе порта, через который было отправлено сообщение, а также другими параметрами конфигурации, такими как максимальное время ожидания, время приветствия и задержка пересылки.