#traffic #network #htb 

В предыдущем разделе мы рассмотрели анализ сетевого трафика, зависимости, необходимые для его проведения, и его важность. В этом разделе мы разберём рабочий процесс анализа трафика и познакомимся с его ключевыми компонентами.

Это не точная наука. Это может быть очень динамичный процесс, в котором нет прямой связи. На него сильно влияет то, что мы ищем (ошибки в работе сети или злонамеренные действия), а также то, насколько хорошо вы видите свою сеть. Однако анализ можно свести к нескольким основным принципам.

---

## Описательный анализ

Описательный анализ — важный этап любого анализа данных. Он позволяет описать набор данных на основе индивидуальных характеристик. Он помогает выявить возможные ошибки при сборе данных и/или выбросы в наборе данных.

1. `What is the issue?`
    - Подозреваете взлом? Проблема с сетью?
2. `Define our scope and the goal. (what are we looking for? which time period?)`
    - Цель: несколько хостов потенциально могут загрузить вредоносный файл с сайта bad.example.com
    - Когда: в течение последних 48 часов + 2 часа с сегодняшнего дня.
    - Дополнительная информация: имена файлов/типы файлов: 'superbad.exe' 'new-crypto-miner.exe'
3. `Define our target(s) (net / host(s) / protocol)`
    - Область действия: сеть 192.168.100.0/24, используемые протоколы: HTTP и FTP.

Используя наш рабочий процесс, мы определим проблему, которую нужно решить, а также то, что, когда и где нужно найти. Описательный анализ охватывает эти важнейшие для нашего анализа понятия.

---

## Диагностический Анализ

Диагностический анализ выявляет причины, следствия и взаимосвязи между условиями. При этом он позволяет получить представление о ситуации с помощью корреляций и интерпретации. Характерной чертой этого метода является ретроспективный взгляд, как и в тесно связанной с ним описательной аналитике, с той лишь разницей, что он пытается найти причины событий и изменений.

4. `Capture network traffic`
    - Подключитесь к ссылке с доступом к сети 192.168.100.0/24, чтобы перехватить трафик в реальном времени и попытаться получить один из исполняемых файлов в transfer. Узнайте, может ли администратор получить данные PCAP и/или netflow из нашей SIEM-системы для анализа исторических данных.
5. `Identification of required network traffic components (filtering)`
    - Как только мы получим данные о трафике, отфильтруйте все пакеты, которые не нужны для данного расследования. Отфильтруйте весь трафик, который соответствует нашим базовым показателям, и оставьте только то, что имеет отношение к расследованию. Например, HTTP и FTP из подсети, все, что передает или содержит GET-запрос для подозрительных исполняемых файлов.
6. `An understanding of captured network traffic`
    - После того как мы отфильтровали шум, пришло время заняться поиском наших целей — отфильтровать такие данные, как `ftp-data`, чтобы найти все переданные файлы и восстановить их. Для HTTP мы можем отфильтровать `http.request.method == "GET"` данные, чтобы увидеть все запросы GET, соответствующие искомым именам файлов. Это поможет нам узнать, кто получил файлы, а также, возможно, выявить другие внутренние передачи в сети по тем же протоколам.

Собрав данные о трафике в районе источника проблемы, удалив заведомо корректные данные, а затем потратив время на изучение и анализ того, что осталось, мы сможем определить, в этом ли причина нашей проблемы. Таким образом, мы просто провели диагностический анализ. Мы определяем причину наших проблем и изучаем связанные с ними события.

---

## Прогностический анализ

Оценивая исторические и текущие данные, предиктивный анализ создаёт прогнозную модель для определения вероятностей в будущем. На основе результатов описательного и диагностического анализа этот метод анализа данных позволяет выявлять тенденции, обнаруживать отклонения от ожидаемых значений на ранней стадии и максимально точно прогнозировать будущие события.

7. `Note-taking and mind mapping of the found results`
    
    - Очень важно фиксировать всё, что мы делаем, видим или находим в ходе расследования. Убедитесь, что вы делаете достаточно заметок, в том числе:
    
    - Временные рамки, в которые мы фиксировали трафик.
    - Подозрительные хосты в сети.
    - Разговоры, в которых упоминаются эти файлы. (для указания временных меток и номеров пакетов)
8. `Summary of the analysis (what did we find?)`
    - Наконец, подведите итог всему, что мы обнаружили, и объясните важные детали, чтобы руководство могло принять решение о карантине для затронутых хостов или о более масштабном реагировании на инцидент.
    - Наш анализ повлияет на принимаемые решения, поэтому важно быть максимально ясным и кратким.

Оценивая найденные данные, сравнивая их с базовым трафиком и известными вредоносными данными, такими как маркеры проникновения или эксплуатации (например, сигнатуры вирусов и других хакерских инструментов), мы проводим предиктивный анализ. В ходе этого процесса мы получаем чёткую картину, чтобы можно было принять соответствующие меры.

---

## Предписывающий анализ

Предписывающий анализ направлен на то, чтобы определить, какие действия необходимо предпринять для устранения или предотвращения проблемы в будущем, а также для запуска конкретного действия или процесса. Используя результаты нашего рабочего процесса, мы можем принять взвешенное решение о том, какие действия необходимы для решения проблемы и предотвращения её повторного возникновения. Предписание решения — это кульминация данного рабочего процесса. После того как проблема решена, целесообразно проанализировать весь процесс и извлечь из него уроки. Эти уроки, если их задокументировать, помогут нам усовершенствовать наши процессы: мы сможем зафиксировать, что было сделано правильно, какие действия не помогли и что можно улучшить.

Этот рабочий процесс — пример того, как начать анализ перехваченного трафика. Выше мы разбили его на части, чтобы объяснить, как они соотносятся с процессом анализа и к какому типу анализа относятся. Мы приводим его здесь целиком, чтобы он мог служить шаблоном.

1. `What is the issue?`
    - Подозреваете взлом? Проблема с сетью?
2. `Define our scope and the goal (what are we looking for? which time period?)`
    - цель: несколько хостов потенциально могут загрузить вредоносный файл с сайта bad.example.com
    - когда: в течение последних 48 часов + 2 часа с настоящего момента.
    - Дополнительная информация: имена файлов/типы файлов: 'superbad.exe' 'new-crypto-miner.exe'
3. `Define our target(s) (net / host(s) / protocol)`
    - Область действия: 192.168.100.0/24. Использовались сетевые протоколы HTTP и FTP.
4. `Capture network traffic`
    - подключитесь к ссылке с доступом к сети 192.168.100.0/24, чтобы перехватить трафик в реальном времени и попытаться получить один из исполняемых файлов в transfer. Узнайте, может ли администратор получить данные PCAP и/или netflow из нашей SIEM-системы для анализа исторических данных.
5. `Identification of required network traffic components (filtering)`
    - как только мы получим данные о трафике, отфильтруйте весь трафик, который не нужен для этого расследования; весь трафик, который соответствует нашим общим базовым показателям, и оставьте только то, что имеет отношение к теме. `HTTP и FTP из подсети, все, что передает или содержит GET-запрос для предполагаемых исполняемых файлов.
6. `An understanding of captured network traffic`
    - После того как мы отфильтровали шум, можно приступать к поиску наших целей — отфильтровать такие элементы, как `ftp-data`, чтобы найти все переданные файлы и восстановить их. Для HTTP мы можем отфильтровать `http.request.method == "GET"` и увидеть все запросы GET, соответствующие искомым именам файлов. Это поможет нам понять, кто получил файлы, а также выявить другие внутренние передачи по тем же протоколам.
7. `Note-taking and mind mapping of the found results.`
    
    - Очень важно фиксировать всё, что мы делаем, видим или находим в ходе расследования. Убедитесь, что вы делаете достаточно заметок, в том числе:
    
    - Временные рамки, в которые мы фиксировали трафик.
    - Подозрительные хосты в сети.
    - Разговоры, в которых упоминаются эти файлы. (для указания временных меток и номеров пакетов)
8. `Summary of the analysis (what did we find?)`
    - Наконец, подведите итог всему, что было обнаружено, и объясните важные детали, чтобы руководство могло принять взвешенное решение о карантине для затронутых хостов или о более масштабных мерах реагирования на инцидент.
    - Наш анализ повлияет на принимаемые решения, поэтому важно быть максимально ясным и кратким.

Зачастую этот процесс не ограничивается одним разом. Обычно он цикличен, и нам нужно будет повторять шаги, основанные на анализе исходного снимка, чтобы составить более полную картину. Это могла быть гораздо более масштабная атака, чем в примерах. Предположим, что необходимо принять полномасштабные меры реагирования на инцидент. В таком случае нам, возможно, придётся повторно проанализировать ранее захваченный PCAP-файл, чтобы выявить все разговоры с участием затронутых хостов в течение нескольких минут после передачи исполняемого файла. Это нужно для того, чтобы убедиться, что вирус не распространился по другому маршруту.

---

## Ключевые компоненты эффективного анализа

#### 1. Изучите окружающую среду

Для эффективного анализа трафика необходимо несколько ключевых компонентов. Во-первых, нужно знать среду. Если мы не уверены, что хост принадлежит сети, как мы можем определить, является ли он вредоносным? Крайне важно вести учёт активов и составлять карты сети. Это поможет в процессе анализа.

#### 2. Размещение — это главное

Далее, критически важным является расположение нашего хоста для перехвата трафика. Идеальным местом для размещения инструмента перехвата будет точка, расположенная как можно ближе к источнику проблемы. Если трафик поступает из Интернета, прослушивание входящих ссылок — отличный способ получить полную картину. Это максимально приближенное к источнику расположение, которое мы, администраторы, можем обеспечить. Если проблема, по-видимому, связана с одним хостом во внутренней сети, попробуйте разместить инструменты перехвата в том же сегменте, что и проблемный хост, и посмотрите, какой трафик проходит внутри сегмента.

#### 3. Настойчивость

Настойчивость — следующий критически важный для нас компонент. Проблему не всегда легко обнаружить. Она может возникать в сети не так часто. Например, сервер управления и контроля злоумышленника может обращаться к компьютерам жертвы раз в несколько часов или даже раз в день или реже. Это значит, что если мы не обнаружили проблему с первого раза, то она может появиться в наших журналах не сразу. Не теряйте стремления найти проблему. От этого может зависеть, удастся ли остановить злоумышленника и предотвратить полномасштабную атаку, например с использованием программ-вымогателей.

---

## Аналитический подход

Мы потратили некоторое время на обсуждение процесса анализа и того, как организовать базовый рабочий процесс для выполнения наших задач. Давайте вкратце обсудим, как легко выявить проблемы с трафиком.

Начните с `standard protocols first` и продвигайтесь к `austere and specific` только внутри организации. Большинство атак происходит из интернета, поэтому злоумышленнику нужно каким-то образом получить доступ к внутренней сети. Это означает, что будет генерироваться трафик и вестись журналы. HTTP/S, FTP, электронная почта, а также базовый TCP- и UDP-трафик будут наиболее распространёнными видами трафика из внешнего мира. Начните с них и удалите всё, что не нужно для расследования. После этого проверьте стандартные протоколы, обеспечивающие связь между сетями, такие как SSH, RDP или Telnet. При поиске таких аномалий учитывайте политику безопасности сети. Позволяет ли план обеспечения безопасности нашей организации и его реализация проводить сеансы RDP за пределами предприятия? А как насчёт использования Telnet?

Ищите `patterns`. Проверяет ли определенный хост или группа хостов что-то в интернете в одно и то же время каждый день? Это типичная настройка профиля управления и контроля, которую можно легко обнаружить, проанализировав данные о трафике.

Проверьте всё `host to host` в нашей сети. При стандартной настройке хосты пользователя редко взаимодействуют друг с другом. Поэтому с подозрением относитесь к любому подобному трафику. Как правило, хосты взаимодействуют с инфраструктурой для получения IP-адресов, отправки DNS-запросов, обращения к корпоративным службам и определения маршрута. Мы также увидим, как хосты взаимодействуют с локальными веб-серверами, файловыми хранилищами и другими критически важными элементами инфраструктуры, необходимыми для функционирования среды, такими как контроллеры домена и приложения для аутентификации.

Ищите `unique` события. Любопытно, например, когда хост, который обычно посещает определенный сайт десять раз в день, меняет свой шаблон и делает это только один раз. Также стоит обратить внимание на другую строку User-Agent, которая не соответствует нашим приложениям или хостам, взаимодействующим с сервером в интернете. Также стоит обратить внимание на случайный порт, который привязывается к хосту только один или два раза. Это может быть связано с такими вещами, как обратные вызовы C2, когда кто-то открывает порт для выполнения нестандартных действий, или с аномальным поведением приложения. В больших помещениях ожидаемо наличие узоров, поэтому всё, что выделяется, заслуживает внимания.

`Don't be afraid to ask for help.` Это может показаться преувеличением и очевидным, но если долго смотреть на перехваченные пакеты данных, то детали могут слиться воедино, и мы не увидим всей картины. Если на данные посмотрит ещё один человек, это может существенно помочь в выявлении того, что может ускользнуть от внимания.

---

Подводя итог, можно сказать, что процесс анализа - это очень динамичная задача, и наши дни уже никогда не будут прежними. Продолжайте учиться, понимайте, что происходит вокруг нас, и по мере роста ваших навыков будет расти и способность обнаруживать угрозы. Этот процесс зависит не только от использования таких инструментов, как tcpdump и Wireshark. Существует множество полезных инструментов, таких как Snort, Security Onion, брандмауэры и SIEMs, которые могут помочь обогатить наше понимание окружающей среды и обеспечить лучшую защиту. Не бойтесь использовать их в расследованиях.