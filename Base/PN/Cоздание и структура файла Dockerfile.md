#docker

# Основные концепции Dockerfile

**Dockerfile** — это `текстовый файл`, содержащий последовательность команд, которые Docker использует для создания образа. Он служит «рецептом», который описывает, как должен быть собран образ, начиная от базового слоя до финального состояния. Понимание структуры и создания Dockerfile является ключевым для эффективного использования Docker.

## **Основные концепции Dockerfile**

1. **Идемпотентность**: Dockerfile описывает команды, которые должны быть выполнены для создания образа. Эти команды должны быть идемпотентными, то есть их выполнение несколько раз должно давать один и тот же результат.
2. **Последовательность**: Команды в Dockerfile выполняются последовательно сверху вниз. Порядок команд имеет значение, так как каждая команда создает новый слой образа .
3. **Слоистая структура**: Практически каждый шаг в Dockerfile добавляет новый слой к образу . Эти слои кэшируются и могут быть повторно использованы для оптимизации процесса сборки.

## **Структура Dockerfile**

Dockerfile состоит из множества инструкций, каждая из которых выполняет определенную функцию. Ниже приведены основные инструкции, используемые в Dockerfile:

1. **FROM**: Указывает базовый образ, из которого будет создан новый образ.
2. **MAINTAINER**: Определяет автора Dockerfile (не является обязательной, но полезной для информации).
3. **RUN**: Выполняет команды в контейнере и создает новый слой.
4. **COPY**: Копирует файлы и директории из контекста сборки в файловую систему контейнера.
5. **ADD**: Копирует файлы и директории, а также поддерживает извлечение архивов и загрузку файлов из URL.
6. **WORKDIR**: Устанавливает рабочую директорию для последующих команд.
7. **ENV**: Устанавливает переменные окружения.
8. **CMD**: Определяет команду по умолчанию для выполнения при запуске контейнера.
9. **ENTRYPOINT**: Определяет команду, которая будет выполняться при запуске контейнера, и позволяет передавать аргументы.
10. **EXPOSE**: Информирует Docker о том, какие порты будут использоваться контейнером.
11. **VOLUME**: Создает точку монтирования для внешних томов.

# Создания Dockerfile

## **Пример создания Dockerfile**

Рассмотрим пример создания простого Dockerfile для веб-приложения на Node.js.

**Шаг 1: Создание базового Dockerfile**

Создайте файл с именем Dockerfile в корне вашего проекта и добавьте следующие строки:

dockerfile
```
  
FROM node:14 

WORKDIR /app 

COPY package*.json ./ 

RUN npm install 

COPY . . 

EXPOSE 3000 

CMD ["node", "app.js"]
```

Этот Dockerfile делает следующее:

1. **FROM node:14**: Использует официальный образ `Node.js` версии 14 в качестве базового.
2. **WORKDIR /app**: Устанавливает рабочую директорию в контейнере.
3. **COPY package.json ./**:* Копирует файлы `package.json` и `package-lock.json` в рабочую директорию.
4. **RUN npm install**: Устанавливает зависимости, указанные в `package.json`.
5. **COPY . .**: Копирует все файлы проекта в рабочую директорию контейнера.
6. **EXPOSE 3000**: Задает порт 3000 для доступа к приложению.
7. **CMD ["node", "app.js"]**: Определяет команду по умолчанию для запуска приложения.

**Шаг 2: Сборка образа**

После создания Dockerfile вы можете собрать образ с помощью команды `docker build`.

Эта команда создает образ с именем my-node-app на основе Dockerfile в текущем каталоге.

Terminal
```
docker build -t my-node-app .
```

**Шаг 3: Запуск контейнера**

Запустите контейнер на основе созданного образа с помощью команды `docker run`.

Этот пример запускает контейнер в фоновом режиме, перенаправляя порт 3000 хостовой машины на порт 3000 контейнера.

Terminal
```
docker run -d -p 3000:3000 my-node-app
```

# Дополнительные инструкции Dockerfile

## **Установка переменных окружения**

Вы можете установить переменные окружения, которые будут доступны в контейнере, используя инструкцию `ENV`.

dockerfile
```
ENV NODE_ENV=production
```

## **Использование нескольких команд `RUN`**

Иногда имеет смысл объединять несколько команд в одну инструкцию `RUN`, чтобы уменьшить количество слоев, уменьшить размер Image и ускорить сборку .

dockerfile
```
RUN apt-get update && apt-get install -y \ 
	curl \ 
	git \ 
	&& rm -rf /var/lib/apt/lists/*
```

`Полезно!` В Linux, если у вас команда не помещается на одну строку, вы можете поставить символ `\` и продолжить писать ее на следующей строке. Тогда две (или несколько строк) будут интерпретироваться ОС как одна.

`Полезно!` Если вы хотите записать несколько команда ОС на одной строке, то вам нужно использовать символы `&&: command1 && command2 && command3` – это просто 3 отдельных команды записанных в одной строке.

## **Оптимизация порядка команд**

Для эффективного использования кэша Docker рекомендуется сначала копировать файлы, которые изменяются реже, такие как `package.json`, и устанавливать зависимости перед копированием остальных файлов проекта

Пример продвинутого Dockerfile

Для сложных проектов может потребоваться более продвинутый Dockerfile с дополнительными настройками.

dockerfile
```
  
FROM node:14-alpine 

WORKDIR /usr/src/app 

COPY package*.json ./ 

RUN npm install --only=production 

COPY . . 

EXPOSE 8080 

ENV NODE_ENV=production 

CMD ["node", "server.js"]
```