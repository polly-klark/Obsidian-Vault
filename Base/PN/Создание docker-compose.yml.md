#docker 

# Файл `docker-compose.yml`

**Файл `docker-compose.yml`** — это основной конфигурационный файл, используемый Docker Compose для определения и управления многоконтейнерными приложениями. Он описывает, какие контейнеры (сервисы) должны быть запущены, как они должны взаимодействовать друг с другом и какие ресурсы им нужны. В этой лекции мы подробно рассмотрим структуру файла `docker-compose.yml` и основные директивы, которые используются для конфигурации сервисов.

## **Структура файла `docker-compose.yml`**

Файл `docker-compose.yml` состоит из нескольких разделов, каждый из которых описывает различные аспекты конфигурации приложений. Основные разделы включают:

1. **version**
2. **services**
3. **volumes**
4. **networks**

# Основные директивы

**1. version**

Директива version определяет версию синтаксиса Docker Compose, используемого в файле. На момент написания статьи наиболее распространены версии 2 и 3.

Yaml
```
version: '3.8'
```

**2. services**

Раздел **services** определяет контейнеры, которые Compose должен создать и запустить. Каждый сервис представляет собой отдельный контейнер с определенной конфигурацией.

**Пример:**

Yaml
```
services: 
	web: 
		image: nginx:latest 
		ports: 
			- "80:80" 
	db: 
		image: mongo:latest 
		volumes: 
			- mongo-data:/data/db
```

В этом примере определены два сервиса: `web` и `db`.

**3. volumes**

Раздел **volumes** используется для определения томов, которые могут быть подключены к контейнерам для хранения данных.

**Пример:**

Yaml
```
volumes: 
	mongo-data:
```

**4. networks**

Раздел **networks** позволяет определить пользовательские сети, в которых будут работать контейнеры, что обеспечивает изоляцию и настройку сетевых подключений. Если сети не указаны, Docker Compose создаст дефолтную сеть, и все сервисы будут подключены к ней

**Пример:**

Yaml
```
networks: 
	front-end: 
	back-end:
```

# Директивы для настройки сервисов

Основные директивы для настройки сервисов

**1. image**

Директива **image** указывает образ, который будет использоваться для создания контейнера.

**Пример:**

Yaml
```
services: 
	web: 
		image: nginx:latest
```

**2. build**

Директива **build** используется для указания пути к Dockerfile, который должен быть использован для сборки образа.

**Пример:**

Yaml
```
services: 
	app: 
		build: ./app
```

**3. ports**

Директива **ports** определяет порты, которые должны быть открыты и перенаправлены с хост-машины на контейнер.

**Пример:**

Yaml
```
services: 
	web: 
		image: nginx:latest 
		ports:
			 - "80:80"
```

**4. volumes**

Директива **volumes** монтирует тома в контейнеры, что позволяет сохранять данные между перезапусками контейнеров.

**Пример:**

Yaml
```
services: 
	db: 
		image: mongo:latest 
		volumes: 
			- mongo-data:/data/db
```

**5. environment**

Директива **environment** задает переменные окружения для контейнера.

**Пример:**

Yaml
```
services: 
	app: image: 
		myapp:latest 
		environment: 
			- NODE_ENV=production 
			- API_KEY=1234567890
```

**6. depends_on**

Директива **depends_on** указывает, что данный сервис зависит от других сервисов и должен быть запущен после них .

`Важно!` При запуске вашего сервиса у вас нет 100% гарантии, что все нужные для его работы сервисы отлично работают. Они будут запущены – да, но дальнейшая работоспособность не гарантируется. Эта проблема решается с помощью хелс-чек, но об этом позднее.

**Пример:**

Yaml
```
services: 
	web: 
		image: nginx:latest 
		depends_on: 
			- db 
	db: image: mongo:latest
```

**7. command**

Директива **command** позволяет переопределить команду, которая будет выполнена при запуске контейнера.

**Пример:**

Yaml
```
services: 
	app: 
		image: myapp:latest 
		command: python app.py
```

**8. networks**

Директива **networks** подключает сервис к одной или нескольким сетям.

**Пример:**

Yaml
```
services: 
	web: 
		image: nginx:latest 
		networks: 
			- front-end 
	db: 
		image: mongo:latest 
		networks: 
			- back-end
```

# Полный пример

**Пример полного файла `docker-compose.yml`**

Yaml
```
version: '3.8' 

services: 
	web: 
		image: nginx:latest 
		ports: 
			- "80:80" 
		volumes: 
			- ./nginx.conf:/etc/nginx/nginx.conf 
		depends_on: 
			- app 
		networks: 
			- front-end 
	 
	app: 
		build: ./app 
		volumes: 
			- ./app:/usr/src/app 
		environment: 
			- NODE_ENV=production 
		networks: 
			- front-end 
			- back-end
	
	db: 
		image: mongo:latest 
		volumes: 
			- mongo-data:/data/db 
		networks: 
			- back-end
	
	volumes: 
		mongo-data: 
		
	networks: 
		front-end: 
		back-end:
```

В этом примере:

- Определены три сервиса: `web`, `app` и `db`.
- `web` использует образ Nginx, монтирует конфигурационный файл и зависит от сервиса `app`.
- `app` собирается из локального Dockerfile, монтирует исходный код приложения и использует переменные окружения.
- `db` использует образ MongoDB и монтирует том для хранения данных.
- Созданы два тома и две сети для изоляции и управления взаимодействием сервисов.

**Примечание**: один том – это `mongo-data`, второй – это замаунченая директория с хост-машины.