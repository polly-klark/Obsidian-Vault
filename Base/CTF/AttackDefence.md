#LetoCTF #AD

# whoami

Александр Котов

- CEO HackerDome
- Instructure Team Lead ALT

# План лекции
Как играть в A/D?

1. Познакомиться с основными компонентами игры в A/D
2. Изучим процесс взаимодействия компонентов игры
3. Рассмотрим основные моменты при работе с сервисом
4. Познакомлюсь опытом организации командного взаимодействия на игре

# Задачи участников
...

# Основные компоненты
Attack/Defence

## Сервисы
Содержат уязвимости

- Различные сервисы доставки
- Имитация службы поддержки
- Интерфейс для взаимодействия с промышленными системами
- Социальные сети
- Etc...

- Набор игровых сервисов с ОС - игрвой образ

## Чекеры
Проверяют работоспособность сервисов

- Имитируют взаимодействие пользователя с сервисом
- В процессе работы выполняют 4 действия:
1. CHECK - проверка работоспособности сервиса
2. PUT - положить флаг
3. GET - получить флаг, положенный в предыдущем шаге
4. GET - получить произвольный флаг за последние N-минут
- Флаг состоит из 31 произвольных символов и "="
- Чекер возвращает один из следующих статусов:
1. OK - сервис в порядке, - все проверки завершились успешно
2. MUMBLE - сервис работает, но отвечает не по протоколу
3. CORRUPT - сервис работает, но не отдаются прошлые флаги
4. DOWN - сервис не работает

## Чек-система 
Запускает чекеры  выставляет баллы

- Производит запуск чекеров
- Конвертирует полученный результат в баллы
- Принимает флаги от команд после успешных атак
- Визуализация результатов

## Сеть: local / VPN

## Cloud
Облако для игры в A/D

- Разворачиваем игрвой образ на DO/YaCloud/BareMetal
- Участникам достаточно ввести токен от веб-интерфейса клауда, чтобы начать игру
- Запуск образа, бэкап, восстановление до начальных настроек
- Получение VPN-конфигов для доступа в игровую сеть

# Этапы игры
Очного 9-ти часового Attack/Defence

- Размещение участников за столы
- Начало игры - знакомство с игровым образом
- - Участники получают доступ к образу
- - Но чек-система не работает и игровая сеть закрыта
- Открытие игрвой сети - через 1 час после начала
- Перерыв на обед - 1 час (сервисы можно смотреть, чек-система не работает, сеть закрыта)
- Продолжение игры
- Завершение и подведение итогов

# Как играть?

## Получить доступа

- В первую очередь необходимо получить доступ к образу
- Получить конфиг и инструкции от оргов
- Настроить VPN (OpenVPN/Wireguard)
- Подключиться к обазу по ssh

## Скачать исходники и найти порты сервисов

- Для того, чтобы удобно было искать уязвимости в коде, необходимо выкачать исходники и бинари всех сервисов к себе на комп
- Это можно сделать через scp
- Заархивировать и пошарить команде архив
- Занимается этим обин человек
- Заодно можно определить порты сервисов

## Искать уязвимости

- После того, как исходники получены, самое время распределиться по сервисам и начать искать уязвимости
- Для поиска уязвимостей, в первую очередь, важно определить доменную область сервиса через изучение пользовательского интерфейса
- После этого можно открыть любимую IDE

## Произвести атаку и закрыть у себя 

- Изучение потенциальной уязвимости необходимо производить на собственных сервисах, чтобы избежать преждевременной утечки пэйлоада - полезная нагрузка, эксплуатирующая уязвимость
- После того, как пэйлоад найден, необходимо закрыть уязвимость на собственном сервисе
- Затем написать эксплойт (скрипт, автоматизирующий атаку)

## Хакнуть другие команды

- После того, как эксплойт готов, необходимо докрутить его взаимодействие с проверяющей системой
- Научить отправлять полученные флаги

## Ферма не нужна
Если вы подумали об огороде

## Итого

1. Получить доступ VPN и ssh
2. Скачать исходники и найти сервисы
3. Найти уязвимость
4. Закрыть уязвимость в сервисе
5. Произвести атаки на другие команды

# Роли в команде
Choose your fighter

## Админ
1 шт

- В каждой команде должен быть человек, ответственный за игровой образ
- В обязанности роли входитЖ
- - Настройка sshd (no password, keys only)
- - Установка необходимого софта
- - Обеспечение команде доступа к образу
- - Прочие вещи, которые необходимо сделать с образом до начала игры
- - Предварительная настройка образа
- Контроль состояния образа и починка в случае необходимости 
- Необходимо знать про linux и контейнеры

## Тимлид
1 шт

- Контролирует успехи тимы по сервисам
- Заполняет таблицу с инфой о сервисах
- Выкачивает сервисы с образа (но не обязательно)
- Производит переодический опрос команды

## Crypyo/Rev/PWN/Web
(N - 2) шт

- Остальные игроки ждут получения сервисов
- Могут помогать админу и тимлиду при начале игры
- Произвольно выбирают сервис и записываются в таблице
- О сложностях с сервисом сообщает тимлиду

# Как делать низзя
То, за что можно получить по рукам

- Генерирование неоправданно много трафика
- Производить атаку на инфраструктуру оргов
- Отделять запросы проверяющей системы от запросов участников
- Нарушать регламент сорев

# Level up
Если это у вас не в первый раз

- Хорошей практикой может стать написание ansible-скрипта, который произведёт всю настройку образа (установка пакетов, запуск служб, создание пользователей)
- Одна команда может спасти жизнь - git init
- Писать трафик - tshark, tcpdump
- Используйте фермы
- Настройте IDS/IPS для отсечения простых атак (suricata)

# Бонус уровень
Чек-лист уязвимостей

- База даныых выставлена на 0.0.0.0 - можно подключиться к базам других команд и вытянуть флаги (креды одинаковые)
- Проверьте содержмое бд - вдруг там лежат креды от какой-нибудь админки
- Захардкоженые переменные с чувствительными даными могут стать отправной точкой (образы идентичны), для бд на localhost - нормально
- В сервисе нет ORM - потенциально возможна инъекция
- ФС как БД - потенциальный path traversal
- Не знаешь откуда начать - начни с пользовательского ввода
- Некорректное использование ГПСЧ
- IDOR