#forensic #writeup #bytes

_Джигбой, супергерой, обладает замечательной способностью вытаскивать колоссальных размеров рыбу из глубин глубокого синего моря._

## Первоначальный мыслительный процесс

Нам выдается небольшой файл размером 415 байт с именем [flag.damaged](https://github.com/Jonnen98cool/CTF_writeups/blob/main/mapna_ctf_2024/helper/flag.damaged), выглядит он так:

![[Pasted image 20240825095755.png]]

Запуск `file flag.damaged` выдает `flag.damaged: PGP Secret Sub-key -` ошибку, которая кажется неправильной. Я подозреваю, что файл каким-то образом поврежден, и мне нужно его восстановить (имя файла также намекает на это).

Я просматриваю первые пару байтов, чтобы увидеть, соответствует ли их подпись известному типу файла в соответствии с [этим сайтом](https://www.garykessler.net/library/file_sigs.html). Этого нет, но я заметил, что они очень похожи на волшебные байты PNG: `89 50 4E 47 0D 0A 1A 0A`. Я редактирую файл с помощью `hexeditor`, чтобы он содержал подпись PNG, и переименовываю файл в `flag.png`. Я пытаюсь открыть его, безуспешно. Конечно, это было бы не так просто. С помощью таких инструментов, как `pngcheck`, я пытаюсь отладить, почему это не работает. Файлы PNG соответствуют определенному формату в отношении файловой структуры ([спецификация PNG](https://www.w3.org/TR/2003/REC-PNG-20031110/#5DataRep)). После некоторого изучения спецификации PNG я понимаю, что большая ее часть отсутствует в файле, который мне дали. Возможно, это все-таки был не файл .png.

## Решение

Я смотрю на подпись трейлера `flag.damaged` и о чудо, она в точности соответствует подписи файла типа jbig2 (формат файла сжатого изображения). Если еще раз взглянуть на первые пару байтов, они очень похожи на правильную подпись для `.jb2` файла, которая является: `97 4A 42 32 0D 0A 1A 0A`. Я редактирую 2-й и 3-й байты, чтобы они соответствовали подписи jbig2, и переименовываю файл в `flag.jb2`. 415 Байт довольно мало для файла изображения, но если он сжат, это имеет больше смысла. Название соревнования также заставляет меня поверить, что я на правильном пути.

Я ищу инструменты для открытия `.jb2` файла и нахожу `jbig2dec`. Я запускаю`jbig2dec flag.jb2`, но получаю некоторые ошибки, которые не очень легко отладить. Я просматриваю `man` страницы для поиска инструмента и запускаю его снова с флагами `--verbose=3` и `--dump` (="Распечатайте структуру файла JBIG2, а не явно декодируйте его."). К сожалению, последний вариант еще не был реализован. Я потратил некоторое время, пытаясь найти спецификацию файловой структуры jbig2, но не смог найти ничего полезного.

В конце концов мне пришлось прибегнуть к модификации байтов методом проб и ошибок в соответствии с сообщением об ошибке, которое я получил. Во-первых, это ошибка:

![[Pasted image 20240825095846.png]]

Там написано `FATAL ERROR segment too short (segment 0x00000000)`. После определения, какие 4 байта относятся к сегменту (с текущим значением `0x00000000`) и безрезультатного их изменения, я нацеливаюсь `data_length=1` вместо этого. Я ищу `0x01` байт в начале файла и устанавливаю его равным `0x02`, запускаю `jbig2dec` снова, пока не появится мое изменение. Методом проб и ошибок я обнаружил, что мне нужно отредактировать 24-й байт. Я установил для него возрастающие значения, чтобы попытаться устранить ошибку. Например, при установке значения `0xA1` выдается предупреждение: `WARNING extra data in segment (segment 0x00000000)`. В конце концов я нахожу, что `0x13` это правильное значение, выдающее следующий результат:

![[Pasted image 20240825095917.png]]

Этого изменения было достаточно, чтобы файл был декодирован в видимое изображение:

![[Pasted image 20240825095935.png]]

Так близко! Я изучил подробный вывод, в котором теперь отсутствовали какие-либо предупреждения или ошибки, чтобы попытаться выяснить, как просмотреть оставшуюся часть изображения. Я попробовал изменить несколько значений, например, установив `data_length=339` более высокое значение, и посмотрел, оказало ли это положительное влияние на декодированное изображение. В конце концов я обнаружил, что разрешение изображения было 257x19. Мне нужно было "больше изображения", поэтому я поискал шестнадцатеричный эквивалент этого значения (`0x101`), обнаружил, что оно равно 27-28 байтам, и изменил их на `0x401`. Затем я снова запустил `jbig2dec` и вуаля:

![[Pasted image 20240825095948.png]]

Затем я потратил невыносимо много времени, пытаясь на самом деле представить флаг, и в конце концов был вынужден спросить своего товарища по команде, как он интерпретировал отдельные символы...

После решения задачи я все еще не знаю, как предполагается описание задачи, поэтому ссылаюсь.