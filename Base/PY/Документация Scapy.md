#python #degree #forensic #wireshark #traffic #pcap #capture #dump

# Введение

## О Scapy

Scapy - это программа на Python, которая позволяет пользователю отправлять, анализировать, анализировать и подделывать сетевые пакеты. Эта возможность позволяет создавать инструменты, которые могут исследовать, сканировать или атаковать сети.

Другими словами, Scapy - это мощная интерактивная программа для обработки пакетов. Он способен подделывать или декодировать пакеты из широкого числа протоколов, отправлять их по проводам, перехватывать их, сопоставлять запросы и ответы и многое другое. Scapy может легко обрабатывать большинство классических задач, таких как сканирование, трассировка, зондирование, модульные тесты, атаки или обнаружение сети. Он может заменить hping, arpspoof, arp-sk, arping, p0f и даже некоторые части Nmap, tcpdump и tshark.

![[Pasted image 20230206224612.png]]

Scapy также очень хорошо справляется со многими другими специфическими задачами, с которыми не справляется большинство других инструментов, такими как отправка недопустимых кадров, внедрение собственных кадров стандарта 802.11, комбинирование методов (переключение VLAN + отравление кэша ARP, декодирование VOIP по зашифрованному каналу WEP, ...) и т.д.

Идея проста. Scapy в основном выполняет две задачи: отправляет пакеты и получает ответы. Вы определяете набор пакетов, он отправляет их, получает ответы, сопоставляет запросы с ответами и возвращает список пар пакетов (запрос, ответ) и список несовпадающих пакетов. Это имеет большое преимущество перед такими инструментами, как Nmap или hping, в том, что ответ не сводится к (открыт / закрыт / отфильтрован), а представляет собой весь пакет.

В дополнение к этому можно создать более высокоуровневые функции, например, ту, которая выполняет трассировку и выдает в результате только начальный TTL запроса и исходный IP ответа. Тот, который выполняет пинг всей сети и выдает список машин, отвечающих. Тот, который выполняет сканирование портов и возвращает отчет LaTeX.

## Что делает Scapy таким особенным

Во-первых, с большинством других сетевых инструментов вы не создадите то, что автор не представлял. Эти инструменты были созданы для конкретной цели и не могут сильно отклоняться от нее. Например, программа отравления кэша ARP не позволит вам использовать двойную инкапсуляцию 802.1q. Или попробуйте найти программу, которая может отправлять, скажем, ICMP-пакет с заполнением (я сказал _заполнение_, а не полезную _нагрузку_, понимаете?). Фактически, каждый раз, когда у вас возникает новая потребность, вам приходится создавать новый инструмент.

Во-вторых, они обычно путают декодирование и интерпретацию. Машины хороши в декодировании и могут помочь людям в этом. Устный перевод предназначен только для людей. Некоторые программы пытаются имитировать это поведение. Например, они говорят “_этот порт открыт_” вместо “_Я получил SYN-подтверждение_”. Иногда они правы. Иногда нет. Это проще для новичков, но когда вы знаете, что делаете, вы продолжаете пытаться вывести, что на самом деле произошло, из интерпретации программы, чтобы создать свою собственную, что сложно, потому что вы потеряли большое количество информации. И вы часто в конечном итоге используете `tcpdump -xX` для декодирования и интерпретации то, что пропустил инструмент.

В-третьих, даже программы, которые только декодируют, не дают вам всей информации, которую они получили. Видение сети, которое они дают вам, является тем, которое их автор посчитал достаточным. Но она не полная, и у вас есть предвзятость. Например, знаете ли вы инструмент, который сообщает о заполнении Ethernet?

Scapy пытается преодолеть эти проблемы. Это позволяет вам создавать именно те пакеты, которые вы хотите. Даже если я думаю, что укладка слоя 802.1q поверх TCP не имеет смысла, это может иметь значение для кого-то другого, работающего над каким-то продуктом, который я не знаю. Scapy имеет гибкую модель, которая пытается избежать таких произвольных ограничений. Вы можете поместить любое значение, которое вы хотите, в любое поле, которое вы хотите, и сложить их, как вы хотите. В конце концов, вы взрослый человек.

На самом деле, это все равно, что каждый раз создавать новый инструмент, но вместо того, чтобы иметь дело со стострочной программой на C, вы пишете только 2 строки Scapy.

После проверки (сканирования, трассировки и т. Д.) Scapy всегда предоставляет вам полные декодированные пакеты из зонда перед любой интерпретацией. Это означает, что вы можете проверять один раз и интерпретировать много раз, запрашивать трассировку и, например, просматривать заполнение.

### Быстрая разработка пакетов

Другие инструменты придерживаются парадигмы **программы, которую вы запускаете из оболочки**. Результатом является ужасный синтаксис для описания пакета. Для этих инструментов принятое решение использует более подробное, но менее подробное описание в виде сценариев, воображаемых автором инструмента. В качестве примера, для запуска сценария **сканирования портов** сканеру портов должен быть предоставлен только IP-адрес. Даже если сценарий немного изменен, вы все равно застряли на сканировании портов.

Парадигма Scapy заключается в предложении языка, специфичного для домена (DSL), который обеспечивает мощное и быстрое описание любого типа пакетов. Использование синтаксиса Python и интерпретатора Python в качестве синтаксиса и интерпретатора DSL имеет много преимуществ: нет необходимости писать отдельный интерпретатор, пользователям не нужно изучать еще один язык, и они получают выгоду от полного, краткого и очень мощного языка.

Scapy позволяет пользователю описывать пакет или набор пакетов как слои, которые укладываются один на другой. Поля каждого уровня имеют полезные значения по умолчанию, которые могут быть перегружены. Scapy не обязывает пользователя использовать заранее определенные методы или шаблоны. Это облегчает необходимость написания нового инструмента каждый раз, когда требуется другой сценарий. В C для описания пакета может потребоваться в среднем 60 строк. С помощью Scapy отправляемые пакеты могут быть описаны только в одной строке с другой строкой для вывода результата. 90% инструментов сетевого зондирования можно переписать в 2 строки Scapy.

### Исследуйте один раз, интерпретируйте много

Обнаружение сети - это тестирование черного ящика. При зондировании сети отправляется много стимулов, в то время как ответы получены только на несколько из них. Если выбраны правильные стимулы, желаемая информация может быть получена с помощью ответов или отсутствия ответов. В отличие от многих инструментов, Scapy предоставляет всю информацию, то есть все отправленные стимулы и все полученные ответы. Изучение этих данных даст пользователю желаемую информацию. Когда набор данных невелик, пользователь может просто порыться в нем. В других случаях интерпретация данных будет зависеть от принятой точки зрения. Большинство инструментов выбирают точку зрения и отбрасывают все данные, не относящиеся к этой точке зрения. Поскольку Scapy предоставляет полные необработанные данные, эти данные могут использоваться много раз, позволяя видоизменять точку зрения во время анализа. Например, сканирование TCP-порта может быть проверено, и данные визуализируются как результат сканирования порта. Затем данные также могут быть визуализированы в отношении TTL пакета ответа. Для корректировки точки зрения данных не требуется инициировать новое исследование.

![[Pasted image 20230206225053.png]]

### Scapy декодирует, он не интерпретирует

Общая проблема с инструментами сетевого зондирования заключается в том, что они пытаются интерпретировать полученные ответы вместо того, чтобы только расшифровывать и предоставлять факты. Сообщение о чем-то вроде **получения сброса TCP на порту 80** не подвержено ошибкам интерпретации. Сообщение о **закрытии порта 80** - это интерпретация, которая может быть правильной в большинстве случаев, но неправильной в некоторых конкретных контекстах, которые автор инструмента не представлял. Например, некоторые сканеры, как правило, сообщают о отфильтрованном TCP-порту, когда они получают недоступный пакет назначения ICMP. Это может быть правильно, но в некоторых случаях это означает, что пакет не был отфильтрован брандмауэром, а скорее не было хоста для пересылки пакета.

Интерпретация результатов может помочь пользователям, которые не знают, что такое сканирование портов, но это также может принести больше вреда, чем пользы, поскольку вносит предвзятость в результаты. Что может иметь тенденцию происходить, так это то, что для того, чтобы они могли сами выполнять интерпретацию, знающие пользователи будут пытаться перепроектировать интерпретацию инструмента, чтобы получить факты, которые вызвали эту интерпретацию. К сожалению, при этой операции теряется много информации.

## Быстрая демонстрация

Сначала мы немного поиграем и создадим сразу четыре IP-пакета. Давайте посмотрим, как это работает. Сначала мы создаем экземпляр класса IP. Затем мы снова создаем его экземпляр и предоставляем адресату значение, равное четырем IP-адресам (/30 дает сетевую маску). Используя идиому Python, мы разрабатываем этот неявный пакет в виде набора явных пакетов. Затем мы завершаем работу интерпретатора. Поскольку мы предоставили файл сеанса, переменные, над которыми мы работали, сохраняются, а затем перезагружаются:

```
# ./run_scapy -s mysession
New session [mysession]
Welcome to Scapy (2.4.0)
>>> IP()
<IP |>
>>> target="www.target.com/30"
>>> ip=IP (dst =target)
>>> ip
<IP dst=<Net www > |>
>>> [p for p in ip]
[<IP dst=207.171.175.28 |>, <IP dst=207.171.175.29 |>,
 <IP dst =207.171.175.30 |>, <IP dst = 207.171.175.31 |>]
>>> ^D
```

```
# ./run_scapy -s mysession
Using session  [mysession]
Welcome to Scapy (2.4.0)
>>> ip
<IP dst=<Net www > |>
```

Теперь давайте поработаем с некоторыми пакетами:

```
IP()
<IP |>
>>>a=IP(dst = "172.16.1.40")
>>>a
<IP dst=172.16.1.40 |>
>>>a.dst
'172.16.1.40'
>>>a.ttl
 64
```

Допустим, мне нужен широковещательный MAC-адрес и полезная нагрузка IP для ketchup.com и чтобы mayo.com , значение TTL от 1 до 9 и полезная нагрузка UDP:

```
Ether (dst="ff:ff:ff:ff:ff:ff")
 /IP(dst=["ketchup.com","mayo.com"],ttl=(1,9))
 /UDP()
```

У нас есть 18 пакетов, определенных в 1 строке (1 неявный пакет).

### Разумные значения по умолчанию

Scapy пытается использовать разумные значения по умолчанию для всех полей пакета. Если не переопределено,

-   Источник IP выбирается в соответствии с пунктом назначения и таблицей маршрутизации
    
-   Вычисляется контрольная сумма
    
-   Исходный MAC выбирается в соответствии с интерфейсом вывода
    
-   Тип Ethernet и IP-протокол определяются верхним уровнем

![[Pasted image 20230206225534.png]]

Значения по умолчанию для других полей выбираются как наиболее полезные:

-   Порт источника TCP равен 20, порт назначения равен 80.
    
-   Порты источника и назначения UDP равны 53.
    
-   Тип ICMP - это эхо-запрос.

## Изучение Python

Scapy использует интерпретатор Python в качестве командной панели. Это означает, что вы можете напрямую использовать язык Python (назначать переменные, использовать циклы, Определять функции и т. Д.)

Если вы новичок в Python и из-за этого действительно не понимаете ни слова, или если вы хотите выучить этот язык, потратьте час на чтение очень хорошего [руководства по Python](http://docs.python.org/tutorial/) от Guido Van Rossum . После этого вы узнаете Python :) (действительно!). Для более глубокого изучения Python [погружение в Python](http://getpython3.com/diveintopython3/index.html) также является очень хорошим началом.

![[Pasted image 20230525083147.png]]
